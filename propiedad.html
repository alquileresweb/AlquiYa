<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AlquiYa - Detalle de Alquiler</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SSJ5DG33JK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-SSJ5DG33JK');
  </script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <link rel="icon" type="image/png" href="https://i.postimg.cc/MKpMcrcQ/AlquiYa.png">

  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f4f4f4; }
    header {
      background: white;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    header img { max-width: 250px; }
    #alquiler-detalle {
      max-width: 700px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 2px solid #3483fa;
    }
    #alquiler-detalle h2 { color: #3483fa; margin-top: 0; }
    #alquiler-detalle p { margin: 12px 0; line-height: 1.5; }
    #alquiler-detalle button {
      background: #25D366;
      color: white;
      border: none;
      padding: 12px 20px;
      margin: 10px 8px 0 0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    #alquiler-detalle button:hover { background: #1ebe57; }
    #loading-msg {
      text-align: center;
      font-weight: bold;
      color: #3483fa;
      font-size: 18px;
      margin: 40px;
    }
    #imagenes-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 15px;
    }
    #imagenes-container img {
      width: 120px;
      height: 90px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid #ddd;
      transition: transform 0.2s;
    }
    #imagenes-container img:hover { transform: scale(1.05); border-color: #3483fa; }
    #map { height: 400px; margin-top: 20px; border-radius: 10px; border: 2px solid #3483fa; }
    #modal-img {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #modal-img img { max-width: 90%; max-height: 90%; border-radius: 10px; }
    #modal-img .close-btn, #modal-img .nav-btn {
      position: absolute;
      background: rgba(0,0,0,0.7);
      color: white;
      color: white;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      font-size: 28px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #modal-img .close-btn { top: 15px; right: 15px; }
    #modal-img .prev-btn { left: 15px; }
    #modal-img .next-btn { right: 15px; }
    .marker-icon {
      background: #3483fa;
      color: white;
      font-weight: bold;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 3px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>

<header>
  <img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="Logo Alqui Ya">
</header>

<div id="loading-msg">Cargando datos del alquiler...</div>
<div id="alquiler-detalle"></div>

<!-- Modal de imagen grande -->
<div id="modal-img">
  <img id="img-grande" alt="Imagen ampliada">
  <button class="close-btn" onclick="cerrarModal()">X</button>
  <button class="nav-btn prev-btn" onclick="cambiarImagen(-1)">Previous</button>
  <button class="nav-btn next-btn" onclick="cambiarImagen(1)">Next</button>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
  const webAppURL = "https://script.google.com/macros/s/AKfycbyFvDRwPZoG6ChhvcxGm6B27ziD6Qkg4RcH0TI9K59b7zPz7iFxy7mgmbs5mo5T-TxD/exec";
  let currentImages = [];
  let currentImageIndex = 0;

  function getField(obj, keys) {
    for (const k of keys) {
      if (obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null && obj[k] !== "") {
        return obj[k];
      }
    }
    return "";
  }

  function toInt(val, def = 0) {
    const n = parseInt(val, 10);
    return isNaN(n) ? def : n;
  }

  function driveUrlDirect(url) {
    if (!url || !url.includes("drive.google.com")) return url;
    let match = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
    return match ? `https://drive.google.com/uc?export=view&id=${match[1]}` : url;
  }

  function formatPrice(num) {
    if (!num) return "";
    const clean = String(num).replace(/[^\d]/g, "");
    return "$" + parseInt(clean, 10).toLocaleString('es-AR').replace(/,/g, ".");
  }

  function abrirModal(src, images, index) {
    currentImages = images;
    currentImageIndex = index;
    document.getElementById("img-grande").src = src;
    document.getElementById("modal-img").style.display = "flex";
    document.querySelector(".prev-btn").style.display = images.length > 1 ? "block" : "none";
    document.querySelector(".next-btn").style.display = images.length > 1 ? "block" : "none";
  }

  function cerrarModal() {
    document.getElementById("modal-img").style.display = "none";
  }

  function cambiarImagen(dir) {
    currentImageIndex = (currentImageIndex + dir + currentImages.length) % currentImages.length;
    document.getElementById("img-grande").src = currentImages[currentImageIndex];
  }

  function initMap(lat, lng, direccion, nroAmb, tipo) {
    const map = L.map('map').setView([lat, lng], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markers = L.layerGroup().addTo(map);

    let iconHtml = tipo === "Temporario" ? 'Timer' : tipo === "Local" ? 'Shopping Cart' : `House ${nroAmb || ""}`;
    const rentalIcon = L.divIcon({ className: 'marker-icon', html: iconHtml, iconSize: [30,30] });
    L.marker([lat, lng], {icon: rentalIcon})
      .addTo(markers)
      .bindPopup(`<b>${tipo === "Temporario" ? "Alquiler Temporario" : tipo}</b><br>${direccion}`)
      .openPopup();

    // Puntos de interés (puedes quitarlos si no los necesitas)
    const poi = [
      [-28.5509978, -56.0409727, 'University', "Facultad Fundación Barceló"],
      [-28.5551127, -56.0389282, 'Hospital', "Hospital Universitario"],
      [-28.5519443, -56.0401962, 'Shopping Cart', "Supermercado La Bomba"],
      [-28.5472635, -56.0438082, 'Shopping Cart', "Supermercado El Super"],
      [-28.5462903, -56.0440365, 'Shopping Cart', "Supermercado La Economía"],
      [-28.5468697, -56.0432862, 'Bus', "Terminal de Ómnibus"],
      [-28.5487787, -56.0396171, 'Police', "Policía"]
    ];
    poi.forEach(p => {
      L.marker([p[0], p[1]], {icon: L.divIcon({className:'marker-icon', html:p[2], iconSize:[30,30]})})
        .addTo(markers)
        .bindPopup(`<b>${p[3]}</b>`);
    });
  }

  // =================== CARGA DEL ALQUILER ===================
  window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const alquilerId = urlParams.get("id");
    const loadingEl = document.getElementById("loading-msg");
    const detalle = document.getElementById("alquiler-detalle");

    if (!alquilerId) {
      detalle.innerHTML = "<h2>Error: No se proporcionó un ID de alquiler</h2>";
      loadingEl.style.display = "none";
      return;
    }

    loadingEl.style.display = "block";

    fetch(`${webAppURL}?action=getAlquiler&id=${encodeURIComponent(alquilerId)}`)
      .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      })
      .then(data => {
        loadingEl.style.display = "none";

        if (!data.success || !data.alquiler) {
          detalle.innerHTML = "<h2>Este alquiler no existe o fue dado de baja</h2>";
          return;
        }

        const a = data.alquiler;
        const tipo = getField(a, ["Tipo"]) || "Alquiler";
        const direccion = getField(a, ["Direccion", "Dirección", "Domicilio"]) || "Sin dirección";
        const precio = a.Precio ? formatPrice(a.Precio) : "Consultar";

        detalle.innerHTML = `<h2>${tipo === "Temporario" ? "Alquiler Temporario" : tipo === "Local" ? "Local Comercial" : "Alquiler"}: ${direccion}</h2>`;

        const filas = (tipo === "Temporario" || tipo === "Local")
          ? [
              ["Dirección", direccion],
              ["Información de ingreso", getField(a, ["Informacion ingreso","Información ingreso","InfoIngreso"]) || "No especificado"],
              ["Detalles", getField(a, ["Detalles","Detalle","Descripcion","Descripción"]) || "Sin detalles"]
            ]
          : [
              ["Dirección", direccion],
              ["Ambientes", getField(a, ["Nro Ambientes","Ambientes","Nro"]) || "?"],
              ["Precio", precio],
              ["Información de ingreso", getField(a, ["Informacion ingreso","Información ingreso","InfoIngreso"]) || "No especificado"],
              ["Detalles", getField(a, ["Detalles","Detalle","Descripcion","Descripción"]) || "Sin detalles"],
              ["Mascotas", getField(a, ["Mascotas"]) || "No especificado"]
            ];

        filas.forEach(([label, val]) => {
          const p = document.createElement("p");
          p.innerHTML = `<b>${label}:</b> ${val || "No disponible"}`;
          detalle.appendChild(p);
        });

        // ==== IMÁGENES ====
        const contImg = document.createElement("div");
        contImg.id = "imagenes-container";
        const fotosRaw = getField(a, ["Fotos","Imagenes","Imágenes","images","fotos","FOTOS"]);

        let urls = [];
        if (fotosRaw && typeof fotosRaw === "string" && fotosRaw.trim()) {
          urls = fotosRaw
            .split(",")
            .map(u => u.trim())
            .filter(u => u)
            .map(url => url.includes("drive.google.com") ? driveUrlDirect(url) : url)
            .filter(url => url.startsWith("http"));
        }

        if (urls.length === 0) {
          contImg.innerHTML = "<p>No hay imágenes disponibles.</p>";
        } else {
          urls.forEach((url, i) => {
            const img = document.createElement("img");
            img.src = url;
            img.alt = `Imagen ${i+1}`;
            img.loading = "lazy";
            img.onclick = () => abrirModal(url, urls, i);
            img.onerror = () => {
              img.src = "https://via.placeholder.com/120x90?text=Error";
              img.style.opacity = "0.5";
            };
            contImg.appendChild(img);
          });
        }
        detalle.appendChild(contImg);

        // ==== MAPA ====
        const lat = parseFloat(getField(a, ["Lat","Latitude","Latitud"]));
        const lng = parseFloat(getField(a, ["Lng","Longitude","Longitud"]));

        if (!isNaN(lat) && !isNaN(lng)) {
          const mapDiv = document.createElement("div");
          mapDiv.id = "map";
          detalle.appendChild(mapDiv);
          setTimeout(() => initMap(lat, lng, direccion, toInt(getField(a, ["Nro Ambientes","Ambientes"])), tipo), 150);
        } else {
          const p = document.createElement("p");
          p.innerHTML = "<b>Ubicación:</b> No disponible";
          detalle.appendChild(p);
        }

        // ==== BOTONES ====
        if (a.Contacto && a.Contacto.trim()) {
          const btnWA = document.createElement("button");
          btnWA.textContent = "Contactar por WhatsApp";
          btnWA.onclick = () => {
            const msg = `Hola, vengo desde AlquiYa y quiero consultar por el alquiler en ${direccion}`;
            const num = a.Contacto.replace(/[^\d]/g, '');
            window.open(`https://wa.me/${num}?text=${encodeURIComponent(msg)}`, "_blank");
          };
          detalle.appendChild(btnWA);
        }

        const btnBack = document.createElement("button");
        btnBack.textContent = "Volver al Mapa";
        btnBack.onclick = () => window.location.href = "index.html";
        detalle.appendChild(btnBack);

      })
      .catch(err => {
        loadingEl.style.display = "none";
        detalle.innerHTML = "<h2>Error al cargar los datos</h2><p>Revisa la consola para más detalles.</p>";
        console.error("Error:", err);
      });
  };
</script>

</body>
</html>
