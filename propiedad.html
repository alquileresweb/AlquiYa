<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlquiYa - Detalle de Propiedad</title>

<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SSJ5DG33JK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-SSJ5DG33JK');
</script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="icon" type="image/png" href="https://i.postimg.cc/MKpMcrcQ/AlquiYa.png">

<style>
  body { margin:0; font-family:Arial,sans-serif; background:#f4f4f4; }
  header { background:white; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  header img { max-width:250px; }
  #loading-msg { text-align:center; padding:30px; font-size:18px; color:#3483fa; font-weight:bold; }
  #alquiler-detalle {
    max-width:720px; margin:20px auto; padding:20px;
    background:white; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);
  }
  h2 { margin-top:0; color:#3483fa; }
  p { margin:12px 0; line-height:1.5; }
  b { color:#333; }
  #imagenes-container {
    display:flex; flex-wrap:wrap; gap:10px; margin:15px 0;
  }
  #imagenes-container img {
    width:120px; height:90px; object-fit:cover; border-radius:8px;
    cursor:pointer; border:2px solid #ddd; transition:0.3s;
  }
  #imagenes-container img:hover { border-color:#3483fa; transform:scale(1.05); }
  #map { height:400px; margin:20px 0; border-radius:12px; border:2px solid #3483fa; }
  button {
    background:#25D366; color:white; border:none; padding:12px 20px;
    margin:8px 8px 0 0; border-radius:8px; cursor:pointer; font-size:16px;
  }
  button:hover { background:#1ebe57; }
  button.map-btn { background:#3483fa; }
  button.map-btn:hover { background:#2d70d5; }

  /* Modal */
  #modal-img {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.95); z-index:9999; justify-content:center; align-items:center;
  }
  #img-grande { max-width:92%; max-height:92%; border-radius:12px; }
  .close-btn, .nav-btn {
    position:absolute; background:rgba(0,0,0,0.7); color:white;
    border:none; width:44px; height:44px; border-radius:50%; font-size:24px;
    cursor:pointer; display:flex; align-items:center; justify-content:center;
  }
  .close-btn { top:15px; right:15px; }
  .prev-btn { left:15px; }
  .next-btn { right:15px; }
</style>
</head>
<body>

<header>
  <img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="AlquiYa">
</header>

<div id="loading-msg">Cargando propiedad...</div>
<div id="alquiler-detalle" style="display:none;"></div>

<div id="modal-img">
  <img id="img-grande" src="" alt="Imagen grande">
  <button class="close-btn" onclick="cerrarModal()">X</button>
  <button class="nav-btn prev-btn" onclick="cambiarImagen(-1)">‹</button>
  <button class="nav-btn next-btn" onclick="cambiarImagen(1)">›</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwDl73ZMnMowfSu_NoISSSc4fnQpLp6kaxT9Dz5jMjE9NxT64AmeN23ORQy8lejul6S/exec";

let imagenes = [];
let indiceActual = 0;

function getParam(name) {
  return new URLSearchParams(window.location.search).get(name) || "";
}

function safeGet(obj, keys, def = "") {
  for (const k of keys) {
    if (obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
  }
  return def;
}

function toNumber(val, def = 0) {
  const n = parseFloat(val);
  return isNaN(n) ? def : n;
}

function formatPrice(p) {
  if (!p) return "Consultar";
  return "$" + Number(p).toLocaleString("es-AR");
}

function googleDriveToDirect(url) {
  if (!url) return "";
  const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
  return match ? `https://drive.google.com/uc?export=view&id=${match[1]}` : url;
}

function abrirModal(src, arr, i) {
  imagenes = arr;
  indiceActual = i;
  document.getElementById("img-grande").src = src;
  document.getElementById("modal-img").style.display = "flex";
}
function cerrarModal() {
  document.getElementById("modal-img").style.display = "none";
}
function cambiarImagen(dir) {
  indiceActual = (indiceActual + dir + imagenes.length) % imagenes.length;
  document.getElementById("img-grande").src = imagenes[indiceActual];
}

function initMap(lat, lng, direccion, ambientes, tipo) {
  const mapDiv = document.getElementById("map");
  const map = L.map(mapDiv).setView([lat, lng], 16);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const iconText = tipo === "Temporario" ? "Temporario" : tipo === "Local" ? "Local" : `${ambientes || "?"} amb`;
  const icon = L.divIcon({
    className: "marker-icon",
    html: `<div style="background:#3483fa;color:white;padding:6px 10px;border-radius:50px;font-weight:bold;white-space:nowrap;">${iconText}</div>`,
    iconSize: [100, 40],
    iconAnchor: [50, 40]
  });

  L.marker([lat, lng], { icon }).addTo(map)
    .bindPopup(`<b>${direccion}</b>`)
    .openPopup();
}

// =========================== CARGA DE PROPIEDAD ===========================
window.onload = () => {
  const id = getParam("id");
  const loading = document.getElementById("loading-msg");
  const contenedor = document.getElementById("alquiler-detalle");

  if (!id) {
    loading.style.display = "none";
    contenedor.innerHTML = "<h2>Error: No se indicó ID de propiedad</h2>";
    contenedor.style.display = "block";
    return;
  }

  fetch(`${WEB_APP_URL}?action=getAlquiler&id=${id}`)
    .then(r => r.json())
    .then(res => {
      loading.style.display = "none";

      if (!res.success || !res.alquiler) {
        contenedor.innerHTML = "<h2>Propiedad no disponible</h2><p>Es posible que haya sido dada de baja o el dueño no tenga plan vigente.</p>";
        contenedor.style.display = "block";
        console.warn("Propiedad no encontrada o no activa:", res);
        return;
      }

      const a = res.alquiler;

      const tipo = safeGet(a, ["Tipo", "tipo"]);
      const direccion = safeGet(a, ["Direccion", "Dirección", "direccion"]) || "Sin dirección";
      const precio = formatPrice(safeGet(a, ["Precio", "precio"]));
      const ambientes = safeGet(a, ["Nro Ambientes", "Ambientes", "nro ambientes", "Nro"]) || "?";
      const mascotas = safeGet(a, ["Mascotas", "mascotas"]) || "No especificado";
      const amoblado = safeGet(a, ["Amoblado", "amoblado"]) || "No especificado";
      const infoIngreso = safeGet(a, ["Informacion ingreso", "Información ingreso", "info ingreso", "InformacionIngreso"]) || "No especificado";
      const detalles = safeGet(a, ["Detalles", "detalles", "Descripcion", "descripción"]) || "Sin detalles adicionales";
      const contacto = safeGet(a, ["Contacto", "contacto", "Teléfono", "telefono"]) || "";
      const fotosRaw = safeGet(a, ["Fotos", "fotos", "Imagenes", "imágenes", "images"]);
      const lat = toNumber(safeGet(a, ["Lat", "lat", "Latitud"]));
      const lng = toNumber(safeGet(a, ["Lng", "lng", "Longitud"]));

      // Título
      contenedor.innerHTML = `<h2>${tipo === "Temporario" ? "Temporario" : tipo === "Local" ? "Local Comercial" : "Departamento"} en ${direccion}</h2>`;

      // Tabla de datos
      const datos = [
        ["Dirección", direccion],
        tipo !== "Temporario" && tipo !== "Local" ? ["Ambientes", ambientes] : null,
        tipo !== "Temporario" && tipo !== "Local" ? ["Precio", precio] : null,
        ["Mascotas", mascotas],
        ["Amoblado", amoblado],
        ["Información de ingreso", infoIngreso],
        ["Detalles adicionales", detalles]
      ].filter(Boolean);

      datos.forEach(([label, valor]) => {
        if (valor && valor !== "No especificado") {
          contenedor.innerHTML += `<p><b>${label}:</b> ${valor}</p>`;
        }
      });

      // Fotos
      if (fotosRaw && fotosRaw.trim()) {
        const urls = fotosRaw.split(",")
          .map(u => u.trim())
          .filter(u => u)
          .map(u => googleDriveToDirect(u));

        if (urls.length > 0) {
          const galeria = document.createElement("div");
          galeria.id = "imagenes-container";
          urls.forEach((url, i) => {
            const img = document.createElement("img");
            img.src = url;
            img.alt = `Foto ${i+1}`;
            img.onclick = () => abrirModal(url, urls, i);
            galeria.appendChild(img);
          });
          contenedor.appendChild(galeria);
        } else {
          contenedor.innerHTML += "<p>No se pudieron cargar las imágenes.</p>";
        }
      } else {
        contenedor.innerHTML += "<p>Sin fotos disponibles.</p>";
      }

      // Mapa
      if (lat && lng && lat !== 0 && lng !== 0) {
        const mapDiv = document.createElement("div");
        mapDiv.id = "map";
        contenedor.appendChild(mapDiv);
        setTimeout(() => initMap(lat, lng, direccion, ambientes, tipo), 100);
      } else {
        contenedor.innerHTML += "<p><b>Ubicación:</b> No disponible</p>";
      }

      // Botones
      if (contacto) {
        const btnWA = document.createElement("button");
        btnWA.textContent = "Contactar por WhatsApp";
        btnWA.onclick = () => {
          const msg = encodeURIComponent(`Hola! Vi tu propiedad en AlquiYa: ${direccion}`);
          window.open(`https://wa.me/${contacto.replace(/[^\d+]/g,"")}?text=${msg}`, "_blank");
        };
        contenedor.appendChild(btnWA);
      }

      const btnMapa = document.createElement("button");
      btnMapa.textContent = "Volver al mapa";
      btnMapa.className = "map-btn";
      btnMapa.onclick = () => location.href = "index.html";
      contenedor.appendChild(btnMapa);

      contenedor.style.display = "block";
    })
    .catch(err => {
      loading.style.display = "none";
      contenedor.innerHTML = "<h2>Error de conexión</h2><p>No se pudo cargar la propiedad.</p>";
      contenedor.style.display = "block";
      console.error(err);
    });
};
</script>
</body>
</html>
