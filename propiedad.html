<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alquiler en AlquiYa</title>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SSJ5DG33JK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-SSJ5DG33JK');
  </script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="icon" type="image/png" href="https://i.postimg.cc/MKpMcrcQ/AlquiYa.png">
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#f4f4f4; }
    header { background:white; padding:15px; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    header img { max-width:250px; }
    #alquiler-detalle {
      max-width:700px; margin:20px auto; padding:20px; background:white;
      border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.1); border:2px solid #3483fa;
    }
    #alquiler-detalle h2 { color:#3483fa; margin-top:0; }
    #alquiler-detalle p { margin:12px 0; line-height:1.5; }
    #alquiler-detalle b { color:#333; }
    #imagenes-container {
      display:flex; flex-wrap:wrap; gap:10px; margin:15px 0; justify-content:center;
    }
    #imagenes-container img {
      width:120px; height:90px; object-fit:cover; border-radius:8px;
      cursor:pointer; border:2px solid #ddd; transition:0.3s;
    }
    #imagenes-container img:hover { transform:scale(1.05); border-color:#3483fa; }
    #map { height:400px; margin:20px 0; border-radius:12px; border:2px solid #3483fa; }
    button {
      background:#25D366; color:white; border:none; padding:12px 20px;
      border-radius:8px; font-size:16px; cursor:pointer; margin:8px 8px 0 0;
      transition:0.3s;
    }
    button:hover { background:#1ebe57; transform:translateY(-2px); }
    #loading-msg { text-align:center; padding:30px; font-size:18px; color:#3483fa; font-weight:bold; }
    #error-msg { color:#d32f2f; background:#ffebee; padding:20px; border-radius:8px; text-align:center; margin:20px; }
    #debug-panel {
      position:fixed; bottom:10px; right:10px; background:#1e1e1e; color:#0f0; padding:12px;
      border-radius:8px; font-family:monospace; font-size:12px; max-width:380px; z-index:99999;
      box-shadow:0 4px 20px rgba(0,0,0,0.5); border:1px solid #0f0; opacity:0.9;
    }
    #debug-panel button {
      background:#0f0; color:black; font-weight:bold; margin-top:8px;
    }
    #modal-img {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center;
    }
    #modal-img img { max-width:92%; max-height:92%; border-radius:12px; }
    .close-btn, .nav-btn {
      position:absolute; background:rgba(0,0,0,0.7); color:white; border:none;
      width:44px; height:44px; border-radius:50%; font-size:24px; cursor:pointer;
    }
    .close-btn { top:15px; right:15px; }
    .prev-btn { left:15px; top:50%; transform:translateY(-50%); }
    .next-btn { right:15px; top:50%; transform:translateY(-50%); }
    .marker-icon {
      background:#3483fa; color:white; font-weight:bold; border-radius:50%;
      width:34px; height:34px; display:flex; align-items:center; justify-content:center;
      border:3px solid white; box-shadow:0 2px 8px rgba(0,0,0,0.3); font-size:14px;
    }
  </style>
</head>
<body>

<header>
  <img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="AlquiYa">
</header>

<div id="loading-msg">Cargando propiedad...</div>
<div id="alquiler-detalle" style="display:none;"></div>

<!-- Panel de depuración (solo visible al inspeccionar o si hay error) -->
<div id="debug-panel" style="display:none;">
  <strong>Inspector AlquiYa</strong><br>
  <span id="debug-id">ID: detectando...</span><br>
  <span id="debug-status">Estado: inicializando...</span><br>
  <span id="debug-error" style="color:#f66;"></span><br>
  <button onclick="location.reload()">Recargar página</button>
  <button onclick="document.getElementById('debug-panel').style.display='none'">Ocultar</button>
</div>

<div id="modal-img">
  <img id="img-grande" src="" alt="Imagen ampliada">
  <button class="close-btn" onclick="cerrarModal()">X</button>
  <button class="nav-btn prev-btn" onclick="cambiarImagen(-1)">Left</button>
  <button class="nav-btn next-btn" onclick="cambiarImagen(1)">Right</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwDl73ZMnMowfSu_NoISSSc4fnQpLp6kaxT9Dz5jMjE9NxT64AmeN23ORQy8lejul6S/exec";
  let propiedadId = "";
  const debug = {
    id: document.getElementById("debug-id"),
    status: document.getElementById("debug-status"),
    error: document.getElementById("debug-error"),
    panel: document.getElementById("debug-panel")
  };

  // Mostrar panel de depuración
  debug.panel.style.display = "block";
  debug.status.textContent = "Estado: extrayendo ID...";

  // Extraer ID de cualquier enlace compartido
  function extraerId() {
    const url = new URL(window.location.href);
    const idParam = url.searchParams.get("id");
    if (idParam) return idParam.trim();

    const match = window.location.href.match(/id[=\/]([a-zA-Z0-9_-]{20,})/i);
    return match ? match[1] : null;
  }

  propiedadId = extraerId();
  debug.id.textContent = `ID: ${propiedadId || "NO DETECTADO"}`;

  if (!propiedadId) {
    debug.status.textContent = "ERROR: No se encontró ID";
    debug.error.textContent = "No hay 'id=' en la URL";
    document.getElementById("loading-msg").innerHTML = `<div id="error-msg"><h2>Error</h2><p>No se pudo detectar el ID de la propiedad</p></div>`;
    return;
  }

  // Contar vista
  fetch(`${WEB_APP_URL}?action=incrementarmetrica&metrica=vistas&idPropiedad=${propiedadId}`)
    .then(() => debug.status.textContent = "Vista contada")
    .catch(() => debug.status.textContent = "Vista (posible duplicada)");

  function contarConsulta() {
    fetch(`${WEB_APP_URL}?action=incrementarmetrica&metrica=contactos&idPropiedad=${propiedadId}`)
      .then(() => console.log("Consulta contada"))
      .catch(() => {});
  }

  function abrirModal(src, images, index) {
    currentImages = images;
    currentImageIndex = index;
    document.getElementById("img-grande").src = src;
    document.getElementById("modal-img").style.display = "flex";
  }

  function cerrarModal() {
    document.getElementById("modal-img").style.display = "none";
  }

  function cambiarImagen(dir) {
    currentImageIndex = (currentImageIndex + dir + currentImages.length) % currentImages.length;
    document.getElementById("img-grande").src = currentImages[currentImageIndex];
  }

  function initMap(lat, lng, direccion, ambientes, tipo) {
    const map = L.map("map").setView([lat, lng], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const iconText = tipo === "Temporario" ? "Temporario" : tipo === "Local" ? "Local" : ambientes ? `${ambientes} amb` : "Casa";
    const icon = L.divIcon({ className: "marker-icon", html: iconText, iconSize: [40, 40] });
    L.marker([lat, lng], { icon }).addTo(map).bindPopup(`<b>${direccion}</b>`).openPopup();
  }

  // Carga principal
  window.onload = async () => {
    debug.status.textContent = "Consultando backend...";

    try {
      const res = await fetch(`${WEB_APP_URL}?action=getAlquiler&id=${propiedadId}`);
      const data = await res.json();

      console.log("Respuesta completa del backend:", data); // Para ver en Consola

      if (!data.success || !data.alquiler) {
        debug.status.textContent = "ERROR: Propiedad no disponible";
        debug.error.textContent = data.error || "Sin datos";
        document.getElementById("alquiler-detalle").innerHTML = `
          <div id="error-msg">
            <h2>Propiedad no disponible</h2>
            <p>${data.error || "El anuncio fue dado de baja o el plan está vencido."}</p>
            <button onclick="location.href='index.html'" style="background:#3483fa;">Volver al mapa</button>
          </div>`;
        document.getElementById("alquiler-detalle").style.display = "block";
        document.getElementById("loading-msg").style.display = "none";
        return;
      }

      debug.status.textContent = "Propiedad cargada correctamente";

      const a = data.alquiler;
      const tipo = a.Tipo || "Alquiler";
      const direccion = a.Direccion || "Sin dirección";
      const precio = a.Precio ? "$" + Number(a.Precio).toLocaleString("es-AR") : "Consultar";
      const ambientes = a["Nro Ambientes"] || "";
      const mascotas = a.Mascotas || "";
      const detalles = a.Detalles || "";
      const infoIngreso = a["Informacion ingreso"] || "";
      const contacto = (a.Contacto || "").replace(/[^\d+]/g, "");

      let html = `
        <h2>${tipo === "Temporario" ? "Temporario" : tipo === "Local" ? "Local Comercial" : "Alquiler"} en ${direccion}</h2>
        ${tipo !== "Temporario" && tipo !== "Local" ? `<p><b>Ambientes:</b> ${ambientes || "No especificado"}</p>` : ""}
        <p><b>Precio:</b> ${precio}</p>
        ${mascotas ? `<p><b>Mascotas:</b> ${mascotas}</p>` : ""}
        ${infoIngreso ? `<p><b>Información de ingreso:</b> ${infoIngreso}</p>` : ""}
        ${detalles ? `<p><b>Detalles:</b> ${detalles}</p>` : ""}
      `;

      // Fotos
      const fotosRaw = (a.Fotos || "").split(",").map(u => u.trim()).filter(Boolean);
      const fotosUrls = fotosRaw.map(url => {
        if (url.includes("drive.google.com")) {
          const match = url.match(/id=([a-zA-Z0-9_-]+)/) || url.match(/\/d\/([a-zA-Z0-9_-]+)/);
          return match ? `https://drive.google.com/uc?export=view&id=${match[1]}` : url;
        }
        return url;
      });

      if (fotosUrls.length > 0) {
        html += `<div id="imagenes-container">`;
        fotosUrls.forEach((url, i) => {
          html += `<img src="${url}" alt="Foto ${i+1}" onclick="abrirModal('${url}', ${JSON.stringify(fotosUrls)}, ${i})">`;
        });
        html += `</div>`;
      } else {
        html += `<p><i>Sin fotos disponibles</i></p>`;
      }

      // Mapa
      const lat = parseFloat(a.Lat);
      const lng = parseFloat(a.Lng);
      if (lat && lng && lat !== 0) {
        html += `<div id="map"></div>`;
      }

      // Botones
      html += `<div style="margin-top:20px;">`;
      if (contacto) {
        html += `
          <button onclick="contarConsulta(); window.open('https://wa.me/${contacto}?text=${encodeURIComponent("Hola! Vi tu propiedad en AlquiYa: " + direccion)}', '_blank')">
            Contactar por WhatsApp
          </button>`;
      }
      html += `
        <button onclick="location.href='index.html'" style="background:#3483fa;">
          Volver al Mapa
        </button>
      </div>`;

      document.getElementById("alquiler-detalle").innerHTML = html;
      document.getElementById("alquiler-detalle").style.display = "block";
      document.getElementById("loading-msg").style.display = "none";

      if (lat && lng && lat !== 0) {
        setTimeout(() => initMap(lat, lng, direccion, ambientes, tipo), 500);
      }

    } catch (err) {
      console.error("Error fatal:", err);
      debug.status.textContent = "ERROR CRÍTICO";
      debug.error.textContent = err.message;
      document.getElementById("loading-msg").innerHTML = `<div id="error-msg"><h2>Error de conexión</h2><p>Revisa tu internet o intenta más tarde</p></div>`;
    }
  };
</script>
</body>
</html>
