<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Alquileres Santo Tomé</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    header { background:#3483fa; color:white; padding:15px; text-align:center; }
    nav { display:flex; justify-content:center; gap:20px; background:#f4f4f4; padding:10px; }
    nav a { text-decoration:none; font-weight:bold; color:#333; }
    nav a:hover { color:#3483fa; }
    #map { height:60vh; width:100%; margin-bottom:20px; display:none; }
    #login, #panel-dueno { display:none; max-width:500px; margin:auto; }
    input, select, button { width:100%; padding:8px; margin:5px 0; border-radius:6px; }
    button { background:#3483fa; color:white; border:none; cursor:pointer; }
    button:hover { background:#2565c0; }
  </style>
</head>
<body>

<header>
  <h1>Alquileres en Santo Tomé</h1>
  <p>Encuentra tu próximo departamento de forma rápida y segura</p>
</header>

<nav>
  <a href="#" onclick="mostrarMapa()">Mapa</a>
  <a href="#" onclick="mostrarLogin()">Soy Dueño</a>
</nav>

<!-- MAPA -->
<div id="map"></div>

<!-- LOGIN DUEÑO -->
<div id="login">
  <h2>Login Dueños</h2>
  <input type="text" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Contraseña">
  <button onclick="login()">Ingresar</button>
  <p id="login-msg" style="color:red"></p>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
  const sheetAlquileres = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR5ywR4kynlqCe7boNscWy3jq2o40iTpyx1qC1enzUVGuJyfi-GZMRrxqDMUeR3HC4w-EB2l90X5Zyp/pub?gid=0&single=true&output=csv";
  const sheetDueños = "URL_PUBLICA_CSV_DE_DUEÑOS"; // reemplazar por tu sheet de dueños

  // Inicializar mapa
  let map = L.map('map').setView([-28.5503, -56.0406], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);

  // Mostrar mapa
  function mostrarMapa() {
    document.getElementById("map").style.display="block";
    document.getElementById("login").style.display="none";
    document.getElementById("panel-dueno").style.display="none";
    setTimeout(()=>{map.invalidateSize();},200); // Corregir visualización
    cargarAlquileres();
  }

  // Mostrar login
  function mostrarLogin() {
    document.getElementById("map").style.display="none";
    document.getElementById("login").style.display="block";
    document.getElementById("panel-dueno").style.display="none";
  }

  // LOGIN DUEÑO
  async function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    const msg = document.getElementById("login-msg");

    try {
      const resp = await fetch(sheetDueños);
      const csvText = await resp.text();
      const results = Papa.parse(csvText, {header:true});
      const data = results.data;

      const dueño = data.find(d => d.email.trim()===email && d.password.trim()===password);
      if(dueño){
        localStorage.setItem("dueno", dueño.nombre);
        localStorage.setItem("dueno_email", email);
        window.location.href="dueños.html"; // Redirigir al panel de dueños
      } else msg.textContent="Email o contraseña incorrecta";
    } catch(e){
      console.error("Error al leer la hoja de dueños:",e);
      msg.textContent="Error al verificar los datos. Intenta nuevamente.";
    }
  }

  // Cargar alquileres en el mapa
  function cargarAlquileres(){
    Papa.parse(sheetAlquileres, {
      download:true, header:true,
      complete: function(results){
        results.data.forEach(a=>{
          if(a.estado && a.estado.toLowerCase()==="activo"){
            const lat=parseFloat(a.latitud);
            const lng=parseFloat(a.longitud);
            if(isNaN(lat)||isNaN(lng)) return;
            const color=a.ambientes.includes("Mono")?"blue":a.ambientes.includes("2")?"red":"yellow";
            const marker=L.circleMarker([lat,lng],{radius:8,color:color,fillOpacity:0.9}).addTo(map);
            marker.bindPopup(`
              <b>${a.direccion}</b><br>
              Ambientes: ${a.ambientes}<br>
              Precio: ${a.precio}<br>
              Contacto: <a href="https://wa.me/${a.contacto}" target="_blank">${a.contacto}</a><br>
              ${a.fotos?`<img src="${a.fotos}" width="150">`:""}
            `);
          }
        });
      }
    });
  }
</script>
</body>
</html>
