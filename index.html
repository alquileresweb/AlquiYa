// --- Datos de Cloudinary ---
const CLOUDINARY_CLOUD_NAME = "dnugmwern";
const CLOUDINARY_API_KEY = "877726879255954";
const CLOUDINARY_API_SECRET = "t8CStqLDqd1hs3P9Hkr4lqicIQU";
const CLOUDINARY_UPLOAD_PRESET = "preset_alquileres"; // Crea uno en tu panel de Cloudinary

// --- Planes ---
const PLANES = {
  Basico: { limiteDeptos: 3, limiteFotos: 3, destacar: 0 },
  Plus: { limiteDeptos: 5, limiteFotos: 5, destacar: 1 },
  Full: { limiteDeptos: 10, limiteFotos: 99, destacar: 99 }
};

// --- Manejo principal de solicitudes ---
function doGet(e) {
  var action = e.parameter.action;
  var callback = e.parameter.callback || null;
  var res = {};

  try {
    if (action == "getAlquileres") {
      res = { success: true, data: getAlquileresActivos() };
    } else if (action == "addAlquiler") {
      res = addAlquiler(e);
    } else if (action == "editAlquiler") {
      res = editAlquiler(e);
    } else if (action == "toggleEstado") {
      res = toggleEstado(e);
    } else if (action == "deleteAlquiler") {
      res = deleteAlquiler(e);
    } else if (action == "registerDueno") {
      res = registerDueno(e);
    } else if (action == "getAlquileresDueno") {
      res = { success: true, data: getAlquileres(e) };
    } else if (action == "mejorarPlan") {
      res = mejorarPlan(e);
    } else if (action == "getLoginInfo") {
      res = getLoginInfo(e);
    } else if (action == "verificarLogin") {
      res = verificarLogin(e);
    } else {
      res = { success: false, error: "Acción no reconocida" };
    }
  } catch (err) {
    res = { success: false, error: err.message };
  }

  var json = JSON.stringify(res);
  if (callback) {
    return ContentService.createTextOutput(callback + "(" + json + ");")
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  } else {
    return ContentService.createTextOutput(json)
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// --- Manejar POST ---
function doPost(e) {
  try {
    if (e.postData && e.postData.contents) {
      const params = JSON.parse(e.postData.contents);

      // === Subir imágenes Base64 a Cloudinary ===
      if (params.action === "uploadImagesCloudinary" && params.images) {
        const links = [];
        params.images.forEach((b64, i) => {
          try {
            const url = subirImagenCloudinary(b64);
            if(url) links.push(url);
          } catch(err){
            Logger.log("❌ Error subiendo a Cloudinary: " + err.message);
          }
        });
        if(params.row && links.length > 0){
          const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
          sheet.getRange(parseInt(params.row), 9).setValue(links.join(","));
        }
        return ContentService.createTextOutput(JSON.stringify({ success: true, links }))
          .setMimeType(ContentService.MimeType.JSON);
      }

      // --- comportamiento original para POST con JSON ---
      return doGet({ parameter: params });
    }

    return ContentService.createTextOutput(JSON.stringify({ success: false, error: "POST vacío" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log("❌ Error en doPost: " + err.message);
    return ContentService.createTextOutput(
      JSON.stringify({ success: false, error: err.message })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}

// --- Subir imagen Base64 a Cloudinary ---
function subirImagenCloudinary(base64Data){
  const endpoint = "https://api.cloudinary.com/v1_1/" + CLOUDINARY_CLOUD_NAME + "/image/upload";
  const payload = { file: base64Data, upload_preset: CLOUDINARY_UPLOAD_PRESET };
  const options = { method: "post", contentType: "application/json", payload: JSON.stringify(payload) };
  const response = UrlFetchApp.fetch(endpoint, options);
  const data = JSON.parse(response.getContentText());
  return data.secure_url; // devuelve la URL pública
}

// --- Convierte texto "d/m/yyyy" o "dd/mm/yyyy" a Date ---
function parseFecha(fechaStr){
  if(!fechaStr) return null;
  if(fechaStr instanceof Date) return fechaStr;
  const partes = fechaStr.split("/");
  if(partes.length===3) return new Date(partes[2], partes[1]-1, partes[0]);
  return null;
}

// --- Obtener todos los alquileres activos (solo dueños con pago al día) ---
function getAlquileresActivos() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var alquileres = [];

  for (var i = 1; i < data.length; i++) {
    var tipo = data[i][0];
    var estado = data[i][9];
    var lat = data[i][3];
    var lng = data[i][4];
    var email = data[i][1];
    var dueño = loginData.find(row => row[1] === email);
    var fechaVenc = dueño ? parseFecha(dueño[7]) : null;
    var pagoAlDia = dueño && dueño[6]==="Pago al día" && fechaVenc && fechaVenc >= new Date();

    if (tipo === "alquiler" && estado === "Activo" && lat && lng && pagoAlDia) {
      var obj = {};
      for (var j = 0; j < headers.length; j++) obj[headers[j]] = data[i][j];
      obj["Contacto"] = data[i][7] || "";
      obj["Estado del Pago"] = dueño ? dueño[6] : "";
      obj["Fecha Vencimiento"] = dueño ? Utilities.formatDate(fechaVenc, Session.getScriptTimeZone(), "yyyy-MM-dd") : "";
      obj.row = i + 1;
      alquileres.push(obj);
    }
  }
  return alquileres;
}

// --- Obtener alquileres de un dueño específico ---
function getAlquileres(e) {
  var email = e.parameter.dueno;
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var alquileres = [];

  for (var i = 1; i < data.length; i++) {
    var tipo = data[i][0];
    var correo = data[i][1];
    if (tipo === "alquiler" && correo === email) {
      var obj = {};
      for (var j = 0; j < headers.length; j++) obj[headers[j]] = data[i][j];
      obj["Contacto"] = data[i][7] || "";
      obj.row = i + 1;
      alquileres.push(obj);
    }
  }
  return alquileres;
}

// --- Validar límite de deptos (solo activos) ---
function validarLimiteDeptos(email) {
  const loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  const loginData = loginSheet.getDataRange().getValues();
  const dueño = loginData.find(row => row[1] === email);
  if (!dueño) throw "Dueño no encontrado";

  const plan = dueño[5] || "Basico"; // columna F = Plan
  const limite = PLANES[plan].limiteDeptos;

  const alquileresSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  const cantidadDeptos = alquileresSheet.getDataRange().getValues()
    .filter(r => r[0]==="alquiler" && r[1]===email && r[9]==="Activo").length;

  if (cantidadDeptos >= limite) throw `Tu plan actual (${plan}) solo permite ${limite} deptos. Mejora tu plan para agregar más.`;
}

// --- Validar vencimiento ---
function validarVencimiento(email) {
  const loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  const loginData = loginSheet.getDataRange().getValues();
  const dueño = loginData.find(row => row[1] === email);
  if (!dueño) throw "Dueño no encontrado";

  const fechaVencimiento = parseFecha(dueño[7]); // columna H
  if (!fechaVencimiento) return true;
  if (new Date() > fechaVencimiento) throw "Tu plan está vencido. Debes renovar para poder agregar o mostrar tus deptos en el mapa.";
  return true;
}

// --- Agregar nuevo alquiler (validando plan y vencimiento) ---
function addAlquiler(e) {
  var email = e.parameter.dueno;
  validarLimiteDeptos(email);
  validarVencimiento(email);

  var direccion = e.parameter.direccion;
  var ambientes = e.parameter.ambientes;
  var precio = e.parameter.precio;
  var mascotas = e.parameter.mascotas || "";
  var fotos = e.parameter.fotos || "";
  var infoIngreso = e.parameter.infoIngreso || "";
  var detalles = e.parameter.detalles || "";

  // --- Obtener contacto real desde Login ---
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var contacto = "auto";
  for (var i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === email) {
      contacto = loginData[i][4] || "auto"; // columna E
      break;
    }
  }

  var alquileresSheet = ss.getSheetByName("Alquileres");
  alquileresSheet.appendRow([
    "alquiler", email, direccion, "", "", ambientes, precio, contacto, fotos, "Activo", infoIngreso, detalles, mascotas
  ]);
  return { success: true };
}

// --- Editar alquiler existente ---
function editAlquiler(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) return { success: false, error: "Fila inválida" };

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");

  if (e.parameter.direccion) sheet.getRange(row, 3).setValue(e.parameter.direccion);
  if (e.parameter.ambientes) sheet.getRange(row, 6).setValue(e.parameter.ambientes);
  if (e.parameter.precio) sheet.getRange(row, 7).setValue(e.parameter.precio);
  if (e.parameter.mascotas) sheet.getRange(row, 13).setValue(e.parameter.mascotas);
  if (e.parameter.infoIngreso) sheet.getRange(row, 11).setValue(e.parameter.infoIngreso);
  if (e.parameter.detalles) sheet.getRange(row, 12).setValue(e.parameter.detalles);
  if (e.parameter.fotos) sheet.getRange(row, 9).setValue(e.parameter.fotos);

  return { success: true };
}

// --- Cambiar estado Activo/Inactivo ---
function toggleEstado(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) return { success: false, error: "Fila inválida" };

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var estado = sheet.getRange(row, 10).getValue();
  var nuevoEstado = estado === "Activo" ? "Inactivo" : "Activo";
  sheet.getRange(row, 10).setValue(nuevoEstado);

  return { success: true, nuevoEstado: nuevoEstado };
}

// --- Eliminar alquiler ---
function deleteAlquiler(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) return { success: false, error: "Fila inválida" };

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  sheet.deleteRow(row);
  return { success: true };
}

// --- Registrar dueño (agrega fecha de vencimiento y plan por defecto) ---
function registerDueno(e) {
  var email = e.parameter.email;
  var password = e.parameter.password;
  var nombre = e.parameter.nombre;
  var contacto = e.parameter.contacto;

  if (!email || !password || !nombre || !contacto) 
    return { success: false, error: "Faltan datos" };

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();

  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) 
      return { success: false, error: "El email ya está registrado" };
  }

  // Fecha vencimiento por defecto = hoy + 30 días
  var fechaVencimiento = new Date();
  fechaVencimiento.setDate(fechaVencimiento.getDate() + 30);

  loginSheet.appendRow([
    "Dueño",          // Col A - Tipo
    email,            // Col B - Email
    password,         // Col C - Password
    nombre,           // Col D - Nombre
    contacto,         // Col E - Contacto
    "Basico",         // Col F - Plan
    "Pago al día",    // Col G - Estado del Pago
    fechaVencimiento  // Col H - Fecha Vencimiento
  ]);

  return { success: true, message: "Dueño registrado correctamente" };
}

// --- Verificar login ---
function verificarLogin(e) {
  var email = e.parameter.email;
  var password = e.parameter.password;

  if (!email || !password)
    return { success: false, error: "Faltan credenciales" };

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();

  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email && data[i][2] === password) {
      return {
        success: true,
        tipo: data[i][0],       // A
        email: data[i][1],      // B
        nombre: data[i][3],     // D
        contacto: data[i][4],   // E
        plan: data[i][5],       // F
        estadoPago: data[i][6], // G
        vencimiento: data[i][7] 
          ? Utilities.formatDate(new Date(data[i][7]), Session.getScriptTimeZone(), "yyyy-MM-dd") 
          : ""
      };
    }
  }

  return { success: false, error: "Email o contraseña incorrectos" };
}

// --- Mejorar plan ---
function mejorarPlan(e) {
  var email = e.parameter.email;
  var nuevoPlan = e.parameter.plan;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();

  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) {
      var fechaNueva = new Date();
      fechaNueva.setDate(fechaNueva.getDate() + 30);
      loginSheet.getRange(i+1, 6).setValue(nuevoPlan); // columna F
      loginSheet.getRange(i+1, 7).setValue("Pago al día"); // columna G
      loginSheet.getRange(i+1, 8).setValue(fechaNueva); // columna H
      return { success: true, message: "Plan actualizado correctamente" };
    }
  }
  return { success: false, error: "Dueño no encontrado" };
}

// --- NUEVA FUNCIÓN PARA FRONTEND DUEÑOS ---
function getLoginInfo(e) {
  var email = e.parameter.email;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var alquileresSheet = ss.getSheetByName("Alquileres");
  var alquileresData = alquileresSheet.getDataRange().getValues();
  var result = [];

  for (var i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === email) {
      var plan = loginData[i][5] || "Basico"; 
      var estadoPago = loginData[i][6] || "Pago al día"; 
      var vencimiento = loginData[i][7] ? Utilities.formatDate(parseFecha(loginData[i][7]), Session.getScriptTimeZone(), "yyyy-MM-dd") : "";
      var deptosActivos = 0;
      for (var j = 1; j < alquileresData.length; j++) {
        if (alquileresData[j][0] === "alquiler" && alquileresData[j][1] === email && alquileresData[j][9] === "Activo") {
          deptosActivos++;
        }
      }
      return { success:true, plan:plan, estadoPago:estadoPago, vencimiento:vencimiento, deptosActivos: deptosActivos };
    }
  }
  return { success:false, error:"Dueño no encontrado" };
}
