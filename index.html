<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SSJ5DG33JK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-SSJ5DG33JK');
</script>
<link rel="icon" type="image/png" href="https://i.postimg.cc/MKpMcrcQ/AlquiYa.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  :root {
    --primary: #3483fa;
    --primary-dark: #2565c0;
    --success: #25D366;
    --bg: #fafafa;
    --card: white;
    --text: #333;
    --border: #e0e0e0;
    --shadow: 0 4px 20px rgba(0,0,0,0.08);
    --radius: 14px;
    --transition: all 0.3s ease;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
  }
  header {
    background: white;
    padding: 1rem;
    text-align: center;
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  header img { max-width: 250px; height: auto; }

  nav {
    display: flex;
    justify-content: center;
    gap: 2rem;
    background: white;
    padding: 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    flex-wrap: wrap;
  }
  nav a {
    text-decoration: none;
    font-weight: 600;
    color: var(--text);
    padding: 0.7rem 1.2rem;
    border-radius: 10px;
    transition: var(--transition);
  }
  nav a:hover { background: var(--primary); color: white; }

  /* Botones principales más compactos y uno al lado del otro */
  #boton-filtros-container {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin: 1.5rem auto;
    max-width: 600px;
  }
  #boton-filtros-container button {
    padding: 0.85rem 1.8rem;   /* más corto */
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    box-shadow: var(--shadow);
    transition: var(--transition);
    white-space: nowrap;
  }
  #boton-filtros-container button:hover {
    background: var(--primary-dark);
    transform: translateY(-3px);
  }

  #filtros {
    max-width: 800px;
    margin: 0 auto 2rem;
    padding: 1.8rem;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    display: none;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: end;
  }
  #filtros input,
  #filtros select {
    padding: 0.9rem 1rem;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    flex: 1;
    min-width: 140px;
    transition: var(--transition);
  }
  #filtros input:focus,
  #filtros select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(52,131,250,0.15);
  }
  #filtros label {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-weight: 500;
    white-space: nowrap;
  }
  #filtros button {
    padding: 0.9rem 2.5rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
  }
  #filtros button:hover {
    background: var(--primary-dark);
    transform: translateY(-3px);
  }

  #map {
    height: 65vh;
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    margin: 1.5rem auto;
    max-width: 1400px;
  }
  #loading-msg {
    text-align: center;
    font-weight: 600;
    color: var(--primary);
    font-size: 1.3rem;
    margin: 2rem;
    display: none;
  }

  #alquiler-detalle {
    display: none;
    max-width: 800px;
    margin: 2rem auto;
    padding: 2rem;
    background: var(--card);
    border: 2px solid var(--primary);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    animation: fadeIn 0.6s ease;
  }
  #alquiler-detalle.highlight { animation: resaltar 1.2s ease; }
  #alquiler-detalle h2 {
    margin-top: 0;
    color: var(--primary);
    font-size: 2rem;
  }
  #alquiler-detalle p {
    margin: 0.9rem 0;
    padding-bottom: 0.9rem;
    border-bottom: 1px solid #eee;
  }
  #alquiler-detalle p:last-child { border-bottom: none; }

  .action-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin: 1.5rem 0;
  }
  .copy-share-btn {
    background: #10b981;
    color: white;
    padding: 1rem 1.8rem;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
  }
  .copy-share-btn:hover { background: #059669; }

  #imagenes-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 14px;
    margin: 1.8rem 0;
  }
  #imagenes-container img {
    width: 100%;
    height: 110px;
    object-fit: cover;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 3px 12px rgba(0,0,0,0.12);
    transition: var(--transition);
  }
  #imagenes-container img:hover {
    transform: scale(1.06);
    box-shadow: 0 10px 30px rgba(0,0,0,0.22);
  }

  /* Marcadores con los emojis originales (sin tocar el estilo) */
  .marker-icon {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    background: #3483fa !important;
    color: white !important;
    font-weight: bold !important;
    border-radius: 50% !important;
    width: 30px !important;
    height: 30px !important;
    border: 2px solid white !important;
    box-shadow: 0 0 2px #000 !important;
  }
  .popup-button {
    display: inline-block;
    padding: 8px 16px;
    margin-top: 8px;
    background: var(--primary);
    color: white;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: var(--transition);
  }
  .popup-button:hover { background: var(--primary-dark); }

  /* Modal imágenes */
  #modal-img {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.94);
    backdrop-filter: blur(10px);
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 2rem;
  }
  #modal-img img {
    max-width: 95%;
    max-height: 95%;
    border-radius: 18px;
    box-shadow: 0 25px 60px rgba(0,0,0,0.6);
  }
  .nav-btn, .close-btn {
    position: absolute;
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    font-size: 30px;
    cursor: pointer;
    backdrop-filter: blur(12px);
    transition: var(--transition);
  }
  .nav-btn:hover, .close-btn:hover {
    background: var(--primary);
    transform: scale(1.12);
  }
  .close-btn { top: 20px; right: 20px; }
  .prev-btn { left: 20px; }
  .next-btn { right: 20px; }

  /* Paneles login, registro, avisos */
  #login, #registro, #avisos-panel, #panel-dueno {
    display: none;
    max-width: 500px;
    margin: 3rem auto;
    padding: 2.5rem;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    text-align: center;
  }
  #login h2, #registro h2, #avisos-panel h2 {
    color: var(--primary);
    margin-bottom: 1.5rem;
  }
  input, select, button {
    width: 100%;
    padding: 0.9rem;
    margin: 0.8rem 0;
    border-radius: var(--radius);
    border: 1.5px solid var(--border);
    font-size: 1rem;
  }
  button {
    background: var(--primary);
    color: white;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
  }
  button:hover {
    background: var(--primary-dark);
    transform: translateY(-3px);
  }
  .password-container {
    position: relative;
    display: flex;
    align-items: center;
  }
  .eye-icon {
    position: absolute;
    right: 12px;
    width: 24px;
    height: 24px;
    cursor: pointer;
    background: url('https://img.icons8.com/ios/50/000000/visible.png') no-repeat center/contain;
  }
  #publicidad-container {
    background: var(--card);
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 2rem;
    margin: 2rem auto;
    max-width: 700px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
  }
  #publicidad-container:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow);
  }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes resaltar { 0%, 100% { transform: scale(1); box-shadow: var(--shadow); } 50% { transform: scale(1.02); box-shadow: 0 0 35px rgba(52,131,250,0.4); } }

  @media (max-width: 768px) {
    #boton-filtros-container { flex-direction: column; }
    #boton-filtros-container button { width: 80%; margin: 0 auto; }
    #filtros, #login, #registro { padding: 1.5rem; margin: 1.5rem; }
    #map { height: 55vh; }
  }
</style>
</head>
<body>
<header>
  <img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="Logo Alqui Ya">
</header>

<!-- Términos solo una vez -->
<div id="modal-terminos" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;">
  <div id="modal-terminos-content" style="background:white;max-width:90%;max-height:90%;overflow-y:auto;padding:2rem;border-radius:14px;box-shadow:var(--shadow);">
    <h2>Términos y Condiciones de Uso</h2>
    <p><strong>Última actualización: 10/09/2025</strong></p>
<p>Bienvenido/a a AlquiYa (en adelante, “la Plataforma”).<br>
Al acceder o utilizar la Plataforma, usted acepta estos Términos y Condiciones. Si no está de acuerdo, debe abstenerse de usarla.</p>
<h3>1. Naturaleza del Servicio – Exclusión de Intermediación Inmobiliaria</h3>
<p>La Plataforma es un intermediador publicitario digital que facilita la publicación y visualización de ofertas de alquiler de inmuebles.<br>
No somos corredores inmobiliarios ni una inmobiliaria.<br>
No participamos en la negociación, celebración ni ejecución de contratos de alquiler o compraventa.<br>
Cualquier acuerdo, gestión o transacción vinculada al alquiler se realiza de manera directa entre Dueños y Usuarios, sin intervención ni responsabilidad de la Plataforma.</p>
<h3>2. Publicaciones y Responsabilidad de los Dueños</h3>
<p>Los Dueños son responsables de la información, imágenes y condiciones que publiquen.<br>
La Plataforma no garantiza la veracidad ni autenticidad de las publicaciones.<br>
Si un Usuario detecta un anuncio falso o sospechoso, podrá reportarlo a través de <a href="mailto:alquiya@gmail.com">alquiya@gmail.com</a> para que sea revisado y eventualmente eliminado.<br>
El Dueño se compromete a proporcionar datos de contacto reales y verificables (email y teléfono).</p>
<h3>3. Exención de Responsabilidad por Fraudes o Estafas</h3>
<p>La Plataforma no será responsable por fraudes, engaños o incumplimientos cometidos por Dueños o Usuarios.<br>
El Usuario reconoce y acepta que:<br>
- Debe verificar por su cuenta la existencia del inmueble y la identidad del Dueño antes de concretar operaciones.<br>
- Cualquier perjuicio económico, daño o pérdida derivados de anuncios falsos es ajeno a la responsabilidad de la Plataforma.</p>
<h3>4. Protección de Datos Personales</h3>
<p>La Plataforma cumple con la Ley de Protección de Datos Personales Nº 25.326.<br>
Los datos proporcionados serán utilizados únicamente para el funcionamiento de la Plataforma.<br>
El Usuario puede ejercer sus derechos de acceso, rectificación o supresión comunicándose a <a href="mailto:alquiya@gmail.com">alquiya@gmail.com</a>.<br>
La base de datos será registrada ante la Agencia de Acceso a la Información Pública conforme a la normativa vigente.</p>
<h3>5. Relación de Consumo – Limitaciones de Responsabilidad</h3>
<p>En caso de que el servicio contratado (ej. publicación destacada, plan pago) no funcione correctamente, el Usuario deberá notificarlo dentro de los 7 días posteriores para gestionar un ajuste o reembolso si corresponde.<br>
La responsabilidad de la Plataforma se limita estrictamente al monto abonado por el servicio contratado.<br>
En ningún caso la Plataforma será responsable por:<br>
- Lucro cesante, pérdida de chance o daños indirectos.<br>
- El éxito de la operación de alquiler entre Dueños y Usuarios.</p>
<h3>6. Contenido y Derechos de Autor</h3>
<p>El Dueño declara que cuenta con derechos de uso sobre las imágenes, textos y contenidos que publique.<br>
La Plataforma no será responsable por infracciones a derechos de autor cometidas por los Dueños.<br>
En caso de reclamo de terceros, el Dueño mantendrá indemne a la Plataforma.</p>
<h3>7. Uso Permitido</h3>
<p>Queda prohibido utilizar la Plataforma para:<br>
- Publicar información falsa, ilegal, discriminatoria o que vulnere derechos de terceros.<br>
- Suplantar la identidad de otra persona.<br>
- Subir material protegido sin autorización.</p>
<h3>8. Modificaciones</h3>
<p>La Plataforma podrá modificar los presentes Términos y Condiciones en cualquier momento, notificando a los Usuarios mediante su publicación en el sitio.</p>
<h3>9. Ley Aplicable y Jurisdicción</h3>
<p>Los presentes Términos se rigen por las leyes de la República Argentina.<br>
Cualquier conflicto será resuelto ante los tribunales ordinarios de Santo Tomé, Corrientes, renunciando expresamente a cualquier otro fuero.</p>
    <button onclick="aceptarTerminos()" style="margin-top:2rem;padding:1rem 2rem;background:var(--primary);color:white;border:none;border-radius:var(--radius);cursor:pointer;">Aceptar Términos y Condiciones</button>
  </div>
</div>

<nav>
  <a href="#" onclick="mostrarMapa()">Mapa</a>
  <a href="#" onclick="mostrarLogin()">Publicar Propiedad</a>
</nav>

<!-- Botones uno al lado del otro -->
<div id="boton-filtros-container">
  <button onclick="toggleFiltros()">Añadir Filtros</button>
  <button onclick="mostrarAvisos()">Recibir Avisos</button>
</div>
<div id="filtros">
<input type="number" id="filtroAmb" placeholder="Nro de Ambientes">
<input type="text" id="filtroMin" placeholder="Precio Mínimo" oninput="formatCurrency(this)">
<input type="text" id="filtroMax" placeholder="Precio Máximo" oninput="formatCurrency(this)">
<select id="filtroTipo">
<option value="">Todos los tipos</option>
<option value="Departamento">Departamento</option>
<option value="Temporario">Alquiler Temporario</option>
<option value="Local">Local Comercial</option>
</select>
<label><input type="checkbox" id="filtroMascotas"> Mascotas Permitidas</label>
<label><input type="checkbox" id="filtroAmoblado"> Amoblado</label>
<button onclick="cargarAlquileres()">Filtrar</button>
</div>
<div id="avisos-panel">
<h2>Recibir Notificaciones</h2>
<input type="text" id="avisos_email" placeholder="Email">
<button onclick="registrarEmailAvisos()">Suscribirse</button>
<button onclick="mostrarMapa()">Cancelar</button>
<p id="avisos-msg" style="color:green"></p>
</div>
<div id="loading-msg">Cargando alquileres disponibles...</div>
<div id="map"></div>
<div id="rapiclean-img-container">
<a href="https://wa.me/5493756617167?text=Hola" target="_blank">
<img src="https://i.postimg.cc/NMMZQ3YG/M-s-de-40-estudiantes-ya-confiaron-en-Rapiclean-1.png" alt="Más de 40 estudiantes confiaron en Rapiclean" style="max-width:100%;margin:10px auto;display:block;">
</a>
<a href="https://wa.me/5493764275443?text=Hola,+quiero+publicitar+en+AlquiYa&utm_source=chatgpt.com" target="_blank">
<div id="publicidad-container">
<p>Espacio Publicitario</p>
<p>Haz clic para publicitar aquí</p>
</div>
</a>
</div>
<div id="alquiler-detalle">
<p id="metricas-error"></p>
</div>
<div id="login">
<h2>Login Dueños</h2>
<input type="text" id="email" placeholder="Email">
<div class="password-container">
<input type="password" id="password" placeholder="Contraseña">
<div class="eye-icon" onclick="togglePassword('password')"></div>
</div>
<button onclick="login()">Ingresar</button>
<p id="login-loading" style="color:#3483fa">Iniciando sesión...</p>
<p>¿No tienes cuenta?</p>
<p><button onclick="mostrarRegistro()">Registrarme</button></p>
<p id="login-msg" style="color:red"></p>
</div>
<div id="registro">
<h2>Registro Dueños</h2>
<input type="text" id="reg_email" placeholder="Email">
<input type="text" id="reg_nombre" placeholder="Nombre">
<div class="password-container">
<input type="password" id="reg_password" placeholder="Contraseña">
<div class="eye-icon" onclick="togglePassword('reg_password')"></div>
</div>
<div id="reg_contacto-container">
<select id="reg_codigo_pais">
<option value="+54">+54 (Argentina)</option>
<option value="+55">+55 (Brasil)</option>
<option value="+56">+56 (Chile)</option>
<option value="+57">+57 (Colombia)</option>
<option value="+51">+51 (Perú)</option>
<option value="+52">+52 (México)</option>
</select>
<input type="text" id="reg_contacto" placeholder="WhatsApp (ej: 3794000000)">
</div>
<button onclick="registrarDueno()">Registrar</button>
<button onclick="mostrarLogin()">Cancelar</button>
<p id="registro-msg" style="color:green"></p>
</div>
<div id="panel-dueno">
<h2>Panel de Dueños</h2>
<p id="bienvenida"></p>
<button onclick="logout()">Cerrar Sesión</button>
</div>
<div id="modal-img">
<img id="img-grande">
<button class="close-btn" onclick="cerrarModal()">X</button>
<button class="nav-btn prev-btn" onclick="cambiarImagen(-1)">&lt;</button>
<button class="nav-btn next-btn" onclick="cambiarImagen(1)">&gt;</button>
</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* =========================
CONFIG
*/
const webAppURL = "https://script.google.com/macros/s/AKfycbyFvDRwPZoG6ChhvcxGm6B27ziD6Qkg4RcH0TI9K59b7zPz7iFxy7mgmbs5mo5T-TxD/exec";
const cloudinaryURL = "https://api.cloudinary.com/v1_1/dnugmwern/image/upload";
const cloudinaryUploadPreset = "preset_alquileres";
let currentImages = [];
let currentImageIndex = 0;
/* =========================
MAPA
*/
let map = null;
let markersLayer = null;
function initializeMap() {
  if (map) return; // Prevent reinitialization
  const mapElement = document.getElementById('map');
  if (!mapElement) {
    console.error("Map element not found");
    document.getElementById("loading-msg").textContent = "Error: No se encontró el contenedor del mapa.";
    return false;
  }
  try {
    map = L.map('map').setView([-28.5503, -56.0406], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
    return true;
  } catch (error) {
    console.error("Error initializing map:", error);
    document.getElementById("loading-msg").textContent = "Error al cargar el mapa. Por favor, intenta de nuevo.";
    return false;
  }
}
/* =========================
UTILS
*/
function getField(obj, keys) {
  for (const k of keys) {
    if (Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null && obj[k] !== "") return obj[k];
  }
  return "";
}
function toNumber(val) {
  if (typeof val === "number") return val;
  if (!val) return 0;
  const clean = String(val).replace(/[^\d.,-]/g, "").replace(/\./g, "").replace(",", ".");
  const num = parseFloat(clean);
  return isNaN(num) ? 0 : num;
}
function toInt(val, def = 0) {
  const n = parseInt(val, 10);
  return isNaN(n) ? def : n;
}
function parseDate(dateStr) {
  if (!dateStr) return null;
  const [day, month, year] = dateStr.split('/').map(Number);
  if (!day || !month || !year) return null;
  return new Date(year, month - 1, day);
}
/* =========================
FORMATO MONEDA
*/
function formatCurrency(el) {
  let selectionStart = el.selectionStart;
  let raw = String(el.value || "");
  let digits = raw.replace(/\D/g, '');
  if (digits === '') { el.value = ''; return; }
  let n = parseInt(digits, 10);
  if (isNaN(n)) { el.value = ''; return; }
  let formatted = n.toLocaleString('es-AR');
  el.value = '$' + formatted;
  try { el.setSelectionRange(el.value.length, el.value.length); } catch (e) {}
}
function parseCurrency(str) {
  if (!str) return 0;
  let cleaned = String(str).replace(/[^\d]/g, '');
  if (cleaned === '') return 0;
  let num = parseInt(cleaned, 10);
  return isNaN(num) ? 0 : num;
}
function formatPrice(num) {
  if (!num) return "";
  const clean = String(num).replace(/[^\d]/g, "");
  const formatted = parseInt(clean, 10).toLocaleString('es-AR');
  return "$" + formatted.replace(/,/g, ".");
}
/* =========================
UI NAV
*/
function toggleFiltros() {
  const f = document.getElementById("filtros");
  f.style.display = (f.style.display === "none" || f.style.display === "") ? "flex" : "none";
}
function mostrarMapa() {
  document.getElementById("map").style.display = "block";
  document.getElementById("login").style.display = "none";
  document.getElementById("panel-dueno").style.display = "none";
  document.getElementById("registro").style.display = "none";
  document.getElementById("avisos-panel").style.display = "none";
  document.getElementById("alquiler-detalle").style.display = "none";
  document.getElementById("boton-filtros-container").style.display = "flex";
  document.getElementById("loading-msg").style.display = "none";
  document.getElementById("rapiclean-img-container").style.display = "block";
  if (!map) {
    if (initializeMap()) {
      map.invalidateSize();
      cargarAlquileres();
    }
  } else {
    map.invalidateSize();
    cargarAlquileres();
  }
}
function mostrarLogin() {
  document.getElementById("map").style.display = "none";
  document.getElementById("filtros").style.display = "none";
  document.getElementById("login").style.display = "block";
  document.getElementById("panel-dueno").style.display = "none";
  document.getElementById("registro").style.display = "none";
  document.getElementById("avisos-panel").style.display = "none";
  document.getElementById("alquiler-detalle").style.display = "none";
  document.getElementById("boton-filtros-container").style.display = "none";
  document.getElementById("loading-msg").style.display = "none";
  document.getElementById("rapiclean-img-container").style.display = "none";
  document.getElementById("login-loading").style.display = "none";
}
function mostrarRegistro() {
  document.getElementById("login").style.display = "none";
  document.getElementById("registro").style.display = "block";
  document.getElementById("map").style.display = "none";
  document.getElementById("filtros").style.display = "none";
  document.getElementById("panel-dueno").style.display = "none";
  document.getElementById("avisos-panel").style.display = "none";
  document.getElementById("alquiler-detalle").style.display = "none";
  document.getElementById("boton-filtros-container").style.display = "none";
  document.getElementById("loading-msg").style.display = "none";
  document.getElementById("rapiclean-img-container").style.display = "none";
}
function mostrarAvisos() {
  document.getElementById("map").style.display = "none";
  document.getElementById("filtros").style.display = "none";
  document.getElementById("login").style.display = "none";
  document.getElementById("panel-dueno").style.display = "none";
  document.getElementById("registro").style.display = "none";
  document.getElementById("avisos-panel").style.display = "block";
  document.getElementById("alquiler-detalle").style.display = "none";
  document.getElementById("boton-filtros-container").style.display = "none";
  document.getElementById("loading-msg").style.display = "none";
  document.getElementById("rapiclean-img-container").style.display = "none";
}
/* =========================
TÉRMINOS Y CONDICIONES
*/
function mostrarTerminos() {
  const terminosAceptados = localStorage.getItem("terminosAceptados");
  if (!terminosAceptados) {
    document.getElementById("modal-terminos").style.display = "flex";
  }
}
function aceptarTerminos() {
  localStorage.setItem("terminosAceptados", "true");
  document.getElementById("modal-terminos").style.display = "none";
}
/* =========================
FETCH HELPER
*/
async function makeRequest(url, options) {
  try {
    const response = await fetch(url, options);
    if (!response.ok && options.mode !== 'no-cors') {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    if (options.mode === 'no-cors') {
      return null;
    }
    const text = await response.text();
    console.log("Raw response:", text);
    try {
      return JSON.parse(text);
    } catch (e) {
      console.error("JSON parsing error:", e, "Raw text:", text);
      throw new Error("Respuesta del servidor no es un JSON válido");
    }
  } catch (error) {
    console.error("Fetch error:", error);
    throw new Error("No se pudo conectar con el servidor. Por favor, intenta de nuevo.");
  }
}
/* =========================
AUTH
*/
function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  if (!email || !password) {
    document.getElementById("login-msg").textContent = "Ingrese email y contraseña";
    document.getElementById("login-loading").style.display = "none";
    return;
  }
  document.getElementById("login-loading").style.display = "block";
  document.getElementById("login-msg").textContent = "";
  makeRequest(webAppURL + "?action=verificarLogin&email=" + encodeURIComponent(email) + "&password=" + encodeURIComponent(password), {
    method: "GET",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    }
  })
    .then(data => {
      document.getElementById("login-loading").style.display = "none";
      if (data.success) {
        localStorage.setItem("dueno", email);
        localStorage.setItem("dueno_email", email);
        window.location.href = "dueños.html";
      } else {
        if (data.error === "Usuario no registrado") {
          document.getElementById("login-msg").textContent = "Usuario no registrado";
        } else if (data.error === "Contraseña incorrecta") {
          document.getElementById("login-msg").textContent = "Contraseña incorrecta";
        } else {
          document.getElementById("login-msg").textContent = "Error en el inicio de sesión";
        }
      }
    })
    .catch(error => {
      document.getElementById("login-loading").style.display = "none";
      document.getElementById("login-msg").textContent = error.message;
    });
}
function logout() {
  localStorage.removeItem("dueno");
  localStorage.removeItem("dueno_email");
  mostrarLogin();
}
function registrarDueno() {
  const email = document.getElementById("reg_email").value.trim();
  const nombre = document.getElementById("reg_nombre").value.trim();
  const password = document.getElementById("reg_password").value.trim();
  const codigoPais = document.getElementById("reg_codigo_pais").value;
  const contacto = document.getElementById("reg_contacto").value.trim();
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const contactoRegex = /^\d{9,10}$/;
  if (!email || !nombre || !password || !contacto) {
    document.getElementById("registro-msg").style.color = "red";
    document.getElementById("registro-msg").textContent = "Complete todos los campos";
    return;
  }
  if (!emailRegex.test(email)) {
    document.getElementById("registro-msg").style.color = "red";
    document.getElementById("registro-msg").textContent = "Ingrese un email válido";
    return;
  }
  if (!contactoRegex.test(contacto)) {
    document.getElementById("registro-msg").style.color = "red";
    document.getElementById("registro-msg").textContent = "Ingrese un número de WhatsApp válido (9-10 dígitos)";
    return;
  }
  if (password.length < 6) {
    document.getElementById("registro-msg").style.color = "red";
    document.getElementById("registro-msg").textContent = "La contraseña debe tener al menos 6 caracteres";
    return;
  }
  const params = new URLSearchParams();
  params.append("action", "registrarDueno");
  params.append("email", email);
  params.append("nombre", nombre);
  params.append("password", password);
  params.append("contacto", codigoPais + contacto);
  makeRequest(webAppURL, {
    method: "POST",
    body: params,
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    mode: "no-cors"
  })
    .then(() => {
      document.getElementById("registro-msg").style.color = "green";
      document.getElementById("registro-msg").innerHTML = "Dueño registrado con éxito.<br><button onclick='mostrarLogin()'>Ir a Login</button>";
      setTimeout(() => mostrarLogin(), 2000);
    })
    .catch(error => {
      console.error("Error en registro:", error);
      document.getElementById("registro-msg").style.color = "red";
      document.getElementById("registro-msg").textContent = `Error: ${error.message}`;
    });
}
/* =========================
REGISTRO DE EMAILS PARA AVISOS
*/
function registrarEmailAvisos() {
  const email = document.getElementById("avisos_email").value.trim();
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!email) {
    document.getElementById("avisos-msg").style.color = "red";
    document.getElementById("avisos-msg").textContent = "Ingrese un email";
    return;
  }
  if (!emailRegex.test(email)) {
    document.getElementById("avisos-msg").style.color = "red";
    document.getElementById("avisos-msg").textContent = "Ingrese un email válido";
    return;
  }
  const params = new URLSearchParams();
  params.append("action", "suscribirNotificaciones");
  params.append("email", email);
  makeRequest(webAppURL, {
    method: "POST",
    body: params,
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    mode: "no-cors"
  })
    .then(() => {
      document.getElementById("avisos-msg").style.color = "green";
      document.getElementById("avisos-msg").textContent = "Email registrado con éxito para recibir notificaciones.";
      document.getElementById("avisos_email").value = "";
      setTimeout(() => mostrarMapa(), 2000);
    })
    .catch(error => {
      document.getElementById("avisos-msg").style.color = "red";
      document.getElementById("avisos-msg").textContent = error.message;
    });
}
/* =========================
IMÁGENES
*/
async function subirImagenCloudinary(file) {
  const data = new FormData();
  data.append("file", file);
  data.append("upload_preset", cloudinaryUploadPreset);
  try {
    const res = await fetch(cloudinaryURL, { method: "POST", body: data });
    const json = await res.json();
    return json.secure_url;
  } catch (err) {
    console.error("Error subiendo imagen a Cloudinary:", err);
    return null;
  }
}
function driveUrlDirect(url) {
  let fileId = null;
  if (url && url.includes("drive.google.com")) {
    let match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if (match) fileId = match[1];
    else {
      match = url.match(/id=([a-zA-Z0-9_-]+)/);
      if (match) fileId = match[1];
    }
  }
  return fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : url;
}
function abrirModal(src, images, index) {
  currentImages = images;
  currentImageIndex = index;
  const modal = document.getElementById("modal-img");
  const img = document.getElementById("img-grande");
  img.src = src;
  modal.style.display = "flex";
  document.querySelector(".prev-btn").style.display = images.length > 1 ? "block" : "none";
  document.querySelector(".next-btn").style.display = images.length > 1 ? "block" : "none";
}
function cerrarModal() {
  document.getElementById("modal-img").style.display = "none";
  currentImages = [];
  currentImageIndex = 0;
}
function cambiarImagen(direction) {
  currentImageIndex = (currentImageIndex + direction + currentImages.length) % currentImages.length;
  document.getElementById("img-grande").src = currentImages[currentImageIndex];
}
/* =========================
MÉTRICAS
*/
async function incrementarMetrica(idPropiedad, metrica) {
  if (!idPropiedad) {
    console.warn("ID de propiedad vacío, no se incrementa métrica");
    return;
  }
  const url = `${webAppURL}?action=incrementarmetrica&idPropiedad=${encodeURIComponent(idPropiedad)}&metrica=${metrica}&t=${Date.now()}`;
  console.log("Intentando incrementar:", url); // ← Esto te va a salvar la vida
  try {
    const res = await fetch(url, {
      method: "GET",
      cache: "no-cache"
    });
    if (!res.ok) {
      const text = await res.text();
      console.error("Error HTTP:", res.status, text);
      throw new Error("HTTP " + res.status);
    }
    const data = await res.json();
    console.log(`Métrica ${metrica} incrementada →`, data);
  } catch (err) {
    console.error("Falló incrementarMetrica:", err);
    // No rompemos la UX
  }
function cargarAlquileres() {
  const loadingEl = document.getElementById("loading-msg");
  loadingEl.style.display = "block";
  loadingEl.textContent = "Cargando alquileres disponibles...";

  if (!map || !markersLayer) {
    if (!initializeMap()) return;
  }
  markersLayer.clearLayers();

  /* Iconos originales con emojis */
  const uniIcon    = L.divIcon({ className: 'marker-icon', html: 'Graduation Cap',   iconSize: [30,30], iconAnchor: [15,15] });
  const hospIcon   = L.divIcon({ className: 'marker-icon', html: 'Hospital',        iconSize: [30,30], iconAnchor: [15,15] });
  const superIcon  = L.divIcon({ className: 'marker-icon', html: 'Shopping Cart',   iconSize: [30,30], iconAnchor: [15,15] });
  const busIcon    = L.divIcon({ className: 'marker-icon', html: 'Bus',             iconSize: [30,30], iconAnchor: [15,15] });
  const policeIcon = L.divIcon({ className: 'marker-icon', html: 'Police Officer',  iconSize: [30,30], iconAnchor: [15,15] });

  L.marker([-28.5509978, -56.0409727], { icon: uniIcon }).addTo(markersLayer).bindPopup("<b>Facultad Fundación Barceló</b>");
  L.marker([-28.5551127, -56.0389282], { icon: hospIcon }).addTo(markersLayer).bindPopup("<b>Hospital Universitario San Juan Bautista</b>");
  L.marker([-28.5519443, -56.0401962], { icon: superIcon }).addTo(markersLayer).bindPopup("<b>Supermercado La Bomba</b>");
  L.marker([-28.5472635, -56.0438082], { icon: superIcon }).addTo(markersLayer).bindPopup("<b>Supermercado El Super</b>");
  L.marker([-28.5462903, -56.0440365], { icon: superIcon }).addTo(markersLayer).bindPopup("<b>Supermercado La Economía</b>");
  L.marker([-28.5468697, -56.0432862], { icon: busIcon }).addTo(markersLayer).bindPopup("<b>Terminal de Omnibus</b>");
  L.marker([-28.5487787, -56.0396171], { icon: policeIcon }).addTo(markersLayer).bindPopup("<b>Policía</b>");
  
  const filtroAmb = document.getElementById("filtroAmb").value;
  const filtroMin = parseCurrency(document.getElementById("filtroMin").value) || 0;
  const filtroMax = parseCurrency(document.getElementById("filtroMax").value) || Infinity;
  const filtroMascotas = document.getElementById("filtroMascotas").checked;
  const filtroAmoblado = document.getElementById("filtroAmoblado").checked;
  const filtroTipo = document.getElementById("filtroTipo").value;

  makeRequest(webAppURL + "?action=getAlquileres", {
    method: "GET",
    headers: { "Content-Type": "application/x-www-form-urlencoded" }
  })
  .then(res => {
    loadingEl.style.display = "none";
    if (!res.success || !Array.isArray(res.data)) {
      console.error("Error al cargar alquileres:", res.error || "Respuesta inválida");
      loadingEl.textContent = "Error al cargar alquileres. Por favor, intenta de nuevo.";
      return;
    }

    let cont = 0;
    res.data.forEach(a => {
      // === Filtros de plan y vencimiento ===
      const plan = getField(a, ["Plan"]);
      const fechaVencimientoStr = getField(a, ["Fecha de Vencimiento", "FechaVencimiento", "Vencimiento"]);
      if (plan === "Prueba") {
        const fechaVencimiento = parseDate(fechaVencimientoStr);
        const fechaActual = new Date();
        if (fechaVencimiento && fechaActual > fechaVencimiento) return;
      }

      // === Coordenadas ===
      const latRaw = getField(a, ["Latitud", "lat", "LAT", "Lat"]);
      const lngRaw = getField(a, ["Longitud", "lng", "LNG", "Long"]);
      const lat = parseFloat(String(latRaw).replace(/[^0-9.-]/g, ""));
      const lng = parseFloat(String(lngRaw).replace(/[^0-9.-]/g, ""));
      if (isNaN(lat) || isNaN(lng)) return;

      // === Datos principales ===
      const tipo = getField(a, ["Tipo"]) || "Propiedad";
      if (filtroTipo && tipo !== filtroTipo) return;

      const ambVal = getField(a, ["Nro Ambientes", "Ambientes", "Nro de Ambientes", "Nro"]);
      const nroAmb = toInt(ambVal, 0);
      const precioVal = getField(a, ["Precio", "precio", "$"]);
      const precio = toNumber(precioVal);
      const formattedPrecio = formatPrice(precioVal);

      if (filtroAmb && nroAmb !== toInt(filtroAmb)) return;
      if (precio < filtroMin || precio > filtroMax) return;

      const mascotas = getField(a, ["Mascotas"]);
      if (filtroMascotas && (!mascotas || mascotas.toLowerCase() !== "sí")) return;
      const amoblado = getField(a, ["Amoblado"]);
      if (filtroAmoblado && (!amoblado || amoblado.toLowerCase() !== "sí")) return;

      const idPropiedad = getField(a, ["ID Propiedad", "idPropiedad", "ID", "Id"]);
      const direccion = getField(a, ["Direccion", "Dirección", "Domicilio"]);
      const infoIngreso = getField(a, ["Informacion ingreso", "Información ingreso", "InformacionIngreso", "InfoIngreso", "Informacion de ingreso"]);
      const detalles = getField(a, ["Detalles", "Detalle", "Descripcion", "Descripción"]);
      const contacto = getField(a, ["Contacto", "Whatsapp", "WhatsApp", "Tel", "Telefono", "Teléfono"]);
      const fotos = getField(a, ["Fotos", "Imagenes", "Imágenes", "images"]);

      // === Ícono del marcador ===
      let iconHtml;
  if (tipo === "Temporario")      iconHtml = 'Hourglass';
  else if (tipo === "Local")      iconHtml = 'Shopping Bag';
  else                            iconHtml = `House<span style="font-size:12px;margin-left:2px;">${nroAmb || "-"}</span>`;

  const icon = L.divIcon({
    className: 'marker-icon',
    html: iconHtml,
    iconSize: [30, 30],
    iconAnchor: [15, 15]
  });

      const marker = L.marker([lat, lng], { icon: icon }).addTo(markersLayer);

      // === POPUP DEL MARCADOR (mejorado) ===
      const popupDiv = document.createElement('div');
      popupDiv.innerHTML = `<b>${tipo}</b><br><b>Dirección:</b> ${direccion || 'No disponible'}`;

      if (tipo === "Departamento" || tipo === "Casa") {
        popupDiv.innerHTML += `<br><b>Ambientes:</b> ${nroAmb || 'N/D'}<br><b>Precio:</b> ${formattedPrecio || 'Consultar'}`;
      } else if (tipo !== "Temporario" && tipo !== "Local") {
        popupDiv.innerHTML += `<br><b>Precio:</b> ${formattedPrecio || 'Consultar'}`;
      }

      const verBtn = document.createElement('button');
      verBtn.className = 'popup-button';
      verBtn.textContent = 'Ver Detalles';
      verBtn.onclick = () => {
        if (idPropiedad) incrementarMetrica(idPropiedad, "vistas");

        const detalle = document.getElementById('alquiler-detalle');
        detalle.innerHTML = `<h2>${tipo}: ${direccion || ''}</h2><p id="metricas-error"></p>`;

        // === Datos del detalle ===
        const rows = (tipo === "Temporario" || tipo === "Local") ? [
          ['Dirección', direccion || ''],
          ['Información de ingreso', infoIngreso || ''],
          ['Detalles', detalles || '']
        ] : [
          ['Tipo', tipo],
          ['Dirección', direccion || ''],
          ['Ambientes', nroAmb || '-'],
          ['Precio', formattedPrecio || '-'],
          ['Información de ingreso', infoIngreso || ''],
          ['Detalles', detalles || ''],
          ['Mascotas', mascotas || '-'],
          ['Amoblado', amoblado || '-']
        ];

        rows.forEach(([label, val]) => {
          const p = document.createElement('p');
          p.innerHTML = `<b>${label}:</b> ${val || 'No disponible'}`;
          detalle.appendChild(p);
        });

        // === Imágenes ===
        const imgContainer = document.createElement('div');
        imgContainer.id = 'imagenes-container';
        let imageUrls = [];
        if (fotos) {
          imageUrls = fotos.split(',').map(f => driveUrlDirect(f.trim())).filter(url => url);
          imageUrls.forEach((url, index) => {
            const img = document.createElement('img');
            img.src = url;
            img.alt = "Imagen del alquiler";
            img.referrerPolicy = "no-referrer";
            img.onclick = () => abrirModal(url, imageUrls, index);
            imgContainer.appendChild(img);
          });
        }
        detalle.appendChild(imgContainer);

        // === BOTONES DE ACCIÓN ===
        const actionDiv = document.createElement('div');
        actionDiv.className = 'action-buttons';

        // WhatsApp
        if (contacto) {
          const waBtn = document.createElement('button');
          waBtn.textContent = 'Contactar por WhatsApp';
          waBtn.style.background = '#25D366';
          waBtn.style.color = 'white';
          waBtn.style.padding = '1rem 2rem';
          waBtn.style.borderRadius = 'var(--radius)';
          waBtn.style.margin = '0.6rem 0';
          waBtn.style.border = 'none';
          waBtn.style.fontWeight = '600';
          waBtn.style.cursor = 'pointer';
          waBtn.onclick = () => {
            if (idPropiedad) incrementarMetrica(idPropiedad, "contactos");
            const mensaje = `Hola, vengo desde AlquiYa y quiero consultar por el ${tipo.toLowerCase()} en ${direccion}`;
            window.open(`https://wa.me/${contacto}?text=${encodeURIComponent(mensaje)}`, '_blank');
          };
          actionDiv.appendChild(waBtn);
        }

        // Copiar Enlace
        if (idPropiedad) {
          const copyBtn = document.createElement('button');
          copyBtn.className = 'copy-share-btn';
          copyBtn.setAttribute('data-id', idPropiedad);
          copyBtn.textContent = 'Copiar Enlace';
          actionDiv.appendChild(copyBtn);
        }

        detalle.appendChild(actionDiv);

        // Mostrar
        detalle.style.display = 'block';
        detalle.classList.add("highlight");
        detalle.scrollIntoView({ behavior: "smooth", block: "start" });
        setTimeout(() => detalle.classList.remove("highlight"), 1200);
        if (map) map.invalidateSize();
      };

      popupDiv.appendChild(verBtn);
      marker.bindPopup(popupDiv);
      cont++;
    });

    if (cont === 0) {
      loadingEl.textContent = "No se encontraron alquileres para los filtros actuales.";
    }
  })
  .catch(err => {
    document.getElementById("loading-msg").style.display = "none";
    console.error("Error al conectar con WebApp:", err);
    loadingEl.textContent = "Error al conectar con el servidor. Por favor, intenta de nuevo.";
  });
}
/* =========================
PASSWORD VISIBILITY TOGGLE
*/
function togglePassword(inputId) {
  const input = document.getElementById(inputId);
  const eyeIcon = input.nextElementSibling;
  if (input.type === "password") {
    input.type = "text";
    eyeIcon.style.backgroundImage = "url('https://img.icons8.com/ios/50/000000/invisible.png')";
  } else {
    input.type = "password";
    eyeIcon.style.backgroundImage = "url('https://img.icons8.com/ios/50/000000/visible.png')";
  }
  }
/* Listener del botón Copiar Enlace (obligatorio) */
document.addEventListener('click', function(e) {
  if (e.target && e.target.classList.contains('copy-share-btn')) {
    const idPropiedad = e.target.getAttribute('data-id');
    const url = `https://www.alquiya.com.ar/propiedad.html?id=${idPropiedad}`;

    fetch(`${webAppURL}?action=generarEnlaceCompartido&id=${idPropiedad}`, { method: 'GET', mode: 'no-cors' }).catch(() => {});

    navigator.clipboard.writeText(url).then(() => {
      const textoOriginal = e.target.textContent;
      e.target.textContent = "Enlace copiado";
      e.target.style.background = "#10b981";
      setTimeout(() => {
        e.target.textContent = textoOriginal;
        e.target.style.background = "";
      }, 2000);
    }).catch(() => {
      alert('Enlace (copia manual):\n' + url);
    });
  }
});

/* INIT */
window.onload = () => {
  mostrarTerminos();
  mostrarMapa();
};
</script>
</body>
</html>
