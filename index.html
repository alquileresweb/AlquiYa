/* --- Datos de Cloudinary --- */
const CLOUDINARY_CLOUD_NAME = "dnugmwern";
const CLOUDINARY_API_KEY = "877726879255954";
const CLOUDINARY_API_SECRET = "t8CStqLDqd1hs3P9Hkr4lqicIQU";
const CLOUDINARY_UPLOAD_PRESET = "preset_alquileres"; // Crea uno en tu panel de Cloudinary

/* --- Clave secreta para verificación de webhooks --- */
const WEBHOOK_SECRET = "2a2b5b39aefa97460ab135de0ee6c2363bf7bfde8a9b621304751e5789bafa58";

/* --- Credenciales de Mux y Spreadsheet --- */
const MUX_TOKEN_ID = 'TU_TOKEN_ID';
const MUX_TOKEN_SECRET = 'TU_TOKEN_SECRET';
const SPREADSHEET_ID = 'TU_SPREADSHEET_ID';

/* --- Obtener precios y límites dinámicos desde la hoja "Planes" --- */
function getPlanesDinamicos() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("Planes");
  var data = sheet.getRange("E2:G2").getValues()[0]; // fila 2, columnas E,F,G
  return {
    Prueba: { limiteDeptos: Infinity, limiteFotos: 3, destacar: 0, precio: 0 },
    Basico: { limiteDeptos: 3, limiteFotos: 3, destacar: 0, precio: data[0] || 0 },
    Plus: { limiteDeptos: 5, limiteFotos: 5, destacar: 1, precio: data[1] || 0 },
    Full: { limiteDeptos: 10, limiteFotos: 99, destacar: 99, precio: data[2] || 0 }
  };
}

/* --- Obtener información de planes --- */
function getPlanes() {
  var planes = getPlanesDinamicos();
  var result = [];
  for (var plan in planes) {
    result.push({
      nombre: plan,
      precio: planes[plan].precio,
      limiteDeptos: planes[plan].limiteDeptos
    });
  }
  return { success: true, data: result };
}

/* --- Obtener datos de la hoja "Login" --- */
function getLogins() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();
  var headers = data[0];
  var logins = [];

  for (var i = 1; i < data.length; i++) {
    var obj = {};
    for (var j = 0; j < headers.length; j++) {
      obj[headers[j]] = data[i][j] || "";
    }
    obj.row = i + 1;
    logins.push(obj);
  }
  return logins;
}

/* --- NUEVA FUNCIÓN: Obtener estadísticas completas --- */
function getEstadisticas(e) {
  var email = e.parameter.email;
  if (!email) {
    return { success: false, error: "Email requerido" };
  }

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var alquileresSheet = ss.getSheetByName("Alquileres");
  var metricasSheet = ss.getSheetByName("Métricas");
  
  // Obtener datos del dueño
  var loginData = loginSheet.getDataRange().getValues();
  var dueño = null;
  for (var i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === email) {
      dueño = {
        nombre: loginData[i][3] || "",
        plan: loginData[i][5] || "Prueba",
        estadoPago: loginData[i][6] || "",
        vencimiento: loginData[i][7] ? new Date(loginData[i][7]) : null,
        pagos: loginData[i][8] || ""
      };
      break;
    }
  }
  
  if (!dueño) {
    return { success: false, error: "Dueño no encontrado" };
  }

  // Obtener todos los alquileres del dueño
  var alquileresData = alquileresSheet.getDataRange().getValues();
  var metricasData = metricasSheet.getDataRange().getValues();
  
  var stats = {
    totalPropiedades: 0,
    propiedadesActivas: 0,
    propiedadesInactivas: 0,
    porTipo: { Departamento: 0, Local: 0, Temporario: 0, Otros: 0 },
    porOperacion: { Alquilar: 0, Vender: 0 },
    porAmoblado: { Sí: 0, No: 0 },
    conMascotas: 0,
    sinMascotas: 0,
    promedioPrecio: 0,
    totalFotos: 0,
    propiedadesConVideo: 0,
    limiteDeptos: getPlanesDinamicos()[dueño.plan].limiteDeptos,
    limiteFotos: getPlanesDinamicos()[dueño.plan].limiteFotos,
    planInfo: getPlanesDinamicos()[dueño.plan],
    diasRestantes: dueño.vencimiento ? 
      Math.max(0, Math.ceil((dueño.vencimiento - new Date()) / (1000 * 60 * 60 * 24))) : 0,
    planVigente: dueño.plan === "Prueba" || (dueño.vencimiento && dueño.vencimiento >= new Date()),
    totalVistas: 0,
    totalContactos: 0,
    metricasPorPropiedad: {}
  };

  var precios = [];
  var totalFotos = 0;

  // Contar estadísticas
  for (var i = 1; i < alquileresData.length; i++) {
    if (alquileresData[i][1] === email) {
      stats.totalPropiedades++;
      var estado = alquileresData[i][9];
      var tipo = alquileresData[i][0] || "Otros";
      var operacion = alquileresData[i][17] || "Alquilar";
      var amoblado = alquileresData[i][16] || "No";
      var mascotas = alquileresData[i][12] || "No";
      var precio = parseFloat(alquileresData[i][6]) || 0;
      var fotos = (alquileresData[i][8] || "").split(",").filter(f => f.trim()).length;
      var videos = alquileresData[i][15] || "";
      var idPropiedad = alquileresData[i][13] || "";

      if (estado === "Activo") stats.propiedadesActivas++;
      else stats.propiedadesInactivas++;

      // Por tipo
      if (["Departamento", "Local", "Temporario"].includes(tipo)) {
        stats.porTipo[tipo]++;
      } else {
        stats.porTipo.Otros++;
      }

      // Por operación
      if (["Alquilar", "Vender"].includes(operacion)) {
        stats.porOperacion[operacion]++;
      }

      // Por amoblado
      stats.porAmoblado[amoblado === "Sí" ? "Sí" : "No"]++;

      // Mascotas
      if (mascotas === "Sí") stats.conMascotas++;
      else stats.sinMascotas++;

      // Precio promedio
      if (precio > 0) precios.push(precio);

      // Total fotos
      totalFotos += fotos;
      stats.totalFotos += fotos;

      // Videos
      if (videos) stats.propiedadesConVideo++;

      // Métricas por propiedad
      var metricasProp = metricasData.find(row => row[0] == idPropiedad);
      if (metricasProp) {
        stats.metricasPorPropiedad[idPropiedad] = {
          vistas: metricasProp[2] || 0,
          contactos: metricasProp[3] || 0
        };
        stats.totalVistas += metricasProp[2] || 0;
        stats.totalContactos += metricasProp[3] || 0;
      }
    }
  }

  // Calcular promedio de precio
  stats.promedioPrecio = precios.length > 0 ? 
    Math.round(precios.reduce((a, b) => a + b, 0) / precios.length) : 0;

  return { 
    success: true, 
    data: {
      dueño: dueño,
      estadisticas: stats,
      mensaje: stats.planVigente ? 
        `¡Tu plan está vigente! Te quedan ${stats.diasRestantes} días.` : 
        "Tu plan está vencido. Renueva para mostrar tus propiedades."
    }
  };
}

/* --- Maneja OPTIONS (preflight de CORS) --- */
function doOptions(e) {
  return ContentService.createTextOutput("")
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeader("Access-Control-Allow-Origin", "https://alquiya.com.ar")
    .setHeader("Access-Control-Allow-Methods", "POST, GET, OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
}

/* --- Respuesta común con CORS habilitado --- */
function buildCorsResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "https://alquiya.com.ar")
    .setHeader("Access-Control-Allow-Methods", "POST, GET, OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
}

/* --- Manejo principal de solicitudes GET (AGREGADA ESTADÍSTICAS) --- */
function doGet(e) {
  var action = e.parameter.action;
  var callback = e.parameter.callback || null;
  var res = {};

  try {
    if (action == "getAlquileres") {
      res = { success: true, data: getAlquileresActivos(e) };
    } else if (action == "addAlquiler") {
      res = addAlquiler(e);
    } else if (action == "editAlquiler") {
      res = editAlquiler(e);
    } else if (action == "toggleEstado") {
      res = toggleEstado(e);
    } else if (action == "deleteAlquiler") {
      res = deleteAlquiler(e);
    } else if (action == "getAlquileresDueno") {
      res = { success: true, data: getAlquileres(e) };
    } else if (action == "getLoginInfo") {
      res = getLoginInfo(e);
    } else if (action == "verificarLogin") {
      res = verificarLogin(e);
    } else if (action == "getPlanes") {
      res = getPlanes();
    } else if (action == "editarDueno") {
      res = editarDueno(e);
    } else if (action == "updatePlan") {
      res = updatePlan(e);
    } else if (action == "actualizarFechaVencimiento") {
      res = actualizarFechaVencimiento(e);
    } else if (action == "getAlquiler") {
      res = getAlquiler(e);
    } else if (action == "getInmobiliaria") {
      res = getInmobiliaria(e);
    } else if (action == "getLogins") {
      res = { success: true, data: getLogins() };
    } else if (action == "getEstadisticas") {  // ← NUEVA LÍNEA AGREGADA
      res = getEstadisticas(e);
    } else {
      res = { success: false, error: "Acción no reconocida" };
    }
  } catch (err) {
    Logger.log("❌ Error en doGet: " + err.message);
    res = { success: false, error: err.message };
  }

  var json = JSON.stringify(res);
  var output;
  if (callback) {
    output = ContentService.createTextOutput(callback + "(" + json + ");")
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  } else {
    output = ContentService.createTextOutput(json)
      .setMimeType(ContentService.MimeType.JSON);
  }

  return output;
}

/* --- Manejo de solicitudes POST (Webhooks, FormData, and JSON) CON MÉTRICAS --- */
function doPost(e) {
  try {
    const params = e.parameter || JSON.parse(e.postData.contents || "{}");
    const action = params.action;

    // Configura las cabeceras CORS
    const headers = {
      'Access-Control-Allow-Origin': 'https://alquiya.com.ar',
      'Access-Control-Allow-Methods': 'POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
      'Access-Control-Max-Age': '86400'
    };

    // Maneja la solicitud preflight (OPTIONS)
    if (e.parameter.method === 'OPTIONS') {
      return ContentService.createTextOutput()
        .setContent(JSON.stringify({ success: true }))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeaders(headers);
    }

    // *** NUEVA LÓGICA PARA MÉTRICAS ***
    if (params.action === "actualizarMetricas") {
      try {
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        const hojaAlquileres = ss.getSheetByName('Alquileres');
        const hojaMetricas = ss.getSheetByName('Métricas');
        
        const idPropiedad = params.idPropiedad;
        const tipo = params.tipo; // "vistas" o "contactos"
        
        // Buscar ID en columna N de Alquileres
        const datosAlquileres = hojaAlquileres.getDataRange().getValues();
        let filaMetricas = -1;
        
        for (let i = 1; i < datosAlquileres.length; i++) {
          if (datosAlquileres[i][13] == idPropiedad) { // Columna N = índice 13
            filaMetricas = i + 1; // +1 porque Apps Script usa 1-based
            break;
          }
        }
        
        if (filaMetricas === -1) {
          console.log(`ID ${idPropiedad} no encontrado en Alquileres`);
          return ContentService.createTextOutput('OK');
        }
        
        // Buscar en hoja Métricas (columna A) y sumar
        const datosMetricas = hojaMetricas.getDataRange().getValues();
        let filaEncontrada = -1;
        
        for (let i = 1; i < datosMetricas.length; i++) {
          if (datosMetricas[i][0] == idPropiedad) { // Columna A = índice 0
            filaEncontrada = i + 1;
            break;
          }
        }
        
        if (filaEncontrada === -1) {
          // Si no existe, crear nueva fila
          const nuevaFila = [idPropiedad, 0, 0, 0]; // A=ID, B=?, C=Vistas, D=Contactos
          hojaMetricas.appendRow(nuevaFila);
          filaEncontrada = hojaMetricas.getLastRow();
        }
        
        // Sumar 1 a la columna correspondiente
        let valorActual;
        if (tipo === "vistas") {
          valorActual = hojaMetricas.getRange(filaEncontrada, 3).getValue(); // Columna C
          hojaMetricas.getRange(filaEncontrada, 3).setValue(valorActual + 1);
        } else if (tipo === "contactos") {
          valorActual = hojaMetricas.getRange(filaEncontrada, 4).getValue(); // Columna D
          hojaMetricas.getRange(filaEncontrada, 4).setValue(valorActual + 1);
        }
        
        console.log(`Métrica ${tipo} actualizada para ID ${idPropiedad}`);
        return ContentService.createTextOutput('OK');
        
      } catch (error) {
        console.error('Error en actualizarMetricas:', error);
        return ContentService.createTextOutput('ERROR');
      }
    }
    // *** FIN NUEVA LÓGICA PARA MÉTRICAS ***

    // Maneja la acción registrarDueno
    if (action === "registrarDueno") {
      return registerDueno(e);
    }

    // Maneja la acción uploadVideoMux
    if (action === 'uploadVideoMux') {
      const base64Video = params.video;
      const row = params.row;

      // Extrae el contenido base64 (después de "data:video/mp4;base64,")
      const base64Content = base64Video.split(',')[1];
      const videoBlob = Utilities.newBlob(Utilities.base64Decode(base64Content), 'video/mp4', 'video.mp4');

      // Sube el video a Mux
      const muxResponse = uploadToMux(videoBlob);
      const videoUrl = muxResponse.data.playback_ids[0].id
        ? `https://stream.mux.com/${muxResponse.data.playback_ids[0].id}.m3u8`
        : '';

      // Opcional: Guarda la URL en Google Sheets
      if (row && videoUrl) {
        const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('Alquileres');
        const currentVideos = sheet.getRange(parseInt(row), 16).getValue() || "";
        const updatedVideos = currentVideos ? `${currentVideos},${videoUrl}` : videoUrl;
        sheet.getRange(parseInt(row), 16).setValue(updatedVideos);
        SpreadsheetApp.flush();
      }

      // Respuesta con CORS
      return ContentService.createTextOutput()
        .setContent(JSON.stringify({ success: true, videoUrl: videoUrl }))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeaders(headers);
    }

    // Otras acciones existentes
    if (action === "suscribirNotificaciones") {
      var response = suscribirNotificaciones({
        parameter: {
          email: Array.isArray(params.email) ? params.email[0] : params.email
        }
      });
      return buildCorsResponse(response);
    }

    if (e.postData && e.postData.contents) {
      // Handle Mercado Pago webhook for payment events
      if (params.type === "payment" && params.data && params.data.id) {
        // Verify webhook signature
        var signature = e.parameter['x-signature'] || '';
        var requestId = e.parameter['x-request-id'] || '';
        var timestamp = signature.split(',')[0]?.split('ts=')[1] || '';
        var signatureHash = signature.split(',')[1]?.split('v1=')[1] || '';
        var expectedSignature = Utilities.computeHmacSha256Signature(
          timestamp + '.' + requestId + '.' + e.postData.contents,
          WEBHOOK_SECRET
        ).reduce(function(str, byte) {
          return str + ('0' + (byte & 0xFF).toString(16)).slice(-2);
        }, '');

        if (signatureHash !== expectedSignature) {
          Logger.log("❌ Error en doPost: Firma de webhook inválida - " + signature);
          return buildCorsResponse({ success: false, error: "Firma de webhook inválida" });
        }

        var externalReference = params.data.external_reference || "";
        var [email, plan] = externalReference.split("_");
        if (!email || !plan) {
          Logger.log("❌ Error en doPost: external_reference inválido - " + externalReference);
          return buildCorsResponse({ success: false, error: "external_reference inválido" });
        }

        var response = updatePlan({
          parameter: {
            payment_id: params.data.id,
            email: email,
            plan: plan,
            estadoPago: "Aprobado",
            descripcionPago: `Pago plan ${plan} - ID: ${params.data.id}`
          }
        });
        return buildCorsResponse(response);
      }

      // Subir imágenes Base64 a Cloudinary
      if (params.action === "uploadImagesCloudinary" && params.images) {
        const links = [];
        params.images.forEach((b64, i) => {
          try {
            const url = subirImagenCloudinary(b64);
            if (url) links.push(url);
          } catch (err) {
            Logger.log("❌ Error subiendo a Cloudinary: " + err.message);
          }
        });
        if (params.row && links.length > 0) {
          const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
          sheet.getRange(parseInt(params.row), 9).setValue(links.join(","));
        }
        return buildCorsResponse({ success: true, links });
      }
    }

    return buildCorsResponse({ success: false, error: "Acción no reconocida" });

  } catch (err) {
    Logger.log("❌ Error en doPost: " + err.message);
    return buildCorsResponse({ success: false, error: err.message });
  }
}

/* --- Registrar dueño --- */
function registerDueno(e) {
  var email = e.parameter.email;
  var password = e.parameter.password;
  var nombre = e.parameter.nombre;
  var contacto = e.parameter.contacto;

  if (!email || !password || !nombre || !contacto) {
    return { success: false, error: "Faltan datos requeridos" };
  }
  if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
    return { success: false, error: "El email no es válido" };
  }
  if (password.length < 6) {
    return { success: false, error: "La contraseña debe tener al menos 6 caracteres" };
  }
  if (!contacto.match(/^\+\d+$/)) {
    return { success: false, error: "El contacto debe empezar con '+' seguido de dígitos" };
  }

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();

  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) {
      return { success: false, error: "El email ya está registrado" };
    }
  }

  try {
    // Set trial plan and expiration date (7 days from now)
    var fechaNueva = new Date();
    fechaNueva.setDate(fechaNueva.getDate() + 7);
    var formattedDate = Utilities.formatDate(fechaNueva, Session.getScriptTimeZone(), "dd/MM/yyyy");

    // Columns: Tipo | Email | Password | Nombre | Contacto | Plan | EstadoPago | Vencimiento
    loginSheet.appendRow([
      "Dueño", email, password, nombre, contacto, "Prueba", "Activo", formattedDate
    ]);
    SpreadsheetApp.flush();
    return { success: true, message: "Dueño registrado correctamente con plan Prueba" };
  } catch (err) {
    return { success: false, error: "Error al guardar en la hoja: " + err.message };
  }
}

/* --- Subir imagen Base64 a Cloudinary --- */
function subirImagenCloudinary(base64Data) {
  const endpoint = "https://api.cloudinary.com/v1_1/" + CLOUDINARY_CLOUD_NAME + "/image/upload";
  const payload = {
    file: base64Data,
    upload_preset: CLOUDINARY_UPLOAD_PRESET
  };
  const options = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(payload)
  };
  const response = UrlFetchApp.fetch(endpoint, options);
  const data = JSON.parse(response.getContentText());
  return data.secure_url;
}

/* --- Subir video Base64 a Mux --- */
function uploadToMux(videoBlob) {
  const url = 'https://api.mux.com/video/v1/assets';
  const options = {
    method: 'POST',
    headers: {
      'Authorization': 'Basic ' + Utilities.base64Encode(MUX_TOKEN_ID + ':' + MUX_TOKEN_SECRET),
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify({
      input: [{
        url: 'data:video/mp4;base64,' + Utilities.base64Encode(videoBlob.getBytes()),
        type: 'video'
      }],
      playback_policy: ['public']
    })
  };
  return JSON.parse(UrlFetchApp.fetch(url, options).getContentText());
}

/* --- Obtener todos los alquileres activos (solo dueños con pago al día) --- */
function getAlquileresActivos(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var alquileres = [];

  // Verificar filtro de mascotas
  var filtroMascotas = e.parameter.mascotas === "true";

  for (var i = 1; i < data.length; i++) {
    var tipo = data[i][0];
    var estado = data[i][9];
    var lat = data[i][3];
    var lng = data[i][4];
    var email = data[i][1];
    var mascotas = data[i][12]; // Columna M: Mascotas
    var pagoAlDia = loginData.find(row => row[1] === email && (new Date(row[7]) >= new Date() || row[5] === "Prueba"));

    if (estado === "Activo" && lat && lng && pagoAlDia) {
      if (filtroMascotas && mascotas !== "Sí") continue; // Saltar si el filtro de mascotas está activo y no es "Sí"

      var obj = {};
      for (var j = 0; j < headers.length; j++) obj[headers[j]] = data[i][j];
      obj["Contacto"] = data[i][7] || "";
      obj["ID"] = data[i][13] || "";
      obj["Enlace para compartir"] = data[i][14] || "";
      obj["Videos"] = data[i][15] || "";
      obj["Amoblado"] = data[i][16] || "";
      obj["Operacion"] = data[i][17] || ""; // Columna R: Operacion
      // Añadir Plan y Fecha de Vencimiento desde loginData
      var loginRow = loginData.find(row => row[1] === email);
      obj["Plan"] = loginRow ? loginRow[5] || "" : "";
      obj["Fecha de Vencimiento"] = loginRow && loginRow[7] ? Utilities.formatDate(new Date(loginRow[7]), Session.getScriptTimeZone(), "dd/MM/yyyy") : "";
      obj.row = i + 1;
      alquileres.push(obj);
    }
  }
  return alquileres;
}

/* --- Obtener alquileres de un dueño específico --- */
function getAlquileres(e) {
  var email = e.parameter.dueno;
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var alquileres = [];

  for (var i = 1; i < data.length; i++) {
    var correo = data[i][1];
    if (correo === email) {
      var obj = {};
      for (var j = 0; j < headers.length; j++) obj[headers[j]] = data[i][j];
      obj["Contacto"] = data[i][7] || "";
      obj["ID"] = data[i][13] || "";
      obj["Enlace para compartir"] = data[i][14] || "";
      obj["Videos"] = data[i][15] || "";
      obj["Amoblado"] = data[i][16] || "";
      obj["Operacion"] = data[i][17] || ""; // Columna R: Operacion
      obj.row = i + 1;
      alquileres.push(obj);
    }
  }
  return alquileres;
}

/* --- Obtener detalles de una inmobiliaria y sus alquileres --- */
function getInmobiliaria(e) {
  var inmobiliariaEmail = e.parameter.email;
  if (!inmobiliariaEmail) {
    Logger.log("❌ Error en getInmobiliaria: Email no proporcionado");
    return { success: false, error: "Email de inmobiliaria no proporcionado" };
  }

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var alquileresSheet = ss.getSheetByName("Alquileres");
  var alquileresData = alquileresSheet.getDataRange().getValues();
  var headers = alquileresData[0];
  var alquileres = [];
  var inmoData = {};

  // Buscar metadata de la inmobiliaria en la hoja Login
  for (var i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === inmobiliariaEmail) { // Columna B (índice 1): Email
      inmoData = {
        Email: loginData[i][1] || "",
        Nombre: loginData[i][3] || "", // Columna D (índice 3): Nombre
        Contacto: loginData[i][4] || "",
        Plan: loginData[i][5] || "",
        EstadoPago: loginData[i][6] || "",
        Vencimiento: loginData[i][7]
          ? Utilities.formatDate(new Date(loginData[i][7]), Session.getScriptTimeZone(), "yyyy-MM-dd")
          : "",
        Inmobiliaria: loginData[i][9] || ""
      };
      break;
    }
  }

  // Si no se encontró la inmobiliaria, devolver error
  if (!inmoData.Email) {
    Logger.log("❌ Error en getInmobiliaria: Inmobiliaria no encontrada para el email: " + inmobiliariaEmail);
    return { success: false, error: "Inmobiliaria no encontrada para el email proporcionado" };
  }

  // Obtener alquileres asociados al email en columna B de Alquileres
  for (var i = 1; i < alquileresData.length; i++) {
    var tipo = alquileresData[i][0];
    var email = alquileresData[i][1];
    var estado = alquileresData[i][9];
    var lat = alquileresData[i][3];
    var lng = alquileresData[i][4];

    if (email === inmobiliariaEmail && estado === "Activo" && lat && lng) {
      var obj = {};
      for (var j = 0; j < headers.length; j++) obj[headers[j]] = alquileresData[i][j];
      obj["Contacto"] = alquileresData[i][7] || "";
      obj["ID"] = alquileresData[i][13] || "";
      obj["Enlace para compartir"] = alquileresData[i][14] || "";
      obj["Videos"] = alquileresData[i][15] || "";
      obj["Amoblado"] = alquileresData[i][16] || "";
      obj["Operacion"] = alquileresData[i][17] || ""; // Columna R: Operacion
      obj.row = i + 1;
      alquileres.push(obj);
    }
  }

  // Si no se encontraron alquileres, devolver mensaje apropiado
  if (alquileres.length === 0) {
    Logger.log("⚠️ No se encontraron alquileres activos para el email: " + inmobiliariaEmail);
    return { success: true, data: inmoData, alquileres: [], message: "No se encontraron propiedades activas para este email" };
  }

  Logger.log("✅ Inmobiliaria encontrada: " + (inmoData.Nombre || inmobiliariaEmail) + ", " + alquileres.length + " alquileres activos");
  return { success: true, data: inmoData, alquileres: alquileres };
}

/* --- Obtener detalles de un alquiler por ID --- */
function getAlquiler(e) {
  var id = e.parameter.id;
  if (!id) return { success: false, error: "ID de alquiler no proporcionado" };

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var data = sheet.getDataRange().getValues();
  var headers = data[0];

  for (var i = 1; i < data.length; i++) {
    if (data[i][13] === id) { // Columna N (14ª columna, índice 13): ID
      var email = data[i][1];
      var pagoAlDia = loginData.find(row => row[1] === email && (new Date(row[7]) >= new Date() || row[5] === "Prueba"));
      if (data[i][9] === "Activo" && pagoAlDia) {
        var obj = {
          alquiler: {
            Tipo: data[i][0],
            Direccion: data[i][2],
            Lat: data[i][3],
            Lng: data[i][4],
            "Nro Ambientes": data[i][5],
            Precio: data[i][6],
            Contacto: data[i][7] || "",
            Fotos: data[i][8] || "",
            Estado: data[i][9],
            "Informacion ingreso": data[i][10],
            Detalles: data[i][11],
            Mascotas: data[i][12],
            ID: data[i][13],
            "Enlace para compartir": data[i][14],
            Videos: data[i][15],
            Amoblado: data[i][16] || "",
            Operacion: data[i][17] || "" // Columna R: Operacion
          }
        };
        return { success: true, alquiler: obj.alquiler };
      } else {
        return { success: false, error: "Alquiler no está activo o el dueño no tiene un plan válido" };
      }
    }
  }
  return { success: false, error: "Alquiler no encontrado" };
}

/* --- Validar límite de deptos (solo activos) --- */
function validarLimiteDeptos(email) {
  const loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  const loginData = loginSheet.getDataRange().getValues();
  const dueño = loginData.find(row => row[1] === email);
  if (!dueño) throw "Dueño no encontrado";

  const plan = dueño[5] || "Basico";
  const planes = getPlanesDinamicos();
  const limite = planes[plan].limiteDeptos;

  if (limite === Infinity) return; // Sin límite para el plan Prueba

  const alquileresSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  const cantidadDeptos = alquileresSheet.getDataRange().getValues()
    .filter(r => r[1] === email && r[9] === "Activo").length;

  if (cantidadDeptos >= limite) {
    throw `Tu plan actual (${plan}) solo permite ${limite} deptos. Mejora tu plan para agregar más.`;
  }
}

/* --- Validar vencimiento --- */
function validarVencimiento(email) {
  const loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  const loginData = loginSheet.getDataRange().getValues();
  const dueño = loginData.find(row => row[1] === email);
  if (!dueño) throw "Dueño no encontrado";

  const plan = dueño[5] || "Basico";
  if (plan === "Prueba") return true; // El plan Prueba no requiere validación de pago

  const fechaVencimiento = dueño[7];
  if (!fechaVencimiento) return true;
  if (new Date() > new Date(fechaVencimiento)) throw "Tu plan está vencido. Debes renovar para poder agregar o mostrar tus deptos en el mapa.";
  return true;
}

/* --- Generar ID único --- */
function generarIdUnico() {
  return Utilities.getUuid();
}

/* --- Agregar nuevo alquiler (validando plan y vencimiento) --- */
function addAlquiler(e) {
  var email = e.parameter.dueno;
  var tipo = e.parameter.tipo; // Obtener el tipo de propiedad (e.g., Departamento, Local, Temporario)
  var operacion = e.parameter.operacion || ""; // Obtener la operación (Vender o Alquilar)

  // Validar que el tipo de propiedad sea proporcionado
  if (!tipo) {
    Logger.log("❌ Error en addAlquiler: Tipo de propiedad no proporcionado");
    return { success: false, error: "Tipo de propiedad no proporcionado" };
  }

  // Validar que la operación sea proporcionada y válida
  if (!operacion || !["Vender", "Alquilar"].includes(operacion)) {
    Logger.log("❌ Error en addAlquiler: Operación no proporcionada o inválida - " + operacion);
    return { success: false, error: "Operación debe ser 'Vender' o 'Alquilar'" };
  }

  // Validar plan y vencimiento
  try {
    validarLimiteDeptos(email);
    validarVencimiento(email);
  } catch (err) {
    Logger.log("❌ Error en addAlquiler: " + err);
    return { success: false, error: err };
  }

  // Obtener parámetros
  var direccion = e.parameter.direccion || "";
  var ambientes = e.parameter.ambientes || "";
  var precio = e.parameter.precio || "";
  var mascotas = e.parameter.mascotas || "";
  var amoblado = e.parameter.amoblado || "";
  var fotos = e.parameter.fotos || "";
  var videos = e.parameter.videos || "";
  var infoIngreso = e.parameter.infoIngreso || "";
  var detalles = e.parameter.detalles || "";
  var lat = e.parameter.lat || "";
  var lng = e.parameter.lng || "";
  var estado = e.parameter.estado || "Activo";
  var idUnico = generarIdUnico();
  var enlace = `www.alquiya.com.ar/alquiler.html?id=${idUnico}`;

  // Obtener contacto del dueño desde la hoja Login
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var contacto = "auto";
  for (var i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === email) {
      contacto = loginData[i][4] || "auto";
      break;
    }
  }

  // Validar campos obligatorios según el tipo
  if (!direccion || (tipo === "Departamento" && (!ambientes || !precio))) {
    Logger.log("❌ Error en addAlquiler: Faltan campos obligatorios");
    return { success: false, error: "Faltan campos obligatorios" };
  }

  // Guardar en la hoja Alquileres
  var alquileresSheet = ss.getSheetByName("Alquileres");
  alquileresSheet.appendRow([
    tipo, // Columna A: Tipo
    email, // Columna B: Email
    direccion, // Columna C: Direccion
    lat, // Columna D: Latitud
    lng, // Columna E: Longitud
    ambientes, // Columna F: Nro Ambientes
    precio, // Columna G: Precio
    contacto, // Columna H: Contacto
    fotos, // Columna I: Fotos
    estado, // Columna J: Estado
    infoIngreso, // Columna K: Informacion ingreso
    detalles, // Columna L: Detalles
    mascotas, // Columna M: Mascotas
    idUnico, // Columna N: ID
    enlace, // Columna O: Enlace para compartir
    videos, // Columna P: Video
    amoblado, // Columna Q: Amoblado
    operacion // Columna R: Operacion
  ]);
  SpreadsheetApp.flush(); // Forzar sincronización
  Logger.log("✅ Alquiler agregado: ID " + idUnico + ", Tipo: " + tipo + ", Operacion: " + operacion);
  return { success: true, id: idUnico, enlace: enlace };
}

/* --- Editar alquiler existente --- */
function editAlquiler(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) {
    Logger.log("❌ Error en editAlquiler: Fila inválida - " + row);
    return { success: false, error: "Fila inválida" };
  }

  var email = e.parameter.dueno;
  var tipo = e.parameter.tipo; // Obtener el tipo de propiedad
  var operacion = e.parameter.operacion; // Obtener la operación
  var estado = e.parameter.estado || "Activo";

  // Validar que la operación sea válida si se proporciona
  if (operacion && !["Vender", "Alquilar"].includes(operacion)) {
    Logger.log("❌ Error en editAlquiler: Operación inválida - " + operacion);
    return { success: false, error: "Operación debe ser 'Vender' o 'Alquilar'" };
  }

  // Validar plan y vencimiento si el estado es Activo
  if (estado === "Activo") {
    try {
      validarLimiteDeptos(email);
      validarVencimiento(email);
    } catch (err) {
      Logger.log("❌ Error en editAlquiler: " + err);
      return { success: false, error: err };
    }
  }

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var currentId = sheet.getRange(row, 14).getValue(); // Columna N: ID
  var idUnico = e.parameter.idUnico || currentId; // Preservar ID existente a menos que se proporcione uno nuevo
  var enlace = `www.alquiya.com.ar/alquiler.html?id=${idUnico}`; // Actualizar enlace

  // Validar campos obligatorios si se actualiza el tipo a Departamento
  if (tipo === "Departamento") {
    var ambientes = e.parameter.ambientes || sheet.getRange(row, 6).getValue();
    var precio = e.parameter.precio || sheet.getRange(row, 7).getValue();
    if (!ambientes || !precio) {
      Logger.log("❌ Error en editAlquiler: Faltan campos obligatorios para Departamento");
      return { success: false, error: "Faltan campos obligatorios para Departamento" };
    }
  }

  // Actualizar solo los campos proporcionados
  if (tipo) sheet.getRange(row, 1).setValue(tipo); // Columna A: Tipo
  if (e.parameter.direccion) sheet.getRange(row, 3).setValue(e.parameter.direccion); // Columna C: Direccion
  if (e.parameter.lat) sheet.getRange(row, 4).setValue(e.parameter.lat); // Columna D: Latitud
  if (e.parameter.lng) sheet.getRange(row, 5).setValue(e.parameter.lng); // Columna E: Longitud
  if (e.parameter.ambientes) sheet.getRange(row, 6).setValue(e.parameter.ambientes); // Columna F: Nro Ambientes
  if (e.parameter.precio) sheet.getRange(row, 7).setValue(e.parameter.precio); // Columna G: Precio
  if (e.parameter.contacto) sheet.getRange(row, 8).setValue(e.parameter.contacto); // Columna H: Contacto
  if (e.parameter.fotos) sheet.getRange(row, 9).setValue(e.parameter.fotos); // Columna I: Fotos
  if (e.parameter.estado) sheet.getRange(row, 10).setValue(e.parameter.estado); // Columna J: Estado
  if (e.parameter.infoIngreso) sheet.getRange(row, 11).setValue(e.parameter.infoIngreso); // Columna K: Informacion ingreso
  if (e.parameter.detalles) sheet.getRange(row, 12).setValue(e.parameter.detalles); // Columna L: Detalles
  if (e.parameter.mascotas) sheet.getRange(row, 13).setValue(e.parameter.mascotas); // Columna M: Mascotas
  if (e.parameter.idUnico) sheet.getRange(row, 14).setValue(e.parameter.idUnico); // Columna N: ID
  sheet.getRange(row, 15).setValue(enlace); // Columna O: Enlace para compartir
  if (e.parameter.videos) sheet.getRange(row, 16).setValue(e.parameter.videos); // Columna P: Video
  if (e.parameter.amoblado) sheet.getRange(row, 17).setValue(e.parameter.amoblado); // Columna Q: Amoblado
  if (operacion) sheet.getRange(row, 18).setValue(operacion); // Columna R: Operacion

  SpreadsheetApp.flush(); // Forzar sincronización
  Logger.log("✅ Alquiler editado: Fila " + row + ", ID: " + idUnico + ", Operacion: " + operacion);
  return { success: true, id: idUnico, enlace: enlace };
}

/* --- Cambiar estado Activo/Inactivo --- */
function toggleEstado(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) return { success: false, error: "Fila inválida" };

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var email = sheet.getRange(row, 2).getValue();
  var estado = sheet.getRange(row, 10).getValue();
  var nuevoEstado = estado === "Activo" ? "Inactivo" : "Activo";

  if (nuevoEstado === "Activo") {
    validarLimiteDeptos(email);
    validarVencimiento(email);
  }

  sheet.getRange(row, 10).setValue(nuevoEstado);
  SpreadsheetApp.flush(); // Forzar sincronización
  return { success: true, nuevoEstado: nuevoEstado };
}

/* --- Eliminar alquiler --- */
function deleteAlquiler(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) return { success: false, error: "Fila inválida" };

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  sheet.deleteRow(row);
  SpreadsheetApp.flush(); // Forzar sincronización
  return { success: true };
}

/* --- Verificar login --- */
function verificarLogin(e) {
  var email = e.parameter.email;
  var password = e.parameter.password;

  if (!email || !password)
    return { success: false, error: "Faltan credenciales" };

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();

  for (var i = 1; i < data.length; i++) {
    var fila = data[i];
    var tipo = fila[0];
    var correo = fila[1];
    var pass = fila[2];

    if (tipo === "Dueño" && correo === email) {
      if (String(pass) == String(password)) {
        return {
          success: true,
          tipo: tipo,
          email: correo,
          nombre: fila[3] || "",
          contacto: fila[4] || "",
          plan: fila[5] || "",
          estadoPago: fila[6] || "",
          vencimiento: fila[7]
            ? Utilities.formatDate(new Date(fila[7]), Session.getScriptTimeZone(), "yyyy-MM-dd")
            : ""
        };
      } else {
        return { success: false, error: "Contraseña incorrecta" };
      }
    }
  }

  return { success: false, error: "Usuario no registrado" };
}

/* --- Editar información del dueño --- */
function editarDueno(e) {
  var email = e.parameter.email;
  var newEmail = e.parameter.newEmail;
  var nombre = e.parameter.nombre;
  var contacto = e.parameter.contacto;
  var password = e.parameter.password;

  if (!email) {
    Logger.log("❌ Error en editarDueno: Email no proporcionado");
    return { success: false, error: "Email no proporcionado" };
  }

  if (!newEmail && !nombre && !contacto && !password) {
    Logger.log("❌ Error en editarDueno: No se proporcionaron datos para actualizar");
    return { success: false, error: "No se proporcionaron datos para actualizar" };
  }

  if (newEmail && !newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
    Logger.log("❌ Error en editarDueno: Nuevo email inválido - " + newEmail);
    return { success: false, error: "El nuevo email no es válido" };
  }

  if (password && password.length < 6) {
    Logger.log("❌ Error en editarDueno: Contraseña demasiado corta - " + password);
    return { success: false, error: "La contraseña debe tener al menos 6 caracteres" };
  }

  if (contacto && !contacto.match(/^\+\d+$/)) {
    Logger.log("❌ Error en editarDueno: Contacto inválido - " + contacto);
    return { success: false, error: "El contacto debe empezar con '+' seguido de dígitos" };
  }

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();

  // Verificar si el nuevo email ya existe (si se proporciona)
  if (newEmail && newEmail !== email) {
    for (var i = 1; i < data.length; i++) {
      if (data[i][1] === newEmail) {
        Logger.log("❌ Error en editarDueno: Nuevo email ya registrado - " + newEmail);
        return { success: false, error: "El nuevo email ya está registrado" };
      }
    }
  }

  // Actualizar información del dueño
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) {
      if (newEmail) loginSheet.getRange(i + 1, 2).setValue(newEmail);
      if (nombre) loginSheet.getRange(i + 1, 4).setValue(nombre);
      if (contacto) loginSheet.getRange(i + 1, 5).setValue(contacto);
      if (password) loginSheet.getRange(i + 1, 3).setValue(password);
      SpreadsheetApp.flush(); // Forzar sincronización
      Logger.log("✅ Dueño actualizado correctamente: " + email);
      return { success: true, message: "Datos actualizados correctamente" };
    }
  }

  Logger.log("❌ Error en editarDueno: Dueño no encontrado - " + email);
  return { success: false, error: "Dueño no encontrado" };
}

/* --- Actualizar fecha de vencimiento --- */
function actualizarFechaVencimiento(e) {
  var email = e.parameter.email;
  var dias = parseInt(e.parameter.dias) || 30; // Por defecto 30 días si no se especifica

  if (!email) {
    Logger.log("❌ Error en actualizarFechaVencimiento: Email no proporcionado");
    return { success: false, error: "Email no proporcionado" };
  }

  if (isNaN(dias) || dias < 1) {
    Logger.log("❌ Error en actualizarFechaVencimiento: Días inválidos - " + dias);
    return { success: false, error: "El número de días debe ser un número positivo" };
  }

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();

  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) {
      var fechaNueva = new Date();
      fechaNueva.setDate(fechaNueva.getDate() + dias);
      var formattedDate = Utilities.formatDate(fechaNueva, Session.getScriptTimeZone(), "dd/MM/yyyy");
      loginSheet.getRange(i + 1, 8).setValue(formattedDate); // Columna H: Fecha Vencimiento
      SpreadsheetApp.flush(); // Forzar sincronización
      Logger.log("✅ Fecha de vencimiento actualizada para " + email + ": " + formattedDate);
      return {
        success: true,
        message: "Fecha de vencimiento actualizada correctamente",
        email: email,
        fechaVencimiento: formattedDate
      };
    }
  }

  Logger.log("❌ Error en actualizarFechaVencimiento: Dueño no encontrado - " + email);
  return { success: false, error: "Dueño no encontrado" };
}

/* --- Actualizar plan tras pago de Mercado Pago --- */
function updatePlan(e, retries = 3) {
  var email = e.parameter.email || null;
  var plan = e.parameter.plan || null;
  var paymentId = e.parameter.payment_id || (e.parameter.data && e.parameter.data.id) || null;
  var estadoPago = e.parameter.estadoPago || "Aprobado";
  var descripcionPago = e.parameter.descripcionPago || null;

  // Validar parámetros de entrada
  if (!paymentId) {
    Logger.log("❌ Error en updatePlan: Faltan parámetros - payment_id: " + paymentId);
    return { success: false, error: "Falta el payment_id" };
  }
  if (!email || !plan) {
    Logger.log("❌ Error en updatePlan: email o plan faltantes - email: " + email + ", plan: " + plan);
    return { success: false, error: "Faltan parámetros email o plan" };
  }

  // Verificar el pago con Mercado Pago
  var mpAccessToken = "APP_USR-595288641172928-010710-d915bce4137b3ee26e0c6e04873f1ac1-695835795";
  var url = "https://api.mercadopago.com/v1/payments/" + encodeURIComponent(paymentId);
  var options = {
    method: "get",
    headers: { "Authorization": "Bearer " + mpAccessToken },
    muteHttpExceptions: true
  };

  try {
    var response = UrlFetchApp.fetch(url, options);
    var paymentData = JSON.parse(response.getContentText());

    // Verificar si el pago está aprobado
    if (response.getResponseCode() === 200 && paymentData.status === "approved") {
      // Extraer email y plan de external_reference si no se proporcionan
      var externalReference = paymentData.external_reference || "";
      if (externalReference && (!email || !plan)) {
        var [refEmail, refPlan] = externalReference.split("_");
        email = email || refEmail;
        plan = plan || refPlan;
      }

      // Validar email y plan
      if (!email || !plan) {
        Logger.log("❌ Error en updatePlan: email o plan faltantes después de external_reference - email: " + email + ", plan: " + plan);
        return { success: false, error: "Faltan parámetros email o plan" };
      }
      if (externalReference && externalReference !== email + "_" + plan) {
        Logger.log("❌ Error en updatePlan: external_reference no coincide - " + externalReference);
        return { success: false, error: "El external_reference no coincide con los parámetros proporcionados" };
      }

      // Validar plan contra getPlanesDinamicos
      var planesValidos = Object.keys(getPlanesDinamicos());
      if (!planesValidos.includes(plan)) {
        Logger.log("❌ Error en updatePlan: Plan inválido - " + plan);
        return { success: false, error: "Plan inválido: debe ser Prueba, Basico, Plus o Full" };
      }

      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var loginSheet = ss.getSheetByName("Login");
      var data = loginSheet.getDataRange().getValues();

      // Verificar si el payment ID ya fue procesado para evitar actualizaciones múltiples
      for (var i = 1; i < data.length; i++) {
        if (data[i][8] && data[i][8].includes(paymentId)) {
          Logger.log("❌ Error en updatePlan: Pago ya procesado - Payment ID: " + paymentId);
          return { success: false, error: "El pago ya fue procesado" };
        }
      }

      // Encontrar la fila del dueño
      for (var i = 1; i < data.length; i++) {
        if (data[i][1] === email) {
          // Calcular fecha de vencimiento: un mes desde la fecha de aprobación del pago
          var fechaAprobacion = new Date(paymentData.date_approved);
          var fechaNueva = new Date(fechaAprobacion.setMonth(fechaAprobacion.getMonth() + 1));
          var formattedDate = Utilities.formatDate(fechaNueva, Session.getScriptTimeZone(), "dd/MM/yyyy");

          // Usar la descripción de pago proporcionada o predeterminada
          var descPago = descripcionPago || `Pago plan ${plan} - ID: ${paymentId}`;

          // Actualizar plan, estado de pago, fecha de vencimiento y descripción
          loginSheet.getRange(i + 1, 6).setValue(plan); // Columna F: Plan
          loginSheet.getRange(i + 1, 7).setValue(estadoPago); // Columna G: Estado del Pago
          loginSheet.getRange(i + 1, 8).setValue(formattedDate); // Columna H: Fecha Vencimiento
          loginSheet.getRange(i + 1, 9).setValue(descPago); // Columna I: Descripción del Pago

          SpreadsheetApp.flush(); // Forzar sincronización

          // Enviar email de notificación al dueño
          var nombre = data[i][3] || "Usuario";
          var message = `Hola ${nombre},\n\nTu pago para el Plan ${plan} ha sido procesado correctamente.\nTu plan estará activo hasta el ${formattedDate}.\n\nGracias por tu suscripción.\n\nSaludos,\nEquipo Alqui Ya`;
          try {
            MailApp.sendEmail(email, "Confirmación de Pago - Alqui Ya", message);
          } catch (emailErr) {
            Logger.log("❌ Error al enviar email de confirmación: " + emailErr.message);
          }

          Logger.log("✅ Plan actualizado para " + email + ": " + plan + ", Payment ID: " + paymentId);
          return {
            success: true,
            message: "Plan actualizado correctamente",
            plan: plan,
            email: email,
            estadoPago: estadoPago,
            fechaVencimiento: formattedDate,
            descripcionPago: descPago
          };
        }
      }
      Logger.log("❌ Error en updatePlan: Dueño no encontrado - " + email);
      return { success: false, error: "Dueño no encontrado" };
    } else {
      Logger.log("❌ Error en updatePlan: Pago no aprobado - Status: " + (paymentData.status || "Desconocido") + ", Response Code: " + response.getResponseCode());
      if (retries > 0) {
        Logger.log(`Reintentando updatePlan (${retries} restantes)...`);
        Utilities.sleep(2000); // Esperar 2 segundos antes de reintentar
        return updatePlan(e, retries - 1);
      }
      return { success: false, error: "El pago no fue aprobado o no se encontró" };
    }
  } catch (err) {
    Logger.log("❌ Error en updatePlan: " + err.message);
    if (retries > 0) {
      Logger.log(`Reintentando updatePlan (${retries} restantes)...`);
      Utilities.sleep(2000); // Esperar 2 segundos antes de reintentar
      return updatePlan(e, retries - 1);
    }
    return { success: false, error: "Error al verificar el pago: " + err.message };
  }
}

/* --- Obtener información de login --- */
function getLoginInfo(e) {
  var email = e.parameter.email;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var result = [];

  for (var i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === email) {
      result.push({
        Email: loginData[i][1],
        Nombre: loginData[i][3] || "",
        Contacto: loginData[i][4] || "",
        Plan: loginData[i][5] || "",
        EstadoPago: loginData[i][6] || "",
        Vencimiento: loginData[i][7]
          ? Utilities.formatDate(new Date(loginData[i][7]), Session.getScriptTimeZone(), "yyyy-MM-dd")
          : "",
        Password: loginData[i][2] || ""
      });
    }
  }

  if (result.length === 0) {
    Logger.log("❌ Error en getLoginInfo: Dueño no encontrado - " + email);
    return { success: false, error: "Dueño no encontrado" };
  }

  return { success: true, data: result };
}

/* --- Suscribir email para notificaciones --- */
function suscribirNotificaciones(e) {
  var email = e.parameter.email;

  if (!email) {
    Logger.log("❌ Error en suscribirNotificaciones: Email no proporcionado");
    return { success: false, error: "Email no proporcionado" };
  }

  if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
    Logger.log("❌ Error en suscribirNotificaciones: Email inválido - " + email);
    return { success: false, error: "El email no es válido" };
  }

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var usuariosSheet = ss.getSheetByName("Usuarios");
  if (!usuariosSheet) {
    Logger.log("❌ Error en suscribirNotificaciones: Hoja 'Usuarios' no encontrada");
    return { success: false, error: "Hoja 'Usuarios' no encontrada" };
  }

  var data = usuariosSheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === email) {
      Logger.log("❌ Error en suscribirNotificaciones: Email ya registrado - " + email);
      return { success: false, error: "El email ya está registrado" };
    }
  }

  try {
    usuariosSheet.appendRow([email]);
    SpreadsheetApp.flush(); // Forzar sincronización
    Logger.log("✅ Email registrado para notificaciones: " + email);
    return { success: true, message: "Email registrado correctamente para notificaciones" };
  } catch (err) {
    Logger.log("❌ Error en suscribirNotificaciones: Error al guardar en la hoja - " + err.message);
    return { success: false, error: "Error al guardar en la hoja: " + err.message };
  }
}

/* --- Trigger diario para notificaciones --- */
function enviarNotificaciones() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const loginSheet = ss.getSheetByName("Login");
  const data = loginSheet.getDataRange().getValues();
  const hoy = new Date();

  for (var i = 1; i < data.length; i++) {
    const email = data[i][1];
    const nombre = data[i][3];
    const plan = data[i][5];
    const fechaVencimiento = new Date(data[i][7]);
    const diffDias = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));

    if (diffDias === 5) {
      MailApp.sendEmail(email, "Tu plan vence en 5 días", `Hola ${nombre}, tu plan ${plan} vence en 5 días. Renueva para no perder servicios.`);
    }
    if (diffDias <= 0 && plan !== "Prueba") {
      MailApp.sendEmail(email, "Plan vencido", `Hola ${nombre}, tu plan ${plan} está vencido. Renueva para seguir mostrando tus deptos.`);
      loginSheet.getRange(i + 1, 7).setValue("Pago vencido");
      SpreadsheetApp.flush(); // Forzar sincronización
    }
  }
}
