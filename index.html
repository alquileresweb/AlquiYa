<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Alquileres Santo Tomé</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body{margin:0;font-family:Arial,sans-serif}
header{background:#3483fa;color:white;padding:15px;text-align:center}
nav{display:flex;justify-content:center;gap:20px;background:#f4f4f4;padding:10px}
nav a{text-decoration:none;font-weight:bold;color:#333}
nav a:hover{color:#3483fa}
#map{height:60vh;width:100%;margin-bottom:20px;}
#filtros{max-width:700px;margin:10px auto;padding:10px;background:#f9f9f9;border:1px solid #ccc;border-radius:8px;display:none;flex-wrap:wrap;gap:10px}
#filtros input{flex:1;min-width:120px;padding:8px;border-radius:6px;border:1px solid #ccc}
#filtros button{padding:8px 15px;border-radius:6px;background:#3483fa;color:white;border:none;cursor:pointer}
#filtros button:hover{background:#2565c0}
#login,#panel-dueno,#registro{display:none;max-width:500px;margin:20px auto;padding:20px}
#alquiler-detalle{display:none;max-width:700px;margin:20px auto;padding:15px;border:2px solid #3483fa;border-radius:8px;background:#f9f9f9;box-shadow:0 0 10px rgba(0,0,0,0.1);}
#alquiler-detalle.highlight{animation: resaltar 1s ease}
#imagenes-container{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
#imagenes-container img{max-width:120px;height:90px;margin:5px;border-radius:6px;object-fit:cover;cursor:pointer;}
input,select,button{width:100%;padding:8px;margin:5px 0;border-radius:6px}
button{background:#3483fa;color:white;border:none;cursor:pointer}
button:hover{background:#2565c0}
.marker-icon {
display:flex;
align-items:center;
justify-content:center;
background:#3483fa;
color:white;
font-weight:bold;
border-radius:50%;
width:30px;
height:30px;
border:2px solid white;
box-shadow:0 0 2px #000;
}
.popup-button {
display:inline-block;
padding:5px 10px;
margin-top:5px;
background:#3483fa;
color:white;
text-decoration:none;
border-radius:5px;
font-weight:bold;
cursor:pointer;
}
@keyframes resaltar {
0% {transform:scale(1);box-shadow:0 0 10px #3483fa;}
50% {transform:scale(1.02);box-shadow:0 0 20px #2565c0;}
100% {transform:scale(1);box-shadow:0 0 10px rgba(0,0,0,0.1);}
}
/* Modal para imagen grande */
#modal-img{
display:none;
position:fixed;
top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,0.8);
align-items:center;
justify-content:center;
z-index:9999;
}
#modal-img img{
max-width:90%;
max-height:90%;
border-radius:8px;
box-shadow:0 0 15px #000;
cursor:pointer;
}
/* --- NUEVO: mensaje cargando alquileres --- */
#loading-msg {
display:none;
text-align:center;
font-weight:bold;
margin:10px;
color:#3483fa;
}
/* Estilos para el contenedor de login y registro centrado en móviles */
#login, #registro {
max-width:90%;
padding:20px;
box-sizing:border-box;
text-align:center;
}
#login h2, #registro h2 {
margin-bottom:20px;
}
#login input, #registro input, #login button, #registro button, #login select, #registro select {
max-width:300px;
margin-left:auto;
margin-right:auto;
}
.password-container {
display: flex;
align-items: center;
width: 100%;
max-width: 300px;
margin-left: auto;
margin-right: auto;
}
.password-container input {
flex: 1;
padding-right: 10px;
}
.eye-icon {
width: 20px;
height: 20px;
cursor: pointer;
background: url('https://img.icons8.com/ios/50/000000/visible.png') no-repeat center;
background-size: contain;
margin-left: 10px;
}
#reg_contacto-container {
display: flex;
gap: 10px;
max-width: 300px;
margin-left: auto;
margin-right: auto;
}
#reg_contacto-container select {
width: 30%;
}
#reg_contacto-container input {
width: 70%;
}
</style>
</head>
<body>

<header>
<h1>Alquileres Santo Tomé</h1>
<p>Encuentra tu próximo departamento fácilmente</p>
</header>

<nav>
<a href="#" onclick="mostrarMapa()">Mapa</a>
<a href="#" onclick="mostrarLogin()">Soy Dueño</a>
</nav>

<div id="boton-filtros-container" style="text-align:center;margin:10px;">
<button onclick="toggleFiltros()">Añadir Filtros</button>
</div>

<div id="filtros">
<input type="number" id="filtroAmb" placeholder="Nro de Ambientes">
<!-- switch a input text para formateo, pero mantenemos el id original -->
<input type="text" id="filtroMin" placeholder="Precio Mínimo" oninput="formatCurrency(this)">
<input type="text" id="filtroMax" placeholder="Precio Máximo" oninput="formatCurrency(this)">
<button onclick="cargarAlquileres()">Filtrar</button>
</div>

<!-- NUEVO: Mensaje de carga -->
<div id="loading-msg">Cargando alquileres disponibles...</div>

<div id="map"></div>
<div id="alquiler-detalle"></div>

<div id="login">
<h2>Login Dueños</h2>
<input type="text" id="email" placeholder="Email">
<div class="password-container">
<input type="password" id="password" placeholder="Contraseña">
<div class="eye-icon" onclick="togglePassword('password')"></div>
</div>
<button onclick="login()">Ingresar</button>
<p id="login-msg" style="color:red"></p>
<p>¿No tienes cuenta? <button onclick="mostrarRegistro()">Registrarme</button></p>
</div>

<div id="registro">
<h2>Registro Dueños</h2>
<input type="text" id="reg_email" placeholder="Email">
<input type="text" id="reg_nombre" placeholder="Nombre">
<div class="password-container">
<input type="password" id="reg_password" placeholder="Contraseña">
<div class="eye-icon" onclick="togglePassword('reg_password')"></div>
</div>
<div id="reg_contacto-container">
<select id="reg_codigo_pais">
<option value="+54">+54 (Argentina)</option>
<option value="+55">+55 (Brasil)</option>
<option value="+56">+56 (Chile)</option>
<option value="+57">+57 (Colombia)</option>
<option value="+51">+51 (Perú)</option>
<option value="+52">+52 (México)</option>
</select>
<input type="text" id="reg_contacto" placeholder="WhatsApp (ej: 3794000000)">
</div>
<button onclick="registrarDueno()">Registrar</button>
<button onclick="mostrarLogin()">Cancelar</button>
<p id="registro-msg" style="color:green"></p>
</div>

<div id="panel-dueno">
<h2>Panel de Dueños</h2>
<p id="bienvenida"></p>
<button onclick="logout()">Cerrar Sesión</button>
</div>

<!-- Modal para imagen grande -->
<div id="modal-img">
<img id="img-grande" onclick="cerrarModal()">
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* =========================
   CONFIG
========================= */
const webAppURL = "https://script.google.com/macros/s/AKfycbwDl73ZMnMowfSu_NoISSSc4fnQpLp6kaxT9Dz5jMjE9NxT64AmeN23ORQy8lejul6S/exec";
const cloudinaryURL = "https://api.cloudinary.com/v1_1/demo/image/upload";
const cloudinaryUploadPreset = "ml_default";

/* =========================
   MAPA
========================= */
let map = L.map('map').setView([-28.5503, -56.0406],14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
let markersLayer = L.layerGroup().addTo(map);

/* =========================
   UTILS
========================= */
// Lee un campo de varias formas posibles (por si cambian encabezados)
function getField(obj, keys){
  for (const k of keys){
    if (Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null && obj[k] !== "") return obj[k];
  }
  return "";
}
// Convierte precio string como "$200,000.00" o "150000" a número
function toNumber(val){
  if (typeof val === "number") return val;
  if (!val) return 0;
  const clean = String(val).replace(/[^\d.,-]/g,"").replace(/\./g,"").replace(",",".");
  const num = parseFloat(clean);
  return isNaN(num) ? 0 : num;
}
// parsea int seguro
function toInt(val, def=0){
  const n = parseInt(val,10);
  return isNaN(n) ? def : n;
}

/* =========================
   FORMATO MONEDA (inputs visibles)
   - formatCurrency(): muestra $100.000 mientras se escribe
   - parseCurrency(): convierte la cadena formateada a número usable
========================= */
function formatCurrency(el){
  let selectionStart = el.selectionStart;
  let raw = String(el.value || "");
  let digits = raw.replace(/\D/g,'');
  if(digits === '') { el.value = ''; return; }
  let n = parseInt(digits, 10);
  if(isNaN(n)) { el.value = ''; return; }
  let formatted = n.toLocaleString('es-AR');
  el.value = '$' + formatted;
  try { el.setSelectionRange(el.value.length, el.value.length); } catch(e){}
}
function parseCurrency(str){
  if(!str) return 0;
  let cleaned = String(str).replace(/[^\d]/g,'');
  if(cleaned === '') return 0;
  let num = parseInt(cleaned,10);
  return isNaN(num) ? 0 : num;
}

/* =========================
   UI NAV
========================= */
function toggleFiltros(){
  const f = document.getElementById("filtros");
  f.style.display = (f.style.display==="none"||f.style.display==="") ? "flex":"none";
}
function mostrarMapa(){
  document.getElementById("map").style.display="block";
  document.getElementById("login").style.display="none";
  document.getElementById("panel-dueno").style.display="none";
  document.getElementById("registro").style.display="none";
  document.getElementById("alquiler-detalle").style.display="none";
  document.getElementById("boton-filtros-container").style.display = "block";
  document.getElementById("loading-msg").style.display = "none";
  map.invalidateSize();
  cargarAlquileres();
}
function mostrarLogin(){
  document.getElementById("map").style.display="none";
  document.getElementById("filtros").style.display="none";
  document.getElementById("login").style.display="block";
  document.getElementById("panel-dueno").style.display="none";
  document.getElementById("registro").style.display="none";
  document.getElementById("alquiler-detalle").style.display="none";
  document.getElementById("boton-filtros-container").style.display = "none";
  document.getElementById("loading-msg").style.display = "none";
}
function mostrarRegistro(){
  document.getElementById("login").style.display="none";
  document.getElementById("registro").style.display="block";
  document.getElementById("map").style.display="none";
  document.getElementById("filtros").style.display="none";
  document.getElementById("panel-dueno").style.display="none";
  document.getElementById("alquiler-detalle").style.display="none";
  document.getElementById("boton-filtros-container").style.display = "none";
  document.getElementById("loading-msg").style.display = "none";
}

/* =========================
   AUTH
========================= */
function login(){
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  if(!email || !password){
    document.getElementById("login-msg").textContent="Ingrese email y contraseña";
    return;
  }
  fetch(webAppURL+"?action=verificarLogin&email="+encodeURIComponent(email)+"&password="+encodeURIComponent(password))
  .then(r=>r.json())
  .then(data=>{
    if (data.success) {
      localStorage.setItem("dueno", email);
      localStorage.setItem("dueno_email", email);
      window.location.href = "dueños.html";
    } else {
      if (data.error === "Usuario no registrado") {
        document.getElementById("login-msg").textContent = "Usuario no registrado";
      } else if (data.error === "Contraseña incorrecta") {
        document.getElementById("login-msg").textContent = "Contraseña incorrecta";
      } else {
        document.getElementById("login-msg").textContent = "Error en el inicio de sesión";
      }
    }
  })
  .catch(()=>{document.getElementById("login-msg").textContent="Error de conexión";});
}
function logout(){
  localStorage.removeItem("dueno");
  localStorage.removeItem("dueno_email");
  mostrarLogin();
}
function registrarDueno(){
  const email = document.getElementById("reg_email").value.trim();
  const nombre = document.getElementById("reg_nombre").value.trim();
  const password = document.getElementById("reg_password").value.trim();
  const codigoPais = document.getElementById("reg_codigo_pais").value;
  const contacto = document.getElementById("reg_contacto").value.trim();
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const contactoRegex = /^\d{9,10}$/;
  
  if (!email || !nombre || !password || !contacto) {
    document.getElementById("registro-msg").style.color = "red";
    document.getElementById("registro-msg").textContent = "Complete todos los campos";
    return;
  }
  if (!emailRegex.test(email)) {
    document.getElementById("registro-msg").style.color = "red";
    document.getElementById("registro-msg").textContent = "Ingrese un email válido";
    return;
  }
  if (!contactoRegex.test(contacto)) {
    document.getElementById("registro-msg").style.color = "red";
    document.getElementById("registro-msg").textContent = "Ingrese un número de WhatsApp válido (9-10 dígitos)";
    return;
  }
  if (password.length < 6) {
    document.getElementById("registro-msg").style.color = "red";
    document.getElementById("registro-msg").textContent = "La contraseña debe tener al menos 6 caracteres";
    return;
  }

  const formData = new FormData();
  formData.append("action", "registrarDueno");
  formData.append("sheetName", "Login");
  formData.append("email", email);
  formData.append("nombre", nombre);
  formData.append("password", password);
  formData.append("contacto", codigoPais + contacto);
  formData.append("plan", "Básico");
  formData.append("estadoPago", "al día");
  formData.append("fechaVencimiento", "30/12/2025");

  fetch(webAppURL, { method: "POST", body: formData })
    .then(response => {
      if (!response.ok) {
        throw new Error("Error en la respuesta del servidor");
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        document.getElementById("registro-msg").style.color = "green";
        document.getElementById("registro-msg").innerHTML = "Dueño registrado con éxito.<br><button onclick='mostrarLogin()'>Ir a Login</button>";
      } else {
        document.getElementById("registro-msg").style.color = "red";
        document.getElementById("registro-msg").textContent = data.error || "Error al registrar el dueño";
      }
    })
    .catch(() => {
      document.getElementById("registro-msg").style.color = "red";
      document.getElementById("registro-msg").textContent = "Error de conexión al servidor. Por favor, intenta de nuevo.";
    });
}

/* =========================
   IMÁGENES
========================= */
async function subirImagenCloudinary(file){
  const data = new FormData();
  data.append("file", file);
  data.append("upload_preset", cloudinaryUploadPreset);
  try {
    const res = await fetch(cloudinaryURL, {method:"POST", body:data});
    const json = await res.json();
    return json.secure_url;
  } catch(err){
    console.error("Error subiendo imagen a Cloudinary:", err);
    return null;
  }
}
function driveUrlDirect(url){
  let fileId = null;
  if(url && url.includes("drive.google.com")){
    let match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if(match) fileId = match[1];
    else {
      match = url.match(/id=([a-zA-Z0-9_-]+)/);
      if(match) fileId = match[1];
    }
  }
  return fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : url;
}
function abrirModal(src){
  const modal = document.getElementById("modal-img");
  const img = document.getElementById("img-grande");
  img.src = src;
  modal.style.display = "flex";
}
function cerrarModal(){
  document.getElementById("modal-img").style.display = "none";
}

/* =========================
   CARGA DE ALQUILERES
========================= */
function cargarAlquileres(){
  const loadingEl = document.getElementById("loading-msg");
  loadingEl.style.display="block";
  markersLayer.clearLayers();

  const uniIcon = L.divIcon({className:'marker-icon', html:'🎓', iconSize:[30,30], iconAnchor:[15,15]});
  const hospIcon = L.divIcon({className:'marker-icon', html:'🏥', iconSize:[30,30], iconAnchor:[15,15]});
  L.marker([-28.5509978,-56.0409727],{icon:uniIcon}).addTo(markersLayer).bindPopup("<b>Facultad Fundación Barceló</b>");
  L.marker([-28.5551127,-56.0389282],{icon:hospIcon}).addTo(markersLayer).bindPopup("<b>Hospital Universitario San Juan Bautista</b>");

  const filtroAmb = document.getElementById("filtroAmb").value;
  const filtroMin = parseCurrency(document.getElementById("filtroMin").value) || 0;
  const filtroMax = parseCurrency(document.getElementById("filtroMax").value) || Infinity;

  fetch(webAppURL + "?action=getAlquileres")
  .then(res => res.json())
  .then(res => {
    loadingEl.style.display="none";
    if(!res.success || !Array.isArray(res.data)) {
      console.error("Error al cargar alquileres:", res.error || "Respuesta inválida");
      return;
    }

    let cont = 0;

    res.data.forEach(a=>{
      const lat = parseFloat(getField(a, ["Latitud","lat","LAT","Lat"]));
      const lng = parseFloat(getField(a, ["Longitud","lng","LNG","Long"]));
      if(isNaN(lat) || isNaN(lng)) return;

      const ambVal = getField(a, ["Nro Ambientes","Ambientes","Nro de Ambientes","Nro"]);
      const nroAmb = toInt(ambVal, 0);

      const precioVal = getField(a, ["Precio","precio","$"]);
      const precio = toNumber(precioVal);

      if(filtroAmb && nroAmb !== toInt(filtroAmb)) return;
      if(precio < filtroMin || precio > filtroMax) return;

      const direccion = getField(a, ["Direccion","Dirección","Domicilio"]);
      const infoIngreso = getField(a, ["Informacion ingreso","Información ingreso","InformacionIngreso","InfoIngreso","Informacion de ingreso"]);
      const detalles = getField(a, ["Detalles","Detalle","Descripcion","Descripción"]);
      const mascotas = getField(a, ["Mascotas"]);
      const contacto = getField(a, ["Contacto","Whatsapp","WhatsApp","Tel","Telefono","Teléfono"]);

      const icon = L.divIcon({
        className:'marker-icon',
        html:'🏠<span style="font-size:12px;margin-left:2px;">'+(nroAmb||"-")+'</span>',
        iconSize:[30,30],
        iconAnchor:[15,15]
      });
      const marker = L.marker([lat,lng], {icon: icon}).addTo(markersLayer);

      const popupDiv = document.createElement('div');
      popupDiv.innerHTML = `<b>Dirección:</b> ${direccion||""}<br><b>Ambientes:</b> ${nroAmb||""}<br><b>Precio:</b> ${precioVal||""}`;

      const verBtn = document.createElement('button');
      verBtn.className = 'popup-button';
      verBtn.textContent = 'Ver Alquiler';
      verBtn.onclick = () => {
        const detalle = document.getElementById('alquiler-detalle');
        detalle.innerHTML = `<h2>Alquiler: ${direccion||''}</h2>`;

        const rows = [
          ['Ambientes', nroAmb||''],
          ['Precio', precioVal||''],
          ['Información de ingreso', infoIngreso||''],
          ['Detalles', detalles||''],
          ['Mascotas', mascotas||'']
        ];
        rows.forEach(([label,val])=>{
          const p=document.createElement('p');
          p.innerHTML=`<b>${label}:</b> ${val}`;
          detalle.appendChild(p);
        });

        const imgContainer = document.createElement('div');
        imgContainer.id = 'imagenes-container';

        const fotos = getField(a, ["Fotos","Imagenes","Imágenes","images"]);
        if(fotos){
          fotos.split(',').forEach(f=>{
            const url = driveUrlDirect(f.trim());
            if(url){
              const img = document.createElement('img');
              img.src = url;
              img.alt = "Imagen del alquiler";
              img.referrerPolicy = "no-referrer";
              img.onclick = ()=>abrirModal(img.src);
              imgContainer.appendChild(img);
            }
          });
        }
        detalle.appendChild(imgContainer);

        if(contacto){
          const waBtn = document.createElement('button');
          waBtn.textContent = 'Contactar por WhatsApp';
          waBtn.style.background = '#25D366';
          waBtn.style.color = 'white';
          waBtn.style.marginTop = '10px';
          waBtn.onclick = ()=>{
            const mensaje = `Hola, quiero consultar por el alquiler de ${direccion}`;
            window.open(`https://wa.me/${contacto}?text=${encodeURIComponent(mensaje)}`,'_blank');
          };
          detalle.appendChild(waBtn);
        }

        detalle.style.display='block';
        detalle.classList.add("highlight");
        detalle.scrollIntoView({behavior:"smooth", block:"start"});
        setTimeout(()=>detalle.classList.remove("highlight"),1200);
        map.invalidateSize();
      };
      popupDiv.appendChild(verBtn);
      marker.bindPopup(popupDiv);
      cont++;
    });

    if (cont === 0){
      console.warn("No se encontraron alquileres para los filtros actuales.");
    }
  })
  .catch(err=>{
    document.getElementById("loading-msg").style.display="none";
    console.error("Error al conectar con WebApp:",err)
  });
}

/* =========================
   PASSWORD VISIBILITY TOGGLE
========================= */
function togglePassword(inputId) {
  const input = document.getElementById(inputId);
  const eyeIcon = input.nextElementSibling;
  if (input.type === "password") {
    input.type = "text";
    eyeIcon.style.backgroundImage = "url('https://img.icons8.com/ios/50/000000/invisible.png')";
  } else {
    input.type = "password";
    eyeIcon.style.backgroundImage = "url('https://img.icons8.com/ios/50/000000/visible.png')";
  }
}

/* =========================
   INIT
========================= */
window.onload = ()=>{mostrarMapa();};
</script>
</body>
</html>
