<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SSJ5DG33JK"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-SSJ5DG33JK');
</script>
<link rel="icon" type="image/png" href="https://i.postimg.cc/MKpMcrcQ/AlquiYa.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body{margin:0;font-family:Arial,sans-serif}
header{background:white;color:white;padding:15px;text-align:center}
nav{display:flex;justify-content:center;gap:20px;background:#f4f4f4;padding:10px}
nav a{text-decoration:none;font-weight:bold;color:#333}
nav a:hover{color:#3483fa}
#map{height:60vh;width:100%;margin-bottom:20px;}
#filtros{max-width:700px;margin:10px auto;padding:10px;background:#f9f9f9;border:1px solid #ccc;border-radius:8px;display:none;flex-wrap:wrap;gap:10px}
#filtros input, #filtros select{flex:1;min-width:120px;padding:8px;border-radius:6px;border:1px solid #ccc}
#filtros button{padding:8px 15px;border-radius:6px;background:#3483fa;color:white;border:none;cursor:pointer}
#filtros button:hover{background:#2565c0}
#filtros label{display:flex;align-items:center;gap:5px;}
#filtros input[type="checkbox"]{width:auto;min-width:auto;}
#boton-filtros-container{display:flex;justify-content:center;gap:10px;margin:10px;}
#boton-filtros-container button{width:auto;padding:8px 20px}
#login,#panel-dueno,#registro,#avisos-panel{display:none;max-width:500px;margin:20px auto;padding:20px}
#alquiler-detalle{display:none;max-width:700px;margin:20px auto;padding:15px;border:2px solid #3483fa;border-radius:8px;background:#f9f9f9;box-shadow:0 0 10px rgba(0,0,0,0.1);}
#alquiler-detalle.highlight{animation: resaltar 1s ease}
#imagenes-container{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
#imagenes-container img{max-width:120px;height:90px;margin:5px;border-radius:6px;object-fit:cover;cursor:pointer;}
input,select,button{width:100%;padding:8px;margin:5px 0;border-radius:6px;box-sizing:border-box}
button{background:#3483fa;color:white;border:none;cursor:pointer}
button:hover{background:#2565c0}
.marker-icon {
display:flex;
align-items:center;
justify-content:center;
background:#3483fa;
color:white;
font-weight:bold;
border-radius:50%;
width:30px;
height:30px;
border:2px solid white;
box-shadow:0 0 2px #000;
}
.popup-button {
display:inline-block;
padding:5px 10px;
margin-top:5px;
background:#3483fa;
color:white;
text-decoration:none;
border-radius:5px;
font-weight:bold;
cursor:pointer;
}
@keyframes resaltar {
0% {transform:scale(1);box-shadow:0 0 10px #3483fa;}
50% {transform:scale(1.02);box-shadow:0 0 20px #2565c0;}
100% {transform:scale(1);box-shadow:0 0 10px rgba(0,0,0,0.1);}
}
#modal-img{
display:none;
position:fixed;
top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,0.8);
align-items:center;
justify-content:center;
z-index:9999;
}
#modal-img img{
max-width:90%;
max-height:90%;
border-radius:8px;
box-shadow:0 0 15px #000;
cursor:pointer;
}
#modal-img .close-btn {
position:absolute;
top:10px;
right:10px;
background:red;
color:white;
border:none;
border-radius:50%;
width:30px;
height:30px;
font-size:20px;
font-weight:bold;
cursor:pointer;
display:flex;
align-items:center;
justify-content:center;
}
#modal-img .nav-btn {
position:absolute;
top:50%;
transform:translateY(-50%);
background:#3483fa;
color:white;
border:none;
border-radius:50%;
width:40px;
height:40px;
font-size:24px;
font-weight:bold;
cursor:pointer;
display:flex;
align-items:center;
justify-content:center;
}
#modal-img .prev-btn {left:10px;}
#modal-img .next-btn {right:10px;}
#loading-msg {
display:none;
text-align:center;
font-weight:bold;
margin:10px;
color:#3483fa;
}
#login-loading {
display:none;
text-align:center;
font-weight:bold;
margin:10px;
color:#3483fa;
}
#login, #registro, #avisos-panel {
max-width:90%;
padding:20px;
box-sizing:border-box;
text-align:center;
}
#login h2, #registro h2, #avisos-panel h2 {
margin-bottom:20px;
}
#login input, #registro input, #avisos-panel input, #login button, #registro button, #avisos-panel button, #login select, #registro select {
max-width:300px;
margin-left:auto;
margin-right:auto;
}
.password-container {
display: flex;
align-items: center;
width: 100%;
max-width: 300px;
margin-left: auto;
margin-right: auto;
}
.password-container input {
flex: 1;
padding-right: 10px;
}
.eye-icon {
width: 20px;
height: 20px;
cursor: pointer;
background: url('https://img.icons8.com/ios/50/000000/visible.png') no-repeat center;
background-size: contain;
margin-left: 10px;
}
#reg_contacto-container {
display: flex;
flex-direction: row;
gap: 10px;
max-width: 300px;
margin-left: auto;
margin-right: auto;
align-items: center;
}
#reg_contacto-container select {
width: 30%;
min-width: 80px;
}
#reg_contacto-container input {
width: 70%;
}
#registro input#reg_email, #registro input#reg_nombre {
display: block;
}
#modal-terminos {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.5);
z-index: 10000;
align-items: center;
justify-content: center;
}
#modal-terminos-content {
background: white;
max-width: 90%;
max-height: 80%;
overflow-y: auto;
padding: 20px;
border-radius: 8px;
box-shadow: 0 0 10px rgba(0,0,0,0.3);
text-align: left;
}
#modal-terminos-content h2 {
margin-top: 0;
}
#modal-terminos-content button {
width: auto;
padding: 10px 20px;
margin-top: 20px;
}
#publicidad-container {
background: white;
border: 1px solid #ccc;
border-radius: 8px;
padding: 20px;
margin: 10px auto;
max-width: 700px;
text-align: center;
cursor: pointer;
}
#publicidad-container p {
margin: 5px 0;
font-size: 1.2em;
font-weight: bold;
color: #333;
}
#link-container {
display: flex;
align-items: center;
gap: 10px;
margin-top: 10px;
}
#link-container input {
flex: 1;
padding: 8px;
border-radius: 6px;
border: 1px solid #ccc;
}
#link-container span {
font-size: 14px;
color: #333;
white-space: nowrap;
}
#copy-msg {
display: none;
text-align: center;
margin-top: 10px;
color: green;
}
#copy-msg.error {
color: red;
}
</style>
</head>
<body>

<header>
<img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="Logo Alqui Ya" style="max-width:250px;margin-bottom:10px;">
</header>

<div id="modal-terminos">
<div id="modal-terminos-content">
<h2>Términos y Condiciones de Uso</h2>
<p><strong>Última actualización: 10/09/2025</strong></p>
<p>Bienvenido/a a AlquiYa (en adelante, “la Plataforma”).<br>
Al acceder o utilizar la Plataforma, usted acepta estos Términos y Condiciones. Si no está de acuerdo, debe abstenerse de usarla.</p>

<h3>1. Naturaleza del Servicio – Exclusión de Intermediación Inmobiliaria</h3>
<p>La Plataforma es un intermediador publicitario digital que facilita la publicación y visualización de ofertas de alquiler de inmuebles.<br>
No somos corredores inmobiliarios ni una inmobiliaria.<br>
No participamos en la negociación, celebración ni ejecución de contratos de alquiler o compraventa.<br>
Cualquier acuerdo, gestión o transacción vinculada al alquiler se realiza de manera directa entre Dueños y Usuarios, sin intervención ni responsabilidad de la Plataforma.</p>

<h3>2. Publicaciones y Responsabilidad de los Dueños</h3>
<p>Los Dueños son responsables de la información, imágenes y condiciones que publiquen.<br>
La Plataforma no garantiza la veracidad ni autenticidad de las publicaciones.<br>
Si un Usuario detecta un anuncio falso o sospechoso, podrá reportarlo a través de <a href="mailto:alquiya@gmail.com">alquiya@gmail.com</a> para que sea revisado y eventualmente eliminado.<br>
El Dueño se compromete a proporcionar datos de contacto reales y verificables (email y teléfono).</p>

<h3>3. Exención de Responsabilidad por Fraudes o Estafas</h3>
<p>La Plataforma no será responsable por fraudes, engaños o incumplimientos cometidos por Dueños o Usuarios.<br>
El Usuario reconoce y acepta que:<br>
- Debe verificar por su cuenta la existencia del inmueble y la identidad del Dueño antes de concretar operaciones.<br>
- Cualquier perjuicio económico, daño o pérdida derivados de anuncios falsos es ajeno a la responsabilidad de la Plataforma.</p>

<h3>4. Protección de Datos Personales</h3>
<p>La Plataforma cumple con la Ley de Protección de Datos Personales Nº 25.326.<br>
Los datos proporcionados serán utilizados únicamente para el funcionamiento de la Plataforma.<br>
El Usuario puede ejercer sus derechos de acceso, rectificación o supresión comunicándose a <a href="mailto:alquiya@gmail.com">alquiya@gmail.com</a>.<br>
La base de datos será registrada ante la Agencia de Acceso a la Información Pública conforme a la normativa vigente.</p>

<h3>5. Relación de Consumo – Limitaciones de Responsabilidad</h3>
<p>En caso de que el servicio contratado (ej. publicación destacada, plan pago) no funcione correctamente, el Usuario deberá notificarlo dentro de los 7 días posteriores para gestionar un ajuste o reembolso si corresponde.<br>
La responsabilidad de la Plataforma se limita estrictamente al monto abonado por el servicio contratado.<br>
En ningún caso la Plataforma será responsable por:<br>
- Lucro cesante, pérdida de chance o daños indirectos.<br>
- El éxito de la operación de alquiler entre Dueños y Usuarios.</p>

<h3>6. Contenido y Derechos de Autor</h3>
<p>El Dueño declara que cuenta con derechos de uso sobre las imágenes, textos y contenidos que publique.<br>
La Plataforma no será responsable por infracciones a derechos de autor cometidas por los Dueños.<br>
En caso de reclamo de terceros, el Dueño mantendrá indemne a la Plataforma.</p>

<h3>7. Uso Permitido</h3>
<p>Queda prohibido utilizar la Plataforma para:<br>
- Publicar información falsa, ilegal, discriminatoria o que vulnere derechos de terceros.<br>
- Suplantar la identidad de otra persona.<br>
- Subir material protegido sin autorización.</p>

<h3>8. Modificaciones</h3>
<p>La Plataforma podrá modificar los presentes Términos y Condiciones en cualquier momento, notificando a los Usuarios mediante su publicación en el sitio.</p>

<h3>9. Ley Aplicable y Jurisdicción</h3>
<p>Los presentes Términos se rigen por las leyes de la República Argentina.<br>
Cualquier conflicto será resuelto ante los tribunales ordinarios de Santo Tomé, Corrientes, renunciando expresamente a cualquier otro fuero.</p>
<button onclick="aceptarTerminos()">Aceptar Términos y Condiciones</button>
</div>
</div>

<nav>
<a href="#" onclick="mostrarMapa()">Mapa</a>
<a href="#" onclick="mostrarLogin()">Soy Dueño</a>
</nav>

<div id="boton-filtros-container">
<button onclick="toggleFiltros()">Añadir Filtros</button>
<button onclick="mostrarAvisos()">Recibir Avisos</button>
</div>

<div id="filtros">
<input type="number" id="filtroAmb" placeholder="Nro de Ambientes">
<input type="text" id="filtroMin" placeholder="Precio Mínimo" oninput="formatCurrency(this)">
<input type="text" id="filtroMax" placeholder="Precio Máximo" oninput="formatCurrency(this)">
<select id="filtroTipo">
  <option value="">Todos</option>
  <option value="Departamento">Departamento</option>
  <option value="Alquiler Temporario">Alquiler Temporario</option>
  <option value="Local Comercial">Local Comercial</option>
</select>
<label><input type="checkbox" id="filtroMascotas"> Mascotas Permitidas</label>
<label><input type="checkbox" id="filtroAmoblado"> Amoblado</label>
<button onclick="cargarAlquileres()">Filtrar</button>
</div>

<div id="avisos-panel">
<h2>Recibir Notificaciones</h2>
<input type="text" id="avisos_email" placeholder="Email">
<button onclick="registrarEmailAvisos()">Suscribirse</button>
<button onclick="mostrarMapa()">Cancelar</button>
<p id="avisos-msg" style="color:green"></p>
</div>

<div id="loading-msg">Cargando alquileres disponibles...</div>

<div id="map"></div>
<div id="rapiclean-img-container">
<a href="https://wa.me/5493756617167?text=Hola" target="_blank">
<img src="https://i.postimg.cc/NMMZQ3YG/M-s-de-40-estudiantes-ya-confiaron-en-Rapiclean-1.png" alt="Más de 40 estudiantes confiaron en Rapiclean" style="max-width:100%;margin:10px auto;display:block;">
</a>
<a href="https://wa.me/5493764275443?text=Hola,+quiero+publicitar+en+AlquiYa&utm_source=chatgpt.com" target="_blank">
<div id="publicidad-container">
<p>Espacio Publicitario</p>
<p>Haz clic para publicitar aquí</p>
</div>
</a>
</div>
<div id="alquiler-detalle"></div>

<div id="login">
<h2>Login Dueños</h2>
<input type="text" id="email" placeholder="Email">
<div class="password-container">
<input type="password" id="password" placeholder="Contraseña">
<div class="eye-icon" onclick="togglePassword('password')"></div>
</div>
<button onclick="login()">Ingresar</button>
<p id="login-loading" style="color:#3483fa">Iniciando sesión...</p>
<p>¿No tienes cuenta?</p>
<p><button onclick="mostrarRegistro()">Registrarme</button></p>
<p id="login-msg" style="color:red"></p>
</div>

<div id="registro">
<h2>Registro Dueños</h2>
<input type="text" id="reg_email" placeholder="Email">
<input type="text" id="reg_nombre" placeholder="Nombre">
<div class="password-container">
<input type="password" id="reg_password" placeholder="Contraseña">
<div class="eye-icon" onclick="togglePassword('reg_password')"></div>
</div>
<div id="reg_contacto-container">
<select id="reg_codigo_pais">
<option value="+54">+54 (Argentina)</option>
<option value="+55">+55 (Brasil)</option>
<option value="+56">+56 (Chile)</option>
<option value="+57">+57 (Colombia)</option>
<option value="+51">+51 (Perú)</option>
<option value="+52">+52 (México)</option>
</select>
<input type="text" id="reg_contacto" placeholder="WhatsApp (ej: 3794000000)">
</div>
<button onclick="registrarDueno()">Registrar</button>
<button onclick="mostrarLogin()">Cancelar</button>
<p id="registro-msg" style="color:green"></p>
</div>

<div id="panel-dueno">
<h2>Panel de Dueños</h2>
<p id="bienvenida"></p>
<button onclick="logout()">Cerrar Sesión</button>
</div>

<div id="modal-img">
<img id="img-grande">
<button class="close-btn" onclick="cerrarModal()">X</button>
<button class="nav-btn prev-btn" onclick="cambiarImagen(-1)">&lt;</button>
<button class="nav-btn next-btn" onclick="cambiarImagen(1)">&gt;</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* =========================
CONFIG
*/
const webAppURL = "https://script.google.com/macros/s/AKfycbwDl73ZMnMowfSu_NoISSSc4fnQpLp6kaxT9Dz5jMjE9NxT64AmeN23ORQy8lejul6S/exec";
const cloudinaryURL = "https://api.cloudinary.com/v1_1/dnugmwern/image/upload";
const cloudinaryUploadPreset = "preset_alquileres";
let currentImages = [];
let currentImageIndex = 0;

/* =========================
MAPA
*/
let map = L.map('map').setView([-28.5503, -56.0406],14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
let markersLayer = L.layerGroup().addTo(map);

/* =========================
UTILS
*/
function getField(obj, keys){
for (const k of keys){
if (Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null && obj[k] !== "") return obj[k];
}
return "";
}
function toNumber(val){
if (typeof val === "number") return val;
if (!val) return 0;
const clean = String(val).replace(/[^\d.,-]/g,"").replace(/\./g,"").replace(",",".");
const num = parseFloat(clean);
return isNaN(num) ? 0 : num;
}
function toInt(val, def=0){
const n = parseInt(val,10);
return isNaN(n) ? def : n;
}

/* =========================
FORMATO MONEDA
*/
function formatCurrency(el){
let selectionStart = el.selectionStart;
let raw = String(el.value || "");
let digits = raw.replace(/\D/g,'');
if(digits === '') { el.value = ''; return; }
let n = parseInt(digits, 10);
if(isNaN(n)) { el.value = ''; return; }
let formatted = n.toLocaleString('es-AR');
el.value = '$' + formatted;
try { el.setSelectionRange(el.value.length, el.value.length); } catch(e){}
}
function parseCurrency(str){
if(!str) return 0;
let cleaned = String(str).replace(/[^\d]/g,'');
if(cleaned === '') return 0;
let num = parseInt(cleaned,10);
return isNaN(num) ? 0 : num;
}
function formatPrice(num) {
if (!num) return "";
const clean = String(num).replace(/[^\d]/g, "");
const formatted = parseInt(clean, 10).toLocaleString('es-AR');
return "$" + formatted.replace(/,/g, ".");
}

/* =========================
UI NAV
*/
function toggleFiltros(){
const f = document.getElementById("filtros");
f.style.display = (f.style.display==="none"||f.style.display==="") ? "flex":"none";
}
function mostrarMapa(){
document.getElementById("map").style.display="block";
document.getElementById("login").style.display="none";
document.getElementById("panel-dueno").style.display="none";
document.getElementById("registro").style.display="none";
document.getElementById("avisos-panel").style.display="none";
document.getElementById("alquiler-detalle").style.display="none";
document.getElementById("boton-filtros-container").style.display = "flex";
document.getElementById("loading-msg").style.display = "none";
document.getElementById("rapiclean-img-container").style.display = "block";
map.invalidateSize();
cargarAlquileres();
}
function mostrarLogin(){
document.getElementById("map").style.display="none";
document.getElementById("filtros").style.display="none";
document.getElementById("login").style.display="block";
document.getElementById("panel-dueno").style.display="none";
document.getElementById("registro").style.display="none";
document.getElementById("avisos-panel").style.display="none";
document.getElementById("alquiler-detalle").style.display="none";
document.getElementById("boton-filtros-container").style.display = "none";
document.getElementById("loading-msg").style.display = "none";
document.getElementById("rapiclean-img-container").style.display = "none";
document.getElementById("login-loading").style.display = "none";
}
function mostrarRegistro(){
document.getElementById("login").style.display="none";
document.getElementById("registro").style.display="block";
document.getElementById("map").style.display="none";
document.getElementById("filtros").style.display="none";
document.getElementById("panel-dueno").style.display="none";
document.getElementById("avisos-panel").style.display="none";
document.getElementById("alquiler-detalle").style.display="none";
document.getElementById("boton-filtros-container").style.display = "none";
document.getElementById("loading-msg").style.display = "none";
document.getElementById("rapiclean-img-container").style.display = "none";
}
function mostrarAvisos(){
document.getElementById("map").style.display="none";
document.getElementById("filtros").style.display="none";
document.getElementById("login").style.display="none";
document.getElementById("panel-dueno").style.display="none";
document.getElementById("registro").style.display="none";
document.getElementById("avisos-panel").style.display="block";
document.getElementById("alquiler-detalle").style.display="none";
document.getElementById("boton-filtros-container").style.display = "none";
document.getElementById("loading-msg").style.display = "none";
document.getElementById("rapiclean-img-container").style.display = "none";
}

/* =========================
TÉRMINOS Y CONDICIONES
*/
function mostrarTerminos() {
const terminosAceptados = localStorage.getItem("terminosAceptados");
if (!terminosAceptados) {
document.getElementById("modal-terminos").style.display = "flex";
}
}
function aceptarTerminos() {
localStorage.setItem("terminosAceptados", "true");
document.getElementById("modal-terminos").style.display = "none";
}

/* =========================
AUTH
*/
function login(){
const email = document.getElementById("email").value.trim();
const password = document.getElementById("password").value.trim();
if(!email || !password){
document.getElementById("login-msg").textContent="Ingrese email y contraseña";
document.getElementById("login-loading").style.display = "none";
return;
}
document.getElementById("login-loading").style.display = "block";
document.getElementById("login-msg").textContent = "";
fetch(webAppURL+"?action=verificarLogin&email="+encodeURIComponent(email)+"&password="+encodeURIComponent(password))
.then(r=>r.json())
.then(data=>{
document.getElementById("login-loading").style.display = "none";
if (data.success) {
localStorage.setItem("dueno", email);
localStorage.setItem("dueno_email", email);
window.location.href = "dueños.html";
} else {
if (data.error === "Usuario no registrado") {
document.getElementById("login-msg").textContent = "Usuario no registrado";
} else if (data.error === "Contraseña incorrecta") {
document.getElementById("login-msg").textContent = "Contraseña incorrecta";
} else {
document.getElementById("login-msg").textContent = "Error en el inicio de sesión";
}
}
})
.catch(()=>{
document.getElementById("login-loading").style.display = "none";
document.getElementById("login-msg").textContent="Error de conexión";
});
}
function logout(){
localStorage.removeItem("dueno");
localStorage.removeItem("dueno_email");
mostrarLogin();
}
function registrarDueno() {
const email = document.getElementById("reg_email").value.trim();
const nombre = document.getElementById("reg_nombre").value.trim();
const password = document.getElementById("reg_password").value.trim();
const codigoPais = document.getElementById("reg_codigo_pais").value;
const contacto = document.getElementById("reg_contacto").value.trim();

const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
const contactoRegex = /^\d{9,10}$/;

if (!email || !nombre || !password || !contacto) {
document.getElementById("registro-msg").style.color = "red";
document.getElementById("registro-msg").textContent = "Complete todos los campos";
return;
}
if (!emailRegex.test(email)) {
document.getElementById("registro-msg").style.color = "red";
document.getElementById("registro-msg").textContent = "Ingrese un email válido";
return;
}
if (!contactoRegex.test(contacto)) {
document.getElementById("registro-msg").style.color = "red";
document.getElementById("registro-msg").textContent = "Ingrese un número de WhatsApp válido (9-10 dígitos)";
return;
}
if (password.length < 6) {
document.getElementById("registro-msg").style.color = "red";
document.getElementById("registro-msg").textContent = "La contraseña debe tener al menos 6 caracteres";
return;
}

const params = new URLSearchParams();
params.append("action", "registrarDueno");
params.append("email", email);
params.append("nombre", nombre);
params.append("password", password);
params.append("contacto", codigoPais + contacto);

console.log("Enviando URLSearchParams:", params.toString());

fetch(webAppURL, {
method: "POST",
body: params,
headers: {
"Content-Type": "application/x-www-form-urlencoded"
},
mode: "no-cors"
})
.then(() => {
document.getElementById("registro-msg").style.color = "green";
document.getElementById("registro-msg").innerHTML = "Dueño registrado con éxito.<br><button onclick='mostrarLogin()'>Ir a Login</button>";
setTimeout(() => mostrarLogin(), 2000);
})
.catch(error => {
console.error("Error en registro:", error);
document.getElementById("registro-msg").style.color = "red";
document.getElementById("registro-msg").textContent = "Error al conectar con el servidor. Por favor, intenta de nuevo.";
});
}

/* =========================
REGISTRO DE EMAILS PARA AVISOS
*/
function registrarEmailAvisos() {
const email = document.getElementById("avisos_email").value.trim();
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

if (!email) {
document.getElementById("avisos-msg").style.color = "red";
document.getElementById("avisos-msg").textContent = "Ingrese un email";
return;
}
if (!emailRegex.test(email)) {
document.getElementById("avisos-msg").style.color = "red";
document.getElementById("avisos-msg").textContent = "Ingrese un email válido";
return;
}

const params = new URLSearchParams();
params.append("action", "suscribirNotificaciones");
params.append("email", email);

console.log("Enviando solicitud:", webAppURL, params.toString());

fetch(webAppURL, {
method: "POST",
body: params,
headers: {
"Content-Type": "application/x-www-form-urlencoded"
},
mode: "no-cors"
})
.then(() => {
document.getElementById("avisos-msg").style.color = "green";
document.getElementById("avisos-msg").textContent = "Email registrado con éxito para recibir notificaciones.";
document.getElementById("avisos_email").value = "";
setTimeout(() => mostrarMapa(), 2000);
})
.catch(error => {
console.error("Error en la solicitud:", error);
document.getElementById("avisos-msg").style.color = "red";
document.getElementById("avisos-msg").textContent = `Error en la solicitud: ${error.message}`;
});
}

/* =========================
IMÁGENES
*/
async function subirImagenCloudinary(file){
const data = new FormData();
data.append("file", file);
data.append("upload_preset", cloudinaryUploadPreset);
try {
const res = await fetch(cloudinaryURL, {method:"POST", body:data});
const json = await res.json();
return json.secure_url;
} catch(err){
console.error("Error subiendo imagen a Cloudinary:", err);
return null;
}
}
function driveUrlDirect(url){
let fileId = null;
if(url && url.includes("drive.google.com")){
let match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
if(match) fileId = match[1];
else {
match = url.match(/id=([a-zA-Z0-9_-]+)/);
if(match) fileId = match[1];
}
}
return fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : url;
}
function abrirModal(src, images, index){
currentImages = images;
currentImageIndex = index;
const modal = document.getElementById("modal-img");
const img = document.getElementById("img-grande");
img.src = src;
modal.style.display = "flex";
document.querySelector(".prev-btn").style.display = images.length > 1 ? "block" : "none";
document.querySelector(".next-btn").style.display = images.length > 1 ? "block" : "none";
}
function cerrarModal(){
document.getElementById("modal-img").style.display = "none";
currentImages = [];
currentImageIndex = 0;
}
function cambiarImagen(direction){
currentImageIndex = (currentImageIndex + direction + currentImages.length) % currentImages.length;
document.getElementById("img-grande").src = currentImages[currentImageIndex];
}

/* =========================
CARGA DE ALQUILERES
*/
function cargarAlquileres(){
const loadingEl = document.getElementById("loading-msg");
loadingEl.style.display="block";
markersLayer.clearLayers();

const uniIcon = L.divIcon({className:'marker-icon', html:'🎓', iconSize:[30,30], iconAnchor:[15,15]});
const hospIcon = L.divIcon({className:'marker-icon', html:'🏥', iconSize:[30,30], iconAnchor:[15,15]});
const superIcon = L.divIcon({className:'marker-icon', html:'🛒', iconSize:[30,30], iconAnchor:[15,15]});
const busIcon = L.divIcon({className:'marker-icon', html:'🚌', iconSize:[30,30], iconAnchor:[15,15]});
const policeIcon = L.divIcon({className:'marker-icon', html:'👮', iconSize:[30,30], iconAnchor:[15,15]});

L.marker([-28.5509978,-56.0409727],{icon:uniIcon}).addTo(markersLayer).bindPopup("<b>Facultad Fundación Barceló</b>");
L.marker([-28.5551127,-56.0389282],{icon:hospIcon}).addTo(markersLayer).bindPopup("<b>Hospital Universitario San Juan Bautista</b>");
L.marker([-28.5519443,-56.0401962],{icon:superIcon}).addTo(markersLayer).bindPopup("<b>Supermercado La Bomba</b>");
L.marker([-28.5472635,-56.0438082],{icon:superIcon}).addTo(markersLayer).bindPopup("<b>Supermercado El Super</b>");
L.marker([-28.5462903,-56.0440365],{icon:superIcon}).addTo(markersLayer).bindPopup("<b>Supermercado La Economía</b>");
L.marker([-28.5468697,-56.0432862],{icon:busIcon}).addTo(markersLayer).bindPopup("<b>Terminal de Omnibus</b>");
L.marker([-28.5487787,-56.0396171],{icon:policeIcon}).addTo(markersLayer).bindPopup("<b>Policía</b>");

const filtroAmb = document.getElementById("filtroAmb").value;
const filtroMin = parseCurrency(document.getElementById("filtroMin").value) || 0;
const filtroMax = parseCurrency(document.getElementById("filtroMax").value) || Infinity;
const filtroMascotas = document.getElementById("filtroMascotas").checked;
const filtroAmoblado = document.getElementById("filtroAmoblado").checked;
const filtroTipo = document.getElementById("filtroTipo").value;

fetch(webAppURL + "?action=getAlquileres")
.then(res => res.json())
.then(res => {
loadingEl.style.display="none";
if(!res.success || !Array.isArray(res.data)) {
console.error("Error al cargar alquileres:", res.error || "Respuesta inválida");
return;
}

let cont = 0;

res.data.forEach(a=>{
const lat = parseFloat(getField(a, ["Latitud","lat","LAT","Lat"]));
const lng = parseFloat(getField(a, ["Longitud","lng","LNG","Long"]));
if(isNaN(lat) || isNaN(lng)) return;

const tipo = getField(a, ["Tipo"]);
const ambVal = getField(a, ["Nro Ambientes","Ambientes","Nro de Ambientes","Nro"]);
const nroAmb = toInt(ambVal, 0);

const precioVal = getField(a, ["Precio","precio","$"]);
const precio = toNumber(precioVal);
const formattedPrecio = formatPrice(precioVal);

if(filtroAmb && nroAmb !== toInt(filtroAmb)) return;
if(precio < filtroMin || precio > filtroMax) return;
const mascotas = getField(a, ["Mascotas"]);
if(filtroMascotas && (!mascotas || mascotas.toLowerCase() !== "sí")) return;
const amoblado = getField(a, ["Amoblado"]);
if(filtroAmoblado && (!amoblado || amoblado.toLowerCase() !== "sí")) return;

if (filtroTipo) {
  const tipoMap = {
    "Departamento": "alquiler",
    "Alquiler Temporario": "Temporario",
    "Local Comercial": "Local"
  };
  if (tipo !== tipoMap[filtroTipo]) return;
}

const direccion = getField(a, ["Direccion","Dirección","Domicilio"]);
const infoIngreso = getField(a, ["Informacion ingreso","Información ingreso","InformacionIngreso","InfoIngreso","Informacion de ingreso"]);
const detalles = getField(a, ["Detalles","Detalle","Descripcion","Descripción"]);
const contacto = getField(a, ["Contacto","Whatsapp","WhatsApp","Tel","Telefono","Teléfono"]);
const enlace = getField(a, ["Enlace para compartir"]);

let iconHtml;
if (tipo === "Temporario") {
iconHtml = '⌛';
} else if (tipo === "Local") {
iconHtml = '🛍️';
} else {
iconHtml = '🏠<span style="font-size:12px;margin-left:2px;">'+(nroAmb||"-")+'</span>';
}

const icon = L.divIcon({
className:'marker-icon',
html: iconHtml,
iconSize:[30,30],
iconAnchor:[15,15]
});
const marker = L.marker([lat,lng], {icon: icon}).addTo(markersLayer);

const popupDiv = document.createElement('div');
popupDiv.innerHTML = `<b>Dirección:</b> ${direccion||""}`;
if (tipo !== "Temporario" && tipo !== "Local") {
popupDiv.innerHTML += `<br><b>Ambientes:</b> ${nroAmb||""}<br><b>Precio:</b> ${formattedPrecio||""}`;
}

const verBtn = document.createElement('button');
verBtn.className = 'popup-button';
verBtn.textContent = 'Ver Alquiler';
verBtn.onclick = () => {
const detalle = document.getElementById('alquiler-detalle');
detalle.innerHTML = `<h2>Alquiler: ${direccion||''}</h2>`;

const rows = (tipo === "Temporario" || tipo === "Local") ? [
['Dirección', direccion||''],
['Información de ingreso', infoIngreso||''],
['Detalles', detalles||'']
] : [
['Dirección', direccion||''],
['Ambientes', nroAmb||''],
['Precio', formattedPrecio||''],
['Información de ingreso', infoIngreso||''],
['Detalles', detalles||''],
['Mascotas', mascotas||''],
['Amoblado', amoblado||'']
];
rows.forEach(([label,val])=>{
const p=document.createElement('p');
p.innerHTML=`<b>${label}:</b> ${val}`;
detalle.appendChild(p);
});

const imgContainer = document.createElement('div');
imgContainer.id = 'imagenes-container';

const fotos = getField(a, ["Fotos","Imagenes","Imágenes","images"]);
let imageUrls = [];
if(fotos){
imageUrls = fotos.split(',').map(f => driveUrlDirect(f.trim())).filter(url => url);
imageUrls.forEach((url, index) => {
const img = document.createElement('img');
img.src = url;
img.alt = "Imagen del alquiler";
img.referrerPolicy = "no-referrer";
img.onclick = () => abrirModal(url, imageUrls, index);
imgContainer.appendChild(img);
});
}
detalle.appendChild(imgContainer);

if(contacto){
const waBtn = document.createElement('button');
waBtn.textContent = 'Contactar por WhatsApp';
waBtn.style.background = '#25D366';
waBtn.style.color = 'white';
waBtn.style.marginTop = '10px';
waBtn.onclick = ()=>{
const mensaje = `Hola, vengo desde AlquiYa y quiero consultar por el alquiler de ${direccion}`;
window.open(`https://wa.me/${contacto}?text=${encodeURIComponent(mensaje)}`,'_blank');
};
detalle.appendChild(waBtn);
}

if(enlace){
const linkContainer = document.createElement('div');
linkContainer.id = 'link-container';
const linkInput = document.createElement('input');
linkInput.type = 'text';
linkInput.value = enlace;
const copyText = document.createElement('span');
copyText.textContent = 'Seleccioná y copiá para compartir';
linkContainer.appendChild(linkInput);
linkContainer.appendChild(copyText);
detalle.appendChild(linkContainer);
}

const copyMsg = document.createElement('p');
copyMsg.id = 'copy-msg';
detalle.appendChild(copyMsg);

detalle.style.display='block';
detalle.classList.add("highlight");
detalle.scrollIntoView({behavior:"smooth", block:"start"});
setTimeout(()=>detalle.classList.remove("highlight"),1200);
map.invalidateSize();
};
popupDiv.appendChild(verBtn);
marker.bindPopup(popupDiv);
cont++;
});

if (cont === 0){
console.warn("No se encontraron alquileres para los filtros actuales.");
}
})
.catch(err=>{
document.getElementById("loading-msg").style.display="none";
console.error("Error al conectar con WebApp:",err)
});
}

/* =========================
PASSWORD VISIBILITY TOGGLE
*/
function togglePassword(inputId) {
const input = document.getElementById(inputId);
const eyeIcon = input.nextElementSibling;
if (input.type === "password") {
input.type = "text";
eyeIcon.style.backgroundImage = "url('https://img.icons8.com/ios/50/000000/invisible.png')";
} else {
input.type = "password";
eyeIcon.style.backgroundImage = "url('https://img.icons8.com/ios/50/000000/visible.png')";
}
}

/* =========================
INIT
*/
window.onload = ()=>{
mostrarTerminos();
mostrarMapa();
};
</script>
</body>
</html>
