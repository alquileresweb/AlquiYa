<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Due√±os</title>
<style>
/* --- estilos originales --- */
body { font-family: Arial, sans-serif; margin: 20px; background:#f5f5f5; }
h2 { color:#333; }
.alquiler { border:1px solid #ccc; padding:10px; margin:10px 0; background:#fff; }
button { margin: 5px; padding: 5px 10px; cursor:pointer; }
#formulario { background:#fff; padding:15px; border:1px solid #ccc; margin-top:20px; }
label { display:block; margin:8px 0 4px; }
input, select, textarea { width:100%; padding:8px; margin-bottom:10px; }
.preview-img { max-width: 120px; margin-top: 5px; display:inline-block; position:relative; }
.preview-img-container { display:inline-block; margin-right:5px; position:relative; }
.delete-img { position:absolute; top:0; right:0; background:red; color:white; border:none; border-radius:50%; cursor:pointer; }
#planStatus { margin:10px 0; font-weight:bold; }
progress { width: 100%; height:20px; }
#modalPlan { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
#modalContent { background:#fff; padding:20px; width:400px; border-radius:8px; }
.plan-option { border:1px solid #ccc; padding:10px; margin:10px 0; }
.plan-option button { margin-top:5px; }
</style>
</head>
<body>
<h2 id="bienvenida"></h2>
<button onclick="logout()">Cerrar Sesi√≥n</button>

<div id="planStatus"></div>
<button id="btnPlan" onclick="abrirModalPlan()">üí≥ Mejorar Plan</button>

<h3>üìã Mis Alquileres</h3>
<div id="listaAlquileres">Cargando...</div>

<h3 id="tituloForm">‚ûï Agregar Alquiler</h3>
<div id="formulario">
<input type="hidden" id="editRow" value="">
<label>Direcci√≥n</label>
<input type="text" id="direccion">
<label>Ambientes</label>
<input type="number" id="ambientes">
<label>Precio</label>
<input type="text" id="precio">
<label>Mascotas Permitidas</label>
<select id="mascotas">
<option value="S√≠">S√≠</option>
<option value="No">No</option>
</select>
<label>Im√°genes del Alquiler (PNG/JPG, m√∫ltiples)</label>
<input type="file" id="imagenFile" accept="image/png, image/jpeg" multiple>
<div id="previewContainer"></div>
<label>Informaci√≥n de ingreso</label>
<textarea id="infoIngreso" rows="2"></textarea>
<label>Detalles</label>
<textarea id="detalles" rows="3"></textarea>
<button id="btnGuardar" onclick="agregarAlquiler()">Agregar</button>
<p id="msg" style="color:green"></p>
</div>

<!-- Modal de Planes -->
<div id="modalPlan">
  <div id="modalContent">
    <h3>Selecciona tu plan</h3>
    <div class="plan-option">
      <b>B√°sico</b><br>Hasta 3 deptos activos.<br>
      <button onclick="seleccionarPlan('Basico')">Elegir B√°sico</button>
    </div>
    <div class="plan-option">
      <b>Plus</b><br>Hasta 5 deptos activos.<br>
      <button onclick="seleccionarPlan('Plus')">Elegir Plus</button>
    </div>
    <div class="plan-option">
      <b>Full</b><br>Hasta 10 deptos activos.<br>
      <button onclick="seleccionarPlan('Full')">Elegir Full</button>
    </div>
    <button onclick="cerrarModalPlan()">Cancelar</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dnugmwern/image/upload";
const CLOUDINARY_UPLOAD_PRESET = "preset_alquileres";
let imagenesBase64 = [];
let planActual = null;
let limiteDeptos = 0;
let deptosActivos = 0;
let fechaVencimiento = null;

// ================== FORMATO DE PRECIO ==================
function formatoPrecio(valor){
  if(!valor) return "";
  valor = valor.toString().replace(/\D/g,"");
  return "$" + valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
document.getElementById("precio").addEventListener("input", function(){
  const cursorPos = this.selectionStart;
  const valorSinSimbolo = this.value.replace(/\D/g,'');
  this.value = formatoPrecio(valorSinSimbolo);
  this.selectionEnd = cursorPos;
});

// ================== PREVIEW IM√ÅGENES ==================
function actualizarPreview(){
  const previewContainer = document.getElementById("previewContainer");
  previewContainer.innerHTML = "";
  imagenesBase64.forEach((imgBase64, index) => {
    const container = document.createElement("div");
    container.className = "preview-img-container";
    const img = document.createElement("img");
    img.src = imgBase64;
    img.className = "preview-img";
    const btnDel = document.createElement("button");
    btnDel.className = "delete-img";
    btnDel.textContent = "x";
    btnDel.onclick = ()=>{ imagenesBase64.splice(index,1); actualizarPreview(); };
    container.appendChild(img);
    container.appendChild(btnDel);
    previewContainer.appendChild(container);
  });
}
document.getElementById("imagenFile").addEventListener("change", function(){
  const files = Array.from(this.files);
  files.forEach(file=>{
    const reader = new FileReader();
    reader.onload = function(e){
      imagenesBase64.push(e.target.result);
      actualizarPreview();
    }
    reader.readAsDataURL(file);
  });
});

// ================== SUBIR IM√ÅGENES ==================
async function subirImagenCloudinary(file){
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
  try {
    const res = await fetch(CLOUDINARY_URL, { method:"POST", body:formData });
    const json = await res.json();
    return json.secure_url;
  } catch(err){
    console.error("Error subiendo imagen a Cloudinary:", err);
    return null;
  }
}

// ================== INICIO ==================
window.onload = function(){
  const email = localStorage.getItem("dueno");
  if(!email){ window.location.href="index.html"; return; }
  document.getElementById("bienvenida").textContent = "Bienvenido, " + email;
  cargarEstadoPlan();
  cargarAlquileres();
}

// ================== ESTADO DE PLAN ==================
function cargarEstadoPlan(){
  const email = localStorage.getItem("dueno");
  const script = document.createElement("script");
  script.src = `${API_URL}?action=getLoginInfo&email=${encodeURIComponent(email)}&callback=mostrarEstadoPlan`;
  document.body.appendChild(script);
}

function mostrarEstadoPlan(res){
  if(!res.success || !res.data || res.data.length===0){
    planActual = null;
    limiteDeptos = 0;
    deptosActivos = 0;
    fechaVencimiento = null;
    document.getElementById("planStatus").innerHTML = `No tienes plan activo`;
    document.getElementById("btnPlan").textContent = "Elegir Plan";
    return;
  }
  planActual = res.data[0].Plan;
  fechaVencimiento = res.data[0].Vencimiento;
  const estadoPago = res.data[0].EstadoPago==="Al d√≠a"?"‚úÖ Pago al d√≠a":"‚ö†Ô∏è Pago vencido";
  limiteDeptos = planActual==="Basico"?3:planActual==="Plus"?5:10;
  deptosActivos = res.data[0].deptosActivos;

  document.getElementById("planStatus").innerHTML = `Plan: <b>${planActual}</b> | Estado de Pago: ${estadoPago} | Vencimiento: ${fechaVencimiento}<br>
    Deptos activos: ${deptosActivos}/${limiteDeptos} <br>
    <progress value="${deptosActivos}" max="${limiteDeptos}"></progress>`;
  document.getElementById("btnPlan").textContent = planActual?"üí≥ Mejorar Plan":"Elegir Plan";
}

// ================== ABRIR / CERRAR MODAL PLAN ==================
function abrirModalPlan(){ document.getElementById("modalPlan").style.display="flex"; }
function cerrarModalPlan(){ document.getElementById("modalPlan").style.display="none"; }

// ================== SELECCIONAR PLAN ==================
function seleccionarPlan(plan){
  const email = localStorage.getItem("dueno");
  const script = document.createElement("script");
  script.src = `${API_URL}?action=mejorarPlan&email=${encodeURIComponent(email)}&plan=${encodeURIComponent(plan)}&callback=recargarPlan`;
  document.body.appendChild(script);
  cerrarModalPlan();
}
function recargarPlan(res){ if(res.success){ alert("‚úÖ Plan actualizado"); cargarEstadoPlan(); } else alert("‚ùå Error al actualizar plan: "+(res.error||"desconocido")); }

// ================== CARGAR ALQUILERES ==================
function cargarAlquileres() {
  const email = localStorage.getItem("dueno");
  const script = document.createElement("script");
  script.src = `${API_URL}?action=getLoginInfo&email=${encodeURIComponent(email)}&callback=mostrarAlquileres`;
  document.body.appendChild(script);
}

function mostrarAlquileres(res){
  const div = document.getElementById("listaAlquileres");
  div.innerHTML = "";
  if(!res.success || !res.data || res.data.length===0 || !res.data[0].data || res.data[0].data.length===0){
    div.innerHTML="No tienes alquileres a√∫n.";
    return;
  }
  res.data[0].data.forEach(alq => {
    let estado = alq.Estado === "Activo" ? "Activo ‚úÖ" : "Inactivo ‚ùå";
    let btnEstado = `<button onclick="cambiarEstado(${alq.row})">Cambiar Estado</button>`;
    let btnEditar = `<button onclick='editarAlquiler(${alq.row}, ${JSON.stringify(alq)})'>Editar</button>`;
    let btnEliminar = `<button onclick="eliminarAlquiler(${alq.row})">Eliminar</button>`;
    let precioFormateado = formatoPrecio(alq.Precio);
    div.innerHTML += `<div class="alquiler">
      <b>${alq.Direccion}</b> - ${alq['Nro Ambientes']} amb - ${precioFormateado} - Mascotas: ${alq.Mascotas || "N/D"}<br>
      Estado: ${estado}<br>
      ${btnEstado} ${btnEditar} ${btnEliminar}
    </div>`;
  });
}

// ================== AGREGAR / EDITAR ==================
async function agregarAlquiler(){
  if(deptosActivos >= limiteDeptos){ alert(`Tu plan actual (${planActual}) permite m√°ximo ${limiteDeptos} deptos activos.`); return; }
  let direccion = document.getElementById("direccion").value;
  const ambientes = document.getElementById("ambientes").value;
  let precio = document.getElementById("precio").value.replace(/\D/g,"");
  const mascotas = document.getElementById("mascotas").value;
  const infoIngreso = document.getElementById("infoIngreso").value;
  const detalles = document.getElementById("detalles").value;
  let row = document.getElementById("editRow").value || new Date().getTime();
  const email = localStorage.getItem("dueno");
  if(!direccion || !ambientes || !precio){ alert("Completa todos los campos obligatorios."); return; }
  direccion += ", Santo Tom√© Corrientes";
  const msgEl = document.getElementById("msg");
  if(document.getElementById("editRow").value) msgEl.textContent = "Guardando cambios...";
  const files = document.getElementById("imagenFile").files;
  let uploadedURLs = [];
  for(let i=0;i<files.length;i++){
    const url = await subirImagenCloudinary(files[i]);
    if(url) uploadedURLs.push(url);
  }
  enviarAlquiler(uploadedURLs.join(","));
  function enviarAlquiler(fotosConcatenadas){
    const action = document.getElementById("editRow").value?"editAlquiler":"addAlquiler";
    const callback = action==="editAlquiler"?"alquilerEditado":"alquilerAgregado";
    const script = document.createElement("script");
    script.src = `${API_URL}?action=${action}&row=${row}&dueno=${encodeURIComponent(email)}&direccion=${encodeURIComponent(direccion)}&ambientes=${encodeURIComponent(ambientes)}&precio=${encodeURIComponent(precio)}&mascotas=${encodeURIComponent(mascotas)}&fotos=${encodeURIComponent(fotosConcatenadas)}&infoIngreso=${encodeURIComponent(infoIngreso)}&detalles=${encodeURIComponent(detalles)}&contacto=auto&callback=${callback}`;
    document.body.appendChild(script);
  }
}

// ================== RESTO DE FUNCIONES ==================
function editarAlquiler(row, datos){
  document.getElementById("tituloForm").textContent="‚úèÔ∏è Editar Alquiler";
  document.getElementById("btnGuardar").textContent="Guardar Cambios";
  document.getElementById("editRow").value=row;
  document.getElementById("direccion").value=datos.Direccion||"";
  document.getElementById("ambientes").value=datos["Nro Ambientes"]||"";
  document.getElementById("precio").value=formatoPrecio(datos.Precio);
  document.getElementById("mascotas").value=datos.Mascotas||"No";
  document.getElementById("infoIngreso").value=datos.InfoIngreso||"";
  document.getElementById("detalles").value=datos.Detalles||"";
  imagenesBase64 = datos.Fotos?datos.Fotos.split(","):[];
  actualizarPreview();
  window.scrollTo(0,document.getElementById("formulario").offsetTop);
}
function resetForm(){
  document.getElementById("tituloForm").textContent="‚ûï Agregar Alquiler";
  document.getElementById("btnGuardar").textContent="Agregar";
  document.getElementById("editRow").value="";
  document.getElementById("direccion").value="";
  document.getElementById("ambientes").value="";
  document.getElementById("precio").value="";
  document.getElementById("mascotas").value="S√≠";
  document.getElementById("infoIngreso").value="";
  document.getElementById("detalles").value="";
  document.getElementById("imagenFile").value="";
  imagenesBase64=[];
  actualizarPreview();
  document.getElementById("msg").textContent="";
}
function cambiarEstado(row){
  const script = document.createElement("script");
  script.src = `${API_URL}?action=toggleEstado&row=${row}&callback=cargarAlquileres`;
  document.body.appendChild(script);
}
function eliminarAlquiler(row){
  if(!confirm("¬øSeguro que deseas eliminar este alquiler?")) return;
  const script = document.createElement("script");
  script.src = `${API_URL}?action=deleteAlquiler&row=${row}&callback=cargarAlquileres`;
  document.body.appendChild(script);
}
function logout(){ localStorage.removeItem("dueno"); window.location.href="index.html"; }
function alquilerAgregado(res){
  if(res.success){ alert("‚úÖ Alquiler agregado"); resetForm(); cargarAlquileres(); cargarEstadoPlan(); }
  else alert("‚ùå Error al agregar: "+(res.error||"desconocido"));
}
function alquilerEditado(res){
  const msgEl = document.getElementById("msg");
  if(res.success){ msgEl.textContent="‚úÖ Cambios guardados"; resetForm(); cargarAlquileres(); }
  else msgEl.textContent="‚ùå Error al editar: "+(res.error||"desconocido");
}
</script>
</body>
</html>
