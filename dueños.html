/* --- Datos de Cloudinary --- */
const CLOUDINARY_CLOUD_NAME = "dnugmwern";
const CLOUDINARY_API_KEY = "877726879255954";
const CLOUDINARY_API_SECRET = "t8CStqLDqd1hs3P9Hkr4lqicIQU";
const CLOUDINARY_UPLOAD_PRESET = "preset_alquileres"; // Crea uno en tu panel de Cloudinary

/* --- Clave secreta para verificación de webhooks --- */
const WEBHOOK_SECRET = "2a2b5b39aefa97460ab135de0ee6c2363bf7bfde8a9b621304751e5789bafa58";

/* --- Obtener precios y límites dinámicos desde la hoja "Planes" --- */
function getPlanesDinamicos() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("Planes");
  var data = sheet.getRange("E2:G2").getValues()[0]; // fila 2, columnas E,F,G
  return {
    Basico: { limiteDeptos: 3, limiteFotos: 3, destacar: 0, precio: data[0] || 0 },
    Plus:   { limiteDeptos: 5, limiteFotos: 5, destacar: 1, precio: data[1] || 0 },
    Full:   { limiteDeptos: 10, limiteFotos: 99, destacar: 99, precio: data[2] || 0 }
  };
}

/* --- Manejo principal de solicitudes GET --- */
function doGet(e) {
  var action = e.parameter.action;
  var callback = e.parameter.callback || null;
  var res = {};

  try {
    if (action == "getAlquileres") {
      res = { success: true, data: getAlquileresActivos() };
    } else if (action == "addAlquiler") {
      res = addAlquiler(e);
    } else if (action == "editAlquiler") {
      res = editAlquiler(e);
    } else if (action == "toggleEstado") {
      res = toggleEstado(e);
    } else if (action == "deleteAlquiler") {
      res = deleteAlquiler(e);
    } else if (action == "registerDueno") {
      res = registerDueno(e);
    } else if (action == "getAlquileresDueno") {
      res = { success: true, data: getAlquileres(e) };
    } else if (action == "mejorarPlan") {
      res = mejorarPlan(e);
    } else if (action == "getLoginInfo") {
      res = getLoginInfo(e);
    } else if (action == "verificarLogin") {
      res = verificarLogin(e);
    } else if (action == "getPlanes") {
      res = getPlanes();
    } else if (action == "editarDueno") {
      res = editarDueno(e);
    } else if (action == "updatePlan") {
      res = updatePlan(e);
    } else {
      res = { success: false, error: "Acción no reconocida" };
    }
  } catch (err) {
    res = { success: false, error: err.message };
  }

  var json = JSON.stringify(res);
  if (callback) {
    return ContentService.createTextOutput(callback + "(" + json + ");")
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  } else {
    return ContentService.createTextOutput(json)
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/* --- Manejo de solicitudes POST (Webhooks y FormData) --- */
function doPost(e) {
  try {
    // Handle FormData requests for registrarDueno
    if (e.parameters && e.parameters.action && e.parameters.action === "registrarDueno") {
      var params = e.parameters;
      var response = registerDueno({
        parameter: {
          email: params.email,
          password: params.password,
          nombre: params.nombre,
          contacto: params.contacto
        }
      });
      return ContentService.createTextOutput(JSON.stringify(response))
        .setMimeType(ContentService.MimeType.JSON);
    }

    // Handle JSON requests, including Mercado Pago webhooks
    if (e.postData && e.postData.contents) {
      const params = JSON.parse(e.postData.contents);

      // Handle Mercado Pago webhook for payment events
      if (params.type === "payment" && params.data && params.data.id) {
        // Verify webhook signature
        var signature = e.parameter['x-signature'] || '';
        var requestId = e.parameter['x-request-id'] || '';
        var timestamp = signature.split(',')[0]?.split('ts=')[1] || '';
        var signatureHash = signature.split(',')[1]?.split('v1=')[1] || '';
        var expectedSignature = Utilities.computeHmacSha256Signature(
          timestamp + '.' + requestId + '.' + e.postData.contents,
          WEBHOOK_SECRET
        ).reduce(function(str, byte) {
          return str + ('0' + (byte & 0xFF).toString(16)).slice(-2);
        }, '');
        
        if (signatureHash !== expectedSignature) {
          Logger.log("❌ Error en doPost: Firma de webhook inválida - " + signature);
          return ContentService.createTextOutput(JSON.stringify({ success: false, error: "Firma de webhook inválida" }))
            .setMimeType(ContentService.MimeType.JSON)
            .setHttpStatusCode(401);
        }

        var externalReference = params.data.external_reference || "";
        var [email, plan] = externalReference.split("_");
        if (!email || !plan) {
          Logger.log("❌ Error en doPost: external_reference inválido - " + externalReference);
          return ContentService.createTextOutput(JSON.stringify({ success: false, error: "external_reference inválido" }))
            .setMimeType(ContentService.MimeType.JSON)
            .setHttpStatusCode(400);
        }

        var response = updatePlan({
          parameter: {
            payment_id: params.data.id,
            email: email,
            plan: plan,
            estadoPago: "Aprobado",
            fechaVencimiento: new Date(new Date().setDate(new Date().getDate() + 30)).toLocaleDateString("es-AR"),
            descripcionPago: `Pago plan ${plan} - ID: ${params.data.id}`
          }
        });
        return ContentService.createTextOutput(JSON.stringify(response))
          .setMimeType(ContentService.MimeType.JSON)
          .setHttpStatusCode(200);
      }

      // Subir imágenes Base64 a Cloudinary
      if (params.action === "uploadImagesCloudinary" && params.images) {
        const links = [];
        params.images.forEach((b64, i) => {
          try {
            const url = subirImagenCloudinary(b64);
            if (url) links.push(url);
          } catch (err) {
            Logger.log("❌ Error subiendo a Cloudinary: " + err.message);
          }
        });
        if (params.row && links.length > 0) {
          const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
          sheet.getRange(parseInt(params.row), 9).setValue(links.join(","));
        }
        return ContentService.createTextOutput(JSON.stringify({ success: true, links }))
          .setMimeType(ContentService.MimeType.JSON);
      }

      // Forward JSON-based actions to doGet
      return doGet({ parameter: params });
    }

    return ContentService.createTextOutput(JSON.stringify({ success: false, error: "POST vacío" }))
      .setMimeType(ContentService.MimeType.JSON)
      .setHttpStatusCode(400);

  } catch (err) {
    Logger.log("❌ Error en doPost: " + err.message);
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: err.message }))
      .setMimeType(ContentService.MimeType.JSON)
      .setHttpStatusCode(500);
  }
}

/* --- Subir imagen Base64 a Cloudinary --- */
function subirImagenCloudinary(base64Data) {
  const endpoint = "https://api.cloudinary.com/v1_1/" + CLOUDINARY_CLOUD_NAME + "/image/upload";
  const payload = {
    file: base64Data,
    upload_preset: CLOUDINARY_UPLOAD_PRESET
  };
  const options = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(payload)
  };
  const response = UrlFetchApp.fetch(endpoint, options);
  const data = JSON.parse(response.getContentText());
  return data.secure_url;
}

/* --- Obtener todos los alquileres activos (solo dueños con pago al día) --- */
function getAlquileresActivos() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var alquileres = [];

  for (var i = 1; i < data.length; i++) {
    var tipo = data[i][0];
    var estado = data[i][9];
    var lat = data[i][3];
    var lng = data[i][4];
    var email = data[i][1];
    var dueño = loginData.find(row => row[1] === email);
    var pagoAlDia = dueño && new Date(dueño[7]) >= new Date();

    if (tipo === "alquiler" && estado === "Activo" && lat && lng && pagoAlDia) {
      var obj = {};
      for (var j = 0; j < headers.length; j++) obj[headers[j]] = data[i][j];
      obj["Contacto"] = data[i][7] || "";
      obj.row = i + 1;
      alquileres.push(obj);
    }
  }
  return alquileres;
}

/* --- Obtener alquileres de un dueño específico --- */
function getAlquileres(e) {
  var email = e.parameter.dueno;
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var alquileres = [];

  for (var i = 1; i < data.length; i++) {
    var tipo = data[i][0];
    var correo = data[i][1];
    if (tipo === "alquiler" && correo === email) {
      var obj = {};
      for (var j = 0; j < headers.length; j++) obj[headers[j]] = data[i][j];
      obj["Contacto"] = data[i][7] || "";
      obj.row = i + 1;
      alquileres.push(obj);
    }
  }
  return alquileres;
}

/* --- Validar límite de deptos (solo activos) --- */
function validarLimiteDeptos(email) {
  const loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  const loginData = loginSheet.getDataRange().getValues();
  const dueño = loginData.find(row => row[1] === email);
  if (!dueño) throw "Dueño no encontrado";

  const plan = dueño[5] || "Basico";
  const planes = getPlanesDinamicos();
  const limite = planes[plan].limiteDeptos;

  const alquileresSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  const cantidadDeptos = alquileresSheet.getDataRange().getValues()
    .filter(r => r[0] === "alquiler" && r[1] === email && r[9] === "Activo").length;

  if (cantidadDeptos >= limite) throw `Tu plan actual (${plan}) solo permite ${limite} deptos. Mejora tu plan para agregar más.`;
}

/* --- Validar vencimiento --- */
function validarVencimiento(email) {
  const loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  const loginData = loginSheet.getDataRange().getValues();
  const dueño = loginData.find(row => row[1] === email);
  if (!dueño) throw "Dueño no encontrado";

  const fechaVencimiento = dueño[7];
  if (!fechaVencimiento) return true;
  if (new Date() > new Date(fechaVencimiento)) throw "Tu plan está vencido. Debes renovar para poder agregar o mostrar tus deptos en el mapa.";
  return true;
}

/* --- Agregar nuevo alquiler (validando plan y vencimiento) --- */
function addAlquiler(e) {
  var email = e.parameter.dueno;

  validarLimiteDeptos(email);
  validarVencimiento(email);

  var direccion = e.parameter.direccion;
  var ambientes = e.parameter.ambientes;
  var precio = e.parameter.precio;
  var mascotas = e.parameter.mascotas || "";
  var fotos = e.parameter.fotos || "";
  var infoIngreso = e.parameter.infoIngreso || "";
  var detalles = e.parameter.detalles || "";
  var lat = e.parameter.lat || "";
  var lng = e.parameter.lng || "";

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var contacto = "auto";
  for (var i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === email) {
      contacto = loginData[i][4] || "auto";
      break;
    }
  }

  var alquileresSheet = ss.getSheetByName("Alquileres");
  alquileresSheet.appendRow([
    "alquiler", email, direccion, lat, lng, ambientes, precio, contacto, fotos, "Activo", infoIngreso, detalles, mascotas
  ]);
  return { success: true };
}

/* --- Editar alquiler existente --- */
function editAlquiler(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) return { success: false, error: "Fila inválida" };

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");

  if (e.parameter.direccion) sheet.getRange(row, 3).setValue(e.parameter.direccion);
  if (e.parameter.lat) sheet.getRange(row, 4).setValue(e.parameter.lat);
  if (e.parameter.lng) sheet.getRange(row, 5).setValue(e.parameter.lng);
  if (e.parameter.ambientes) sheet.getRange(row, 6).setValue(e.parameter.ambientes);
  if (e.parameter.precio) sheet.getRange(row, 7).setValue(e.parameter.precio);
  if (e.parameter.mascotas) sheet.getRange(row, 13).setValue(e.parameter.mascotas);
  if (e.parameter.infoIngreso) sheet.getRange(row, 11).setValue(e.parameter.infoIngreso);
  if (e.parameter.detalles) sheet.getRange(row, 12).setValue(e.parameter.detalles);
  if (e.parameter.fotos) sheet.getRange(row, 9).setValue(e.parameter.fotos);

  return { success: true };
}

/* --- Cambiar estado Activo/Inactivo --- */
function toggleEstado(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) return { success: false, error: "Fila inválida" };

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var estado = sheet.getRange(row, 10).getValue();
  var nuevoEstado = estado === "Activo" ? "Inactivo" : "Activo";
  sheet.getRange(row, 10).setValue(nuevoEstado);

  return { success: true, nuevoEstado: nuevoEstado };
}

/* --- Eliminar alquiler --- */
function deleteAlquiler(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) return { success: false, error: "Fila inválida" };

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  sheet.deleteRow(row);
  return { success: true };
}

/* --- Registrar dueño --- */
function registerDueno(e) {
  var email = e.parameter.email;
  var password = e.parameter.password;
  var nombre = e.parameter.nombre;
  var contacto = e.parameter.contacto;

  // Validate input parameters
  if (!email || !password || !nombre || !contacto) {
    Logger.log("❌ Error en registerDueno: Faltan datos - email: " + email + ", password: " + password + ", nombre: " + nombre + ", contacto: " + contacto);
    return { success: false, error: "Faltan datos requeridos" };
  }

  // Validate email format
  if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
    Logger.log("❌ Error en registerDueno: Email inválido - " + email);
    return { success: false, error: "El email no es válido" };
  }

  // Validate password length
  if (password.length < 6) {
    Logger.log("❌ Error en registerDueno: Contraseña demasiado corta - " + password);
    return { success: false, error: "La contraseña debe tener al menos 6 caracteres" };
  }

  // Validate contacto format
  if (!contacto.match(/^\+\d+$/)) {
    Logger.log("❌ Error en registerDueno: Contacto inválido - " + contacto);
    return { success: false, error: "El contacto debe empezar con '+' seguido de dígitos" };
  }

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();

  // Check for existing email
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) {
      Logger.log("❌ Error en registerDueno: Email ya registrado - " + email);
      return { success: false, error: "El email ya está registrado" };
    }
  }

  // Append new owner to Login sheet
  try {
    loginSheet.appendRow([
      "Dueño", email, password, nombre, contacto
    ]);
    Logger.log("✅ Dueño registrado correctamente: " + email);
    return { success: true, message: "Dueño registrado correctamente" };
  } catch (err) {
    Logger.log("❌ Error al registrar dueño en la hoja Login: " + err.message);
    return { success: false, error: "Error al guardar en la hoja: " + err.message };
  }
}

/* --- Verificar login --- */
function verificarLogin(e) {
  var email = e.parameter.email;
  var password = e.parameter.password;

  if (!email || !password)
    return { success: false, error: "Faltan credenciales" };

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();

  for (var i = 1; i < data.length; i++) {
    var fila = data[i];
    var tipo = fila[0];
    var correo = fila[1];
    var pass = fila[2];

    if (tipo === "Dueño" && correo === email) {
      if (String(pass) == String(password)) {
        return {
          success: true,
          tipo: tipo,
          email: correo,
          nombre: fila[3] || "",
          contacto: fila[4] || "",
          plan: fila[5] || "",
          estadoPago: fila[6] || "",
          vencimiento: fila[7]
            ? Utilities.formatDate(new Date(fila[7]), Session.getScriptTimeZone(), "yyyy-MM-dd")
            : ""
        };
      } else {
        return { success: false, error: "Contraseña incorrecta" };
      }
    }
  }

  return { success: false, error: "Usuario no registrado" };
}

/* --- Mejorar plan --- */
function mejorarPlan(e) {
  var email = e.parameter.email;
  var nuevoPlan = e.parameter.plan;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();

  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) {
      var fechaNueva = new Date();
      fechaNueva.setDate(fechaNueva.getDate() + 30);
      loginSheet.getRange(i + 1, 6).setValue(nuevoPlan);
      loginSheet.getRange(i + 1, 7).setValue("Pago al día");
      loginSheet.getRange(i + 1, 8).setValue(fechaNueva);
      SpreadsheetApp.flush(); // Forzar sincronización
      return { success: true, message: "Plan actualizado correctamente" };
    }
  }
  return { success: false, error: "Dueño no encontrado" };
}

/* --- Actualizar plan tras pago de Mercado Pago --- */
function updatePlan(e) {
  var email = e.parameter.email || null;
  var plan = e.parameter.plan || null;
  var paymentId = e.parameter.payment_id || (e.parameter.data && e.parameter.data.id) || null;
  var estadoPago = e.parameter.estadoPago || "Aprobado";
  var fechaVencimiento = e.parameter.fechaVencimiento || null;
  var descripcionPago = e.parameter.descripcionPago || null;

  // Validate input parameters
  if (!paymentId) {
    Logger.log("❌ Error en updatePlan: Faltan parámetros - payment_id: " + paymentId);
    return { success: false, error: "Falta el payment_id" };
  }
  if (!email || !plan) {
    Logger.log("❌ Error en updatePlan: email o plan faltantes - email: " + email + ", plan: " + plan);
    return { success: false, error: "Faltan parámetros email o plan" };
  }

  // Verify payment with Mercado Pago
  var mpAccessToken = "APP_USR-595288641172928-010710-d915bce4137b3ee26e0c6e04873f1ac1-695835795";
  var url = "https://api.mercadopago.com/v1/payments/" + encodeURIComponent(paymentId);
  var options = {
    method: "get",
    headers: { "Authorization": "Bearer " + mpAccessToken },
    muteHttpExceptions: true
  };

  try {
    var response = UrlFetchApp.fetch(url, options);
    var paymentData = JSON.parse(response.getContentText());

    // Check if payment is approved
    if (response.getResponseCode() === 200 && paymentData.status === "approved") {
      // Extract email and plan from external_reference if not provided
      var externalReference = paymentData.external_reference || "";
      if (externalReference && (!email || !plan)) {
        var [refEmail, refPlan] = externalReference.split("_");
        email = email || refEmail;
        plan = plan || refPlan;
      }

      // Validate email and plan
      if (!email || !plan) {
        Logger.log("❌ Error en updatePlan: email o plan faltantes después de external_reference - email: " + email + ", plan: " + plan);
        return { success: false, error: "Faltan parámetros email o plan" };
      }
      if (externalReference && externalReference !== email + "_" + plan) {
        Logger.log("❌ Error en updatePlan: external_reference no coincide - " + externalReference);
        return { success: false, error: "El external_reference no coincide con los parámetros proporcionados" };
      }

      // Validate plan against getPlanesDinamicos
      var planesValidos = Object.keys(getPlanesDinamicos());
      if (!planesValidos.includes(plan)) {
        Logger.log("❌ Error en updatePlan: Plan inválido - " + plan);
        return { success: false, error: "Plan inválido: debe ser Basico, Plus o Full" };
      }

      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var loginSheet = ss.getSheetByName("Login");
      var data = loginSheet.getDataRange().getValues();

      // Find the owner's row
      for (var i = 1; i < data.length; i++) {
        if (data[i][1] === email) {
          // Use provided fechaVencimiento or calculate default (30 days from now)
          var fechaNueva = fechaVencimiento
            ? new Date(fechaVencimiento)
            : new Date(new Date().setDate(new Date().getDate() + 30));
          var formattedDate = Utilities.formatDate(fechaNueva, Session.getScriptTimeZone(), "dd/MM/yyyy");

          // Use provided descripcionPago or default
          var descPago = descripcionPago || `Pago plan ${plan} - ID: ${paymentId}`;

          // Update plan, payment status, expiration date, and payment description
          loginSheet.getRange(i + 1, 6).setValue(plan); // Column F: Plan
          loginSheet.getRange(i + 1, 7).setValue(estadoPago); // Column G: Estado del Pago
          loginSheet.getRange(i + 1, 8).setValue(formattedDate); // Column H: Fecha Vencimiento
          loginSheet.getRange(i + 1, 9).setValue(descPago); // Column I: Descripción del Pago

          // Send notification email to the owner
          var nombre = data[i][3] || "Usuario";
          var message = `Hola ${nombre},\n\nTu pago para el ${"Plan " + plan} ha sido procesado correctamente.\nTu plan estará activo hasta el ${formattedDate}.\n\nGracias por tu suscripción.\n\nSaludos,\nEquipo Alqui Ya`;
          MailApp.sendEmail(email, "Confirmación de Pago - Alqui Ya", message);

          SpreadsheetApp.flush(); // Forzar sincronización
          Logger.log("✅ Plan actualizado para " + email + ": " + plan + ", Payment ID: " + paymentId);
          return {
            success: true,
            message: "Plan actualizado correctamente",
            plan: plan,
            email: email,
            estadoPago: estadoPago,
            fechaVencimiento: formattedDate,
            descripcionPago: descPago
          };
        }
      }
      Logger.log("❌ Error en updatePlan: Dueño no encontrado - " + email);
      return { success: false, error: "Dueño no encontrado" };
    } else {
      Logger.log("❌ Error en updatePlan: Pago no aprobado - Status: " + (paymentData.status || "Desconocido") + ", Response Code: " + response.getResponseCode());
      return { success: false, error: "El pago no fue aprobado o no se encontró" };
    }
  } catch (err) {
    Logger.log("❌ Error en updatePlan: Error al verificar el pago - " + err.message);
    return { success: false, error: "Error al verificar el pago: " + err.message };
  }
}

/* --- Callbacks JSONP --- */
function alquilerAgregado(res) {
  if (res.success) return { success: true, message: "Alquiler agregado con éxito" };
  else return { success: false, error: res.error || "Error al agregar el alquiler" };
}

function alquilerEditado(res) {
  if (res.success) return { success: true, message: "Alquiler editado con éxito" };
  else return { success: false, error: res.error || "Error al editar el alquiler" };
}

/* --- Trigger diario para notificaciones --- */
function enviarNotificaciones() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const loginSheet = ss.getSheetByName("Login");
  const data = loginSheet.getDataRange().getValues();
  const hoy = new Date();

  for (var i = 1; i < data.length; i++) {
    const email = data[i][1];
    const nombre = data[i][3];
    const fechaVencimiento = new Date(data[i][7]);
    const diffDias = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));

    if (diffDias === 5) {
      MailApp.sendEmail(email, "Tu plan vence en 5 días", `Hola ${nombre}, tu plan vence en 5 días. Renueva para no perder servicios.`);
    }
    if (diffDias <= 0) {
      MailApp.sendEmail(email, "Plan vencido", `Hola ${nombre}, tu plan está vencido. Renueva para seguir mostrando tus deptos.`);
      loginSheet.getRange(i + 1, 7).setValue("Pago vencido");
    }
  }
}

/* --- Obtener información de login --- */
function getLoginInfo(e) {
  var email = e.parameter.email;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var alquileresSheet = ss.getSheetByName("Alquileres");
  var alquileresData = alquileresSheet.getDataRange().getValues();
  var result = [];

  for (var i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === email) {
      var plan = loginData[i][5] || "Basico";
      var estadoPago = loginData[i][6] || "Pago al día";
      var vencimiento = loginData[i][7] ? Utilities.formatDate(new Date(loginData[i][7]), Session.getScriptTimeZone(), "yyyy-MM-dd") : "";
      var deptosActivos = 0;
      for (var j = 1; j < alquileresData.length; j++) {
        if (alquileresData[j][0] === "alquiler" && alquileresData[j][1] === email && alquileresData[j][9] === "Activo") {
          deptosActivos++;
        }
      }

      result.push({
        Email: loginData[i][1],
        Nombre: loginData[i][3] || "",
        Contacto: loginData[i][4] || "",
        Password: loginData[i][2] || "",
        Plan: plan,
        EstadoPago: estadoPago,
        Vencimiento: vencimiento,
        deptosActivos: deptosActivos,
        data: alquileresData.slice(1).filter(r => r[0] === "alquiler" && r[1] === email).map((r, index) => {
          return {
            row: index + 2,
            Direccion: r[2],
            "Nro Ambientes": r[5],
            Precio: r[6],
            Mascotas: r[12],
            Estado: r[9],
            Fotos: r[8],
            InfoIngreso: r[10],
            Detalles: r[11]
          };
        })
      });
      break;
    }
  }

  return { success: true, data: result };
}

/* --- Obtener planes dinámicamente --- */
function getPlanes() {
  const planes = getPlanesDinamicos();
  var planesArray = [];
  for (var key in planes) {
    planesArray.push({ nombre: key, ...planes[key] });
  }
  return { success: true, data: planesArray };
}

/* --- Editar datos de un dueño --- */
function editarDueno(e) {
  var email = e.parameter.email;
  var newEmail = e.parameter.newEmail;
  var nombre = e.parameter.nombre;
  var contacto = e.parameter.contacto;
  var password = e.parameter.password;

  if (!email)
    return { success: false, error: "Falta el email del dueño" };

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();
  var rowIndex = -1;

  // Find the owner
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) {
      rowIndex = i + 1;
      break;
    }
  }

  if (rowIndex === -1)
    return { success: false, error: "Dueño no encontrado" };

  // Validate newEmail if provided
  if (newEmail) {
    if (!newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/))
      return { success: false, error: "El nuevo email no es válido" };

    for (var i = 1; i < data.length; i++) {
      if (data[i][1] === newEmail && i + 1 !== rowIndex)
        return { success: false, error: "El nuevo email ya está registrado" };
    }
    loginSheet.getRange(rowIndex, 2).setValue(newEmail); // Update Email (column B)
  }

  // Validate and update password if provided
  if (password && password.length < 6)
    return { success: false, error: "La contraseña debe tener al menos 6 caracteres" };
  if (password)
    loginSheet.getRange(rowIndex, 3).setValue(password); // Update Password (column C)

  // Validate and update nombre if provided
  if (nombre)
    loginSheet.getRange(rowIndex, 4).setValue(nombre); // Update Nombre (column D)

  // Validate and update contacto if provided
  if (contacto && !contacto.match(/^\+\d+$/))
    return { success: false, error: "El contacto debe empezar con '+' seguido de dígitos" };
  if (contacto)
    loginSheet.getRange(rowIndex, 5).setValue(contacto); // Update Contacto (column E)

  SpreadsheetApp.flush(); // Forzar sincronización
  return { success: true, message: "Datos del dueño actualizados correctamente" };
}

/* --- Obtener planes dinámicamente --- */
function getPlanes() {
  const planes = getPlanesDinamicos();
  var planesArray = [];
  for (var key in planes) {
    planesArray.push({ nombre: key, ...planes[key] });
  }
  return { success: true, data: planesArray };
}

/* --- Editar datos de un dueño --- */
function editarDueno(e) {
  var email = e.parameter.email;
  var newEmail = e.parameter.newEmail;
  var nombre = e.parameter.nombre;
  var contacto = e.parameter.contacto;
  var password = e.parameter.password;

  if (!email)
    return { success: false, error: "Falta el email del dueño" };

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();
  var rowIndex = -1;

  // Find the owner
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) {
      rowIndex = i + 1;
      break;
    }
  }

  if (rowIndex === -1)
    return { success: false, error: "Dueño no encontrado" };

  // Validate newEmail if provided
  if (newEmail) {
    if (!newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/))
      return { success: false, error: "El nuevo email no es válido" };

    for (var i = 1; i < data.length; i++) {
      if (data[i][1] === newEmail && i + 1 !== rowIndex)
        return { success: false, error: "El nuevo email ya está registrado" };
    }
    loginSheet.getRange(rowIndex, 2).setValue(newEmail); // Update Email (column B)
  }

  // Validate and update password if provided
  if (password && password.length < 6)
    return { success: false, error: "La contraseña debe tener al menos 6 caracteres" };
  if (password)
    loginSheet.getRange(rowIndex, 3).setValue(password); // Update Password (column C)

  // Validate and update nombre if provided
  if (nombre)
    loginSheet.getRange(rowIndex, 4).setValue(nombre); // Update Nombre (column D)

  // Validate and update contacto if provided
  if (contacto && !contacto.match(/^\+\d+$/))
    return { success: false, error: "El contacto debe empezar con '+' seguido de dígitos" };
  if (contacto)
    loginSheet.getRange(rowIndex, 5).setValue(contacto); // Update Contacto (column E)

  SpreadsheetApp.flush(); // Forzar sincronización
  return { success: true, message: "Datos del dueño actualizados correctamente" };
}
