<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Due√±os</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background:#f5f5f5; }
h2 { color:#333; }
.alquiler { border:1px solid #ccc; padding:10px; margin:10px 0; background:#fff; }
button { margin: 5px; padding: 5px 10px; }
#formulario { background:#fff; padding:15px; border:1px solid #ccc; margin-top:20px; }
label { display:block; margin:8px 0 4px; }
input, select, textarea { width:100%; padding:8px; margin-bottom:10px; }
.preview-img { max-width: 120px; margin-top: 5px; display:inline-block; position:relative; }
.preview-img-container { display:inline-block; margin-right:5px; position:relative; }
.delete-img { position:absolute; top:0; right:0; background:red; color:white; border:none; border-radius:50%; cursor:pointer; }
</style>
</head>
<body>
<h2 id="bienvenida"></h2>
<button onclick="logout()">Cerrar Sesi√≥n</button>

<h3>üìã Mis Alquileres</h3>
<div id="listaAlquileres">Cargando...</div>

<h3 id="tituloForm">‚ûï Agregar Alquiler</h3>
<div id="formulario">
<input type="hidden" id="editRow" value="">
<label>Direcci√≥n</label>
<input type="text" id="direccion">

<label>Ambientes</label>
<input type="number" id="ambientes">

<label>Precio</label>
<input type="number" id="precio">

<label>Mascotas Permitidas</label>
<select id="mascotas">
<option value="S√≠">S√≠</option>
<option value="No">No</option>
</select>

<label>Im√°genes del Alquiler (PNG/JPG, m√∫ltiples)</label>
<input type="file" id="imagenFile" accept="image/png, image/jpeg" multiple>
<div id="previewContainer"></div>

<label>Informaci√≥n de ingreso</label>
<textarea id="infoIngreso" rows="2"></textarea>

<label>Detalles</label>
<textarea id="detalles" rows="3"></textarea>

<button id="btnGuardar" onclick="agregarAlquiler()">Agregar</button>
<p id="msg" style="color:green"></p>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // reemplaza con tu script
let imagenesBase64 = [];

function actualizarPreview(){
  const previewContainer = document.getElementById("previewContainer");
  previewContainer.innerHTML = "";
  imagenesBase64.forEach((imgBase64, index) => {
    const container = document.createElement("div");
    container.className = "preview-img-container";
    const img = document.createElement("img");
    img.src = imgBase64;
    img.className = "preview-img";
    const btnDel = document.createElement("button");
    btnDel.className = "delete-img";
    btnDel.textContent = "x";
    btnDel.onclick = ()=>{ imagenesBase64.splice(index,1); actualizarPreview(); };
    container.appendChild(img);
    container.appendChild(btnDel);
    previewContainer.appendChild(container);
  });
}

// Manejar selecci√≥n de im√°genes
document.getElementById("imagenFile").addEventListener("change", function(){
  const files = Array.from(this.files);
  files.forEach(file=>{
    const reader = new FileReader();
    reader.onload = function(e){
      imagenesBase64.push(e.target.result);
      actualizarPreview();
    }
    reader.readAsDataURL(file);
  });
});

window.onload = function(){
  const email = localStorage.getItem("dueno");
  if(!email){ window.location.href="index.html"; return; }
  document.getElementById("bienvenida").textContent = "Bienvenido, " + email;
  cargarAlquileres();
}

function cargarAlquileres(){
  const email = localStorage.getItem("dueno");
  fetch(API_URL + "?action=getAlquileresDueno&dueno=" + encodeURIComponent(email))
    .then(res => res.json())
    .then(mostrarAlquileres)
    .catch(console.error);
}

function mostrarAlquileres(res){
  const div = document.getElementById("listaAlquileres");
  div.innerHTML = "";
  if(!res.success || !res.data || res.data.length === 0){ 
    div.innerHTML="No tienes alquileres a√∫n."; 
    return; 
  }

  res.data.forEach(alq => {
    let estado = alq.Estado === "Activo" ? "Activo ‚úÖ" : "Inactivo ‚ùå";
    let btnEstado = `<button onclick="cambiarEstado(${alq.row})">Cambiar Estado</button>`;
    let btnEditar = `<button onclick='editarAlquiler(${alq.row}, ${JSON.stringify(alq)})'>Editar</button>`;
    let btnEliminar = `<button onclick="eliminarAlquiler(${alq.row})">Eliminar</button>`;
    div.innerHTML += `<div class="alquiler">
      <b>${alq.Direccion}</b> - ${alq['Nro Ambientes']} amb - ${alq.Precio} - Mascotas: ${alq.Mascotas || "N/D"}<br>
      Estado: ${estado}<br>
      ${btnEstado} ${btnEditar} ${btnEliminar}
    </div>`;
  });
}

function agregarAlquiler(){
  const direccion = document.getElementById("direccion").value;
  const ambientes = document.getElementById("ambientes").value;
  const precio = document.getElementById("precio").value;
  const mascotas = document.getElementById("mascotas").value;
  const infoIngreso = document.getElementById("infoIngreso").value;
  const detalles = document.getElementById("detalles").value;
  let row = document.getElementById("editRow").value;
  const email = localStorage.getItem("dueno");

  if(!direccion || !ambientes || !precio){ alert("Completa todos los campos obligatorios."); return; }

  let action = row ? "editAlquiler" : "addAlquiler";

  const payload = {
    action,
    row: row || "",
    dueno: email,
    direccion,
    ambientes,
    precio,
    mascotas,
    fotos: imagenesBase64.join(","),
    infoIngreso,
    detalles
  };

  fetch(API_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if(data.success){
      document.getElementById("msg").textContent = row ? "Alquiler editado ‚úÖ" : "Alquiler agregado ‚úÖ";
      resetForm();
      cargarAlquileres();
    } else {
      alert("Error: " + data.error);
    }
  })
  .catch(console.error);
}

function editarAlquiler(row, datos){
  document.getElementById("tituloForm").textContent="‚úèÔ∏è Editar Alquiler";
  document.getElementById("btnGuardar").textContent="Guardar Cambios";
  document.getElementById("editRow").value=row;
  document.getElementById("direccion").value=datos.Direccion||"";
  document.getElementById("ambientes").value=datos["Nro Ambientes"]||"";
  document.getElementById("precio").value=datos.Precio||"";
  document.getElementById("mascotas").value=datos.Mascotas||"No";
  document.getElementById("infoIngreso").value=datos.InfoIngreso||"";
  document.getElementById("detalles").value=datos.Detalles||"";

  imagenesBase64 = [];
  if(datos.Fotos){
    datos.Fotos.split(",").forEach(f=>{ imagenesBase64.push(f); });
  }
  actualizarPreview();
  window.scrollTo(0, document.getElementById("formulario").offsetTop);
}

function resetForm(){
  document.getElementById("tituloForm").textContent="‚ûï Agregar Alquiler";
  document.getElementById("btnGuardar").textContent="Agregar";
  document.getElementById("editRow").value="";
  document.getElementById("direccion").value="";
  document.getElementById("ambientes").value="";
  document.getElementById("precio").value="";
  document.getElementById("mascotas").value="S√≠";
  document.getElementById("infoIngreso").value="";
  document.getElementById("detalles").value="";
  document.getElementById("imagenFile").value="";
  imagenesBase64=[];
  actualizarPreview();
}

function cambiarEstado(row){
  fetch(API_URL + "?action=toggleEstado&row="+row)
    .then(res=>res.json())
    .then(estadoCambiado)
    .catch(console.error);
}
function estadoCambiado(res){ if(res.success) cargarAlquileres(); }

function eliminarAlquiler(row){
  if(!confirm("¬øSeguro que deseas eliminar este alquiler?")) return;
  fetch(API_URL + "?action=deleteAlquiler&row="+row)
    .then(res=>res.json())
    .then(alquilerEliminado)
    .catch(console.error);
}
function alquilerEliminado(res){ if(res.success) cargarAlquileres(); }

function logout(){ localStorage.removeItem("dueno"); window.location.href="index.html"; }
</script>
</body>
</html>
