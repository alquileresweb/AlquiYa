<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Due√±os</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f5f5f5; }
    h2 { color:#333; }
    .alquiler { border:1px solid #ccc; padding:10px; margin:10px 0; background:#fff; }
    button { margin: 5px; padding: 5px 10px; }
    #formulario { background:#fff; padding:15px; border:1px solid #ccc; margin-top:20px; }
    label { display:block; margin:8px 0 4px; }
    input, select { width:100%; padding:8px; margin-bottom:10px; }
  </style>
</head>
<body>
  <h2 id="bienvenida"></h2>
  <button onclick="logout()">Cerrar Sesi√≥n</button>

  <h3>üìã Mis Alquileres</h3>
  <div id="listaAlquileres">Cargando...</div>

  <h3>‚ûï Agregar Alquiler</h3>
  <div id="formulario">
    <label>Direcci√≥n</label>
    <input type="text" id="direccion">

    <label>Ambientes</label>
    <input type="number" id="ambientes">

    <label>Precio</label>
    <input type="number" id="precio">

    <label>Mascotas Permitidas</label>
    <select id="mascotas">
      <option value="S√≠">S√≠</option>
      <option value="No">No</option>
    </select>

    <label>Imagen (PNG/JPG)</label>
    <input type="file" id="imagen" accept="image/png, image/jpeg">

    <button onclick="agregarAlquiler()">Agregar</button>
    <p id="msg" style="color:green"></p>
  </div>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwDl73ZMnMowfSu_NoISSSc4fnQpLp6kaxT9Dz5jMjE9NxT64AmeN23ORQy8lejul6S/exec";

  window.onload = function(){
    const nombre = localStorage.getItem("dueno");
    if(!nombre){ window.location.href="index.html"; return; }
    document.getElementById("bienvenida").textContent = "Bienvenido, " + nombre;
    cargarAlquileres();
  }

  // üìã Obtener lista de alquileres
  function cargarAlquileres(){
    fetch(API_URL+"?action=getAlquileres&dueno="+localStorage.getItem("dueno_email"))
      .then(r => r.json())
      .then(data => {
        const div = document.getElementById("listaAlquileres");
        div.innerHTML = "";
        if(data.length === 0){ div.innerHTML="No tienes alquileres a√∫n."; return; }

        data.forEach(alq => {
          let estado = alq.activo === "TRUE" ? "Activo ‚úÖ" : "Inactivo ‚ùå";
          let btnEstado = `<button onclick="cambiarEstado('${alq.id}')">${estado}</button>`;
          let btnEditar = `<button onclick="editarAlquiler('${alq.id}')">Editar</button>`;
          div.innerHTML += `<div class="alquiler">
            <b>${alq.direccion}</b> - ${alq.ambientes} amb - $${alq.precio} - Mascotas: ${alq.mascotas}<br>
            ${btnEstado} ${btnEditar}
          </div>`;
        });
      })
      .catch(e => {
        document.getElementById("listaAlquileres").innerHTML = "Error cargando alquileres.";
      });
  }

  // ‚ûï Agregar alquiler
  function agregarAlquiler(){
    const direccion = document.getElementById("direccion").value;
    const ambientes = document.getElementById("ambientes").value;
    const precio = document.getElementById("precio").value;
    const mascotas = document.getElementById("mascotas").value;
    const file = document.getElementById("imagen").files[0];

    if(!direccion || !ambientes || !precio){ alert("Completa todos los campos."); return; }

    const formData = new FormData();
    formData.append("action", "addAlquiler");
    formData.append("dueno", localStorage.getItem("dueno_email"));
    formData.append("direccion", direccion);
    formData.append("ambientes", ambientes);
    formData.append("precio", precio);
    formData.append("mascotas", mascotas);
    if(file) formData.append("imagen", file);

    fetch(API_URL, { method:"POST", body:formData })
      .then(r => r.text())
      .then(res => {
        document.getElementById("msg").textContent = "Alquiler agregado ‚úÖ";
        cargarAlquileres();
      })
      .catch(err => alert("Error al guardar: "+err));
  }

  // üîÑ Cambiar estado
  function cambiarEstado(id){
    fetch(API_URL+"?action=toggleEstado&id="+id)
      .then(r => r.text())
      .then(res => cargarAlquileres());
  }

  // ‚úèÔ∏è Editar alquiler (puedes mejorarlo luego con modal o formulario)
  function editarAlquiler(id){
    alert("Aqu√≠ se abrir√≠a un formulario para editar el alquiler con ID: " + id);
  }

  function logout(){
    localStorage.removeItem("dueno");
    localStorage.removeItem("dueno_email");
    window.location.href="index.html";
  }
  </script>
</body>
</html>
