<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Dueños</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SSJ5DG33JK"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-SSJ5DG33JK');
</script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<link rel="icon" type="image/png" href="https://i.postimg.cc/MKpMcrcQ/AlquiYa.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* ESTILO MODERNO 2025 - FIJO Y LIMPIO */
body {
    font-family: 'Segoe UI', Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f8f9fa;
    font-size: 20px;
    text-align: center;
    padding-top: 90px; /* espacio para header fijo */
}

/* HEADER FIJO */
header {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 80px;
    background: white;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
    box-sizing: border-box;
}

/* Flecha volver - esquina superior izquierda */
#back-arrow {
    width: 56px; height: 56px;
    background: rgba(255,255,255,0.95);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    color: #333;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: all 0.3s;
}
#back-arrow:hover { background: #eee; transform: scale(1.05); }

/* Logo centrado */
header img {
    max-height: 60px;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

/* Menú hamburguesa - esquina superior derecha */
#menu-toggle {
    width: 56px; height: 56px;
    background: rgba(255,255,255,0.95);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    color: #333;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: all 0.3s;
}
#menu-toggle:hover { background: #eee; transform: scale(1.05); }

/* Menú desplegable */
#menu {
    display: none;
    position: fixed;
    top: 90px;
    right: 20px;
    background: white;
    border-radius: 14px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    overflow: hidden;
    z-index: 1001;
    min-width: 200px;
}
#menu.active { display: block; }
#menu button {
    display: block;
    width: 100%;
    padding: 16px 20px;
    background: none;
    border: none;
    text-align: left;
    font-size: 1.3em;
    cursor: pointer;
    transition: background 0.3s;
}
#menu button:hover { background: #f0f0f0; }

/* Tarjeta de propiedad */
.alquiler {
    position: relative;
    background: white;
    border-radius: 18px;
    padding: 20px;
    margin: 20px auto;
    max-width: 700px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    text-align: left;
    overflow: hidden;
}

/* Solo la dirección como título grande */
.alquiler h2 {
    margin: 0 0 12px 0;
    font-size: 1.8em;
    color: #222;
    font-weight: 600;
}

/* Información secundaria */
.alquiler-info {
    color: #555;
    font-size: 1.3em;
    line-height: 1.6;
    margin-bottom: 16px;
}

/* Estadísticas inline */
.stats-inline {
    background: #fff8e1;
    padding: 14px;
    border-radius: 12px;
    display: flex;
    justify-content: center;
    gap: 30px;
    flex-wrap: wrap;
    font-size: 1.3em;
    margin: 16px 0;
    box-shadow: 0 2px 8px rgba(255,152,0,0.1);
}
.stats-item i { color: #ff9800; margin-right: 8px; }
.stats-number { color: #ff9800; font-weight: bold; }

/* Switch de estado (arriba derecha) */
.estado-switch {
    position: absolute;
    top: 16px;
    right: 16px;
    z-index: 10;
}
.estado-switch input { display: none; }
.estado-switch label {
    width: 64px; height: 36px;
    background: #ccc;
    border-radius: 36px;
    position: relative;
    display: block;
    cursor: pointer;
    transition: 0.3s;
}
.estado-switch label::after {
    content: '';
    width: 28px; height: 28px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: 4px; left: 4px;
    transition: 0.3s;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.estado-switch input:checked + label { background: #4caf50; }
.estado-switch input:checked + label::after { left: 32px; }

/* Botones de acción */
.alquiler-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 20px;
}
.alquiler-actions button {
    padding: 12px 20px;
    font-size: 1.2em;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
}
.copy-share-btn { background: #2196f3; color: white; }
.copy-share-btn i { margin-right: 8px; }
.copy-share-btn.copied { background: #4caf50; }
button[onclick^="editar"] { background: #ff9800; color: white; }
button[onclick^="eliminar"] { background: #f44336; color: white; }

/* Resto de estilos (formularios, modales, etc.) se mantienen igual */
h3 { font-size: 2.2em; margin: 30px 0 20px; color: #333; }
button { transition: all 0.3s; }
button:hover { transform: translateY(-2px); }
#btnAgregarPropiedad { 
    background: #3681f3; 
    color: white; 
    padding: 16px 32px; 
    font-size: 1.4em; 
    border-radius: 14px; 
    margin: 20px 0;
}

/* Mobile */
@media (max-width: 600px) {
    header { height: 70px; padding: 0 15px; }
    #back-arrow, #menu-toggle { width: 50px; height: 50px; font-size: 24px; }
    header img { max-height: 50px; }
    body { padding-top: 80px; }
    .alquiler h2 { font-size: 1.6em; }
}
</style>
</head>
<body>

<!-- HEADER FIJO -->
<header>
    <button id="back-arrow" onclick="window.location.href='index.html'">
        <i class="fas fa-arrow-left"></i>
    </button>
    <img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="Alqui Ya">
    <button id="menu-toggle" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
    </button>

    <div id="menu">
        <button onclick="abrirModalEditarCuenta()">Editar Cuenta</button>
        <button onclick="logout()">Cerrar Sesión</button>
    </div>
</header>

<div id="planContainer">
    <b>Mi plan</b>
    <div id="planStatus"></div>
    <span id="limiteAlquileres"></span>
    <button id="btnPlan" onclick="abrirModalPlan()">Mejorar Plan</button>
</div>

<h3>Mis Propiedades</h3>
<div id="listaAlquileres">Cargando...</div>

<button id="btnAgregarPropiedad" onclick="toggleOpcionesPropiedad()">Agregar Propiedad</button>

<!-- === SOLO CAMBIO EN mostrarAlquileres() === -->
<script>
// Reemplaza COMPLETAMENTE tu función mostrarAlquileres por esta:
function mostrarAlquileres(res) {
    const div = document.getElementById("listaAlquileres");
    div.innerHTML = "";
    if (!res.success || !res.data || res.data.length === 0) {
        div.innerHTML = "<p style='font-size:1.6em; color:#666;'>No tienes propiedades aún.</p>";
        return;
    }

    deptosActivos = res.data.filter(a => a.Estado === "Activo").length;
    document.getElementById("limiteAlquileres").textContent =
        planActual === "Prueba"
            ? `${deptosActivos} propiedades activas`
            : `${deptosActivos}/${limiteDeptos} propiedades activas`;

    res.data.forEach(alq => {
        const direccion = alq.Direccion || alq.direccion || "Sin dirección";
        const tipo = alq.Tipo || "Propiedad";
        const estado = alq.Estado === "Activo" ? "Activo" : "Inactivo";

        // Info secundaria
        let info = [];
        if (alq['Nro Ambientes']) info.push(`${alq['Nro Ambientes']} amb`);
        if (alq.Precio) info.push(formatoPrecio(alq.Precio));
        if (alq.Superficie) info.push(`${alq.Superficie} m²`);
        if (alq.Patio) info.push(`Patio: ${alq.Patio}`);
        if (alq.Garage) info.push(`Garage: ${alq.Garage}`);
        if (alq.Antiguedad) info.push(`Antigüedad: ${alq.Antiguedad} años`);
        if (alq.Operacion) info.push(`Operación: ${alq.Operacion}`);

        const vistas = parseInt(alq.Vistas || alq[18] || 0) || 0;
        const contactos = parseInt(alq.Consultas || alq.contactos || alq.Contactos || alq[19] || 0) || 0;
        const idPropiedad = alq[13] || alq.ID || alq.row;

        div.innerHTML += `
            <div class="alquiler">
                <h2>${direccion}</h2>
                <div class="alquiler-info">
                    <strong>(${tipo})</strong><br>
                    ${info.length ? info.join(" • ") + "<br>" : ""}
                    Estado: <strong>${estado}</strong>
                </div>

                <div class="stats-inline">
                    <div class="stats-item"><i class="fa-solid fa-eye"></i><span class="stats-number">${vistas}</span> vistas</div>
                    <div class="stats-item"><i class="fa-solid fa-phone"></i><span class="stats-number">${contactos}</span> contactos</div>
                </div>

                <!-- Switch de estado -->
                <div class="estado-switch">
                    <input type="checkbox" id="switch-${alq.row}" ${alq.Estado === 'Activo' ? 'checked' : ''}
                           onchange="cambiarEstado(${alq.row}, '${alq.Estado}')">
                    <label for="switch-${alq.row}"></label>
                </div>

                <!-- Acciones -->
                <div class="alquiler-actions">
                    <button class="copy-share-btn" data-id="${idPropiedad}">
                        <i class="fas fa-copy"></i> Copiar enlace
                    </button>
                    <button onclick="editarAlquiler(${alq.row}, ${JSON.stringify(alq)})">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button onclick="eliminarAlquiler(${alq.row})">
                        <i class="fas fa-trash-alt"></i> Eliminar
                    </button>
                </div>

                <span id="estadoMsg-${alq.row}" class="estado-msg"></span>
            </div>`;
    });

/* Botón copiar enlace */
.copy-share-btn {
    background:#2196f3;
    color:white;
}
.copy-share-btn i { margin-right:6px; }
.copy-share-btn.copied { background:#4caf50; }
#opcionesPropiedad, #opcionesVenta, #opcionesAlquiler { background:#fff; padding:20px; border:1px solid #ccc; margin-top:24px; border-radius:12px; font-size:1.3em; text-align:left; display:none; }
#opcionesPropiedad.active, #opcionesVenta.active, #opcionesAlquiler.active { display:block; }
#formularioDepartamento, #formularioLocal, #formularioTemporario, #formularioTerreno, #formularioCasa { background:#fff; padding:20px; border:1px solid #ccc; margin-top:24px; border-radius:12px; font-size:1.3em; text-align:left; display:none; }
#formularioDepartamento.active, #formularioLocal.active, #formularioTemporario.active, #formularioTerreno.active, #formularioCasa.active { display:block; }
#formularioRegistro { background:#fff; padding:20px; border:1px solid #ccc; margin-top:24px; border-radius:12px; font-size:1.3em; text-align:left; display:none; }
#formularioRegistro.active { display:block; }
label { display:block; margin:12px 0 8px; font-weight:bold; }
input, select, textarea { width:100%; padding:14px; margin-bottom:16px; font-size:1.2em; border-radius:8px; border:1px solid #ccc; }
.contacto-container { display: flex; gap: 12px; align-items: center; }
.contacto-container select { width: 60px; }
.contacto-container input { flex: 1; min-width: 150px; }
.password-container { display: flex; gap: 12px; align-items: center; }
.password-container input { flex: 1; }
.password-container .toggle-password { padding: 10px; font-size: 1.3em; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; background: #fff; }
.preview-img { max-width: 140px; margin-top: 6px; display:inline-block; position:relative; border-radius:6px; }
.preview-img-container { display:inline-block; margin-right:6px; position:relative; }
.delete-img { position:absolute; top:0; right:0; background:red; color:white; border:none; border-radius:50%; cursor:pointer; font-weight:bold; padding:3px 8px; }
.preview-video { max-width: 140px; margin-top: 6px; display:inline-block; position:relative; border-radius:6px; }
.preview-video-container { display:inline-block; margin-right:6px; position:relative; }
.delete-video { position:absolute; top:0; right:0; background:red; color:white; border:none; border-radius:50%; cursor:pointer; font-weight:bold; padding:3px 8px; }
#planStatus { margin:14px 0; font-weight:bold; font-size:1.4em; text-align:center; padding:12px; border-radius:6px; }
progress { width: 100%; height:24px; }
.modal {
display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
overflow: auto; background-color: rgba(0,0,0,0.5);
}
.modal-content {
background-color: #fefefe; margin: 10% auto; padding: 28px; border: 1px solid #888; width: 95%; max-width: 700px; border-radius:14px; text-align:center;
}
.modal-content input, .modal-content select { width: calc(100% - 28px); }
.modal h3 { margin-top:0; font-size:1.7em; }
.plan-option { border:1px solid #ccc; padding:14px; margin:14px 0; border-radius:12px; font-size:1.3em; }
.plan-option button { margin-top:8px; padding:12px 18px; font-size:1.2em; border-radius:8px; }
iframe { width:100%; min-height:500px; border:none; border-radius:6px; margin-top:12px; }
#planContainer { background:#3681f3; color:white; padding:12px; border:1px solid #ccc; border-radius:6px; font-size:1.2em; display:flex; flex-direction:column; align-items:center; width: calc(100% - 24px); min-height: 250px; height: auto; margin: 20px auto; }
#planContainer button { background:#fff; }
#contactoBtn { position:fixed; bottom:24px; right:24px; background:#25D366; color:white; border:none; border-radius:50%; padding:24px; font-size:2em; cursor:pointer; box-shadow:0 3px 6px rgba(0,0,0,0.2); }
.estado-msg { font-size: 1.1em; margin-top: 6px; display: block; }
.estado-msg.loading { color: blue; }
.estado-msg.success { color: green; }
.estado-msg.error { color: red; }
/* Estilos para el menú hamburguesa */
#menu-toggle {
position: fixed;
top: 20px;
right: 20px;
font-size: 30px;
cursor: pointer;
z-index: 1001;
background: none;
border: none;
color: #333;
}
#menu {
display: none;
position: fixed;
top: 60px;
right: 20px;
background: #fff;
border: 1px solid #ccc;
border-radius: 8px;
box-shadow: 0 2px 5px rgba(0,0,0,0.2);
z-index: 1001;
}
#menu.active { display: block; }
#menu button {
display: block;
width: 100%;
padding: 14px 20px;
font-size: 1.3em;
text-align: left;
border: none;
background: none;
cursor: pointer;
}
#menu button:hover { background: #f0f0f0; }
/* Estilo para la flecha de volver atrás */
#back-arrow {
position: fixed;
top: 20px;
left: 20px;
font-size: 36px;
cursor: pointer;
z-index: 1001;
background: none;
border: none;
color: #333;
padding: 10px;
font-weight: bold;
}
#back-arrow:hover {
background: #f0f0f0;
border-radius: 50%;
}
/* Mobile-specific styles */
@media screen and (max-width: 600px) {
body { font-size: 24px; margin-top: 140px; }
h2 { font-size: 2.6em; }
h3 { font-size: 2.4em; }
.alquiler { font-size: 1.6em; padding: 20px; }
button { font-size: 1.5em; padding: 16px 22px; }
#formularioDepartamento, #formularioLocal, #formularioTemporario, #formularioTerreno, #formularioCasa { font-size: 1.5em; padding: 24px; }
input, select, textarea { font-size: 1.4em; padding: 16px; }
.contacto-container select { width: 80px; }
.contacto-container input { min-width: 150px; }
.password-container .toggle-password { padding: 12px; font-size: 1.5em; }
.preview-img { max-width: 160px; }
.preview-video { max-width: 160px; }
#planStatus { font-size: 1.6em; }
.modal-content { width: 98%; max-width: 98%; font-size: 1.3em; padding: 28px; }
.plan-option { font-size: 1.5em; padding: 14px; }
#planContainer { font-size: 1.4em; padding: 12px; min-width: 200px; }
#contactoBtn { font-size: 2.2em; padding: 28px; }
#menu-toggle { font-size: 34px; top: 24px; right: 24px; }
#menu { top: 70px; right: 24px; }
#menu button { font-size: 1.5em; padding: 16px 22px; }
#back-arrow { font-size: 42px; top: 24px; left: 24px; }
}
#publicidad-container {
background: white;
border: 1px solid #ccc;
border-radius: 8px;
padding: 20px;
margin: 10px auto;
max-width: 700px;
text-align: center;
cursor: pointer;
}
#publicidad-container p {
margin: 5px 0;
font-size: 1.2em;
font-weight: bold;
color: #333;
}

/* === ESTADÍSTICAS INLINE (VISTAS Y CONTACTOS DIRECTOS) === */
.stats-inline {
    margin-top: 14px;
    padding: 12px;
    background: #fff8e1;
    border-radius: 10px;
    font-size: 1.3em;
    display: flex;
    justify-content: center;
    gap: 30px;
    flex-wrap: wrap;
    box-shadow: 0 2px 8px rgba(255,152,0,0.1);
}
.stats-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: bold;
    color: #333;
}
.stats-item i {
    color: #ff9800;
    font-size: 1.5em;
}
.stats-number {
    color: #ff9800;
    font-size: 1.4em;
}

/* === MODAL DE ESTADÍSTICAS (se mantiene por compatibilidad) === */
#modalEstadisticas {
display: none;
position: fixed;
z-index: 1001;
left: 0;
top: 0;
width: 100%;
height: 100%;
overflow: auto;
background-color: rgba(0,0,0,0.7);
}
#modalEstadisticas .modal-content {
background-color: #fff;
margin: 5% auto;
padding: 30px;
border: none;
width: 95%;
max-width: 400px;
border-radius: 16px;
text-align: center;
box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
#modalEstadisticas h3 { color: #ff9800; font-size: 2.2em; margin-bottom: 20px; }
.metricas-item {
background: linear-gradient(135deg, #ff9800, #f57c00);
color: white;
padding: 20px;
margin: 15px 0;
border-radius: 12px;
font-size: 1.6em;
text-align: center;
box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.metricas-numero { font-size: 2.8em; font-weight: bold; display: block; margin-bottom: 5px; }
#modalEstadisticas button { background: #ff9800; color: white; padding: 15px 25px; font-size: 1.4em; }
@media screen and (max-width: 600px) {
#modalEstadisticas .modal-content { margin: 10% auto; width: 98%; padding: 25px; }
.metricas-item { font-size: 1.4em; padding: 18px; }
.metricas-numero { font-size: 2.5em; }
}
</style>
</head>
<body>
<header style="position: static; top: 0; left: 0; width: 100%; background: white; z-index: 1000; text-align: center; padding: 15px; box-sizing: border-box;">
<button id="back-arrow" onclick="window.location.href='index.html'">Back</button>
<img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="Logo Alqui Ya" style="max-width: 350px; margin-bottom: 10px;">
<button id="menu-toggle" onclick="toggleMenu()">Menu</button>
<div id="menu">
<button onclick="abrirModalEditarCuenta()">Editar Cuenta</button>
<button onclick="logout()">Cerrar Sesión</button>
</div>
</header>

<div id="planContainer">
<b>Mi plan</b>
<div id="planStatus"></div>
<span id="limiteAlquileres"></span>
<button id="btnPlan" onclick="abrirModalPlan()">Mejorar Plan</button>
</div>

<h3>Mis Propiedades</h3>
<div id="listaAlquileres">Cargando...</div>

<button id="btnAgregarPropiedad" onclick="toggleOpcionesPropiedad()">Agregar Propiedad</button>

<div id="opcionesPropiedad">
<label for="tipoOperacion">Tipo de Operación</label>
<select id="tipoOperacion">
<option value="Vender">Vender</option>
<option value="Alquilar">Alquilar</option>
</select>
<div id="opcionesVenta">
<button onclick="mostrarFormulario('Terreno')">Terreno</button>
<button onclick="mostrarFormulario('Casa')">Casa</button>
<button onclick="mostrarFormulario('Departamento')">Departamento</button>
<button onclick="mostrarFormulario('Local')">Local Comercial</button>
</div>
<div id="opcionesAlquiler">
<button onclick="mostrarFormulario('Departamento')">Departamento</button>
<button onclick="mostrarFormulario('Local')">Local Comercial</button>
<button onclick="mostrarFormulario('Temporario')">Temporario</button>
</div>
</div>

<div id="rapiclean-img-duenos">
<a href="https://wa.me/5493764391885?text=Hola,+%22podrian+darme+informacion+sobre+los+Planes+para+Due%C3%B1os%22&utm_source=chatgpt.com" target="_blank">
<img src="https://i.postimg.cc/28HKjzTs/M-s-de-40-estudiantes-ya-confiaron-en-Rapiclean-2.png" alt="Más de 40 estudiantes confiaron en Rapiclean" style="max-width:100%;margin:10px auto;display:block;">
</a>
<a href="https://wa.me/5493764275443?text=Hola,+quiero+publicitar+en+AlquiYa&utm_source=chatgpt.com" target="_blank">
<div id="publicidad-container">
<p>Espacio Publicitario</p>
<p>Haz clic para publicitar aquí</p>
</div>
</a>
</div>

<!-- Formularios (todos idénticos al original) -->
<div id="formularioTerreno">
<input type="hidden" id="editRowTerreno" value="">
<input type="hidden" id="enlaceCompartirTerreno" value="">
<input type="hidden" id="existingVideosTerreno" value="">
<label>Superficie total (m²)</label>
<input type="number" id="superficieTerreno">
<label>Dirección</label>
<input type="text" id="direccionTerreno">
<label>Precio (USD)</label>
<input type="text" id="precioTerreno">
<label>Imágenes del Terreno (PNG/JPG, múltiples)</label>
<input type="file" id="imagenFileTerreno" accept="image/png, image/jpeg" multiple>
<div id="previewContainerTerreno"></div>
<label>Videos del Terreno (MP4, múltiples)</label>
<input type="file" id="videoFileTerreno" accept="video/*" multiple>
<div id="videoPreviewContainerTerreno"></div>
<label>Información de pago</label>
<textarea id="infoIngresoTerreno" rows="2"></textarea>
<label>Detalles</label>
<textarea id="detallesTerreno" rows="3"></textarea>
<button id="btnGuardarTerreno" onclick="agregarAlquiler('Terreno')">Agregar</button>
<p id="msgTerreno" style="color:green"></p>
</div>

<div id="formularioCasa">
<input type="hidden" id="editRowCasa" value="">
<input type="hidden" id="enlaceCompartirCasa" value="">
<input type="hidden" id="existingVideosCasa" value="">
<label>Dirección</label>
<input type="text" id="direccionCasa">
<label>Precio (USD)</label>
<input type="text" id="precioCasa">
<label>Detalle de Ambientes</label>
<input type="number" id="ambientesCasa">
<label>Patio</label>
<select id="patioCasa">
 <option value="Sí">Sí</option>
 <option value="No">No</option>
</select>
<label>Garage</label>
<select id="garageCasa">
 <option value="Sí">Sí</option>
 <option value="No">No</option>
</select>
<label>Antigüedad (años)</label>
<input type="number" id="antiguedadCasa">
<label>Imágenes de la Casa (PNG/JPG, múltiples)</label>
<input type="file" id="imagenFileCasa" accept="image/png, image/jpeg" multiple>
<div id="previewContainerCasa"></div>
<label>Videos de la Casa (MP4, múltiples)</label>
<input type="file" id="videoFileCasa" accept="video/*" multiple>
<div id="videoPreviewContainerCasa"></div>
<label>Información de pago</label>
<textarea id="infoIngresoCasa" rows="2"></textarea>
<label>Otros detalles</label>
<textarea id="detallesCasa" rows="3"></textarea>
<button id="btnGuardarCasa" onclick="agregarAlquiler('Casa')">Agregar</button>
<p id="msgCasa" style="color:green"></p>
</div>

<div id="formularioDepartamento">
<input type="hidden" id="editRowDepartamento" value="">
<input type="hidden" id="enlaceCompartirDepartamento" value="">
<input type="hidden" id="existingVideosDepartamento" value="">
<label>Dirección</label>
<input type="text" id="direccionDepartamento">
<label>Ambientes</label>
<input type="number" id="ambientesDepartamento">
<label>Precio (USD)</label>
<input type="text" id="precioDepartamento">
<label>Imágenes del Alquiler (PNG/JPG, múltiples)</label>
<input type="file" id="imagenFileDepartamento" accept="image/png, image/jpeg" multiple>
<div id="previewContainerDepartamento"></div>
<label>Videos del Alquiler (MP4, múltiples)</label>
<input type="file" id="videoFileDepartamento" accept="video/*" multiple>
<div id="videoPreviewContainerDepartamento"></div>
<label>Información de pago</label>
<textarea id="infoIngresoDepartamento" rows="2"></textarea>
<label>Otros detalles</label>
<textarea id="detallesDepartamento" rows="3"></textarea>
<button id="btnGuardarDepartamento" onclick="agregarAlquiler('Departamento')">Agregar</button>
<p id="msgDepartamento" style="color:green"></p>
</div>

<div id="formularioLocal">
<input type="hidden" id="editRowLocal" value="">
<input type="hidden" id="enlaceCompartirLocal" value="">
<input type="hidden" id="existingVideosLocal" value="">
<label>Dirección</label>
<input type="text" id="direccionLocal">
<label>Imágenes del Alquiler (PNG/JPG, múltiples)</label>
<input type="file" id="imagenFileLocal" accept="image/png, image/jpeg" multiple>
<div id="previewContainerLocal"></div>
<label>Videos del Alquiler (MP4, múltiples)</label>
<input type="file" id="videoFileLocal" accept="video/*" multiple>
<div id="videoPreviewContainerLocal"></div>
<label>Información de ingreso</label>
<textarea id="infoIngresoLocal" rows="2"></textarea>
<label>Detalles</label>
<textarea id="detallesLocal" rows="3"></textarea>
<button id="btnGuardarLocal" onclick="agregarAlquiler('Local')">Agregar</button>
<p id="msgLocal" style="color:green"></p>
</div>

<div id="formularioTemporario">
<input type="hidden" id="editRowTemporario" value="">
<input type="hidden" id="enlaceCompartirTemporario" value="">
<input type="hidden" id="existingVideosTemporario" value="">
<label>Dirección</label>
<input type="text" id="direccionTemporario">
<label>Imágenes del Alquiler (PNG/JPG, múltiples)</label>
<input type="file" id="imagenFileTemporario" accept="image/png, image/jpeg" multiple>
<div id="previewContainerTemporario"></div>
<label>Videos del Alquiler (MP4, múltiples)</label>
<input type="file" id="videoFileTemporario" accept="video/*" multiple>
<div id="videoPreviewContainerTemporario"></div>
<label>Información de ingreso</label>
<textarea id="infoIngresoTemporario" rows="2"></textarea>
<label>Detalles</label>
<textarea id="detallesTemporario" rows="3"></textarea>
<button id="btnGuardarTemporario" onclick="agregarAlquiler('Temporario')">Agregar</button>
<p id="msgTemporario" style="color:green"></p>
</div>

<!-- Modal de Planes -->
<div id="modalPlan" class="modal">
<div class="modal-content">
<h3>Elige tu plan</h3>
<div class="plan-option">
<b>Básico</b> - Hasta 3 deptos activos
<p id="precioBasico">$0 / mes</p>
<button onclick="seleccionarPlan('Basico')">Elegir Básico</button>
<div id="mpBtnBasico"></div>
</div>
<div class="plan-option">
<b>Plus</b> - Hasta 5 deptos activos
<p id="precioPlus">$0 / mes</p>
<button onclick="seleccionarPlan('Plus')">Elegir Plus</button>
<div id="mpBtnPlus"></div>
</div>
<div class="plan-option">
<b>Full</b> - Hasta 10 deptos activos
<p id="precioFull">$0 / mes</p>
<button onclick="seleccionarPlan('Full')">Elegir Full</button>
<div id="mpBtnFull"></div>
</div>
<button onclick="cerrarModalPlan()">Cerrar</button>
</div>
</div>

<!-- Modal de Editar Cuenta -->
<div id="modalEditarCuenta" class="modal">
<div class="modal-content">
<h3>Editar Cuenta</h3>
<label>Email</label>
<input type="email" id="emailEditar" placeholder="Dejar en blanco para mantener actual">
<label>Nombre</label>
<input type="text" id="nombreEditar" placeholder="Dejar en blanco para mantener actual">
<label>Contacto (Teléfono)</label>
<div class="contacto-container">
<select id="codigoPaisEditar">
<option value="+549">Argentina (+549)</option>
<option value="+55">Brasil (+55)</option>
<option value="+598">Uruguay (+598)</option>
<option value="+56">Chile (+56)</option>
<option value="+595">Paraguay (+595)</option>
</select>
<input type="text" id="contactoEditar" placeholder="Ej: 3764275443">
</div>
<label>Contraseña</label>
<div class="password-container">
<input type="password" id="passwordEditar" placeholder="Dejar en blanco para mantener actual">
<button class="toggle-password" onclick="togglePasswordVisibility()">Mostrar</button>
</div>
<button onclick="editarCuenta()">Guardar Cambios</button>
<button onclick="cerrarModalEditarCuenta()">Cerrar</button>
<p id="msgEditarCuenta" style="color:green"></p>
</div>
</div>

<!-- Modal Estadísticas (se mantiene por si se necesita en otro lado) -->
<div id="modalEstadisticas">
<div class="modal-content">
<h3 id="modal-titulo">Estadísticas</h3>
<div id="metricasContainer">
<div class="metricas-item">
<span class="metricas-numero" id="modal-vistas">0</span>
Vistas
</div>
<div class="metricas-item">
<span class="metricas-numero" id="modal-contactos">0</span>
Contactos
</div>
</div>
<button onclick="cerrarModalEstadisticas()">Cerrar</button>
<p id="msgEstadisticas" style="color:green; margin-top:15px;"></p>
</div>
</div>

<button id="contactoBtn" title="¿Necesitas ayuda o tuviste inconvenientes?" onclick="window.open('https://wa.me/5493764275443', '_blank')">Ayuda</button>

<script>
// === CONSTANTES Y VARIABLES ===
const API_URL = "https://script.google.com/macros/s/AKfycby8Im_WuA2Gfkbc-wHQjL-KOTpl_LnGsgvbR-l1zF3KVYyLv5Qr25d7njUplky8CUWY/exec";
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dnugmwern/image/upload";
const CLOUDINARY_UPLOAD_PRESET = "preset_alquileres";
const GEOCODE_KEY = "AIzaSyAisqYSTfpQ_rqqutAomzitD2v_dtKYtLE";
const MP_BEARER = "APP_USR-595288641172928-010710-d915bce4137b3ee26e0c6e04873f1ac1-695835795";
let imagenesBase64 = { Departamento: [], Local: [], Temporario: [], Terreno: [], Casa: [] };
let videosBase64 = { Departamento: [], Local: [], Temporario: [], Terreno: [], Casa: [] };
let planActual = null;
let limiteDeptos = 0;
let deptosActivos = 0;
let preciosPlanes = {Basico: 0, Plus: 0, Full: 0};

function mostrarAlquileres(res) {
    const div = document.getElementById("listaAlquileres");
    div.innerHTML = "";
    if (!res.success || !res.data || res.data.length === 0) {
        div.innerHTML = "<p style='font-size:1.6em;color:#666;'>No tienes propiedades aún.</p>";
        return;
    }

    deptosActivos = res.data.filter(a => a.Estado === "Activo").length;
    document.getElementById("limiteAlquileres").textContent =
        planActual === "Prueba"
            ? `${deptosActivos} propiedades activas`
            : `${deptosActivos}/${limiteDeptos} propiedades activas`;

    res.data.forEach(alq => {
        const direccion = alq.Direccion || alq.direccion || "Sin dirección";
        const tipo = alq.Tipo || "";
        const estado = alq.Estado === "Activo" ? "Activo" : "Inactivo";

        // Construcción de detalles (todo lo que NO es título)
        let detalles = `<strong>Tipo:</strong> ${tipo}<br>`;
        detalles += `<strong>Estado:</strong> ${estado}<br><br>`;

        if (alq.Precio) detalles += `<strong>Precio:</strong> ${formatoPrecio(alq.Precio)}<br>`;
        if (alq['Nro Ambientes']) detalles += `<strong>Ambientes:</strong> ${alq['Nro Ambientes']}<br>`;
        if (alq.Superficie) detalles += `<strong>Superficie:</strong> ${alq.Superficie} m²<br>`;
        if (alq.Patio) detalles += `<strong>Patio:</strong> ${alq.Patio}<br>`;
        if (alq.Garage) detalles += `<strong>Garage:</strong> ${alq.Garage}<br>`;
        if (alq.Antiguedad) detalles += `<strong>Antigüedad:</strong> ${alq.Antiguedad} años<br>`;
        if (alq.Operacion) detalles += `<strong>Operación:</strong> ${alq.Operacion}<br>`;

        const vistas = parseInt(alq.Vistas || alq[18] || 0) || 0;
        const contactos = parseInt(alq.Consultas || alq.contactos || alq.Contactos || alq[19] || 0) || 0;
        const statsHTML = `
            <div class="stats-inline">
                <div class="stats-item"><i class="fa-solid fa-eye"></i><span class="stats-number">${vistas}</span> vistas</div>
                <div class="stats-item"><i class="fa-solid fa-phone"></i><span class="stats-number">${contactos}</span> contactos</div>
            </div>`;

        const idPropiedad = alq[13] || alq.ID || alq.row;

        div.innerHTML += `
            <div class="alquiler">
                <div class="alquiler-titulo">${direccion}</div>
                <div class="alquiler-detalles">${detalles}${statsHTML}</div>

                <!-- Switch estado -->
                <div class="estado-switch">
                    <input type="checkbox" id="switch-${alq.row}" ${alq.Estado==='Activo'?'checked':''}
                           onchange="cambiarEstado(${alq.row}, '${alq.Estado}')">
                    <label for="switch-${alq.row}"></label>
                </div>

                <!-- Acciones -->
                <div class="alquiler-actions">
                    <button class="copy-share-btn" data-id="${idPropiedad}">
                        <i class="fas fa-copy"></i> Copiar enlace
                    </button>
                    <button onclick="editarAlquiler(${alq.row}, ${JSON.stringify(alq)})">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button onclick="eliminarAlquiler(${alq.row})">
                        <i class="fas fa-trash-alt"></i> Eliminar
                    </button>
                </div>

                <span id="estadoMsg-${alq.row}" class="estado-msg"></span>
            </div>`;
    });

    // Copiar enlace (funciona igual)
    document.querySelectorAll('.copy-share-btn').forEach(btn => {
        btn.onclick = function () {
            const id = this.getAttribute('data-id');
            const url = `https://www.alquiya.com.ar/propiedad.html?id=${id}`;
            fetch(`${API_URL}?action=generarEnlaceCompartido&id=${id}`, {method:'GET',mode:'no-cors'}).catch(()=>{});
            navigator.clipboard.writeText(url).then(() => {
                const orig = this.innerHTML;
                this.classList.add('copied');
                this.innerHTML = `<i class="fas fa-check"></i> ¡Copiado!`;
                setTimeout(() => {
                    this.classList.remove('copied');
                    this.innerHTML = orig;
                }, 2000);
            });
        };
    });
}

function cargarAlquileres() {
    const email = localStorage.getItem("dueno");
    const script = document.createElement("script");
    script.src = `${API_URL}?action=getAlquileresDueno&dueno=${encodeURIComponent(email)}&callback=mostrarAlquileres`;
    document.body.appendChild(script);
}

function initGoogleCharts() {
    console.log('Inicializando Google Charts...');
    if (typeof google === 'undefined' || !google.charts) {
        console.log('Google Charts no disponible, reintentando en 500ms...');
        setTimeout(initGoogleCharts, 500);
        return;
    }
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(() => {
        console.log('GOOGLE CHARTS CARGADO COMPLETAMENTE');
        window.googleChartsReady = true;
    });
}

window.mostrarModalEstadisticasCallback = function(data, idPropiedad) {
  let datosParaModal = { propiedad: { direccion: `Propiedad ID: ${idPropiedad}` }, metricas: { vistas: 0, contactos: 0 } };
  if (data && data.success && data.vistas !== undefined && data.consultas !== undefined) {
    datosParaModal.metricas.vistas = parseInt(data.vistas) || 0;
    datosParaModal.metricas.contactos = parseInt(data.consultas) || 0;
  }
  mostrarModalEstadisticas(datosParaModal);
};

function usarJSONP(idPropiedad, callbackName) {
  return new Promise((resolve, reject) => {
    callbackName = callbackName || 'jsonp_' + Date.now();
    window[callbackName] = function(data) {
      delete window[callbackName];
      const script = document.querySelector(`script[src*="${callbackName}"]`);
      if (script) script.remove();
      resolve(data);
    };
    const script = document.createElement('script');
    script.src = `${API_URL}?action=getvistasconsultas&id=${idPropiedad}&callback=${callbackName}`;
    script.onerror = () => {
      delete window[callbackName];
      script.remove();
      reject(new Error('JSONP falló'));
    };
    document.body.appendChild(script);
  });
}

function solicitarMetricas(idPropiedad, propId, retryCount = 0) {
    if (typeof google === 'undefined' || !google.charts || !window.googleChartsReady) {
        if (retryCount < 10) {
            setTimeout(() => solicitarMetricas(idPropiedad, propId, retryCount + 1), 500);
            return;
        } else {
            mostrarErrorMetricas(propId);
            return;
        }
    }
    const callbackName = 'metricasCallback_' + Date.now();
    usarJSONP(idPropiedad, callbackName)
      .then(datos => mostrarModalEstadisticasCallback(datos, propId))
      .catch(() => mostrarErrorMetricas(propId));
}

function mostrarErrorMetricas(propId) {
    const datosParaModal = { propiedad: { direccion: `Propiedad ID: ${propId}` }, metricas: { vistas: 0, contactos: 0 } };
    mostrarModalEstadisticas(datosParaModal);
    document.getElementById("msgEstadisticas").style.color = "orange";
    document.getElementById("msgEstadisticas").textContent = "Sin datos aún - ¡Comparte tu propiedad!";
}

function mostrarModalEstadisticas(data) {
  document.getElementById('modal-titulo').textContent = `Estadísticas - ${data.propiedad.direccion}`;
  document.getElementById('modal-vistas').textContent = data.metricas.vistas || 0;
  document.getElementById('modal-contactos').textContent = data.metricas.contactos || 0;
  document.getElementById("modalEstadisticas").style.display = "block";
  document.getElementById("msgEstadisticas").style.color = "green";
  document.getElementById("msgEstadisticas").textContent = "Estadísticas cargadas correctamente";
}

function cerrarModalEstadisticas() {
    document.getElementById("modalEstadisticas").style.display = "none";
    document.getElementById("msgEstadisticas").textContent = "";
}

function formatoPrecio(valor) {
    if (!valor) return "";
    valor = valor.toString().replace(/\D/g, "");
    return "$" + valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function inicializarFormatoPrecio(tipo) {
    document.getElementById(`precio${tipo}`).addEventListener("input", function(e) {
        const cursorPos = this.selectionStart;
        const valorSinSimbolo = this.value.replace(/\D/g, '');
        const formattedValue = formatoPrecio(valorSinSimbolo);
        const prevLength = this.value.length;
        this.value = formattedValue;
        const newLength = formattedValue.length;
        const diff = newLength - prevLength;
        this.selectionStart = cursorPos + diff;
        this.selectionEnd = cursorPos + diff;
    });
}

function formatoPrecioPlan(valor) {
    if (!valor) return "$0,00";
    const numero = parseFloat(valor);
    if (isNaN(numero)) return "$0,00";
    const entero = Math.floor(numero);
    const decimal = Math.round((numero - entero) * 100).toString().padStart(2, "0");
    const enteroFormateado = entero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return `$${enteroFormateado},${decimal}`;
}

function formatoFecha(fecha) {
    if (fecha === "N/D") return fecha;
    const partes = fecha.split("/");
    if (partes.length !== 3) return fecha;
    const [dia, mes, anio] = partes;
    return `${parseInt(dia, 10)}/${parseInt(mes, 10)}/${anio}`;
}

function actualizarPreview(tipo) {
    const previewContainer = document.getElementById(`previewContainer${tipo}`);
    previewContainer.innerHTML = "";
    imagenesBase64[tipo].forEach((imgBase64, index) => {
        const container = document.createElement("div");
        container.className = "preview-img-container";
        const img = document.createElement("img");
        img.src = imgBase64;
        img.className = "preview-img";
        const btnDel = document.createElement("button");
        btnDel.className = "delete-img";
        btnDel.textContent = "x";
        btnDel.onclick = () => { imagenesBase64[tipo].splice(index, 1); actualizarPreview(tipo); };
        container.appendChild(img);
        container.appendChild(btnDel);
        previewContainer.appendChild(container);
    });
}

function inicializarPreviewImagenes(tipo) {
    document.getElementById(`imagenFile${tipo}`).addEventListener("change", function() {
        const files = Array.from(this.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagenesBase64[tipo].push(e.target.result);
                actualizarPreview(tipo);
            }
            reader.readAsDataURL(file);
        });
    });
}

function actualizarVideoPreview(tipo) {
    const videoPreviewContainer = document.getElementById(`videoPreviewContainer${tipo}`);
    videoPreviewContainer.innerHTML = "";
    videosBase64[tipo].forEach((videoBase64, index) => {
        const container = document.createElement("div");
        container.className = "preview-video-container";
        const video = document.createElement("video");
        video.src = videoBase64;
        video.className = "preview-video";
        video.controls = true;
        const btnDel = document.createElement("button");
        btnDel.className = "delete-video";
        btnDel.textContent = "x";
        btnDel.onclick = () => { videosBase64[tipo].splice(index, 1); actualizarVideoPreview(tipo); };
        container.appendChild(video);
        container.appendChild(btnDel);
        videoPreviewContainer.appendChild(container);
    });
}

function inicializarPreviewVideos(tipo) {
    document.getElementById(`videoFile${tipo}`).addEventListener("change", function() {
        const files = Array.from(this.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                videosBase64[tipo].push(e.target.result);
                actualizarVideoPreview(tipo);
            }
            reader.readAsDataURL(file);
        });
    });
}

async function subirImagenCloudinary(file) {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
    try {
        const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
        const json = await res.json();
        return json.secure_url;
    } catch (err) {
        console.error("Error subiendo imagen a Cloudinary:", err);
        return null;
    }
}

async function subirVideoMux(videoFile, row, tipo) {
  const msgEl = document.getElementById(`msg${tipo}`);
  try {
    const base64Video = await fileToBase64(videoFile);
    const response = await fetch(API_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'uploadVideoMux', video: base64Video, row: row })
    });
    if (!response.ok) throw new Error(`Error HTTP! Estado: ${response.status}`);
    const result = await response.json();
    if (result.success) return result.videoUrl;
    else throw new Error(result.error || 'Error desconocido al subir el video');
  } catch (error) {
    console.error('Error subiendo video a Mux:', error.message);
    msgEl.className = "estado-msg error";
    msgEl.textContent = `Error al subir video: ${error.message}`;
    setTimeout(() => { msgEl.textContent = ""; }, 5000);
    throw error;
  }
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(new Error('Error al convertir el video a base64'));
    reader.readAsDataURL(file);
  });
}

function toggleMenu() {
    const menu = document.getElementById("menu");
    menu.classList.toggle("active");
}

function toggleOpcionesPropiedad() {
    const opciones = document.getElementById("opcionesPropiedad");
    const opcionesVenta = document.getElementById("opcionesVenta");
    const opcionesAlquiler = document.getElementById("opcionesAlquiler");
    const btn = document.getElementById("btnAgregarPropiedad");
    if (opciones.classList.contains("active")) {
        opciones.classList.remove("active");
        opcionesVenta.classList.remove("active");
        opcionesAlquiler.classList.remove("active");
        btn.textContent = "Agregar Propiedad";
        resetAllForms();
    } else {
        opciones.classList.add("active");
        btn.textContent = "Cerrar Opciones";
        window.scrollTo(0, document.getElementById("opcionesPropiedad").offsetTop);
    }
}

function mostrarOpcionesPorOperacion() {
    const tipoOperacion = document.getElementById("tipoOperacion").value;
    const opcionesVenta = document.getElementById("opcionesVenta");
    const opcionesAlquiler = document.getElementById("opcionesAlquiler");
    if (tipoOperacion === "Vender") {
        opcionesVenta.classList.add("active");
        opcionesAlquiler.classList.remove("active");
    } else {
        opcionesAlquiler.classList.add("active");
        opcionesVenta.classList.remove("active");
    }
}

function mostrarFormulario(tipo) {
    const formularios = ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'];
    formularios.forEach(f => document.getElementById(`formulario${f}`).classList.remove("active"));
    document.getElementById(`formulario${tipo}`).classList.add("active");
    document.getElementById("btnAgregarPropiedad").textContent = "Cerrar Opciones";
    window.scrollTo(0, document.getElementById(`formulario${tipo}`).offsetTop);
}

window.onload = function() {
    initGoogleCharts();
    const email = localStorage.getItem("dueno");
    if (!email) { window.location.href = "index.html"; return; }
    cargarEstadoPlan();
    cargarAlquileres();
    cargarPreciosPlanes();
    cargarDatosCuenta();
    checkPaymentOnReturn();
    ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'].forEach(tipo => {
        inicializarPreviewImagenes(tipo);
        inicializarPreviewVideos(tipo);
        if (tipo === 'Departamento' || tipo === 'Terreno' || tipo === 'Casa') inicializarFormatoPrecio(tipo);
    });
    document.getElementById("tipoOperacion").addEventListener("change", mostrarOpcionesPorOperacion);
}
async function checkPaymentOnReturn() {
const urlParams = new URLSearchParams(window.location.search);
const status = urlParams.get("status");
const paymentId = urlParams.get("payment_id");
const planStatusEl = document.getElementById("planStatus");
if (status && paymentId) {
planStatusEl.innerHTML = `<span class="estado-msg loading">Verificando estado del pago...</span>`;
try {
const response = await fetch(`https://api.mercadopago.com/v1/payments/${paymentId}`, {
method: "GET",
headers: { "Authorization": "Bearer " + MP_BEARER }
});
const paymentData = await response.json();
if (response.ok && paymentData.status === "approved") {
const [email, plan] = paymentData.external_reference.split("_");
const script = document.createElement("script");
script.src = `${API_URL}?action=updatePlan&email=${encodeURIComponent(email)}&plan=${plan}&payment_id=${paymentId}&estadoPago=Aprobado&descripcionPago=Pago%20plan%20${plan}%20-%20ID:%20${paymentId}&callback=planActualizado`;
document.body.appendChild(script);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">Pago no aprobado. Estado: ${paymentData.status || "Desconocido"}.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
} catch (err) {
console.error("Error verificando pago:", err);
planStatusEl.innerHTML = `<span class="estado-msg error">Error al verificar el pago. Por favor, intenta de nuevo.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
window.history.replaceState({}, document.title, window.location.pathname);
}
}
function cargarPreciosPlanes() {
const script = document.createElement("script");
script.src = `${API_URL}?action=getPlanes&callback=mostrarPreciosPlanes`;
document.body.appendChild(script);
}
function mostrarPreciosPlanes(res) {
if (res.success && res.data && res.data.length) {
res.data.forEach(plan => {
preciosPlanes[plan.nombre] = parseFloat(plan.precio) || 0;
});
document.getElementById("precioBasico").textContent = formatoPrecioPlan(preciosPlanes.Basico) + " / mes";
document.getElementById("precioPlus").textContent = formatoPrecioPlan(preciosPlanes.Plus) + " / mes";
document.getElementById("precioFull").textContent = formatoPrecioPlan(preciosPlanes.Full) + " / mes";
} else {
console.error("Error al cargar precios de planes:", res);
}
}
function cargarEstadoPlan() {
const email = localStorage.getItem("dueno");
const script = document.createElement("script");
script.src = `${API_URL}?action=getLoginInfo&email=${encodeURIComponent(email)}&callback=mostrarEstadoPlan`;
document.body.appendChild(script);
}
function mostrarEstadoPlan(res) {
const planStatusEl = document.getElementById("planStatus");
if (!res.success || !res.data || !res.data[0]) {
planActual = null;
limiteDeptos = 0;
planStatusEl.innerHTML = `Plan: <b>Sin plan</b> | Estado de Pago: N/D | Vencimiento: N/D`;
document.getElementById("btnPlan").textContent = "Elegir Plan";
document.getElementById("limiteAlquileres").textContent = "";
return;
}
const login = res.data[0];
planActual = login.Plan || null;
limiteDeptos = planActual === "Prueba" ? Infinity : planActual === "Basico" ? 3 : planActual === "Plus" ? 5 : planActual === "Full" ? 10 : 0;
const estadoPago = login.EstadoPago || "No registrado";
const vencimiento = formatoFecha(login.Vencimiento || "N/D");
let planStatusHTML = `Plan: <b>${planActual || "Sin plan"}</b> | Estado de Pago: ${estadoPago} | Vencimiento: ${vencimiento}`;
if (planActual === "Prueba" && vencimiento !== "N/D") {
const vencimientoDate = new Date(vencimiento.split("/").reverse().join("-"));
const today = new Date();
const diffTime = vencimientoDate - today;
const diasRestantes = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
if (diasRestantes > 0) {
planStatusHTML += `<br><span style="color:#00FF00">Te quedan ${diasRestantes} días para mostrar tus departamentos GRATIS con el plan Prueba</span>`;
} else {
planStatusHTML += `<br><span style="color:red">Plan Prueba vencido, tus alquileres no se mostrarán en el mapa</span>`;
}
} else if (vencimiento !== "N/D") {
const vencimientoDate = new Date(vencimiento.split("/").reverse().join("-"));
const today = new Date();
if (vencimientoDate < today) {
planStatusHTML += `<br><span style="color:red">Plan vencido, tus alquileres no se mostrarán en el mapa</span>`;
}
}
planStatusEl.innerHTML = planStatusHTML;
document.getElementById("limiteAlquileres").textContent = planActual === "Prueba" ? `${deptosActivos} propiedades activas` : `${deptosActivos}/${limiteDeptos} propiedades activas`;
document.getElementById("btnPlan").textContent = planActual ? "Mejorar Plan" : "Elegir Plan";
}
function abrirModalPlan() { document.getElementById("modalPlan").style.display = "block"; }
function cerrarModalPlan() {
document.getElementById("modalPlan").style.display = "none";
document.getElementById("mpBtnBasico").innerHTML = "";
document.getElementById("mpBtnPlus").innerHTML = "";
document.getElementById("mpBtnFull").innerHTML = "";
}
async function seleccionarPlan(plan, retries = 3) {
const email = localStorage.getItem("dueno");
const precio = preciosPlanes[plan] || 0;
const planStatusEl = document.getElementById("planStatus");
planStatusEl.innerHTML = `<span class="estado-msg loading">Procesando pago...</span>`;
const preferenceData = {
items: [{ title: `Plan ${plan}`, quantity: 1, unit_price: parseFloat(precio), currency_id: "ARS" }],
payer: { email: email },
external_reference: email + "_" + plan,
back_urls: {
success: window.location.href,
failure: window.location.href,
pending: window.location.href
},
auto_return: "approved",
notification_url: `${API_URL}?action=updatePlan`
};
try {
const response = await fetch("https://api.mercadopago.com/checkout/preferences", {
method: "POST",
headers: { "Authorization": "Bearer " + MP_BEARER, "Content-Type": "application/json" },
body: JSON.stringify(preferenceData)
});
const res = await response.json();
if (res.init_point) {
const mpContainer = document.getElementById("mpBtn" + plan);
mpContainer.innerHTML = `<iframe src="${res.init_point}" width="100%" height="650" frameborder="0" allowtransparency="true"></iframe>`;
planStatusEl.innerHTML = `<span class="estado-msg loading">Iniciando pago. Esperando confirmación...</span>`;
} else {
console.error("Error MP:", res);
if (retries > 0) {
console.log(`Reintentando (${retries} restantes)...`);
setTimeout(() => seleccionarPlan(plan, retries - 1), 2000);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">No se pudo generar el botón de pago. Revisa la consola.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
}
} catch (err) {
console.error("Error MP:", err);
if (retries > 0) {
console.log(`Reintentando (${retries} restantes)...`);
setTimeout(() => seleccionarPlan(plan, retries - 1), 2000);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">Error al procesar el pago. Por favor, intenta de nuevo.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
}
}
function planActualizado(res) {
const planStatusEl = document.getElementById("planStatus");
if (res.success) {
planStatusEl.innerHTML = `<span class="estado-msg success">Plan actualizado con éxito: ${res.plan}</span>`;
setTimeout(() => {
planStatusEl.innerHTML = "";
cargarEstadoPlan();
cargarAlquileres();
cerrarModalPlan();
}, 3000);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">Error al actualizar el plan: ${res.error || "desconocido"}</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
}
function cargarAlquileres() {
const email = localStorage.getItem("dueno");
const script = document.createElement("script");
script.src = `${API_URL}?action=getAlquileresDueno&dueno=${encodeURIComponent(email)}&callback=mostrarAlquileres`;
document.body.appendChild(script);
}
async function agregarAlquiler(tipo) {
const msgEl = document.getElementById(`msg${tipo}`);
msgEl.textContent = "Agregando propiedad...";
msgEl.className = "estado-msg loading";
let direccion = document.getElementById(`direccion${tipo}`).value;
const ambientes = (tipo === "Departamento" || tipo === "Casa") ? document.getElementById(`ambientes${tipo}`).value : "";
let precio = (tipo === "Departamento" || tipo === "Terreno" || tipo === "Casa") ? document.getElementById(`precio${tipo}`).value.replace(/\D/g, "") : "";
const superficie = tipo === "Terreno" ? document.getElementById(`superficie${tipo}`).value : "";
const patio = tipo === "Casa" ? document.getElementById(`patio${tipo}`).value : "";
const garage = tipo === "Casa" ? document.getElementById(`garage${tipo}`).value : "";
const antiguedad = tipo === "Casa" ? document.getElementById(`antiguedad${tipo}`).value : "";
const infoIngreso = document.getElementById(`infoIngreso${tipo}`).value;
const detalles = document.getElementById(`detalles${tipo}`).value;
const operacion = document.getElementById("tipoOperacion").value;
let row = document.getElementById(`editRow${tipo}`).value || new Date().getTime();
const enlaceCompartir = document.getElementById(`editRow${tipo}`).value ? document.getElementById(`enlaceCompartir${tipo}`).value : "";
const email = localStorage.getItem("dueno");
if (!direccion ||
    (tipo === "Departamento" && (!ambientes || !precio)) ||
    (tipo === "Terreno" && (!superficie || !precio)) ||
    (tipo === "Casa" && (!ambientes || !precio))) {
msgEl.className = "estado-msg error";
msgEl.textContent = "Completa todos los campos obligatorios.";
setTimeout(() => { msgEl.textContent = ""; }, 5000);
return;
}
direccion = direccion + ", Santo Tomé Corrientes";
const files = document.getElementById(`imagenFile${tipo}`).files;
let uploadedURLs = [];
for (let i = 0; i < files.length; i++) {
const url = await subirImagenCloudinary(files[i]);
if (url) uploadedURLs.push(url);
}
const videoFiles = document.getElementById(`videoFile${tipo}`).files;
let videos = "";
if (videoFiles.length > 0) {
let videoURLs = [];
for (let i = 0; i < videoFiles.length; i++) {
const url = await subirVideoMux(videoFiles[i], row, tipo);
if (url) videoURLs.push(url);
}
videos = videoURLs.join(",");
} else if (document.getElementById(`editRow${tipo}`).value) {
videos = document.getElementById(`existingVideos${tipo}`).value;
}
fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(direccion)}&key=${GEOCODE_KEY}`)
.then(r => r.json()).then(data => {
let lat = "", lng = "";
if (data.results && data.results[0]) {
lat = data.results[0].geometry.location.lat;
lng = data.results[0].geometry.location.lng;
}
enviarAlquiler(tipo, uploadedURLs.join(","), lat, lng, enlaceCompartir, videos, operacion);
}).catch(err => {
msgEl.className = "estado-msg error";
msgEl.textContent = "Error al obtener coordenadas: " + (err.message || "Error de conexión");
setTimeout(() => { msgEl.textContent = ""; }, 5000);
});
function enviarAlquiler(tipo, fotosConcatenadas, lat, lng, enlaceCompartir, videos, operacion) {
const action = document.getElementById(`editRow${tipo}`).value ? "editAlquiler" : "addAlquiler";
const callback = action === "editAlquiler" ? "alquilerEditado" : "alquilerAgregado";
let estado = "Activo";
if (action === "editAlquiler" && deptosActivos >= limiteDeptos && planActual !== "Prueba") {
estado = "Inactivo";
}
const script = document.createElement("script");
let query = `${API_URL}?action=${action}&row=${row}&dueno=${encodeURIComponent(email)}&direccion=${encodeURIComponent(direccion)}&tipo=${encodeURIComponent(tipo)}`;
if (tipo === "Departamento" || tipo === "Casa") query += `&ambientes=${encodeURIComponent(ambientes)}`;
if (tipo === "Departamento" || tipo === "Terreno" || tipo === "Casa") query += `&precio=${encodeURIComponent(precio)}`;
if (tipo === "Terreno") query += `&superficie=${encodeURIComponent(superficie)}`;
if (tipo === "Casa") {
query += `&patio=${encodeURIComponent(patio)}`;
query += `&garage=${encodeURIComponent(garage)}`;
query += `&antiguedad=${encodeURIComponent(antiguedad)}`;
}
query += `&fotos=${encodeURIComponent(fotosConcatenadas)}&infoIngreso=${encodeURIComponent(infoIngreso)}&detalles=${encodeURIComponent(detalles)}&lat=${lat}&lng=${lng}&contacto=auto&estado=${estado}&videos=${encodeURIComponent(videos)}&operacion=${encodeURIComponent(operacion)}`;
if (enlaceCompartir) query += `&enlaceCompartir=${encodeURIComponent(enlaceCompartir)}`;
query += `&callback=${callback}`;
script.src = query;
document.body.appendChild(script);
}
}
function resetAllForms() {
['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'].forEach(tipo => {
document.getElementById(`formulario${tipo}`).classList.remove("active");
document.getElementById(`editRow${tipo}`).value = "";
document.getElementById(`enlaceCompartir${tipo}`).value = "";
document.getElementById(`existingVideos${tipo}`).value = "";
document.getElementById(`direccion${tipo}`).value = "";
if (tipo === "Departamento" || tipo === "Casa") {
document.getElementById(`ambientes${tipo}`).value = "";
document.getElementById(`precio${tipo}`).value = "";
}
if (tipo === "Terreno") {
document.getElementById(`superficie${tipo}`).value = "";
document.getElementById(`precio${tipo}`).value = "";
}
if (tipo === "Casa") {
document.getElementById(`patio${tipo}`).value = "Sí";
document.getElementById(`garage${tipo}`).value = "Sí";
document.getElementById(`antiguedad${tipo}`).value = "";
}
document.getElementById(`infoIngreso${tipo}`).value = "";
document.getElementById(`detalles${tipo}`).value = "";
document.getElementById(`imagenFile${tipo}`).value = "";
document.getElementById(`videoFile${tipo}`).value = "";
imagenesBase64[tipo] = [];
videosBase64[tipo] = [];
actualizarPreview(tipo);
actualizarVideoPreview(tipo);
document.getElementById(`msg${tipo}`).textContent = "";
document.getElementById(`btnGuardar${tipo}`).textContent = "Agregar";
});
document.getElementById("opcionesPropiedad").classList.remove("active");
document.getElementById("opcionesVenta").classList.remove("active");
document.getElementById("opcionesAlquiler").classList.remove("active");
document.getElementById("btnAgregarPropiedad").textContent = "Agregar Propiedad";
document.getElementById("tipoOperacion").value = "Vender";
mostrarOpcionesPorOperacion();
}
function editarAlquiler(row, datos) {
const tipo = datos.Tipo || "Departamento";
document.getElementById("btnAgregarPropiedad").textContent = "Cerrar Opciones";
document.getElementById(`formulario${tipo}`).classList.add("active");
document.getElementById(`btnGuardar${tipo}`).textContent = "Guardar Cambios";
document.getElementById(`editRow${tipo}`).value = row;
document.getElementById(`enlaceCompartir${tipo}`).value = datos["Enlace para compartir"] || "";
document.getElementById(`existingVideos${tipo}`).value = datos.Videos || "";
document.getElementById(`direccion${tipo}`).value = datos.Direccion || "";
if (tipo === "Departamento" || tipo === "Casa") {
document.getElementById(`ambientes${tipo}`).value = datos["Nro Ambientes"] || "";
document.getElementById(`precio${tipo}`).value = formatoPrecio(datos.Precio);
}
if (tipo === "Terreno") {
document.getElementById(`superficie${tipo}`).value = datos.Superficie || "";
document.getElementById(`precio${tipo}`).value = formatoPrecio(datos.Precio);
}
if (tipo === "Casa") {
document.getElementById(`patio${tipo}`).value = datos.Patio || "No";
document.getElementById(`garage${tipo}`).value = datos.Garage || "No";
document.getElementById(`antiguedad${tipo}`).value = datos.Antiguedad || "";
}
document.getElementById(`infoIngreso${tipo}`).value = datos.InfoIngreso || "";
document.getElementById(`detalles${tipo}`).value = datos.Detalles || "";
document.getElementById("tipoOperacion").value = datos.Operacion || "Vender";
mostrarOpcionesPorOperacion();
imagenesBase64[tipo] = datos.Fotos ? datos.Fotos.split(",") : [];
videosBase64[tipo] = datos.Videos ? datos.Videos.split(",") : [];
actualizarPreview(tipo);
actualizarVideoPreview(tipo);
window.scrollTo(0, document.getElementById(`formulario${tipo}`).offsetTop);
}
async function cambiarEstado(row, estadoActual) {
const msgEl = document.getElementById(`estadoMsg-${row}`);
if (estadoActual === "Inactivo" && deptosActivos >= limiteDeptos && planActual !== "Prueba") {
msgEl.className = "estado-msg error";
msgEl.textContent = `No puedes activar más propiedades. Tu plan (${planActual}) permite hasta ${limiteDeptos} propiedades activas.`;
setTimeout(() => { msgEl.textContent = ""; }, 5000);
return;
}
msgEl.className = "estado-msg loading";
msgEl.textContent = "Cambiando Estado";
try {
const response = await fetch(`${API_URL}?action=toggleEstado&row=${row}`);
const res = await response.json();
estadoCambiado(res, row);
} catch (err) {
msgEl.className = "estado-msg error";
msgEl.textContent = `Error al cambiar estado: ${err.message || "Error de conexión"}`;
setTimeout(() => { msgEl.textContent = ""; }, 5000);
console.error("Error en cambio de estado:", err);
}
}
function estadoCambiado(res, row) {
const msgEl = document.getElementById(`estadoMsg-${row}`);
if (res.success) {
msgEl.className = "estado-msg success";
msgEl.textContent = "Estado cambiado con éxito";
setTimeout(() => { msgEl.textContent = ""; }, 3000);
cargarAlquileres();
} else {
msgEl.className = "estado-msg error";
msgEl.textContent = `Error al cambiar estado: ${res.error || "desconocido"}`;
setTimeout(() => { msgEl.textContent = ""; }, 5000);
}
}
function eliminarAlquiler(row) {
if (!confirm("¿Seguro que deseas eliminar esta propiedad?")) return;
const script = document.createElement("script");
script.src = `${API_URL}?action=deleteAlquiler&row=${row}&callback=cargarAlquileres`;
document.body.appendChild(script);
}
function logout() { localStorage.removeItem("dueno"); window.location.href = "index.html"; }
function alquilerAgregado(res) {
const formularios = ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'];
formularios.forEach(tipo => {
const msgEl = document.getElementById(`msg${tipo}`);
if (res.success) {
msgEl.className = "estado-msg success";
msgEl.textContent = "Propiedad agregada con éxito";
setTimeout(() => {
resetAllForms();
cargarAlquileres();
cargarEstadoPlan();
}, 3000);
} else {
msgEl.className = "estado-msg error";
msgEl.textContent = "Error al agregar: " + (res.error || "desconocido");
setTimeout(() => { msgEl.textContent = ""; }, 5000);
}
});
}
function alquilerEditado(res) {
const formularios = ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'];
formularios.forEach(tipo => {
const msgEl = document.getElementById(`msg${tipo}`);
if (res.success) {
msgEl.className = "estado-msg success";
msgEl.textContent = "Cambios guardados correctamente";
setTimeout(() => {
resetAllForms();
cargarAlquileres();
}, 3000);
} else {
msgEl.className = "estado-msg error";
msgEl.textContent = "Error al editar: " + (res.error || "desconocido");
setTimeout(() => { msgEl.textContent = ""; }, 5000);
}
});
}
function abrirModalEditarCuenta() {
document.getElementById("modalEditarCuenta").style.display = "block";
cargarDatosCuenta();
}
function cerrarModalEditarCuenta() {
document.getElementById("modalEditarCuenta").style.display = "none";
document.getElementById("emailEditar").value = "";
document.getElementById("nombreEditar").value = "";
document.getElementById("contactoEditar").value = "";
document.getElementById("passwordEditar").value = "";
document.getElementById("codigoPaisEditar").value = "+549";
document.getElementById("msgEditarCuenta").textContent = "";
document.getElementById("passwordEditar").type = "password";
document.querySelector(".toggle-password").textContent = "Mostrar";
}
function cargarDatosCuenta() {
const email = localStorage.getItem("dueno");
const msgEl = document.getElementById("msgEditarCuenta");
const script = document.createElement("script");
script.src = `${API_URL}?action=getLoginInfo&email=${encodeURIComponent(email)}&callback=mostrarDatosCuenta`;
document.body.appendChild(script);
}
function mostrarDatosCuenta(res) {
  const msgEl = document.getElementById("msgEditarCuenta");
  const countryCodes = ["+549", "+55", "+598", "+56", "+595"];
  if (res.success && res.data && res.data[0]) {
    const login = res.data[0];
    document.getElementById("emailEditar").value = login.Email || "";
    document.getElementById("nombreEditar").value = login.Nombre || "";
    document.getElementById("passwordEditar").value = login.Password || "";
    let contacto = login.Contacto || "";
    let codigoPais = "+549";
    let numero = "";
    if (typeof contacto === "string" && contacto.trim() !== "") {
      for (const code of countryCodes) {
        if (contacto.startsWith(code)) {
          codigoPais = code;
          numero = contacto.slice(code.length).trim();
          break;
        }
      }
    }
    document.getElementById("codigoPaisEditar").value = codigoPais;
    document.getElementById("contactoEditar").value = numero;
    msgEl.textContent = "";
  } else {
    msgEl.style.color = "red";
    msgEl.textContent = "Error al cargar los datos de la cuenta";
    setTimeout(() => { msgEl.textContent = ""; }, 3000);
  }
}
function togglePasswordVisibility() {
const passwordInput = document.getElementById("passwordEditar");
const toggleButton = document.querySelector(".toggle-password");
if (passwordInput.type === "password") {
passwordInput.type = "text";
toggleButton.textContent = "Ocultar";
} else {
passwordInput.type = "password";
toggleButton.textContent = "Mostrar";
}
}
async function editarCuenta() {
const email = localStorage.getItem("dueno");
const newEmail = document.getElementById("emailEditar").value;
const nombre = document.getElementById("nombreEditar").value;
const codigoPais = document.getElementById("codigoPaisEditar").value;
const contacto = document.getElementById("contactoEditar").value;
const password = document.getElementById("passwordEditar").value;
const msgEl = document.getElementById("msgEditarCuenta");
if (!newEmail && !nombre && !contacto && !password) {
msgEl.style.color = "red";
msgEl.textContent = "Debes completar al menos un campo para actualizar.";
return;
}
if (newEmail && !newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
msgEl.style.color = "red";
msgEl.textContent = "Ingresa un email válido.";
return;
}
if (password && password.length < 6) {
msgEl.style.color = "red";
msgEl.textContent = "La contraseña debe tener al menos 6 caracteres.";
return;
}
if (contacto && !contacto.match(/^\d{6,}$/)) {
msgEl.style.color = "red";
msgEl.textContent = "El número de teléfono debe contener solo dígitos y al menos 6 caracteres.";
return;
}
msgEl.textContent = "Guardando cambios...";
try {
let query = `${API_URL}?action=editarDueno&email=${encodeURIComponent(email)}`;
if (newEmail) query += `&newEmail=${encodeURIComponent(newEmail)}`;
if (nombre) query += `&nombre=${encodeURIComponent(nombre)}`;
if (contacto) query += `&contacto=${encodeURIComponent(codigoPais + contacto)}`;
if (password) query += `&password=${encodeURIComponent(password)}`;
const response = await fetch(query);
const res = await response.json();
if (res.success) {
msgEl.style.color = "green";
msgEl.textContent = "Cambios guardados con éxito";
if (newEmail) localStorage.setItem("dueno", newEmail);
setTimeout(cerrarModalEditarCuenta, 1000);
} else {
msgEl.style.color = "red";
msgEl.textContent = "Error al guardar: " + (res.error || "desconocido");
}
} catch (err) {
msgEl.style.color = "red";
msgEl.textContent = "Error al guardar: " + (err.message || "Error de conexión");
console.error("Error en edición de cuenta:", err);
}
}
</script>
</body>
</html>
