<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Due√±os</title>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SSJ5DG33JK"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-SSJ5DG33JK');
</script>
<link rel="icon" type="image/png" href="https://i.postimg.cc/MKpMcrcQ/AlquiYa.png">
<style>
/* --- CSS adaptado para m√≥vil con textos m√°s grandes y centrados --- */
body { font-family: Arial, sans-serif; margin: 10px; background:#f5f5f5; font-size:20px; text-align:center; margin-top: 120px; }
h2 { color:#333; font-size:2.2em; margin-bottom:18px; }
h3 { color:#333; font-size:2em; margin-bottom:18px; }
.alquiler { border:1px solid #ccc; padding:16px; margin:14px 0; background:#fff; font-size:1.4em; text-align:left; }
button { margin: 6px; padding:14px 20px; font-size:1.3em; border-radius:6px; cursor:pointer; }
#btnAgregarAlquiler { background:#3681f3; color:white; }
#formulario { background:#fff; padding:20px; border:1px solid #ccc; margin-top:24px; border-radius:12px; font-size:1.3em; text-align:left; display:none; }
#formulario.active { display:block; }
#formularioRegistro { background:#fff; padding:20px; border:1px solid #ccc; margin-top:24px; border-radius:12px; font-size:1.3em; text-align:left; display:none; }
#formularioRegistro.active { display:block; }
label { display:block; margin:12px 0 8px; font-weight:bold; }
input, select, textarea { width:100%; padding:14px; margin-bottom:16px; font-size:1.2em; border-radius:8px; border:1px solid #ccc; }
.contacto-container { display: flex; gap: 12px; align-items: center; }
.contacto-container select { width: 60px; }
.contacto-container input { flex: 1; min-width: 150px; }
.password-container { display: flex; gap: 12px; align-items: center; }
.password-container input { flex: 1; }
.password-container .toggle-password { padding: 10px; font-size: 1.3em; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; background: #fff; }
.preview-img { max-width: 140px; margin-top: 6px; display:inline-block; position:relative; border-radius:6px; }
.preview-img-container { display:inline-block; margin-right:6px; position:relative; }
.delete-img { position:absolute; top:0; right:0; background:red; color:white; border:none; border-radius:50%; cursor:pointer; font-weight:bold; padding:3px 8px; }
#planStatus { margin:14px 0; font-weight:bold; font-size:1.4em; text-align:center; padding:12px; border-radius:6px; }
progress { width: 100%; height:24px; }
.modal {
display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
overflow: auto; background-color: rgba(0,0,0,0.5);
}
.modal-content {
background-color: #fefefe; margin: 10% auto; padding: 28px; border: 1px solid #888; width: 95%; max-width: 700px; border-radius:14px; text-align:center;
}
.modal-content input, .modal-content select { width: calc(100% - 28px); }
.modal h3 { margin-top:0; font-size:1.7em; }
.plan-option { border:1px solid #ccc; padding:14px; margin:14px 0; border-radius:12px; font-size:1.3em; }
.plan-option button { margin-top:8px; padding:12px 18px; font-size:1.2em; border-radius:8px; }
iframe { width:100%; min-height:500px; border:none; border-radius:6px; margin-top:12px; }
#planContainer { background:#3681f3; color:white; padding:12px; border:1px solid #ccc; border-radius:6px; font-size:1.2em; display:flex; flex-direction:column; align-items:center; width: calc(100% - 24px); min-height: 250px; height: auto; margin: 20px auto; }
#planContainer button { background:#fff; }
#contactoBtn { position:fixed; bottom:24px; right:24px; background:#25D366; color:white; border:none; border-radius:50%; padding:24px; font-size:2em; cursor:pointer; box-shadow:0 3px 6px rgba(0,0,0,0.2); }
.estado-msg { font-size: 1.1em; margin-top: 6px; display: block; }
.estado-msg.loading { color: blue; }
.estado-msg.success { color: green; }
.estado-msg.error { color: red; }
/* Estilos para el men√∫ hamburguesa */
#menu-toggle {
position: fixed;
top: 20px;
right: 20px;
font-size: 30px;
cursor: pointer;
z-index: 1001;
background: none;
border: none;
color: #333;
}
#menu {
display: none;
position: fixed;
top: 60px;
right: 20px;
background: #fff;
border: 1px solid #ccc;
border-radius: 8px;
box-shadow: 0 2px 5px rgba(0,0,0,0.2);
z-index: 1001;
}
#menu.active { display: block; }
#menu button {
display: block;
width: 100%;
padding: 14px 20px;
font-size: 1.3em;
text-align: left;
border: none;
background: none;
cursor: pointer;
}
#menu button:hover { background: #f0f0f0; }
/* Estilo para la flecha de volver atr√°s */
#back-arrow {
position: fixed;
top: 20px;
left: 20px;
font-size: 30px;
cursor: pointer;
z-index: 1001;
background: none;
border: none;
color: #333;
padding: 10px;
}
#back-arrow:hover {
background: #f0f0f0;
border-radius: 50%;
}
/* Mobile-specific styles */
@media screen and (max-width: 600px) {
body { font-size: 24px; margin-top: 140px; }
h2 { font-size: 2.6em; }
h3 { font-size: 2.4em; }
.alquiler { font-size: 1.6em; padding: 20px; }
button { font-size: 1.5em; padding: 16px 22px; }
#formulario, #formularioRegistro { font-size: 1.5em; padding: 24px; }
input, select, textarea { font-size: 1.4em; padding: 16px; }
.contacto-container select { width: 80px; }
.contacto-container input { distill-none: 150px; }
.password-container .toggle-password { padding: 12px; font-size: 1.5em; }
.preview-img { max-width: 160px; }
#planStatus { font-size: 1.6em; }
.modal-content { width: 98%; max-width: 98%; font-size: 1.3em; padding: 28px; }
.plan-option { font-size: 1.5em; padding: 14px; }
#planContainer { font-size: 1.4em; padding: 12px; min-width: 200px; }
#contactoBtn { font-size: 2.2em; padding: 28px; }
#menu-toggle { font-size: 34px; top: 24px; right: 24px; }
#menu { top: 70px; right: 24px; }
#menu button { font-size: 1.5em; padding: 16px 22px; }
#back-arrow { font-size: 34px; top: 24px; left: 24px; }
}
#publicidad-container {
background: white;
border: 1px solid #ccc;
border-radius: 8px;
padding: 20px;
margin: 10px auto;
max-width: 700px;
text-align: center;
cursor: pointer;
}
#publicidad-container p {
margin: 5px 0;
font-size: 1.2em;
font-weight: bold;
color: #333;
}
</style>
</head>
<body>
<header style="position: static; top: 0; left: 0; width: 100%; background: white; z-index: 1000; text-align: center; padding: 15px; box-sizing: border-box;">
<button id="back-arrow" onclick="window.location.href='index.html'">‚Üê</button>
<img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="Logo Alqui Ya" style="max-width: 350px; margin-bottom: 10px;">
<button id="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
<div id="menu">
<button onclick="abrirModalEditarCuenta()">Editar Cuenta</button>
<button onclick="logout()">Cerrar Sesi√≥n</button>
</div>
</header>

<div id="planContainer">
<b>Mi plan</b>
<div id="planStatus"></div>
<span id="limiteAlquileres"></span>
<button id="btnPlan" onclick="abrirModalPlan()">üí≥ Mejorar Plan</button>
</div>

<h3>üìã Mis Alquileres</h3>
<div id="listaAlquileres">Cargando...</div>

<button id="btnAgregarAlquiler" onclick="toggleFormulario()">‚ûï Agregar Alquiler</button>
<div id="rapiclean-img-duenos">
<a href="https://wa.me/5493764391885?text=Hola,+%22podrian+darme+informacion+sobre+los+Planes+para+Due%C3%B1os%22&utm_source=chatgpt.com" target="_blank">
<img src="https://i.postimg.cc/28HKjzTs/M-s-de-40-estudiantes-ya-confiaron-en-Rapiclean-2.png" alt="M√°s de 40 estudiantes confiaron en Rapiclean" style="max-width:100%;margin:10px auto;display:block;">
</a>
<a href="https://wa.me/5493764275443?text=Hola,+quiero+publicitar+en+AlquiYa&utm_source=chatgpt.com" target="_blank">
<div id="publicidad-container">
<p>Espacio Publicitario</p>
<p>Haz clic para publicitar aqu√≠</p>
</div>
</a>
</div>
<div id="formulario">
<input type="hidden" id="editRow" value="">
<label>Direcci√≥n</label>
<input type="text" id="direccion">

<label>Ambientes</label>
<input type="number" id="ambientes">

<label>Precio</label>
<input type="text" id="precio">

<label>Mascotas Permitidas</label>
<select id="mascotas">
<option value="S√≠">S√≠</option>
<option value="No">No</option>
</select>

<label>Im√°genes del Alquiler (PNG/JPG, m√∫ltiples)</label>
<input type="file" id="imagenFile" accept="image/png, image/jpeg" multiple>
<div id="previewContainer"></div>

<label>Informaci√≥n de ingreso</label>
<textarea id="infoIngreso" rows="2"></textarea>

<label>Detalles</label>
<textarea id="detalles" rows="3"></textarea>

<button id="btnGuardar" onclick="agregarAlquiler()">Agregar</button>
<p id="msg" style="color:green"></p>
</div>

<!-- Modal de Planes -->
<div id="modalPlan" class="modal">
<div class="modal-content">
<h3>Elige tu plan</h3>
<div class="plan-option">
<b>B√°sico</b> - Hasta 3 deptos activos
<p id="precioBasico">$0 / mes</p>
<button onclick="seleccionarPlan('Basico')">Elegir B√°sico</button>
<div id="mpBtnBasico"></div>
</div>
<div class="plan-option">
<b>Plus</b> - Hasta 5 deptos activos
<p id="precioPlus">$0 / mes</p>
<button onclick="seleccionarPlan('Plus')">Elegir Plus</button>
<div id="mpBtnPlus"></div>
</div>
<div class="plan-option">
<b>Full</b> - Hasta 10 deptos activos
<p id="precioFull">$0 / mes</p>
<button onclick="seleccionarPlan('Full')">Elegir Full</button>
<div id="mpBtnFull"></div>
</div>
<button onclick="cerrarModalPlan()">Cerrar</button>
</div>
</div>

<!-- Modal de Editar Cuenta -->
<div id="modalEditarCuenta" class="modal">
<div class="modal-content">
<h3>Editar Cuenta</h3>
<label>Email</label>
<input type="email" id="emailEditar" placeholder="Dejar en blanco para mantener actual">
<label>Nombre</label>
<input type="text" id="nombreEditar" placeholder="Dejar en blanco para mantener actual">
<label>Contacto (Tel√©fono)</label>
<div class="contacto-container">
<select id="codigoPaisEditar">
<option value="+549">Argentina (+549)</option>
<option value="+55">Brasil (+55)</option>
<option value="+598">Uruguay (+598)</option>
<option value="+56">Chile (+56)</option>
<option value="+595">Paraguay (+595)</option>
</select>
<input type="text" id="contactoEditar" placeholder="Ej: 3764275443">
</div>
<label>Contrase√±a</label>
<div class="password-container">
<input type="password" id="passwordEditar" placeholder="Dejar en blanco para mantener actual">
<button class="toggle-password" onclick="togglePasswordVisibility()">üëÅ</button>
</div>
<button onclick="editarCuenta()">Guardar Cambios</button>
<button onclick="cerrarModalEditarCuenta()">Cerrar</button>
<p id="msgEditarCuenta" style="color:green"></p>
</div>
</div>

<button id="contactoBtn" title="¬øNecesitas ayuda o tuviste inconvenientes?" onclick="window.open('https://wa.me/5493764275443', '_blank')">Ayuda</button>

<script>
// === CONSTANTES Y VARIABLES ===
const API_URL = "https://script.google.com/macros/s/AKfycbwDl73ZMnMowfSu_NoISSSc4fnQpLp6kaxT9Dz5jMjE9NxT64AmeN23ORQy8lejul6S/exec";
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dnugmwern/image/upload";
const CLOUDINARY_UPLOAD_PRESET = "preset_alquileres";
const GEOCODE_KEY = "AIzaSyAisqYSTfpQ_rqqutAomzitD2v_dtKYtLE";
const MP_BEARER = "APP_USR-595288641172928-010710-d915bce4137b3ee26e0c6e04873f1ac1-695835795";
let imagenesBase64 = [];
let planActual = null;
let limiteDeptos = 0;
let deptosActivos = 0;
let preciosPlanes = {Basico: 0, Plus: 0, Full: 0};

// === FORMATO DE PRECIO ===
function formatoPrecio(valor) {
if (!valor) return "";
valor = valor.toString().replace(/\D/g, "");
return "$" + valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
document.getElementById("precio").addEventListener("input", function() {
const cursorPos = this.selectionStart;
const valorSinSimbolo = this.value.replace(/\D/g, '');
this.value = formatoPrecio(valorSinSimbolo);
this.selectionEnd = cursorPos;
});

// === PREVIEW IM√ÅGENES ===
function actualizarPreview() {
const previewContainer = document.getElementById("previewContainer");
previewContainer.innerHTML = "";
imagenesBase64.forEach((imgBase64, index) => {
const container = document.createElement("div");
container.className = "preview-img-container";
const img = document.createElement("img");
img.src = imgBase64;
img.className = "preview-img";
const btnDel = document.createElement("button");
btnDel.className = "delete-img";
btnDel.textContent = "x";
btnDel.onclick = () => { imagenesBase64.splice(index, 1); actualizarPreview(); };
container.appendChild(img);
container.appendChild(btnDel);
previewContainer.appendChild(container);
});
}
document.getElementById("imagenFile").addEventListener("change", function() {
const files = Array.from(this.files);
files.forEach(file => {
const reader = new FileReader();
reader.onload = function(e) {
imagenesBase64.push(e.target.result);
actualizarPreview();
}
reader.readAsDataURL(file);
});
});

// === SUBIR IM√ÅGENES ===
async function subirImagenCloudinary(file) {
const formData = new FormData();
formData.append("file", file);
formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
try {
const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
const json = await res.json();
return json.secure_url;
} catch (err) {
console.error("Error subiendo imagen a Cloudinary:", err);
return null;
}
}

// === MEN√ö HAMBURGUESA ===
function toggleMenu() {
const menu = document.getElementById("menu");
menu.classList.toggle("active");
}

// === INICIO ===
window.onload = function() {
const email = localStorage.getItem("dueno");
if (!email) { window.location.href = "index.html"; return; }
cargarEstadoPlan();
cargarAlquileres();
cargarPreciosPlanes();
cargarDatosCuenta();
checkPaymentOnReturn();
}

// === VERIFICAR PAGO AL REGRESAR ===
async function checkPaymentOnReturn() {
const urlParams = new URLSearchParams(window.location.search);
const status = urlParams.get("status");
const paymentId = urlParams.get("payment_id");
const planStatusEl = document.getElementById("planStatus");

if (status && paymentId) {
planStatusEl.innerHTML = `<span class="estado-msg loading">‚è≥ Verificando estado del pago...</span>`;

try {
const response = await fetch(`https://api.mercadopago.com/v1/payments/${paymentId}`, {
method: "GET",
headers: { "Authorization": "Bearer " + MP_BEARER }
});
const paymentData = await response.json();

if (response.ok && paymentData.status === "approved") {
const [email, plan] = paymentData.external_reference.split("_");
const script = document.createElement("script");
script.src = `${API_URL}?action=updatePlan&email=${encodeURIComponent(email)}&plan=${plan}&payment_id=${paymentId}&estadoPago=Aprobado&descripcionPago=Pago%20plan%20${plan}%20-%20ID:%20${paymentId}&callback=planActualizado`;
document.body.appendChild(script);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">‚ùå Pago no aprobado. Estado: ${paymentData.status || "Desconocido"}.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
} catch (err) {
console.error("Error verificando pago:", err);
planStatusEl.innerHTML = `<span class="estado-msg error">‚ùå Error al verificar el pago. Por favor, intenta de nuevo.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}

window.history.replaceState({}, document.title, window.location.pathname);
}
}

// === CARGAR PRECIOS PLANES ===
function cargarPreciosPlanes() {
const script = document.createElement("script");
script.src = `${API_URL}?action=getPlanes&callback=mostrarPreciosPlanes`;
document.body.appendChild(script);
}
function mostrarPreciosPlanes(res) {
if (res.success && res.data && res.data.length) {
res.data.forEach(plan => {
preciosPlanes[plan.nombre] = parseFloat(plan.precio) || 0;
});
document.getElementById("precioBasico").textContent = formatoPrecio(preciosPlanes.Basico) + " / mes";
document.getElementById("precioPlus").textContent = formatoPrecio(preciosPlanes.Plus) + " / mes";
document.getElementById("precioFull").textContent = formatoPrecio(preciosPlanes.Full) + " / mes";
} else {
console.error("Error al cargar precios de planes:", res);
}
}

// === CARGAR ESTADO DE PLAN ===
function cargarEstadoPlan() {
const email = localStorage.getItem("dueno");
const script = document.createElement("script");
script.src = `${API_URL}?action=getLoginInfo&email=${encodeURIComponent(email)}&callback=mostrarEstadoPlan`;
document.body.appendChild(script);
}

function mostrarEstadoPlan(res) {
const planStatusEl = document.getElementById("planStatus");
if (!res.success || !res.data || !res.data[0]) {
planActual = null;
limiteDeptos = 0;
planStatusEl.innerHTML = `Plan: <b>Sin plan</b> | Estado de Pago: N/D | Vencimiento: N/D`;
document.getElementById("btnPlan").textContent = "üí≥ Elegir Plan";
document.getElementById("limiteAlquileres").textContent = "";
return;
}
const login = res.data[0];
planActual = login.Plan || null;
limiteDeptos = planActual === "Prueba" ? Infinity : planActual === "Basico" ? 3 : planActual === "Plus" ? 5 : planActual === "Full" ? 10 : 0;
const estadoPago = login.EstadoPago || "No registrado";
const vencimiento = login.Vencimiento || "N/D";
let planStatusHTML = `Plan: <b>${planActual || "Sin plan"}</b> | Estado de Pago: ${estadoPago} | Vencimiento: ${vencimiento}`;

// Agregar mensaje para el plan Prueba
if (planActual === "Prueba" && vencimiento !== "N/D") {
const vencimientoDate = new Date(vencimiento.split("/").reverse().join("-"));
const today = new Date();
const diffTime = vencimientoDate - today;
const diasRestantes = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
if (diasRestantes > 0) {
planStatusHTML += `<br><span style="color:white">Te quedan ${diasRestantes} d√≠as para mostrar tus departamentos GRATIS con el plan Prueba</span>`;
} else {
planStatusHTML += `<br><span style="color:red">Plan Prueba vencido, tus alquileres no se mostrar√°n en el mapa</span>`;
}
} else if (vencimiento !== "N/D") {
const vencimientoDate = new Date(vencimiento.split("/").reverse().join("-"));
const today = new Date();
if (vencimientoDate < today) {
planStatusHTML += `<br><span style="color:red">Plan vencido, tus alquileres no se mostrar√°n en el mapa</span>`;
}
}

planStatusEl.innerHTML = planStatusHTML;
document.getElementById("limiteAlquileres").textContent = planActual === "Prueba" ? `${deptosActivos} alquileres activos` : `${deptosActivos}/${limiteDeptos} alquileres activos`;
document.getElementById("btnPlan").textContent = planActual ? "üí≥ Mejorar Plan" : "üí≥ Elegir Plan";
}

// === MODAL PLAN ===
function abrirModalPlan() { document.getElementById("modalPlan").style.display = "block"; }
function cerrarModalPlan() {
document.getElementById("modalPlan").style.display = "none";
document.getElementById("mpBtnBasico").innerHTML = "";
document.getElementById("mpBtnPlus").innerHTML = "";
document.getElementById("mpBtnFull").innerHTML = "";
}

async function seleccionarPlan(plan, retries = 3) {
const email = localStorage.getItem("dueno");
const precio = preciosPlanes[plan] || 0;
const planStatusEl = document.getElementById("planStatus");
planStatusEl.innerHTML = `<span class="estado-msg loading">‚è≥ Procesando pago...</span>`;
const preferenceData = {
items: [{ title: `Plan ${plan}`, quantity: 1, unit_price: parseFloat(precio), currency_id: "ARS" }],
payer: { email: email },
external_reference: email + "_" + plan,
back_urls: {
success: window.location.href,
failure: window.location.href,
pending: window.location.href
},
auto_return: "approved",
notification_url: `${API_URL}?action=updatePlan`
};
try {
const response = await fetch("https://api.mercadopago.com/checkout/preferences", {
method: "POST",
headers: { "Authorization": "Bearer " + MP_BEARER, "Content-Type": "application/json" },
body: JSON.stringify(preferenceData)
});
const res = await response.json();
if (res.init_point) {
const mpContainer = document.getElementById("mpBtn" + plan);
mpContainer.innerHTML = `<iframe src="${res.init_point}" width="100%" height="650" frameborder="0" allowtransparency="true"></iframe>`;
planStatusEl.innerHTML = `<span class="estado-msg loading">‚è≥ Iniciando pago. Esperando confirmaci√≥n...</span>`;
} else {
console.error("Error MP:", res);
if (retries > 0) {
console.log(`Reintentando (${retries} restantes)...`);
setTimeout(() => seleccionarPlan(plan, retries - 1), 2000);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">‚ùå No se pudo generar el bot√≥n de pago. Revisa la consola.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
}
} catch (err) {
console.error("Error MP:", err);
if (retries > 0) {
console.log(`Reintentando (${retries} restantes)...`);
setTimeout(() => seleccionarPlan(plan, retries - 1), 2000);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">‚ùå Error al procesar el pago. Por favor, intenta de nuevo.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
}
}

function planActualizado(res) {
const planStatusEl = document.getElementById("planStatus");
if (res.success) {
planStatusEl.innerHTML = `<span class="estado-msg success">‚úÖ Plan actualizado con √©xito: ${res.plan}</span>`;
setTimeout(() => {
planStatusEl.innerHTML = "";
cargarEstadoPlan();
cargarAlquileres();
cerrarModalPlan();
}, 3000);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">‚ùå Error al actualizar el plan: ${res.error || "desconocido"}</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
}

// === CARGAR ALQUILERES ===
function cargarAlquileres() {
const email = localStorage.getItem("dueno");
const script = document.createElement("script");
script.src = `${API_URL}?action=getAlquileresDueno&dueno=${encodeURIComponent(email)}&callback=mostrarAlquileres`;
document.body.appendChild(script);
}

function mostrarAlquileres(res) {
const div = document.getElementById("listaAlquileres");
div.innerHTML = "";
if (!res.success || !res.data || res.data.length === 0) { div.innerHTML = "No tienes alquileres a√∫n."; return; }
deptosActivos = res.data.filter(a => a.Estado === "Activo").length;
document.getElementById("limiteAlquileres").textContent = planActual === "Prueba" ? `${deptosActivos} alquileres activos` : `${deptosActivos}/${limiteDeptos} alquileres activos`;
res.data.forEach(alq => {
let estado = alq.Estado === "Activo" ? "Activo ‚úÖ" : "Inactivo ‚ùå";
let btnEstado = `<button onclick="cambiarEstado(${alq.row}, '${alq.Estado}')">Cambiar Estado</button>`;
let btnEditar = `<button onclick='editarAlquiler(${alq.row}, ${JSON.stringify(alq)})'>Editar</button>`;
let btnEliminar = `<button onclick="eliminarAlquiler(${alq.row})">Eliminar</button>`;
let precioFormateado = formatoPrecio(alq.Precio);
div.innerHTML += `<div class="alquiler">
<b>${alq.Direccion}</b> - ${alq['Nro Ambientes']} amb - ${precioFormateado} - Mascotas: ${alq.Mascotas || "N/D"}<br>
Estado: ${estado}<br>
${btnEstado} ${btnEditar} ${btnEliminar}
<span id="estadoMsg-${alq.row}" class="estado-msg"></span>
</div>`;
});
}

// === TOGGLE FORMULARIO ===
function toggleFormulario() {
const form = document.getElementById("formulario");
const btn = document.getElementById("btnAgregarAlquiler");
if (form.classList.contains("active")) {
form.classList.remove("active");
btn.textContent = "‚ûï Agregar Alquiler";
resetForm();
} else {
form.classList.add("active");
btn.textContent = "‚ûñ Cerrar Formulario";
window.scrollTo(0, document.getElementById("formulario").offsetTop);
}
}

// === AGREGAR / EDITAR ALQUILER ===
async function agregarAlquiler() {
let direccion = document.getElementById("direccion").value;
const ambientes = document.getElementById("ambientes").value;
let precio = document.getElementById("precio").value.replace(/\D/g, "");
const mascotas = document.getElementById("mascotas").value;
const infoIngreso = document.getElementById("infoIngreso").value;
const detalles = document.getElementById("detalles").value;
let row = document.getElementById("editRow").value || new Date().getTime();
const email = localStorage.getItem("dueno");
if (!direccion || !ambientes || !precio) { alert("Completa todos los campos obligatorios."); return; }
direccion = direccion + ", Santo Tom√© Corrientes";
const msgEl = document.getElementById("msg");
if (document.getElementById("editRow").value) msgEl.textContent = "Guardando cambios...";
const files = document.getElementById("imagenFile").files;
let uploadedURLs = [];
for (let i = 0; i < files.length; i++) {
const url = await subirImagenCloudinary(files[i]);
if (url) uploadedURLs.push(url);
}
fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(direccion)}&key=${GEOCODE_KEY}`)
.then(r => r.json()).then(data => {
let lat = "", lng = "";
if (data.results && data.results[0]) {
lat = data.results[0].geometry.location.lat;
lng = data.results[0].geometry.location.lng;
}
enviarAlquiler(uploadedURLs.join(","), lat, lng);
});
function enviarAlquiler(fotosConcatenadas, lat, lng) {
const action = document.getElementById("editRow").value ? "editAlquiler" : "addAlquiler";
const callback = action === "editAlquiler" ? "alquilerEditado" : "alquilerAgregado";
let estado = "Activo";
if (action === "editAlquiler" && deptosActivos >= limiteDeptos && planActual !== "Prueba") {
estado = "Inactivo";
}
const script = document.createElement("script");
script.src = `${API_URL}?action=${action}&row=${row}&dueno=${encodeURIComponent(email)}&direccion=${encodeURIComponent(direccion)}&ambientes=${encodeURIComponent(ambientes)}&precio=${encodeURIComponent(precio)}&mascotas=${encodeURIComponent(mascotas)}&fotos=${encodeURIComponent(fotosConcatenadas)}&infoIngreso=${encodeURIComponent(infoIngreso)}&detalles=${encodeURIComponent(detalles)}&lat=${lat}&lng=${lng}&contacto=auto&estado=${estado}&callback=${callback}`;
document.body.appendChild(script);
}
}

// === FUNCIONES RESTANTES ===
function editarAlquiler(row, datos) {
document.getElementById("btnAgregarAlquiler").textContent = "‚ûñ Cerrar Formulario";
document.getElementById("formulario").classList.add("active");
document.getElementById("btnGuardar").textContent = "Guardar Cambios";
document.getElementById("editRow").value = row;
document.getElementById("direccion").value = datos.Direccion || "";
document.getElementById("ambientes").value = datos["Nro Ambientes"] || "";
document.getElementById("precio").value = formatoPrecio(datos.Precio);
document.getElementById("mascotas").value = datos.Mascotas || "No";
document.getElementById("infoIngreso").value = datos.InfoIngreso || "";
document.getElementById("detalles").value = datos.Detalles || "";
imagenesBase64 = datos.Fotos ? datos.Fotos.split(",") : [];
actualizarPreview();
window.scrollTo(0, document.getElementById("formulario").offsetTop);
}

function resetForm() {
document.getElementById("btnAgregarAlquiler").textContent = "‚ûï Agregar Alquiler";
document.getElementById("formulario").classList.remove("active");
document.getElementById("btnGuardar").textContent = "Agregar";
document.getElementById("editRow").value = "";
document.getElementById("direccion").value = "";
document.getElementById("ambientes").value = "";
document.getElementById("precio").value = "";
document.getElementById("mascotas").value = "S√≠";
document.getElementById("infoIngreso").value = "";
document.getElementById("detalles").value = "";
document.getElementById("imagenFile").value = "";
imagenesBase64 = [];
actualizarPreview();
document.getElementById("msg").textContent = "";
}

async function cambiarEstado(row, estadoActual) {
const msgEl = document.getElementById(`estadoMsg-${row}`);
if (estadoActual === "Inactivo" && deptosActivos >= limiteDeptos && planActual !== "Prueba") {
msgEl.className = "estado-msg error";
msgEl.textContent = `No puedes activar m√°s alquileres. Tu plan (${planActual}) permite hasta ${limiteDeptos} deptos activos. ‚ùå`;
setTimeout(() => { msgEl.textContent = ""; }, 5000);
return;
}
msgEl.className = "estado-msg loading";
msgEl.textContent = "Cambiando Estado ‚è≥";
try {
const response = await fetch(`${API_URL}?action=toggleEstado&row=${row}`);
const res = await response.json();
estadoCambiado(res, row);
} catch (err) {
msgEl.className = "estado-msg error";
msgEl.textContent = `Error al cambiar estado: ${err.message || "Error de conexi√≥n"} ‚ùå`;
setTimeout(() => { msgEl.textContent = ""; }, 5000);
console.error("Error en cambio de estado:", err);
}
}

function estadoCambiado(res, row) {
const msgEl = document.getElementById(`estadoMsg-${row}`);
if (res.success) {
msgEl.className = "estado-msg success";
msgEl.textContent = "Estado cambiado con √©xito ‚úÖ";
setTimeout(() => { msgEl.textContent = ""; }, 3000);
cargarAlquileres();
} else {
msgEl.className = "estado-msg error";
msgEl.textContent = `Error al cambiar estado: ${res.error || "desconocido"} ‚ùå`;
setTimeout(() => { msgEl.textContent = ""; }, 5000);
}
}

function eliminarAlquiler(row) {
if (!confirm("¬øSeguro que deseas eliminar este alquiler?")) return;
const script = document.createElement("script");
script.src = `${API_URL}?action=deleteAlquiler&row=${row}&callback=cargarAlquileres`;
document.body.appendChild(script);
}

function logout() { localStorage.removeItem("dueno"); window.location.href = "index.html"; }

function alquilerAgregado(res) {
if (res.success) {
alert("‚úÖ Alquiler agregado con √©xito");
resetForm();
cargarAlquileres();
cargarEstadoPlan();
} else {
alert("‚ùå Error al agregar: " + (res.error || "desconocido"));
}
}

function alquilerEditado(res) {
const msgEl = document.getElementById("msg");
if (res.success) {
msgEl.textContent = "‚úÖ Cambios guardados correctamente";
resetForm();
cargarAlquileres();
} else {
msgEl.textContent = "‚ùå Error al editar: " + (res.error || "desconocido");
}
}

// === EDITAR CUENTA ===
function abrirModalEditarCuenta() {
document.getElementById("modalEditarCuenta").style.display = "block";
cargarDatosCuenta();
}

function cerrarModalEditarCuenta() {
document.getElementById("modalEditarCuenta").style.display = "none";
document.getElementById("emailEditar").value = "";
document.getElementById("nombreEditar").value = "";
document.getElementById("contactoEditar").value = "";
document.getElementById("passwordEditar").value = "";
document.getElementById("codigoPaisEditar").value = "+549";
document.getElementById("msgEditarCuenta").textContent = "";
document.getElementById("passwordEditar").type = "password";
document.querySelector(".toggle-password").textContent = "üëÅ";
}

function cargarDatosCuenta() {
const email = localStorage.getItem("dueno");
const msgEl = document.getElementById("msgEditarCuenta");
const script = document.createElement("script");
script.src = `${API_URL}?action=getLoginInfo&email=${encodeURIComponent(email)}&callback=mostrarDatosCuenta`;
document.body.appendChild(script);
}

function mostrarDatosCuenta(res) {
const msgEl = document.getElementById("msgEditarCuenta");
const countryCodes = ["+549", "+55", "+598", "+56", "+595"];
if (res.success && res.data && res.data[0]) {
const login = res.data[0];
document.getElementById("emailEditar").value = login.Email || "";
document.getElementById("nombreEditar").value = login.Nombre || "";
document.getElementById("passwordEditar").value = login.Password || "";
const contacto = login.Contacto || "";
let codigoPais = "+549"; // Default to Argentina
let numero = contacto;
for (const code of countryCodes) {
if (contacto.startsWith(code)) {
codigoPais = code;
numero = contacto.slice(code.length);
break;
}
}
document.getElementById("codigoPaisEditar").value = codigoPais;
document.getElementById("contactoEditar").value = numero;
msgEl.textContent = "";
} else {
msgEl.style.color = "red";
msgEl.textContent = "‚ùå Error al cargar los datos de la cuenta";
setTimeout(() => { msgEl.textContent = ""; }, 3000);
}
}

function togglePasswordVisibility() {
const passwordInput = document.getElementById("passwordEditar");
const toggleButton = document.querySelector(".toggle-password");
if (passwordInput.type === "password") {
passwordInput.type = "text";
toggleButton.textContent = "üëÅ‚Äçüó®";
} else {
passwordInput.type = "password";
toggleButton.textContent = "üëÅ";
}
}

async function editarCuenta() {
const email = localStorage.getItem("dueno");
const newEmail = document.getElementById("emailEditar").value;
const nombre = document.getElementById("nombreEditar").value;
const codigoPais = document.getElementById("codigoPaisEditar").value;
const contacto = document.getElementById("contactoEditar").value;
const password = document.getElementById("passwordEditar").value;
const msgEl = document.getElementById("msgEditarCuenta");

if (!newEmail && !nombre && !contacto && !password) {
msgEl.style.color = "red";
msgEl.textContent = "Debes completar al menos un campo para actualizar.";
return;
}
if (newEmail && !newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
msgEl.style.color = "red";
msgEl.textContent = "Ingresa un email v√°lido.";
return;
}
if (password && password.length < 6) {
msgEl.style.color = "red";
msgEl.textContent = "La contrase√±a debe tener al menos 6 caracteres.";
return;
}
if (contacto && !contacto.match(/^\d{6,}$/)) {
msgEl.style.color = "red";
msgEl.textContent = "El n√∫mero de tel√©fono debe contener solo d√≠gitos y al menos 6 caracteres.";
return;
}

msgEl.textContent = "Guardando cambios...";
try {
let query = `${API_URL}?action=editarDueno&email=${encodeURIComponent(email)}`;
if (newEmail) query += `&newEmail=${encodeURIComponent(newEmail)}`;
if (nombre) query += `&nombre=${encodeURIComponent(nombre)}`;
if (contacto) query += `&contacto=${encodeURIComponent(codigoPais + contacto)}`;
if (password) query += `&password=${encodeURIComponent(password)}`;
const response = await fetch(query);
const res = await response.json();
if (res.success) {
msgEl.style.color = "green";
msgEl.textContent = "‚úÖ Cambios guardados con √©xito";
if (newEmail) localStorage.setItem("dueno", newEmail);
setTimeout(cerrarModalEditarCuenta, 1000);
} else {
msgEl.style.color = "red";
msgEl.textContent = "‚ùå Error al guardar: " + (res.error || "desconocido");
}
} catch (err) {
msgEl.style.color = "red";
msgEl.textContent = "‚ùå Error al guardar: " + (err.message || "Error de conexi√≥n");
console.error("Error en edici√≥n de cuenta:", err);
}
}
</script>
</body>
</html>
