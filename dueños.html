<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Due√±os</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f5f5f5; }
    h2 { color:#333; }
    .alquiler { border:1px solid #ccc; padding:10px; margin:10px 0; background:#fff; }
    button { margin: 5px; padding: 5px 10px; }
    #formulario { background:#fff; padding:15px; border:1px solid #ccc; margin-top:20px; }
    label { display:block; margin:8px 0 4px; }
    input, select, textarea { width:100%; padding:8px; margin-bottom:10px; }
    img { max-width: 120px; margin-top: 5px; display:block; }
  </style>
</head>
<body>
  <h2 id="bienvenida"></h2>
  <button onclick="logout()">Cerrar Sesi√≥n</button>

  <h3>üìã Mis Alquileres</h3>
  <div id="listaAlquileres">Cargando...</div>

  <h3 id="tituloForm">‚ûï Agregar Alquiler</h3>
  <div id="formulario">
    <input type="hidden" id="editRow" value="">
    <label>Direcci√≥n</label>
    <input type="text" id="direccion">

    <label>Ambientes</label>
    <input type="number" id="ambientes">

    <label>Precio</label>
    <input type="number" id="precio">

    <label>Mascotas Permitidas</label>
    <select id="mascotas">
      <option value="S√≠">S√≠</option>
      <option value="No">No</option>
    </select>

    <label>Imagen del Alquiler (PNG/JPG)</label>
    <input type="file" id="imagenFile" accept="image/png, image/jpeg">
    <img id="previewImg" style="display:none;"/>

    <label>Informaci√≥n de ingreso</label>
    <textarea id="infoIngreso" rows="2"></textarea>

    <label>Detalles</label>
    <textarea id="detalles" rows="3"></textarea>

    <button id="btnGuardar" onclick="agregarAlquiler()">Agregar</button>
    <p id="msg" style="color:green"></p>
  </div>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwDl73ZMnMowfSu_NoISSSc4fnQpLp6kaxT9Dz5jMjE9NxT64AmeN23ORQy8lejul6S/exec";
  const MAKE_WEBHOOK = "https://hook.us2.make.com/29oaaxn76yvca7sjnvrh5xtynckowak4";

  let imagenBase64 = "";

  // ‚úÖ Previsualizar imagen y convertir a Base64
  document.getElementById("imagenFile").addEventListener("change", function(){
    const file = this.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = function(e){
        imagenBase64 = e.target.result;
        document.getElementById("previewImg").src = imagenBase64;
        document.getElementById("previewImg").style.display = "block";
      }
      reader.readAsDataURL(file);
    }
  });

  window.onload = function(){
    const email = localStorage.getItem("dueno");
    if(!email){ window.location.href="index.html"; return; }
    document.getElementById("bienvenida").textContent = "Bienvenido, " + email;
    cargarAlquileres();
  }

  function cargarAlquileres(){
    const email = localStorage.getItem("dueno");
    const script = document.createElement("script");
    script.src = `${API_URL}?action=getAlquileres&dueno=${encodeURIComponent(email)}&callback=mostrarAlquileres`;
    document.body.appendChild(script);
  }

  function mostrarAlquileres(res){
    const div = document.getElementById("listaAlquileres");
    div.innerHTML = "";
    if(!res.success || !res.data || res.data.length === 0){ 
      div.innerHTML="No tienes alquileres a√∫n."; 
      return; 
    }

    res.data.forEach(alq => {
      let estado = alq.Estado === "Activo" ? "Activo ‚úÖ" : "Inactivo ‚ùå";
      let btnEstado = `<button onclick="cambiarEstado(${alq.row})">Cambiar Estado</button>`;
      let btnEditar = `<button onclick='editarAlquiler(${alq.row}, ${JSON.stringify(alq)})'>Editar</button>`;
      let btnEliminar = `<button onclick="eliminarAlquiler(${alq.row})">Eliminar</button>`;
      div.innerHTML += `<div class="alquiler">
        <b>${alq.Direccion}</b> - ${alq['Nro Ambientes']} amb - ${alq.Precio} - Mascotas: ${alq.Mascotas || "N/D"}<br>
        Estado: ${estado}<br>
        ${btnEstado} ${btnEditar} ${btnEliminar}
      </div>`;
    });
  }

  function agregarAlquiler(){
    const direccion = document.getElementById("direccion").value;
    const ambientes = document.getElementById("ambientes").value;
    const precio = document.getElementById("precio").value;
    const mascotas = document.getElementById("mascotas").value;
    const infoIngreso = document.getElementById("infoIngreso").value;
    const detalles = document.getElementById("detalles").value;
    const row = document.getElementById("editRow").value;
    const email = localStorage.getItem("dueno");

    if(!direccion || !ambientes || !precio){ 
      alert("Completa todos los campos obligatorios."); 
      return; 
    }

    let action = row ? "editAlquiler" : "addAlquiler";
    let callback = row ? "alquilerEditado" : "alquilerAgregado";

    // üîπ Guardar en Sheet
    const script = document.createElement("script");
    script.src = `${API_URL}?action=${action}&row=${row}&dueno=${encodeURIComponent(email)}&direccion=${encodeURIComponent(direccion)}&ambientes=${encodeURIComponent(ambientes)}&precio=${encodeURIComponent(precio)}&mascotas=${encodeURIComponent(mascotas)}&fotos=${encodeURIComponent(imagenBase64)}&infoIngreso=${encodeURIComponent(infoIngreso)}&detalles=${encodeURIComponent(detalles)}&callback=${callback}`;
    document.body.appendChild(script);

    // üîπ Enviar al webhook de Make para subir imagen a Drive
    if(imagenBase64){
      fetch(MAKE_WEBHOOK, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          alquilerID: row || new Date().getTime(),
          dueno: email,
          direccion,
          ambientes,
          precio,
          mascotas,
          infoIngreso,
          detalles,
          imagen: imagenBase64
        })
      }).catch(err => console.error("Error webhook Make:", err));
    }
  }

  function alquilerAgregado(res){
    if(res.success){
      document.getElementById("msg").textContent = "Alquiler agregado ‚úÖ";
      resetForm();
      cargarAlquileres();
    } else {
      alert("Error: " + res.error);
    }
  }

  function alquilerEditado(res){
    if(res.success){
      document.getElementById("msg").textContent = "Alquiler editado ‚úÖ";
      resetForm();
      cargarAlquileres();
    } else {
      alert("Error: " + res.error);
    }
  }

  function editarAlquiler(row, datos){
    document.getElementById("tituloForm").textContent = "‚úèÔ∏è Editar Alquiler";
    document.getElementById("btnGuardar").textContent = "Guardar Cambios";
    document.getElementById("editRow").value = row;
    document.getElementById("direccion").value = datos.Direccion || "";
    document.getElementById("ambientes").value = datos["Nro Ambientes"] || "";
    document.getElementById("precio").value = datos.Precio || "";
    document.getElementById("mascotas").value = datos.Mascotas || "No";
    document.getElementById("infoIngreso").value = datos.InfoIngreso || "";
    document.getElementById("detalles").value = datos.Detalles || "";
    if(datos.Fotos){
      imagenBase64 = datos.Fotos;
      document.getElementById("previewImg").src = imagenBase64;
      document.getElementById("previewImg").style.display = "block";
    }
    window.scrollTo(0, document.getElementById("formulario").offsetTop);
  }

  function resetForm(){
    document.getElementById("tituloForm").textContent = "‚ûï Agregar Alquiler";
    document.getElementById("btnGuardar").textContent = "Agregar";
    document.getElementById("editRow").value = "";
    document.getElementById("direccion").value = "";
    document.getElementById("ambientes").value = "";
    document.getElementById("precio").value = "";
    document.getElementById("mascotas").value = "S√≠";
    document.getElementById("infoIngreso").value = "";
    document.getElementById("detalles").value = "";
    document.getElementById("imagenFile").value = "";
    document.getElementById("previewImg").style.display = "none";
    imagenBase64 = "";
  }

  function cambiarEstado(row){
    const script = document.createElement("script");
    script.src = `${API_URL}?action=toggleEstado&row=${row}&callback=estadoCambiado`;
    document.body.appendChild(script);
  }

  function estadoCambiado(res){
    if(res.success) cargarAlquileres();
  }

  function eliminarAlquiler(row){
    if(!confirm("¬øSeguro que deseas eliminar este alquiler?")) return;
    const script = document.createElement("script");
    script.src = `${API_URL}?action=deleteAlquiler&row=${row}&callback=alquilerEliminado`;
    document.body.appendChild(script);
  }

  function alquilerEliminado(res){
    if(res.success) cargarAlquileres();
  }

  function logout(){
    localStorage.removeItem("dueno");
    window.location.href="index.html";
  }
  </script>
</body>
</html>
