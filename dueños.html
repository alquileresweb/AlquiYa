<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Due√±os</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f5f5f5; }
    h2 { color:#333; }
    .alquiler { border:1px solid #ccc; padding:10px; margin:10px 0; background:#fff; }
    button { margin: 5px; padding: 5px 10px; }
    #formulario { background:#fff; padding:15px; border:1px solid #ccc; margin-top:20px; }
    label { display:block; margin:8px 0 4px; }
    input, select { width:100%; padding:8px; margin-bottom:10px; }
  </style>
</head>
<body>
  <h2 id="bienvenida"></h2>
  <button onclick="logout()">Cerrar Sesi√≥n</button>

  <h3>üìã Mis Alquileres</h3>
  <div id="listaAlquileres">Cargando...</div>

  <h3>‚ûï Agregar Alquiler</h3>
  <div id="formulario">
    <label>Direcci√≥n</label>
    <input type="text" id="direccion">

    <label>Ambientes</label>
    <input type="number" id="ambientes">

    <label>Precio</label>
    <input type="number" id="precio">

    <label>Mascotas Permitidas</label>
    <select id="mascotas">
      <option value="S√≠">S√≠</option>
      <option value="No">No</option>
    </select>

    <label>URL Imagen (PNG/JPG)</label>
    <input type="text" id="imagen" placeholder="https://...">

    <button onclick="agregarAlquiler()">Agregar</button>
    <p id="msg" style="color:green"></p>
  </div>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwDl73ZMnMowfSu_NoISSSc4fnQpLp6kaxT9Dz5jMjE9NxT64AmeN23ORQy8lejul6S/exec";

  window.onload = function(){
    const email = localStorage.getItem("dueno");
    if(!email){ window.location.href="index.html"; return; }
    document.getElementById("bienvenida").textContent = "Bienvenido, " + email;
    cargarAlquileres();
  }

  // üìã Obtener lista de alquileres (JSONP)
  function cargarAlquileres(){
    const email = localStorage.getItem("dueno");
    const script = document.createElement("script");
    script.src = `${API_URL}?action=getAlquileres&dueno=${encodeURIComponent(email)}&callback=mostrarAlquileres`;
    document.body.appendChild(script);
  }

  function mostrarAlquileres(data){
    const div = document.getElementById("listaAlquileres");
    div.innerHTML = "";
    if(!data || data.length === 0){ 
      div.innerHTML="No tienes alquileres a√∫n."; 
      return; 
    }

    data.forEach(alq => {
      let estado = alq.Estado === "Activo" ? "Activo ‚úÖ" : "Inactivo ‚ùå";
      let btnEstado = `<button onclick="cambiarEstado(${alq.row})">Cambiar Estado</button>`;
      let btnEditar = `<button onclick="editarAlquiler(${alq.row})">Editar</button>`;
      div.innerHTML += `<div class="alquiler">
        <b>${alq.Direccion}</b> - ${alq['Nro Ambientes']} amb - ${alq.Precio} - Mascotas: ${alq.Mascotas || "N/D"}<br>
        Estado: ${estado}<br>
        ${btnEstado} ${btnEditar}
      </div>`;
    });
  }

  // ‚ûï Agregar alquiler (JSONP)
  function agregarAlquiler(){
    const direccion = document.getElementById("direccion").value;
    const ambientes = document.getElementById("ambientes").value;
    const precio = document.getElementById("precio").value;
    const mascotas = document.getElementById("mascotas").value;
    const imagen = document.getElementById("imagen").value;
    const email = localStorage.getItem("dueno");

    if(!direccion || !ambientes || !precio){ 
      alert("Completa todos los campos obligatorios."); 
      return; 
    }

    const script = document.createElement("script");
    script.src = `${API_URL}?action=addAlquiler&dueno=${encodeURIComponent(email)}&direccion=${encodeURIComponent(direccion)}&ambientes=${encodeURIComponent(ambientes)}&precio=${encodeURIComponent(precio)}&mascotas=${encodeURIComponent(mascotas)}&fotos=${encodeURIComponent(imagen)}&callback=alquilerAgregado`;
    document.body.appendChild(script);
  }

  function alquilerAgregado(res){
    if(res.success){
      document.getElementById("msg").textContent = "Alquiler agregado ‚úÖ";
      cargarAlquileres();
    } else {
      alert("Error: " + res.error);
    }
  }

  // üîÑ Cambiar estado (JSONP)
  function cambiarEstado(row){
    const script = document.createElement("script");
    script.src = `${API_URL}?action=toggleEstado&row=${row}&callback=estadoCambiado`;
    document.body.appendChild(script);
  }

  function estadoCambiado(res){
    if(res.success) cargarAlquileres();
  }

  // ‚úèÔ∏è Editar alquiler
  function editarAlquiler(row){
    alert("Aqu√≠ se abrir√≠a un formulario para editar el alquiler en la fila: " + row);
  }

  function logout(){
    localStorage.removeItem("dueno");
    window.location.href="index.html";
  }
  </script>
</body>
</html>
