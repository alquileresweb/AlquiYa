<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Due√±os</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
header { background: #2c3e50; color: #fff; padding: 15px; text-align: center; font-size: 22px; }
.container { max-width: 1200px; margin: auto; padding: 20px; }
#formulario, #listaAlquileres { background: #fff; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
label { display:block; margin-top:10px; font-weight:bold; font-size: 16px; }
input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border:1px solid #ccc; border-radius: 6px; font-size:16px; }
button { background:#2c3e50; color:#fff; border:none; padding:10px 20px; margin-top:15px; border-radius:6px; cursor:pointer; font-size:16px; }
button:hover { background:#34495e; }
.alquiler { border-bottom:1px solid #ccc; padding:10px 0; }
#preview img { width:80px; height:80px; object-fit:cover; margin:5px; border-radius:6px; }
.estadoPlan { font-size:18px; font-weight:bold; color:#2c3e50; margin-bottom:10px; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); }
.modal-content { background:#fff; margin:5% auto; padding:20px; border-radius:10px; width:90%; max-width:500px; text-align:center; }
.modal h2 { font-size:24px; margin-bottom:15px; }
.plan-opcion { border:1px solid #ccc; border-radius:10px; padding:15px; margin:10px 0; cursor:pointer; font-size:18px; }
.plan-opcion:hover { background:#f0f0f0; }
.precio-plan { font-size:20px; font-weight:bold; margin-top:10px; color:#27ae60; }
</style>
</head>
<body>
<header>üè† Panel de Due√±os</header>
<div class="container">
  <div id="estadoPlan" class="estadoPlan">Cargando tu plan...</div>
  <button onclick="abrirModal()">üìå Cambiar o Ver Plan</button>
  <div id="formulario">
    <h2 id="tituloForm">‚ûï Agregar Alquiler</h2>
    <input type="hidden" id="editRow">
    <label>Direcci√≥n:</label>
    <input type="text" id="direccion">
    <label>Nro Ambientes:</label>
    <input type="number" id="ambientes">
    <label>Precio:</label>
    <input type="text" id="precio">
    <label>Mascotas:</label>
    <select id="mascotas">
      <option>S√≠</option>
      <option>No</option>
    </select>
    <label>Info Ingreso:</label>
    <input type="text" id="infoIngreso">
    <label>Detalles:</label>
    <textarea id="detalles"></textarea>
    <label>Fotos:</label>
    <input type="file" id="imagenFile" multiple>
    <div id="preview"></div>
    <div id="msg" style="margin-top:10px; color:#27ae60; font-weight:bold;"></div>
    <button id="btnGuardar" onclick="guardarAlquiler()">Agregar</button>
  </div>
  <div id="listaAlquileres">
    <h2>üìã Mis Alquileres</h2>
    <div id="alquileres"></div>
  </div>
</div>

<!-- MODAL PLANES -->
<div id="modalPlanes" class="modal">
  <div class="modal-content">
    <h2>Seleccionar Plan</h2>
    <div id="planesOpciones"></div>
    <button onclick="cerrarModal()">‚ùå Cerrar</button>
    <div id="mp-container" style="margin-top:20px;"></div>
  </div>
</div>
<script src="https://sdk.mercadopago.com/js/v2"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwXXXXXXXXXXXXXXXXXXXX/exec";
const GEOCODE_KEY = "YOUR_GEOCODE_KEY";
let email = localStorage.getItem("dueno");
let planActual="", limiteDeptos=0, deptosActivos=0;
let preciosPlanes = {};
let imagenesBase64 = [];
// === CONFIGURACI√ìN MERCADOPAGO (cliente) ===
const MP_BEARER = "APP_USR-595288641172928-010710-d915bce4137b3ee26e0c6e04873f1ac1-695835795"; // <- reemplaza si corresponde

// === UTILIDADES ===
function formatoPrecio(valor){
  if(valor === null || valor === undefined) return "";
  valor = String(valor).replace(/\D/g,"");
  if(!valor) return "";
  return "$" + valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// === PREVIEW Y SUBIDA LOCAL (antes de enviar a GAS) ===
document.getElementById("imagenFile").addEventListener("change", (ev) => {
  const files = Array.from(ev.target.files || []);
  imagenesBase64 = [];
  const preview = document.getElementById("preview");
  preview.innerHTML = "Cargando vistas...";
  let loaded = 0;
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      imagenesBase64.push(e.target.result);
      loaded++;
      if(loaded === files.length){
        preview.innerHTML = "";
        imagenesBase64.forEach(src => {
          const img = document.createElement("img");
          img.src = src;
          preview.appendChild(img);
        });
      }
    };
    reader.readAsDataURL(file);
  });
  if(files.length === 0) preview.innerHTML = "";
});

// === CARGAR PRECIOS DE PLANES (desde GAS / Hoja "Planes" ‚Äî E2,F2,G2) ===
function cargarPreciosPlanes(){
  // usamos JSONP para evitar CORS; getPlanes debe devolver array de objetos (como en backend)
  const script = document.createElement("script");
  script.src = `${API_URL}?action=getPlanes&callback=mostrarPreciosPlanes`;
  document.body.appendChild(script);
}
function mostrarPreciosPlanes(res){
  // Adaptable: backend puede devolver formato { success:true, data: [...] }
  if(!res || !res.success || !res.data) return;
  // Si data es formato [{nombre, limiteDeptos, limiteFotos, destacar}] necesitamos los precios.
  // Intentamos leer campos E2,F2,G2 si el backend las env√≠a; si no, asumimos p.precio.
  // Soportamos varios formatos:
  res.data.forEach(item => {
    if(item.nombre && item.E2 !== undefined && item.F2 !== undefined && item.G2 !== undefined){
      // si backend devolvi√≥ fila con E2,F2,G2
      preciosPlanes.Basico = parseFloat(String(item.E2).replace(/\D/g,""))||preciosPlanes.Basico;
      preciosPlanes.Plus = parseFloat(String(item.F2).replace(/\D/g,""))||preciosPlanes.Plus;
      preciosPlanes.Full = parseFloat(String(item.G2).replace(/\D/g,""))||preciosPlanes.Full;
    } else if(item.nombre && item.precio !== undefined){
      // si backend devuelve objeto por plan con campo 'precio'
      preciosPlanes[item.nombre] = parseFloat(String(item.precio).replace(/\D/g,""))||preciosPlanes[item.nombre]||0;
    }
  });
  // Si no hubo datos en el primer intento, tambi√©n intentamos si data[0] contiene E2,F2,G2
  if(res.data.length && res.data[0].E2 !== undefined){
    preciosPlanes.Basico = parseFloat(String(res.data[0].E2).replace(/\D/g,""))||preciosPlanes.Basico;
    preciosPlanes.Plus = parseFloat(String(res.data[0].F2).replace(/\D/g,""))||preciosPlanes.Plus;
    preciosPlanes.Full = parseFloat(String(res.data[0].G2).replace(/\D/g,""))||preciosPlanes.Full;
  }
  // Mostrar en modal si existe
  document.getElementById("planesOpciones").innerHTML = `
    <div class="plan-opcion" data-plan="Basico">
      B√°sico ‚Äî Hasta 3 deptos activos
      <div class="precio-plan" id="pBasico">${formatoPrecio(preciosPlanes.Basico)} / mes</div>
      <button onclick="seleccionarPlan('Basico')">Pagar B√°sico</button>
      <div id="mpBtnBasico"></div>
    </div>
    <div class="plan-opcion" data-plan="Plus">
      Plus ‚Äî Hasta 5 deptos activos
      <div class="precio-plan" id="pPlus">${formatoPrecio(preciosPlanes.Plus)} / mes</div>
      <button onclick="seleccionarPlan('Plus')">Pagar Plus</button>
      <div id="mpBtnPlus"></div>
    </div>
    <div class="plan-opcion" data-plan="Full">
      Full ‚Äî Hasta 10 deptos activos
      <div class="precio-plan" id="pFull">${formatoPrecio(preciosPlanes.Full)} / mes</div>
      <button onclick="seleccionarPlan('Full')">Pagar Full</button>
      <div id="mpBtnFull"></div>
    </div>
  `;
}

// === CARGAR ESTADO DE PLAN (due√±o) ===
function cargarEstadoPlan(){
  if(!email){ document.getElementById("estadoPlan").textContent = "No logueado"; return; }
  const script = document.createElement("script");
  script.src = `${API_URL}?action=getLoginInfo&email=${encodeURIComponent(email)}&callback=mostrarEstadoPlan`;
  document.body.appendChild(script);
}
function mostrarEstadoPlan(res){
  if(!res || !res.success || !res.data || !res.data[0]){
    document.getElementById("estadoPlan").textContent = "Plan: Sin plan | Estado de Pago: N/D | Vencimiento: N/D";
    return;
  }
  const info = res.data[0];
  planActual = info.Plan || "Basico";
  limiteDeptos = info.deptosActivos !== undefined ? Math.max(info.deptosActivos, 0) : (planActual==="Basico"?3:planActual==="Plus"?5:10);
  deptosActivos = info.deptosActivos || 0;
  // mostramos con fondo celeste (ya en CSS #estadoPlan con bg)
  document.getElementById("estadoPlan").innerHTML = `Plan: <b>${planActual}</b> | Estado de Pago: ${info.EstadoPago || "N/D"} | Vencimiento: ${info.Vencimiento || "N/D"}`;
  // contador lateral en la secci√≥n Mis Alquileres
  const contador = document.getElementById("contadorAlq");
  if(contador) contador.textContent = `(${deptosActivos}/${ (planActual==="Basico"?3:planActual==="Plus"?5:10) } alquileres)`;
  // Si el estado de pago indica aprobado, mostramos alerta (backend debe actualizar ese campo tras pago)
  const estadoPago = (info.EstadoPago || "").toString().toLowerCase();
  if(estadoPago === "aprobado" || estadoPago === "approved"){
    // mostramos una sola vez la notificaci√≥n
    console.info("Pago aprobado detectado");
    // no usar alert intrusivo si ya fue mostrado; puedes mejorar con un flag si lo deseas
  }
}

// === ABRIR / CERRAR MODAL ===
function abrirModal(){ 
  document.getElementById("modalPlanes").style.display = "block";
  // cargar precios cada vez que abre para tener valores actualizados
  cargarPreciosPlanes();
}
function cerrarModal(){ document.getElementById("modalPlanes").style.display = "none"; }

// === CREAR PREFERENCIA MERCADO PAGO y mostrar iframe sin cerrar modal ===
async function seleccionarPlan(plan){
  // mantener modal abierto (no llamamos a cerrarModal)
  const precio = preciosPlanes[plan] || 0;
  if(!precio || precio <= 0){
    alert("Precio inv√°lido para el plan seleccionado.");
    return;
  }
  // Mostramos mensaje de carga y limpiamos contenedor
  const mpContainer = document.getElementById("mp-container");
  mpContainer.innerHTML = "<div>Generando pago...</div>";
  // Creamos preferencia directamente (nota: usar bearer en frontend expone la key)
  try {
    const preferenceData = {
      items: [{ title: `Plan ${plan}`, quantity: 1, unit_price: Number(precio), currency_id: "ARS" }],
      payer: { email: email }
    };
    const resp = await fetch("https://api.mercadopago.com/checkout/preferences", {
      method: "POST",
      headers: { "Authorization": "Bearer " + MP_BEARER, "Content-Type": "application/json" },
      body: JSON.stringify(preferenceData)
    });
    const json = await resp.json();
    if(json && json.init_point){
      // Insertamos iframe dentro del plan correspondiente y tambi√©n en mp-container
      const target = document.getElementById("mpBtn" + plan);
      if(target) target.innerHTML = `<iframe src="${json.init_point}" allowtransparency="true"></iframe>`;
      mpContainer.innerHTML = `<iframe src="${json.init_point}" allowtransparency="true"></iframe>`;
      // dejamos modal abierto para que el usuario complete el pago
      // Instrucci√≥n: el backend debe actualizar el estado del plan al recibir notificaci√≥n de MP
    } else {
      console.error("MP error", json);
      mpContainer.innerHTML = "<div>Error generando pago. Revisa consola.</div>";
    }
  } catch(err){
    console.error("Error creando preferencia MP", err);
    document.getElementById("mp-container").innerHTML = "<div>Error de conexi√≥n.</div>";
  }
}
// === PUBLICAR ALQUILER ===
function publicarAlquiler(){
  if(!email){ alert("Debes iniciar sesi√≥n"); return; }
  if(deptosActivos >= limiteDeptos){
    alert(`Has alcanzado el l√≠mite de deptos activos para tu plan (${limiteDeptos}).`);
    return;
  }
  const titulo = document.getElementById("titulo").value;
  const desc = document.getElementById("descripcion").value;
  const precio = document.getElementById("precio").value;
  const contacto = document.getElementById("contacto").value;
  const data = new FormData();
  data.append("action", "agregarAlquiler");
  data.append("email", email);
  data.append("titulo", titulo);
  data.append("descripcion", desc);
  data.append("precio", precio);
  data.append("contacto", contacto);
  // im√°genes base64
  imagenesBase64.forEach((img, i) => {
    data.append("imagen"+i, img);
  });
  fetch(API_URL, { method: "POST", body: data })
    .then(r => r.json())
    .then(res => {
      if(res.success){
        alert("Alquiler publicado");
        cargarMisAlquileres();
      } else {
        alert("Error publicando alquiler");
      }
    });
}

// === CARGAR MIS ALQUILERES ===
function cargarMisAlquileres(){
  if(!email){ document.getElementById("listaMisAlquileres").innerHTML = "<li>No logueado</li>"; return; }
  const script = document.createElement("script");
  script.src = `${API_URL}?action=getAlquileres&email=${encodeURIComponent(email)}&callback=mostrarMisAlquileres`;
  document.body.appendChild(script);
}
function mostrarMisAlquileres(res){
  const ul = document.getElementById("listaMisAlquileres");
  ul.innerHTML = "";
  if(!res || !res.success || !res.data || res.data.length===0){
    ul.innerHTML = "<li>No tienes alquileres</li>";
    return;
  }
  deptosActivos = res.data.filter(d => d.activo==="SI").length;
  document.getElementById("contadorAlq").textContent = `(${deptosActivos}/${limiteDeptos} alquileres)`;
  res.data.forEach(alq => {
    const li = document.createElement("li");
    li.className = "alquiler-item";
    li.innerHTML = `
      <b>${alq.titulo}</b> - ${formatoPrecio(alq.precio)}<br>
      <button onclick="eliminarAlquiler('${alq.id}')">Eliminar</button>
    `;
    ul.appendChild(li);
  });
}

// === ELIMINAR ALQUILER ===
function eliminarAlquiler(id){
  if(!confirm("¬øEliminar este alquiler?")) return;
  const data = new FormData();
  data.append("action", "eliminarAlquiler");
  data.append("id", id);
  data.append("email", email);
  fetch(API_URL, { method: "POST", body: data })
    .then(r => r.json())
    .then(res => {
      if(res.success){
        alert("Alquiler eliminado");
        cargarMisAlquileres();
      } else {
        alert("Error eliminando");
      }
    });
}

// === LOGIN ===
function login(){
  const em = document.getElementById("loginEmail").value;
  const pass = document.getElementById("loginPass").value;
  const data = new FormData();
  data.append("action","verificarLogin");
  data.append("email", em);
  data.append("password", pass);
  fetch(API_URL, { method:"POST", body:data })
    .then(r => r.json())
    .then(res => {
      if(res.success){
        email = em;
        document.getElementById("loginForm").style.display="none";
        document.getElementById("panel").style.display="block";
        cargarEstadoPlan();
        cargarMisAlquileres();
      } else {
        alert("Login incorrecto");
      }
    });
}

// === REGISTRAR DUE√ëO ===
function registrarDueno(){
  const em = document.getElementById("regEmail").value;
  const pass = document.getElementById("regPass").value;
  const nom = document.getElementById("regNombre").value;
  const cont = document.getElementById("regContacto").value;
  const data = new FormData();
  data.append("action","registrarDueno");
  data.append("email",em);
  data.append("password",pass);
  data.append("nombre",nom);
  data.append("contacto",cont);
  fetch(API_URL,{method:"POST", body:data})
    .then(r=>r.json())
    .then(res=>{
      if(res.success){
        alert("Registrado correctamente, ahora puedes iniciar sesi√≥n");
      } else {
        alert("Error en el registro");
      }
    });
}
// === LOGOUT ===
function logout(){
  email="";
  document.getElementById("loginForm").style.display="block";
  document.getElementById("panel").style.display="none";
}

  .then(r=>r.json())
  .then(res=>{
    if(res.init_point){
      window.open(res.init_point,"_blank");
    }else{
      console.error("Error MP:",res);
      alert("Error creando preferencia");
    }
  })
  .catch(err=>{
    console.error("Error MP:",err);
    alert("Error con Mercado Pago");
  });
}

// === INICIO ===
window.onload=()=>{
  cargarPreciosPlanes();
};
</script>
</body>
</html>
