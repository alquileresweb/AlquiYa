<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Due√±os</title>
<style>
body { font-family: Arial, sans-serif; margin: 10px; background:#f5f5f5; font-size:18px; text-align:center; }
h2 { color:#333; font-size:1.6em; margin-bottom:15px; } /* Bienvenida m√°s peque√±a */
.alquiler { border:1px solid #ccc; padding:16px; margin:12px 0; background:#fff; font-size:1.2em; text-align:left; }
button { margin:5px; padding:12px 18px; font-size:1.2em; border-radius:5px; cursor:pointer; }
#formulario { background:#fff; padding:20px; border:1px solid #ccc; margin-top:10px; border-radius:10px; font-size:1.2em; text-align:left; display:none; } /* desplegable */
label { display:block; margin:10px 0 6px; font-weight:bold; }
input, select, textarea { width:100%; padding:12px; margin-bottom:14px; font-size:1.1em; border-radius:6px; border:1px solid #ccc; }
.preview-img { max-width: 120px; margin-top: 5px; display:inline-block; position:relative; border-radius:5px; }
.preview-img-container { display:inline-block; margin-right:5px; position:relative; }
.delete-img { position:absolute; top:0; right:0; background:red; color:white; border:none; border-radius:50%; cursor:pointer; font-weight:bold; padding:2px 6px; }
#planStatus { margin:12px 0; font-weight:bold; font-size:1em; text-align:center; background:#cce7ff; padding:10px; border-radius:8px; } /* fondo celeste */
progress { width: 100%; height:20px; }
.modal { display: none; position: fixed; z-index: 1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.5);}
.modal-content { background-color: #fefefe; margin: 8% auto; padding:20px; border:1px solid #888; width:95%; max-width:450px; border-radius:12px; text-align:center; }
.modal h3 { margin-top:0; font-size:1.5em; }
.plan-option { border:1px solid #ccc; padding:12px; margin:12px 0; border-radius:10px; font-size:1.2em; }
.plan-option button { margin-top:6px; padding:10px 16px; font-size:1.1em; border-radius:6px; }
iframe { width:100%; min-height:450px; border:none; border-radius:5px; margin-top:10px; }
</style>
</head>
<body>
<h2 id="bienvenida"></h2>
<button onclick="logout()">Cerrar Sesi√≥n</button>
<a href="https://wa.me/5493764275443" target="_blank"><button>üìû Contacto</button></a>
<div id="planStatus"></div>
<button id="btnPlan" onclick="abrirModalPlan()">üí≥ Mejorar Plan</button>

<button id="btnAgregarAlquiler" onclick="toggleForm()">‚ûï Agregar Alquiler</button>

<h3>üìã Mis Alquileres <span id="contadorAlquileres">(0/0)</span></h3>
<div id="listaAlquileres">Cargando...</div>

<div id="formulario">
<input type="hidden" id="editRow" value="">
<label>Direcci√≥n</label>
<input type="text" id="direccion">

<label>Ambientes</label>
<input type="number" id="ambientes">

<label>Precio</label>
<input type="text" id="precio">

<label>Mascotas Permitidas</label>
<select id="mascotas">
<option value="S√≠">S√≠</option>
<option value="No">No</option>
</select>

<label>Im√°genes del Alquiler (PNG/JPG, m√∫ltiples)</label>
<input type="file" id="imagenFile" accept="image/png, image/jpeg" multiple>
<div id="previewContainer"></div>

<label>Informaci√≥n de ingreso</label>
<textarea id="infoIngreso" rows="2"></textarea>

<label>Detalles</label>
<textarea id="detalles" rows="3"></textarea>

<button id="btnGuardar" onclick="agregarAlquiler()">Agregar</button>
<p id="msg" style="color:green"></p>
</div>

<!-- Modal de Planes -->
<div id="modalPlan" class="modal">
  <div class="modal-content">
    <h3>Elige tu plan</h3>
    <div class="plan-option">
      <b>B√°sico</b> - Hasta 3 deptos activos
      <p id="precioBasico">$0 / mes</p>
      <button onclick="seleccionarPlan('Basico')">Elegir B√°sico</button>
      <div id="mpBtnBasico"></div>
    </div>
    <div class="plan-option">
      <b>Plus</b> - Hasta 5 deptos activos
      <p id="precioPlus">$0 / mes</p>
      <button onclick="seleccionarPlan('Plus')">Elegir Plus</button>
      <div id="mpBtnPlus"></div>
    </div>
    <div class="plan-option">
      <b>Full</b> - Hasta 10 deptos activos
      <p id="precioFull">$0 / mes</p>
      <button onclick="seleccionarPlan('Full')">Elegir Full</button>
      <div id="mpBtnFull"></div>
    </div>
    <button onclick="cerrarModalPlan()">Cerrar</button>
  </div>
</div>

<script>
// === CONSTANTES Y VARIABLES ===
const API_URL = "https://script.google.com/macros/s/AKfycbwDl73ZMnMowfSu_NoISSSc4fnQpLp6kaxT9Dz5jMjE9NxT64AmeN23ORQy8lejul6S/exec";
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dnugmwern/image/upload";
const CLOUDINARY_UPLOAD_PRESET = "preset_alquileres";
const GEOCODE_KEY = "AIzaSyAisqYSTfpQ_rqqutAomzitD2v_dtKYtLE";
const MP_BEARER = "APP_USR-595288641172928-010710-d915bce4137b3ee26e0c6e04873f1ac1-695835795";
let imagenesBase64 = [];
let planActual = null;
let limiteDeptos = 0;
let deptosActivos = 0;
let preciosPlanes = {Basico:0, Plus:0, Full:0};

// === FUNCIONES ADICIONALES ===
function toggleForm(){
  const form = document.getElementById("formulario");
  form.style.display = form.style.display==="none" ? "block" : "none";
}
// === CARGAR PRECIOS PLANES ===
function cargarPreciosPlanes(){
  const script = document.createElement("script");
  script.src = `${API_URL}?action=getPlanes&callback=mostrarPreciosPlanes`;
  document.body.appendChild(script);
}

function mostrarPreciosPlanes(res){
  if(res.success && res.data && res.data.length){
    res.data.forEach(plan=>{
      preciosPlanes[plan.nombre] = parseFloat(plan.precio)||0;
    });
    document.getElementById("precioBasico").textContent = formatoPrecio(preciosPlanes.Basico) + " / mes";
    document.getElementById("precioPlus").textContent = formatoPrecio(preciosPlanes.Plus) + " / mes";
    document.getElementById("precioFull").textContent = formatoPrecio(preciosPlanes.Full) + " / mes";
  }
}

// === CARGAR ESTADO DE PLAN ===
function cargarEstadoPlan(){
  const email = localStorage.getItem("dueno");
  const script = document.createElement("script");
  script.src = `${API_URL}?action=getLoginInfo&email=${encodeURIComponent(email)}&callback=mostrarEstadoPlan`;
  document.body.appendChild(script);
}

function mostrarEstadoPlan(res){
  const planDiv = document.getElementById("planStatus");
  if(!res.success || !res.data || !res.data[0]){
    planActual = null;
    limiteDeptos = 0;
    planDiv.style.backgroundColor = "#ccefff"; // fondo celeste
    planDiv.innerHTML = `Plan: <b>Sin plan</b> | Estado de Pago: N/D | Vencimiento: N/D`;
    document.getElementById("btnPlan").textContent = "üí≥ Elegir Plan";
    document.getElementById("contadorAlquileres").textContent = `(0/0)`;
    return;
  }
  const login = res.data[0];
  planActual = login.Plan || null;
  limiteDeptos = planActual==="Basico"?3:planActual==="Plus"?5:planActual==="Full"?10:0;
  const estadoPago = login.EstadoPago || "No registrado";
  const vencimiento = login.Vencimiento || "N/D";
  planDiv.style.backgroundColor = "#ccefff";
  planDiv.innerHTML = `Plan: <b>${planActual || "Sin plan"}</b> | Estado de Pago: ${estadoPago} | Vencimiento: ${vencimiento}`;
  document.getElementById("btnPlan").textContent = planActual ? "üí≥ Mejorar Plan" : "üí≥ Elegir Plan";
}

// === ACTUALIZAR CONTADOR DE ALQUILERES ===
function actualizarContador(){
  document.getElementById("contadorAlquileres").textContent = `(${deptosActivos}/${limiteDeptos})`;
}

// === MODAL PLAN ===
function abrirModalPlan(){ document.getElementById("modalPlan").style.display="block"; }
function cerrarModalPlan(){ document.getElementById("modalPlan").style.display="none"; }

async function seleccionarPlan(plan){
  const email = localStorage.getItem("dueno");
  const precio = preciosPlanes[plan]||0;
  const preferenceData = {
    items:[{ title:`Plan ${plan}`, quantity:1, unit_price:parseFloat(precio), currency_id:"ARS" }],
    payer: { email: email }
  };
  fetch("https://api.mercadopago.com/checkout/preferences", {
    method:"POST",
    headers:{ "Authorization": "Bearer " + MP_BEARER, "Content-Type":"application/json" },
    body: JSON.stringify(preferenceData)
  })
  .then(r => r.json())
  .then(res => {
    if(res.init_point){
      const mpContainer = document.getElementById("mpBtn" + plan);
      mpContainer.innerHTML = `<iframe src="${res.init_point}" width="100%" height="650" frameborder="0" allowtransparency="true"></iframe>`;
    } else {
      console.error("Error MP:", res);
      alert("No se pudo generar el bot√≥n de pago. Revisa la consola.");
    }
  })
  .catch(err => console.error("Error MP:", err));
  // **NO se cierra el modal** al seleccionar plan
}
// === CARGAR ALQUILERES ===
function cargarAlquileres() {
  const email = localStorage.getItem("dueno");
  const script = document.createElement("script");
  script.src = `${API_URL}?action=getAlquileresDueno&dueno=${encodeURIComponent(email)}&callback=mostrarAlquileres`;
  document.body.appendChild(script);
}

function mostrarAlquileres(res){
  const div = document.getElementById("listaAlquileres");
  div.innerHTML = "";
  if(!res.success || !res.data || res.data.length === 0){ div.innerHTML="No tienes alquileres a√∫n."; actualizarContador(); return; }

  deptosActivos = res.data.filter(a=>a.Estado==="Activo").length;
  actualizarContador();

  res.data.forEach(alq => {
    let estado = alq.Estado === "Activo" ? "Activo ‚úÖ" : "Inactivo ‚ùå";
    let btnEstado = `<button onclick="cambiarEstado(${alq.row}, '${alq.Estado}')">Cambiar Estado</button>`;
    let btnEditar = `<button onclick='editarAlquiler(${alq.row}, ${JSON.stringify(alq)})'>Editar</button>`;
    let btnEliminar = `<button onclick="eliminarAlquiler(${alq.row})">Eliminar</button>`;
    let precioFormateado = formatoPrecio(alq.Precio);
    div.innerHTML += `<div class="alquiler">
      <b>${alq.Direccion}</b> - ${alq['Nro Ambientes']} amb - ${precioFormateado} - Mascotas: ${alq.Mascotas || "N/D"}<br>
      Estado: ${estado}<br>
      ${btnEstado} ${btnEditar} ${btnEliminar}
    </div>`;
  });
}

// === AGREGAR / EDITAR ALQUILER ===
async function agregarAlquiler(){
  let direccion = document.getElementById("direccion").value;
  const ambientes = document.getElementById("ambientes").value;
  let precio = document.getElementById("precio").value.replace(/\D/g,"");
  const mascotas = document.getElementById("mascotas").value;
  const infoIngreso = document.getElementById("infoIngreso").value;
  const detalles = document.getElementById("detalles").value;
  let row = document.getElementById("editRow").value || new Date().getTime();
  const email = localStorage.getItem("dueno");
  if(!direccion || !ambientes || !precio){ alert("Completa todos los campos obligatorios."); return; }
  direccion = direccion + ", Santo Tom√© Corrientes";
  const msgEl = document.getElementById("msg");
  if(document.getElementById("editRow").value) msgEl.textContent = "Guardando cambios...";

  const files = document.getElementById("imagenFile").files;
  let uploadedURLs = [];
  for(let i=0; i<files.length; i++){
    const url = await subirImagenCloudinary(files[i]);
    if(url) uploadedURLs.push(url);
  }

  fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(direccion)}&key=${GEOCODE_KEY}`)
  .then(r=>r.json()).then(data=>{
    let lat="", lng="";
    if(data.results && data.results[0]){
      lat = data.results[0].geometry.location.lat;
      lng = data.results[0].geometry.location.lng;
    }
    enviarAlquiler(uploadedURLs.join(","), lat, lng);
  });

  function enviarAlquiler(fotosConcatenadas, lat, lng){
    const action = document.getElementById("editRow").value ? "editAlquiler" : "addAlquiler";
    const callback = action==="editAlquiler" ? "alquilerEditado" : "alquilerAgregado";
    const script = document.createElement("script");
    script.src = `${API_URL}?action=${action}&row=${row}&dueno=${encodeURIComponent(email)}&direccion=${encodeURIComponent(direccion)}&ambientes=${encodeURIComponent(ambientes)}&precio=${encodeURIComponent(precio)}&mascotas=${encodeURIComponent(mascotas)}&fotos=${encodeURIComponent(fotosConcatenadas)}&infoIngreso=${encodeURIComponent(infoIngreso)}&detalles=${encodeURIComponent(detalles)}&lat=${lat}&lng=${lng}&contacto=auto&callback=${callback}`;
    document.body.appendChild(script);
  }
}

// === FUNCIONES RESTANTES ===
function editarAlquiler(row, datos){
  document.getElementById("tituloForm").textContent="‚úèÔ∏è Editar Alquiler";
  document.getElementById("btnGuardar").textContent="Guardar Cambios";
  document.getElementById("editRow").value=row;
  document.getElementById("direccion").value=datos.Direccion||"";
  document.getElementById("ambientes").value=datos["Nro Ambientes"]||"";
  document.getElementById("precio").value = formatoPrecio(datos.Precio);
  document.getElementById("mascotas").value=datos.Mascotas||"No";
  document.getElementById("infoIngreso").value=datos.InfoIngreso||"";
  document.getElementById("detalles").value=datos.Detalles||"";
  imagenesBase64 = datos.Fotos ? datos.Fotos.split(",") : [];
  actualizarPreview();
  window.scrollTo(0, document.getElementById("formulario").offsetTop);
}

function resetForm(){
  document.getElementById("tituloForm").textContent="‚ûï Agregar Alquiler";
  document.getElementById("btnGuardar").textContent="Agregar";
  document.getElementById("editRow").value="";
  document.getElementById("direccion").value="";
  document.getElementById("ambientes").value="";
  document.getElementById("precio").value="";
  document.getElementById("mascotas").value="S√≠";
  document.getElementById("infoIngreso").value="";
  document.getElementById("detalles").value="";
  document.getElementById("imagenFile").value="";
  imagenesBase64=[];
  actualizarPreview();
  document.getElementById("msg").textContent = "";
}

function cambiarEstado(row, estadoActual){
  const msg = document.createElement("p");
  msg.textContent = "Cambiando estado...";
  document.body.appendChild(msg);

  if(estadoActual === "Inactivo" && deptosActivos >= limiteDeptos){
    alert(`No puedes activar m√°s alquileres. Tu plan (${planActual}) permite hasta ${limiteDeptos} deptos activos.`);
    msg.remove();
    return;
  }
  const script = document.createElement("script");
  script.src = `${API_URL}?action=toggleEstado&row=${row}&callback=cargarAlquileres`;
  document.body.appendChild(script);
  setTimeout(()=>msg.remove(), 1500);
}

function eliminarAlquiler(row){
  if(!confirm("¬øSeguro que deseas eliminar este alquiler?")) return;
  const script = document.createElement("script");
  script.src = `${API_URL}?action=deleteAlquiler&row=${row}&callback=cargarAlquileres`;
  document.body.appendChild(script);
}

function logout(){ localStorage.removeItem("dueno"); window.location.href="index.html"; }

function alquilerAgregado(res) {
  if (res.success) { 
    alert("‚úÖ Alquiler agregado con √©xito"); 
    resetForm(); 
    cargarAlquileres(); 
    cargarEstadoPlan();
  }
  else { alert("‚ùå Error al agregar: " + (res.error || "desconocido")); }
}

function alquilerEditado(res) {
  const msgEl = document.getElementById("msg");
  if (res.success) { 
    msgEl.textContent = "‚úÖ Cambios guardados correctamente";
    resetForm(); 
    cargarAlquileres(); 
  }
  else { 
    msgEl.textContent = "‚ùå Error al editar: " + (res.error || "desconocido"); 
  }
}

// === BOT√ìN DE CONTACTO ===
const btnContacto = document.createElement("button");
btnContacto.textContent = "üìû Contacto";
btnContacto.onclick = ()=>window.open("https://wa.me/5493764275443","_blank");
document.body.appendChild(btnContacto);

// === CONTADOR DE ALQUILERES ACTIVOS / L√çMITE ===
const contadorSpan = document.createElement("span");
contadorSpan.id = "contadorAlquileres";
contadorSpan.style.marginLeft="10px";
document.getElementById("planStatus").appendChild(contadorSpan);
actualizarContador();
