// --- Datos de Cloudinary ---
const CLOUDINARY_CLOUD_NAME = "dnugmwern";
const CLOUDINARY_API_KEY = "877726879255954";
const CLOUDINARY_API_SECRET = "t8CStqLDqd1hs3P9Hkr4lqicIQU";
const CLOUDINARY_UPLOAD_PRESET = "preset_alquileres"; // Crea uno en tu panel de Cloudinary

// --- Obtener precios y límites dinámicos desde la hoja "Planes" ---
function getPlanesDinamicos() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("Planes");
  var data = sheet.getRange("E2:G2").getValues()[0]; // fila 2, columnas E,F,G
  return {
    Basico: { limiteDeptos: 3, limiteFotos: 3, destacar: 0, precio: data[0] || 0 },
    Plus:   { limiteDeptos: 5, limiteFotos: 5, destacar: 1, precio: data[1] || 0 },
    Full:   { limiteDeptos: 10, limiteFotos: 99, destacar: 99, precio: data[2] || 0 }
  };
}

// --- Manejo principal de solicitudes ---
function doGet(e) {
  var action = e.parameter.action;
  var callback = e.parameter.callback || null;
  var res = {};

  try {
    if (action == "getAlquileres") {
      res = { success: true, data: getAlquileresActivos() };
    } else if (action == "addAlquiler") {
      res = addAlquiler(e);
    } else if (action == "editAlquiler") {
      res = editAlquiler(e);
    } else if (action == "toggleEstado") {
      res = toggleEstado(e);
    } else if (action == "deleteAlquiler") {
      res = deleteAlquiler(e);
    } else if (action == "registerDueno") {
      res = registerDueno(e);
    } else if (action == "getAlquileresDueno") {
      res = { success: true, data: getAlquileres(e) };
    } else if (action == "mejorarPlan") {
      res = mejorarPlan(e);
    } else if (action == "getLoginInfo") {
      res = getLoginInfo(e);
    } else if (action == "verificarLogin") {
      res = verificarLogin(e);
    } else if (action == "getPlanes") {
      res = getPlanes();
    } else if (action == "editarDueno") {
      res = editarDueno(e);
    } else {
      res = { success: false, error: "Acción no reconocida" };
    }
  } catch (err) {
    res = { success: false, error: err.message };
  }

  var json = JSON.stringify(res);
  if (callback) {
    return ContentService.createTextOutput(callback + "(" + json + ");")
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  } else {
    return ContentService.createTextOutput(json)
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// --- Manejar POST ---
function doPost(e) {
  try {
    if (e.postData && e.postData.contents) {
      const params = JSON.parse(e.postData.contents);

      // === Subir imágenes Base64 a Cloudinary ===
      if (params.action === "uploadImagesCloudinary" && params.images) {
        const links = [];
        params.images.forEach((b64, i) => {
          try {
            const url = subirImagenCloudinary(b64);
            if(url) links.push(url);
          } catch(err){
            Logger.log("❌ Error subiendo a Cloudinary: " + err.message);
          }
        });
        if(params.row && links.length > 0){
          const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
          sheet.getRange(parseInt(params.row), 9).setValue(links.join(","));
        }
        return ContentService.createTextOutput(JSON.stringify({ success: true, links }))
          .setMimeType(ContentService.MimeType.JSON);
      }

      // --- comportamiento original para POST con JSON ---
      return doGet({ parameter: params });
    }

    return ContentService.createTextOutput(JSON.stringify({ success: false, error: "POST vacío" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log("❌ Error en doPost: " + err.message);
    return ContentService.createTextOutput(
      JSON.stringify({ success: false, error: err.message })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}

// --- Subir imagen Base64 a Cloudinary ---
function subirImagenCloudinary(base64Data){
  const endpoint = "https://api.cloudinary.com/v1_1/" + CLOUDINARY_CLOUD_NAME + "/image/upload";
  const payload = {
    file: base64Data,
    upload_preset: CLOUDINARY_UPLOAD_PRESET
  };
  const options = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(payload)
  };
  const response = UrlFetchApp.fetch(endpoint, options);
  const data = JSON.parse(response.getContentText());
  return data.secure_url;
}

// --- Obtener todos los alquileres activos (solo dueños con pago al día) ---
function getAlquileresActivos() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var alquileres = [];

  for (var i = 1; i < data.length; i++) {
    var tipo = data[i][0];
    var estado = data[i][9];
    var lat = data[i][3];
    var lng = data[i][4];
    var email = data[i][1];
    var dueño = loginData.find(row => row[1] === email);
    var pagoAlDia = dueño && new Date(dueño[7]) >= new Date();

    if (tipo === "alquiler" && estado === "Activo" && lat && lng && pagoAlDia) {
      var obj = {};
      for (var j = 0; j < headers.length; j++) obj[headers[j]] = data[i][j];
      obj["Contacto"] = data[i][7] || "";
      obj.row = i + 1;
      alquileres.push(obj);
    }
  }
  return alquileres;
}

// --- Obtener alquileres de un dueño específico ---
function getAlquileres(e) {
  var email = e.parameter.dueno;
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var alquileres = [];

  for (var i = 1; i < data.length; i++) {
    var tipo = data[i][0];
    var correo = data[i][1];
    if (tipo === "alquiler" && correo === email) {
      var obj = {};
      for (var j = 0; j < headers.length; j++) obj[headers[j]] = data[i][j];
      obj["Contacto"] = data[i][7] || "";
      obj.row = i + 1;
      alquileres.push(obj);
    }
  }
  return alquileres;
}

// --- Validar límite de deptos (solo activos) ---
function validarLimiteDeptos(email) {
  const loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  const loginData = loginSheet.getDataRange().getValues();
  const dueño = loginData.find(row => row[1] === email);
  if (!dueño) throw "Dueño no encontrado";

  const plan = dueño[5] || "Basico";
  const planes = getPlanesDinamicos();
  const limite = planes[plan].limiteDeptos;

  const alquileresSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  const cantidadDeptos = alquileresSheet.getDataRange().getValues()
    .filter(r => r[0]==="alquiler" && r[1]===email && r[9]==="Activo").length;

  if (cantidadDeptos >= limite) throw `Tu plan actual (${plan}) solo permite ${limite} deptos. Mejora tu plan para agregar más.`;
}

// --- Validar vencimiento ---
function validarVencimiento(email) {
  const loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  const loginData = loginSheet.getDataRange().getValues();
  const dueño = loginData.find(row => row[1] === email);
  if (!dueño) throw "Dueño no encontrado";

  const fechaVencimiento = dueño[7];
  if (!fechaVencimiento) return true;
  if (new Date() > new Date(fechaVencimiento)) throw "Tu plan está vencido. Debes renovar para poder agregar o mostrar tus deptos en el mapa.";
  return true;
}

// --- Agregar nuevo alquiler (validando plan y vencimiento) ---
function addAlquiler(e) {
  var email = e.parameter.dueno;

  validarLimiteDeptos(email);
  validarVencimiento(email);

  var direccion = e.parameter.direccion;
  var ambientes = e.parameter.ambientes;
  var precio = e.parameter.precio;
  var mascotas = e.parameter.mascotas || "";
  var fotos = e.parameter.fotos || "";
  var infoIngreso = e.parameter.infoIngreso || "";
  var detalles = e.parameter.detalles || "";
  var lat = e.parameter.lat || "";
  var lng = e.parameter.lng || "";

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var contacto = "auto";
  for (var i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === email) {
      contacto = loginData[i][4] || "auto";
      break;
    }
  }

  var alquileresSheet = ss.getSheetByName("Alquileres");
  alquileresSheet.appendRow([
    "alquiler", email, direccion, lat, lng, ambientes, precio, contacto, fotos, "Activo", infoIngreso, detalles, mascotas
  ]);
  return { success: true };
}

// --- Editar alquiler existente ---
function editAlquiler(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) return { success: false, error: "Fila inválida" };

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");

  if (e.parameter.direccion) sheet.getRange(row, 3).setValue(e.parameter.direccion);
  if (e.parameter.lat) sheet.getRange(row, 4).setValue(e.parameter.lat);
  if (e.parameter.lng) sheet.getRange(row, 5).setValue(e.parameter.lng);
  if (e.parameter.ambientes) sheet.getRange(row, 6).setValue(e.parameter.ambientes);
  if (e.parameter.precio) sheet.getRange(row, 7).setValue(e.parameter.precio);
  if (e.parameter.mascotas) sheet.getRange(row, 13).setValue(e.parameter.mascotas);
  if (e.parameter.infoIngreso) sheet.getRange(row, 11).setValue(e.parameter.infoIngreso);
  if (e.parameter.detalles) sheet.getRange(row, 12).setValue(e.parameter.detalles);
  if (e.parameter.fotos) sheet.getRange(row, 9).setValue(e.parameter.fotos);

  return { success: true };
}

// --- Cambiar estado Activo/Inactivo ---
function toggleEstado(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) return { success: false, error: "Fila inválida" };

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var estado = sheet.getRange(row, 10).getValue();
  var nuevoEstado = estado === "Activo" ? "Inactivo" : "Activo";
  sheet.getRange(row, 10).setValue(nuevoEstado);

  return { success: true, nuevoEstado: nuevoEstado };
}

// --- Eliminar alquiler ---
function deleteAlquiler(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) return { success: false, error: "Fila inválida" };

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  sheet.deleteRow(row);
  return { success: true };
}

// --- Registrar dueño ---
function registerDueno(e) {
  var email = e.parameter.email;
  var password = e.parameter.password;
  var nombre = e.parameter.nombre;
  var contacto = e.parameter.contacto;

  if (!email || !password || !nombre || !contacto) 
    return { success: false, error: "Faltan datos" };

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();

  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) 
      return { success: false, error: "El email ya está registrado" };
  }

  var fechaVencimiento = new Date();
  fechaVencimiento.setDate(fechaVencimiento.getDate() + 30);

  loginSheet.appendRow([
    "Dueño", email, password, nombre, contacto, "Basico", "Pago al día", fechaVencimiento
  ]);

  return { success: true, message: "Dueño registrado correctamente" };
}

// --- Verificar login ---
function verificarLogin(e) {
  var email = e.parameter.email;
  var password = e.parameter.password;

  if (!email || !password) 
    return { success: false, error: "Faltan credenciales" };

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();

  for (var i = 1; i < data.length; i++) {
    var fila = data[i];
    var tipo = fila[0];       
    var correo = fila[1];     
    var pass = fila[2];       

    if (tipo === "Dueño" && correo === email) {
      if (String(pass) == String(password)) {
        return {
          success: true,
          tipo: tipo,
          email: correo,
          nombre: fila[3] || "",
          contacto: fila[4] || "",
          plan: fila[5] || "",
          estadoPago: fila[6] || "",
          vencimiento: fila[7] 
            ? Utilities.formatDate(new Date(fila[7]), Session.getScriptTimeZone(), "yyyy-MM-dd") 
            : ""
        };
      } else {
        return { success: false, error: "Contraseña incorrecta" };
      }
    }
  }

  return { success: false, error: "Usuario no registrado" };
}

// --- Mejorar plan ---
function mejorarPlan(e) {
  var email = e.parameter.email;
  var nuevoPlan = e.parameter.plan;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();

  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) {
      var fechaNueva = new Date();
      fechaNueva.setDate(fechaNueva.getDate() + 30);
      loginSheet.getRange(i+1, 6).setValue(nuevoPlan);
      loginSheet.getRange(i+1, 7).setValue("Pago al día");
      loginSheet.getRange(i+1, 8).setValue(fechaNueva);
      return { success: true, message: "Plan actualizado correctamente" };
    }
  }
  return { success: false, error: "Dueño no encontrado" };
}

// --- Callbacks JSONP ---
function alquilerAgregado(res){
  if(res.success) return { success: true, message: "Alquiler agregado con éxito" };
  else return { success: false, error: res.error || "Error al agregar el alquiler" };
}

function alquilerEditado(res){
  if(res.success) return { success: true, message: "Alquiler editado con éxito" };
  else return { success: false, error: res.error || "Error al editar el alquiler" };
}

// --- Trigger diario para notificaciones ---
function enviarNotificaciones() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const loginSheet = ss.getSheetByName("Login");
  const data = loginSheet.getDataRange().getValues();
  const hoy = new Date();

  for (var i = 1; i < data.length; i++) {
    const email = data[i][1];
    const nombre = data[i][3];
    const fechaVencimiento = new Date(data[i][7]);
    const diffDias = Math.ceil((fechaVencimiento - hoy)/(1000*60*60*24));

    if(diffDias === 5) {
      MailApp.sendEmail(email, "Tu plan vence en 5 días", `Hola ${nombre}, tu plan vence en 5 días. Renueva para no perder servicios.`);
    }
    if(diffDias <= 0) {
      MailApp.sendEmail(email, "Plan vencido", `Hola ${nombre}, tu plan está vencido. Renueva para seguir mostrando tus deptos.`);
      loginSheet.getRange(i+1,7).setValue("Pago vencido");
    }
  }
}

// --- NUEVA FUNCIÓN PARA FRONTEND DUEÑOS ---
function getLoginInfo(e) {
  var email = e.parameter.email;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var alquileresSheet = ss.getSheetByName("Alquileres");
  var alquileresData = alquileresSheet.getDataRange().getValues();
  var result = [];

  for (var i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === email) {
      var plan = loginData[i][5] || "Basico";
      var estadoPago = loginData[i][6] || "Pago al día";
      var vencimiento = loginData[i][7] ? Utilities.formatDate(new Date(loginData[i][7]), Session.getScriptTimeZone(), "yyyy-MM-dd") : "";
      var deptosActivos = 0;
      for (var j = 1; j < alquileresData.length; j++) {
        if (alquileresData[j][0] === "alquiler" && alquileresData[j][1] === email && alquileresData[j][9] === "Activo") {
          deptosActivos++;
        }
      }

      result.push({
        Email: loginData[i][1],
        Nombre: loginData[i][3] || "",
        Contacto: loginData[i][4] || "",
        Password: loginData[i][2] || "",
        Plan: plan,
        EstadoPago: estadoPago,
        Vencimiento: vencimiento,
        deptosActivos: deptosActivos,
        data: alquileresData.slice(1).filter(r => r[0]==="alquiler" && r[1]===email).map((r,index)=>{
          return {
            row: index+2,
            Direccion: r[2],
            "Nro Ambientes": r[5],
            Precio: r[6],
            Mascotas: r[12],
            Estado: r[9],
            Fotos: r[8],
            InfoIngreso: r[10],
            Detalles: r[11]
          };
        })
      });
      break;
    }
  }

  return { success: true, data: result };
}

// --- NUEVA FUNCIÓN: Obtener planes dinámicamente ---
function getPlanes() {
  const planes = getPlanesDinamicos();
  var planesArray = [];
  for(var key in planes){
    planesArray.push({ nombre: key, ...planes[key] });
  }
  return { success:true, data: planesArray };
}

// --- NUEVA FUNCIÓN: Editar datos de un dueño ---
function editarDueno(e) {
  var email = e.parameter.email;
  var newEmail = e.parameter.newEmail;
  var nombre = e.parameter.nombre;
  var contacto = e.parameter.contacto;
  var password = e.parameter.password;

  if (!email) 
    return { success: false, error: "Falta el email del dueño" };

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();
  var rowIndex = -1;

  // Find the owner
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) {
      rowIndex = i + 1;
      break;
    }
  }

  if (rowIndex === -1) 
    return { success: false, error: "Dueño no encontrado" };

  // Validate newEmail if provided
  if (newEmail) {
    if (!newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) 
      return { success: false, error: "El nuevo email no es válido" };
    
    for (var i = 1; i < data.length; i++) {
      if (data[i][1] === newEmail && i + 1 !== rowIndex) 
        return { success: false, error: "El nuevo email ya está registrado" };
    }
    loginSheet.getRange(rowIndex, 2).setValue(newEmail); // Update Email (column B)
  }

  // Validate and update password if provided
  if (password && password.length < 6) 
    return { success: false, error: "La contraseña debe tener al menos 6 caracteres" };
  if (password) 
    loginSheet.getRange(rowIndex, 3).setValue(password); // Update Password (column C)

  // Validate and update nombre if provided
  if (nombre) 
    loginSheet.getRange(rowIndex, 4).setValue(nombre); // Update Nombre (column D)

  // Validate and update contacto if provided
  if (contacto && !contacto.match(/^\+\d+$/)) 
    return { success: false, error: "El contacto debe empezar con '+' seguido de dígitos" };
  if (contacto) 
    loginSheet.getRange(rowIndex, 5).setValue(contacto); // Update Contacto (column E)

  return { success: true, message: "Datos del dueño actualizados correctamente" };
}
