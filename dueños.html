<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Dueños - AlquiYa</title>
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SSJ5DG33JK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-SSJ5DG33JK');
</script>
<!-- Google Charts -->
<script src="https://www.gstatic.com/charts/loader.js"></script>
<link rel="icon" type="image/png" href="https://i.postimg.cc/MKpMcrcQ/AlquiYa.png">

<style>
/* Estilos generales - móvil first */
body { font-family: Arial, sans-serif; margin: 10px; background:#f5f5f5; font-size:20px; text-align:center; margin-top: 120px; }
h2 { color:#333; font-size:2.2em; margin-bottom:18px; }
h3 { color:#333; font-size:2em; margin-bottom:18px; }
.alquiler { border:1px solid #ccc; padding:16px; margin:14px 0; background:#fff; font-size:1.4em; text-align:left; border-radius:12px; }
button { margin: 6px; padding:14px 20px; font-size:1.3em; border-radius:8px; cursor:pointer; border:none; }
button.stats-btn { background:#ff9800; color:white; font-weight:bold; }
#btnAgregarPropiedad { background:#3681f3; color:white; }
#opcionesPropiedad, #opcionesVenta, #opcionesAlquiler { background:#fff; padding:20px; border:1px solid #ccc; margin-top:24px; border-radius:12px; font-size:1.3em; text-align:left; display:none; }
#opcionesPropiedad.active, #opcionesVenta.active, #opcionesAlquiler.active { display:block; }

.formulario { background:#fff; padding:20px; border:1px solid #ccc; margin-top:24px; border-radius:12px; font-size:1.3em; text-align:left; display:none; }
.formulario.active { display:block; }

label { display:block; margin:12px 0 8px; font-weight:bold; }
input, select, textarea { width:100%; padding:14px; margin-bottom:16px; font-size:1.2em; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; }
.preview-img, .preview-video { max-width:140px; margin:5px; border-radius:8px; }
.delete-img, .delete-video { position:absolute; top:-8px; right:-8px; background:red; color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; }

#planContainer { background:#3681f3; color:white; padding:16px; border-radius:12px; margin:20px auto; max-width:600px; }
#contactoBtn { position:fixed; position:fixed; bottom:24px; right:24px; background:#25D366; color:white; border:none; border-radius:50%; padding:24px; font-size:2em; box-shadow:0 4px 10px rgba(0,0,0,0.3); z-index:999; }

/* Menú hamburguesa y flecha volver */
#menu-toggle, #back-arrow { position:fixed; top:20px; font-size:36px; background:none; border:none; cursor:pointer; z-index:1001; }
#menu-toggle { right:20px; }
#back-arrow { left:20px; }
#menu { display:none; position:fixed; top:70px; right:20px; background:white; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.2); z-index:1001; }
#menu.active { display:block; }
#menu button { width:100%; text-align:left; padding:16px; font-size:1.4em; border-bottom:1px solid #eee; }

/* Modal Estadísticas */
#modalEstadisticas { display:none; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); }
#modalEstadisticas .modal-content { background:white; margin:8% auto; padding:30px; border-radius:16px; width:90%; max-width:420px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.4); }
#modalEstadisticas h3 { color:#ff9800; font-size:2.3em; margin-bottom:20px; }
.metricas-item { background:linear-gradient(135deg,#ff9800,#f57c00); color:white; padding:22px; margin:18px 0; border-radius:14px; font-size:1.7em; box-shadow:0 6px 15px rgba(0,0,0,0.2); }
.metricas-numero { font-size:3em; font-weight:bold; display:block; }

/* Responsive */
@media (max-width:600px) {
  body { font-size:24px; margin-top:140px; }
  h3 { font-size:2.4em; }
  .alquiler { font-size:1.6em; padding:20px; }
  button { font-size:1.5em; padding:18px; }
  #modalEstadisticas .modal-content { margin:15% auto; padding:25px; }
  .metricas-numero { font-size:2.6em; }
}
</style>
</head>
<body>

<!-- HEADER -->
<header style="position:fixed; top:0; left:0; width:100%; background:white; z-index:1000; padding:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
  <button id="back-arrow" onclick="window.location.href='index.html'">←</button>
  <img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="AlquiYa" style="max-width:340px; margin:10px auto; display:block;">
  <button id="menu-toggle" onclick="document.getElementById('menu').classList.toggle('active')">☰</button>
  <div id="menu">
    <button onclick="abrirModalEditarCuenta()">Editar Cuenta</button>
    <button onclick="logout()">Cerrar Sesión</button>
  </div>
</header>

<!-- PLAN -->
<div id="planContainer">
  <div id="planContainer">
    <b>Mi plan</b>
    <div id="planStatus">Cargando...</div>
    <span id="limiteAlquileres"></span>
    <button id="btnPlan" onclick="abrirModalPlan()">Mejorar Plan</button>
  </div>
</div>

<h3>Mis Propiedades</h3>
<div id="listaAlquileres">Cargando tus propiedades...</div>

<button id="btnAgregarPropiedad" onclick="toggleOpcionesPropiedad()">Agregar Propiedad</button>

<!-- OPCIONES DE TIPO DE OPERACIÓN -->
<div id="opcionesPropiedad">
  <label>Tipo de Operación</label>
  <select id="tipoOperacion" onchange="mostrarOpcionesPorOperacion()">
    <option value="Vender">Vender</option>
    <option value="Alquilar">Alquilar</option>
  </select>

  <div id="opcionesVenta">
    <button onclick="mostrarFormulario('Terreno')">Terreno</button>
    <button onclick="mostrarFormulario('Casa')">Casa</button>
    <button onclick="mostrarFormulario('Departamento')">Departamento</button>
    <button onclick="mostrarFormulario('Local')">Local Comercial</button>
  </div>

  <div id="opcionesAlquiler">
    <button onclick="mostrarFormulario('Departamento')">Departamento</button>
    <button onclick="mostrarFormulario('Local')">Local Comercial</button>
    <button onclick="mostrarFormulario('Temporario')">Temporario</button>
  </div>
</div>

<!-- ==================== FORMULARIOS COMPLETOS ==================== -->
<div id="formularioTerreno" class="formulario">
  <input type="hidden" id="editRowTerreno">
  <input type="hidden" id="enlaceCompartirTerreno">
  <input type="hidden" id="existingVideosTerreno">
  <label>Superficie total (m²)</label>
  <input type="number" id="superficieTerreno">
  <label>Dirección completa</label>
  <input type="text" id="direccionTerreno">
  <label>Precio (USD)</label>
  <input type="text" id="precioTerreno" placeholder="Ej: 50000">
  <label>Imágenes (múltiples)</label>
  <input type="file" id="imagenFileTerreno" accept="image/*" multiple>
  <div id="previewContainerTerreno"></div>
  <label>Videos (múltiples)</label>
  <input type="file" id="videoFileTerreno" accept="video/*" multiple>
  <div id="videoPreviewContainerTerreno"></div>
  <label>Información de pago</label>
  <textarea id="infoIngresoTerreno" rows="3"></textarea>
  <label>Detalles</label>
  <textarea id="detallesTerreno" rows="4</textarea>
  <button onclick="agregarAlquiler('Terreno')">Agregar Terreno</button>
  <p id="msgTerreno"></p>
</div>

<div id="formularioCasa" class="formulario">
  <input type="hidden" id="editRowCasa">
  <input type="hidden" id="enlaceCompartirCasa">
  <input type="hidden" id="existingVideosCasa">
  <label>Dirección completa</label>
  <input type="text" id="direccionCasa">
  <label>Precio (USD)</label>
  <input type="text" id="precioCasa">
  <label>Ambientes</label>
  <input type="number" id="ambientesCasa">
  <label>Patio</label>
  <select id="patioCasa"><option>Sí</option><option>No</option></select>
  <label>Garage</label>
  <select id="garageCasa"><option>Sí</option><option>No</option></select>
  <label>Antigüedad (años)</label>
  <input type="number" id="antiguedadCasa">
  <label>Imágenes</label>
  <input type="file" id="imagenFileCasa" accept="image/*" multiple>
  <div id="previewContainerCasa"></div>
  <label>Videos</label>
  <input type="file" id="videoFileCasa" accept="video/*" multiple>
  <div id="videoPreviewContainerCasa"></div>
  <label>Información de pago</label>
  <textarea id="infoIngresoCasa" rows="3"></textarea>
  <label>Otros detalles</label>
  <textarea id="detallesCasa" rows="4"></textarea>
  <button onclick="agregarAlquiler('Casa')">Agregar Casa</button>
  <p id="msgCasa"></p>
</div>

<div id="formularioDepartamento" class="formulario">
  <input type="hidden" id="editRowDepartamento">
  <input type="hidden" id="enlaceCompartirDepartamento">
  <input type="hidden" id="existingVideosDepartamento">
  <label>Dirección completa</label>
  <input type="text" id="direccionDepartamento">
  <label>Ambientes</label>
  <input type="number" id="ambientesDepartamento">
  <label>Precio (USD)</label>
  <input type="text" id="precioDepartamento">
  <label>Imágenes</label>
  <input type="file" id="imagenFileDepartamento" accept="image/*" multiple>
  <div id="previewContainerDepartamento"></div>
  <label>Videos</label>
  <input type="file" id="videoFileDepartamento" accept="video/*" multiple>
  <div id="videoPreviewContainerDepartamento"></div>
  <label>Información de pago</label>
  <textarea id="infoIngresoDepartamento" rows="3"></textarea>
  <label>Detalles</label>
  <textarea id="detallesDepartamento" rows="4"></textarea>
  <button onclick="agregarAlquiler('Departamento')">Agregar Departamento</button>
  <p id="msgDepartamento"></p>
</div>

<div id="formularioLocal" class="formulario">
  <input type="hidden" id="editRowLocal">
  <input type="hidden" id="enlaceCompartirLocal">
  <input type="hidden" id="existingVideosLocal">
  <label>Dirección completa</label>
  <input type="text" id="direccionLocal">
  <label>Imágenes</label>
  <input type="file" id="imagenFileLocal" accept="image/*" multiple>
  <div id="previewContainerLocal"></div>
  <label>Videos</label>
  <input type="file" id="videoFileLocal" accept="video/*" multiple>
  <div id="videoPreviewContainerLocal"></div>
  <label>Información de ingreso</label>
  <textarea id="infoIngresoLocal" rows="3"></textarea>
  <label>Detalles</label>
  <textarea id="detallesLocal" rows="4"></textarea>
  <button onclick="agregarAlquiler('Local')">Agregar Local</button>
  <p id="msgLocal"></p>
</div>

<div id="formularioTemporario" class="formulario">
  <input type="hidden" id="editRowTemporario">
  <input type="hidden" id="enlaceCompartirTemporario">
  <input type="hidden" id="existingVideosTemporario">
  <label>Dirección completa</label>
  <input type="text" id="direccionTemporario">
  <label>Imágenes</label>
  <input type="file" id="imagenFileTemporario" accept="image/*" multiple>
  <div id="previewContainerTemporario"></div>
  <label>Videos</label>
  <input type="file" id="videoFileTemporario" accept="video/*" multiple>
  <div id="videoPreviewContainerTemporario"></div>
  <label>Información de ingreso</label>
  <textarea id="infoIngresoTemporario" rows="3"></textarea>
  <label>Detalles</label>
  <textarea id="detallesTemporario" rows="4"></textarea>
  <button onclick="agregarAlquiler('Temporario')">Agregar Temporario</button>
  <p id="msgTemporario"></p>
</div>

<!-- MODAL ESTADÍSTICAS (FUNCIONANDO 100%) -->
<div id="modalEstadisticas">
  <div class="modal-content">
    <h3 id="modal-titulo-estadisticas">Estadísticas</h3>
    <div class="metricas-item">
      <span class="metricas-numero" id="modal-vistas">0</span>
      Vistas
    </div>
    <div class="metricas-item">
      <span class="metricas-numero" id="modal-contactos">0</span>
      Contactos
    </div>
    <button onclick="cerrarModalEstadisticas()" style="background:#ff9800; padding:15px 30px; font-size:1.5em;">Cerrar</button>
    <p id="msgEstadisticas" style="margin-top:15px; color:green;"></p>
  </div>
</div>

<button id="contactoBtn" onclick="window.open('https://wa.me/5493764275443', '_blank')">Ayuda</button>

<script>
// ======================= CONFIGURACIÓN =======================
const API_URL = "https://script.google.com/macros/s/AKfycby8Im_WuA2Gfkbc-wHQjL-KOTpl_LnGsgvbR-l1zF3KVYyLv5Qr25d7njUplky8CUWY/exec";

// ======================= ESTADÍSTICAS POR PROPIEDAD =======================
function solicitarMetricas(idPropiedad) {
  const callbackName = 'metricasCallback_' + Date.now();
  window[callbackName] = function(data) {
    let vistas = 0, contactos = 0;
    if (data && data.success && data.metricas) {
      vistas = data.metricas.vistas || 0;
      contactos = data.metricas.contactos || 0;
    }
    document.getElementById("modal-vistas").textContent = vistas;
    document.getElementById("modal-contactos").textContent = contactos;
    document.getElementById("modal-titulo-estadisticas").textContent = "Estadísticas ID: " + idPropiedad;
    document.getElementById("modalEstadisticas").style.display = "block";
    document.getElementById("msgEstadisticas").textContent = "Datos cargados";
    document.getElementById("msgEstadisticas").style.color = "green";

    // Limpieza
    delete window[callbackName];
    document.querySelectorAll('script').forEach(s => {
      if (s.src.includes(callbackName)) s.remove();
    });
  };

  const script = document.createElement("script");
  script.src = `${API_URL}?action=getmetricas&idPropiedad=${idPropiedad}&callback=${callbackName}`;
  document.body.appendChild(script);
}

function cerrarModalEstadisticas() {
  document.getElementById("modalEstadisticas").style.display = "none";
}

// ======================= MOSTRAR PROPIEDADES (con botón estadísticas) =======================
function mostrarAlquileres(res) {
  const div = document.getElementById("listaAlquileres");
  div.innerHTML = "";
  if (!res.success || !res.data || res.data.length === 0) {
    div.innerHTML = "<p>No tienes propiedades aún.</p>";
    return;
  }

  res.data.forEach(alq => {
    const btnEstadisticas = `<button class="stats-btn" onclick="solicitarMetricas('${alq.ID || alq.row}')">Estadísticas</button>`;
    const btnEditar = `<button onclick='editarAlquiler(${alq.row}, ${JSON.stringify(alq)})'>Editar</button>`;
    const btnEstado = `<button onclick="cambiarEstado(${alq.row}, '${alq.Estado}')">Cambiar Estado</button>`;
    const btnEliminar = `<button onclick="eliminarAlquiler(${alq.row})">Eliminar</button>`;

    div.innerHTML += `
      <div class="alquiler">
        <b>${alq.Direccion || 'Sin dirección'}</b> (${alq.Tipo})
        ${alq.Precio ? ' - $' + alq.Precio : ''}
        <br>Estado: <b>${alq.Estado}</b>
        <br>
        ${btnEstadisticas} ${btnEstado} ${btnEditar} ${btnEliminar}
      </div>`;
  });
}

// ======================= EL RESTO DE TU SCRIPT (todo igual que tenías) =======================
const CLOUDINARY_CLOUD_NAME = "dnugmwern";
const CLOUDINARY_API_KEY = "877726879255954";
const CLOUDINARY_API_SECRET = "t8CStqLDqd1hs3P9Hkr4lqicIQU";
const CLOUDINARY_UPLOAD_PRESET = "preset_alquileres";
const WEBHOOK_SECRET = "2a2b5b39aefa97460ab135de0ee6c2363bf7bfde8a9b621304751e5789bafa58";
const MUX_TOKEN_ID = 'TU_TOKEN_ID';
const MUX_TOKEN_SECRET = 'TU_TOKEN_SECRET';
const SPREADSHEET_ID = 'TU_SPREADSHEET_ID'; // ← Cambia por tu ID real si lo usas en algún lado

/* =========================== CORS & RESPUESTAS =============================== */
function handleResponse(output, callback = null) {
  let response;
  if (typeof output === 'string') {
    response = ContentService.createTextOutput(output);
  } else {
    response = ContentService.createTextOutput(JSON.stringify(output));
  }
  response.setMimeType(ContentService.MimeType.JSON);
  response.setHeaders({
    "Access-Control-Allow-Origin": "https://alquiya.com.ar",
    "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type, Authorization",
    "Access-Control-Max-Age": "3600"
  });
  if (callback) {
    const jsonp = `${callback}(${response.getContent()})`;
    return ContentService.createTextOutput(jsonp).setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  return response;
}

function doOptions() {
  return ContentService.createTextOutput("")
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeaders({
      "Access-Control-Allow-Origin": "https://alquiya.com.ar",
      "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type, Authorization"
    });
}

/* =========================== ENTRADAS ÚNICAS =============================== */
function doGet(e) {
  Logger.log("=== doGet INVOCADO ===");
  Logger.log("Parámetros: " + JSON.stringify(e.parameter));
  return processRequest(e);
}

function doPost(e) {
  Logger.log("=== doPost INVOCADO ===");
  Logger.log("Parámetros: " + JSON.stringify(e.parameter));
  return processRequest(e);
}

/* ============================== ROUTER PRINCIPAL ============================= */
function processRequest(e) {
  const params = e.parameter || {};
  const action = (params.action || "").toString().trim();
  const callback = params.callback;

  Logger.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");
  Logger.log("NUEVA PETICIÓN → " + new Date());
  Logger.log("Action original: '" + action + "'");
  Logger.log("Todos los params: " + JSON.stringify(params));

  const normalizedAction = action
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]/g, "");

  Logger.log("Action normalizada: '" + normalizedAction + "'");

  try {
    let result;

    /* =============== ESTADÍSTICAS POR PROPIEDAD (BOTÓN ESTADÍSTICAS) =============== */
    if ([
      'getvistasconsultas','getmetricas','getstatspropiedad','metricaspropiedad',
      'estadisticaspropiedad','getpropiedadstats','statspropiedad','vermetricas',
      'loadstats','getstats'
    ].includes(normalizedAction)) {
      Logger.log("✓ Acción reconocida → getMetricasPropiedad");
      result = getMetricasPropiedad(e);
    }

    /* =========================== OTRAS ACCIONES =============================== */
    else if (['estadisticas','getestadisticas','stats'].includes(normalizedAction)) {
      result = getEstadisticas(e);
    }
    else if (normalizedAction === 'incrementarmetrica') {
      result = incrementarMetrica(e);
    }
    else if (action === "getAlquileres") result = { success: true, data: getAlquileresActivos(e) };
    else if (action === "addAlquiler") result = addAlquiler(e);
    else if (action === "editAlquiler") result = editAlquiler(e);
    else if (action === "toggleEstado") result = toggleEstado(e);
    else if (action === "deleteAlquiler") result = deleteAlquiler(e);
    else if (action === "getAlquileresDueno") result = { success: true, data: getAlquileres(e) };
    else if (action === "getLoginInfo") result = getLoginInfo(e);
    else if (action === "verificarLogin") result = verificarLogin(e);
    else if (action === "getPlanes") result = getPlanes();
    else if (action === "editarDueno") result = editarDueno(e);
    else if (action === "updatePlan") result = updatePlan(e);
    else if (action === "actualizarFechaVencimiento") result = actualizarFechaVencimiento(e);
    else if (action === "getAlquiler") result = getAlquiler(e);
    else if (action === "getInmobiliaria") result = getInmobiliaria(e);
    else if (action === "getLogins") result = { success: true, data: getLogins() };
    else if (action === "registrarDueno") result = registerDueno(e);
    else if (action === "suscribirNotificaciones") result = suscribirNotificaciones(e);
    else if (action === "uploadVideoMux") result = uploadVideoMuxHandler(e);
    else if (action === "uploadImagesCloudinary") result = uploadImagesCloudinaryHandler(e);
    else if (params.type === "payment") result = handleMercadoPagoWebhook(e);
    else {
      Logger.log("✗ ACCIÓN NO RECONOCIDA → " + action);
      result = { success: false, error: "Acción no reconocida: " + action };
    }

    Logger.log("Respuesta final → " + JSON.stringify(result).substring(0, 1000));
    Logger.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n");
    return handleResponse(result, callback);

  } catch (err) {
    Logger.log("ERROR CRÍTICO → " + err.message + "\n" + err.stack);
    return handleResponse({ success: false, error: err.message }, callback);
  }
}

/* ====================== ESTADÍSTICAS POR PROPIEDAD (LA QUE FALLABA) ===================== */
function getMetricasPropiedad(e) {
  Logger.log("→ getMetricasPropiedad ejecutándose...");

  try {
    const idPropiedad = (e.parameter.id || e.parameter.idPropiedad || "").toString().trim();
    Logger.log("ID recibido: '" + idPropiedad + "'");

    if (!idPropiedad) {
      Logger.log("✗ Falta ID");
      return { success: false, error: "Falta ID de propiedad" };
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("Alquileres");
    if (!sheet) return { success: false, error: "Hoja Alquileres no existe" };

    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    Logger.log("Headers: " + JSON.stringify(headers));

    const idCol = headers.findIndex(h => h && String(h).toLowerCase().includes("id"));
    const vistasCol = headers.findIndex(h => h && String(h).toLowerCase().includes("vistas"));
    const contactosCol = headers.findIndex(h => h && (
      String(h).toLowerCase().includes("consultas") || 
      String(h).toLowerCase().includes("contactos")
    ));

    Logger.log(`Columnas → ID: ${idCol+1} | Vistas: ${vistasCol+1} | Contactos: ${contactosCol+1}`);

    if (idCol === -1 || vistasCol === -1 || contactosCol === -1) {
      return { success: false, error: "Faltan columnas ID/Vistas/Contactos" };
    }

    for (let i = 1; i < data.length; i++) {
      if (String(data[i][idCol]).trim() === idPropiedad) {
        const vistas = parseInt(data[i][vistasCol]) || 0;
        const contactos = parseInt(data[i][contactosCol]) || 0;

        Logger.log(`✓ Propiedad encontrada en fila ${i+1} → Vistas: ${vistas} | Contactos: ${contactos}`);

        return {
          success: true,
          propiedad: {
            direccion: data[i][2] || "Sin dirección",
            tipo: data[i][0] || "Sin tipo",
            precio: data[i][6] || 0,
            estado: data[i][9] || "Desconocido"
          },
          metricas: {
            vistas: vistas,
            contactos: contactos,
            tasaConversion: vistas > 0 ? ((contactos / vistas) * 100).toFixed(1) + "%" : "0%"
          }
        };
      }
    }

    Logger.log("✗ Propiedad NO encontrada con ID: " + idPropiedad);
    return { success: false, error: "Propiedad no encontrada" };

  } catch (err) {
    Logger.log("✗ Error en getMetricasPropiedad: " + err.toString());
    return { success: false, error: err.toString() };
  }
}

/* =============================== INCREMENTAR MÉTRICA =============================== */
function incrementarMetrica(e) {
  try {
    const idPropiedad = e.parameter.idPropiedad?.trim();
    const metrica = e.parameter.metrica?.trim().toLowerCase();
    if (!idPropiedad || !['vistas','contactos'].includes(metrica)) {
      return { success: false, error: "Parámetros inválidos" };
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("Alquileres");
    const headers = sheet.getRange(1,1,1,sheet.getMaxColumns()).getValues()[0];

    const idCol = headers.findIndex(h => h && String(h).toLowerCase().includes("id")) + 1;
    const metricCol = headers.findIndex(h => h && String(h).toLowerCase().includes(metrica === "contactos" ? "contactos" : "vistas")) + 1;

    const ids = sheet.getRange(2, idCol, sheet.getLastRow()-1, 1).getValues();
    let row = -1;
    for (let i = 0; i < ids.length; i++) {
      if (String(ids[i][0]).trim() === idPropiedad) {
        row = i + 2;
        break;
      }
    }
    if (row === -1) return { success: false, error: "ID no encontrado" };

    const cell = sheet.getRange(row, metricCol);
    const val = (parseInt(cell.getValue()) || 0) + 1;
    cell.setValue(val);
    SpreadsheetApp.flush();

    Logger.log(`✓ ${metrica} incrementada → ID ${idPropiedad} = ${val}`);
    return { success: true, nuevoValor: val };

  } catch (err) {
    Logger.log("Error incrementarMetrica: " + err.message);
    return { success: false, error: err.message };
  }
}

function getVistasConsultas(e) {
  const id = e.parameter.id || e.parameter.idPropiedad;
  if (!id) return { success: false, error: "Falta ID" };
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Alquileres");
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const idCol = headers.findIndex(h => h && String(h).toLowerCase().includes("id"));
  const vistasCol = headers.findIndex(h => h && String(h).toLowerCase().includes("vistas"));
  const consultasCol = headers.findIndex(h => h && (String(h).toLowerCase().includes("consultas") || String(h).toLowerCase().includes("contactos")));
  if (idCol < 0 || vistasCol < 0 || consultasCol < 0) return { success: false, error: "Columnas faltantes" };
  let vistas = 0, consultas = 0;
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][idCol]).trim() === String(id).trim()) {
      vistas += parseInt(data[i][vistasCol]) || 0;
      consultas += parseInt(data[i][consultasCol]) || 0;
    }
  }
  return { success: true, vistas, consultas };
}

function getEstadisticas(e) {
  const email = e.parameter.email;
  if (!email) return { success: false, error: "Email requerido" };

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const loginSheet = ss.getSheetByName("Login");
  const alquileresSheet = ss.getSheetByName("Alquileres");
  const loginData = loginSheet.getDataRange().getValues();
  const alquileresData = alquileresSheet.getDataRange().getValues();

  let dueño = null;
  for (let i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === email) {
      dueño = {
        nombre: loginData[i][3] || "",
        plan: loginData[i][5] || "Prueba",
        estadoPago: loginData[i][6] || "",
        vencimiento: loginData[i][7] ? new Date(loginData[i][7]) : null,
        pagos: loginData[i][8] || ""
      };
      break;
    }
  }
  if (!dueño) return { success: false, error: "Dueño no encontrado" };

  const stats = {
    totalPropiedades: 0,
    propiedadesActivas: 0,
    propiedadesInactivas: 0,
    porTipo: { Departamento: 0, Local: 0, Temporario: 0, Otros: 0 },
    porOperacion: { Alquilar: 0, Vender: 0 },
    porAmoblado: { Sí: 0, No: 0 },
    conMascotas: 0,
    sinMascotas: 0,
    promedioPrecio: 0,
    totalFotos: 0,
    propiedadesConVideo: 0,
    limiteDeptos: getPlanesDinamicos()[dueño.plan].limiteDeptos,
    limiteFotos: getPlanesDinamicos()[dueño.plan].limiteFotos,
    planInfo: getPlanesDinamicos()[dueño.plan],
    diasRestantes: dueño.vencimiento ? Math.max(0, Math.ceil((dueño.vencimiento - new Date()) / (1000 * 60 * 60 * 24))) : 0,
    planVigente: dueño.plan === "Prueba" || (dueño.vencimiento && dueño.vencimiento >= new Date()),
    totalVistas: 0,
    totalContactos: 0,
    metricasPorPropiedad: {}
  };

  const precios = [];
  let totalFotos = 0;

  for (let i = 1; i < alquileresData.length; i++) {
    if (alquileresData[i][1] === email) {
      stats.totalPropiedades++;
      const estado = alquileresData[i][9];
      const tipo = alquileresData[i][0] || "Otros";
      const operacion = alquileresData[i][17] || "Alquilar";
      const amoblado = alquileresData[i][16] || "No";
      const mascotas = alquileresData[i][12] || "No";
      const precio = parseFloat(alquileresData[i][6]) || 0;
      const fotos = (alquileresData[i][8] || "").split(",").filter(f => f.trim()).length;
      const videos = alquileresData[i][15] || "";
      const idPropiedad = alquileresData[i][13] || "";
      const vistas = parseInt(alquileresData[i][findCol(alquileresData[0], "vistas")]) || 0;
      const contactos = parseInt(alquileresData[i][findCol(alquileresData[0], "contactos")]) || 0;

      if (estado === "Activo") stats.propiedadesActivas++;
      else stats.propiedadesInactivas++;

      if (["Departamento", "Local", "Temporario"].includes(tipo)) stats.porTipo[tipo]++;
      else stats.porTipo.Otros++;

      if (["Alquilar", "Vender"].includes(operacion)) stats.porOperacion[operacion]++;

      stats.porAmoblado[amoblado === "Sí" ? "Sí" : "No"]++;
      if (mascotas === "Sí") stats.conMascotas++;
      else stats.sinMascotas++;

      if (precio > 0) precios.push(precio);
      totalFotos += fotos;
      stats.totalFotos += fotos;
      if (videos) stats.propiedadesConVideo++;

      stats.totalVistas += vistas;
      stats.totalContactos += contactos;
      stats.metricasPorPropiedad[idPropiedad] = { vistas, contactos };
    }
  }

  stats.promedioPrecio = precios.length > 0 ? Math.round(precios.reduce((a, b) => a + b, 0) / precios.length) : 0;

  return {
    success: true,
    data: {
      dueño,
      estadisticas: stats,
      mensaje: stats.planVigente
        ? `¡Tu plan está vigente! Te quedan ${stats.diasRestantes} días.`
        : "Tu plan está vencido. Renueva para mostrar tus propiedades."
    }
  };
}

function getEstadisticasPorFila(e) {
  try {
    const fila = parseInt(e.parameter.fila);
    const email = e.parameter.email;

    if (!fila || fila < 2) return { success: false, error: "Número de fila inválido" };
    if (!email) return { success: false, error: "Email requerido" };

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const alquileres = ss.getSheetByName("Alquileres");

    const emailFila = alquileres.getRange(fila, 2).getValue();
    if (emailFila !== email) return { success: false, error: "No autorizado" };

    const idPropiedad = alquileres.getRange(fila, 14).getValue();
    if (!idPropiedad) return { success: false, error: "ID no encontrado" };

    const propiedad = {
      tipo: alquileres.getRange(fila, 1).getValue(),
      direccion: alquileres.getRange(fila, 3).getValue(),
      precio: alquileres.getRange(fila, 7).getValue(),
      estado: alquileres.getRange(fila, 10).getValue(),
      operacion: alquileres.getRange(fila, 18).getValue() || "Alquilar",
      amoblado: alquileres.getRange(fila, 17).getValue() || "No",
      mascotas: alquileres.getRange(fila, 13).getValue() || "No",
      fotos: (alquileres.getRange(fila, 9).getValue() || "").split(",").filter(f => f.trim()).length
    };

    const vistas = parseInt(alquileres.getRange(fila, findCol(alquileres.getRange(1,1,1,alquileres.getMaxColumns()).getValues()[0], "vistas")).getValue()) || 0;
    const contactos = parseInt(alquileres.getRange(fila, findCol(alquileres.getRange(1,1,1,quileres.getMaxColumns()).getValues()[0], "contactos")).getValue()) || 0;

    const stats = {
      idPropiedad,
      propiedad,
      metricas: {
        vistas,
        contactos,
        tasaConversion: contactos > 0 ? ((contactos / vistas) * 100).toFixed(1) + "%" : "0%"
      },
      mensaje: `Estadísticas de "${propiedad.direccion}" cargadas correctamente`
    };

    return { success: true, data: stats };

  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

function findCol(headers, keyword) {
  return headers.findIndex(h => h && String(h).toLowerCase().includes(keyword.toLowerCase())) + 1;
}
function doGet(e) {
  const action = e.parameter.action;
  // ACCIÓN PARA BOTÓN ESTADÍSTICAS
  if (action === 'getEstadisticasPorFila') {
    return getEstadisticasPorFila(e);
  }
  // ... resto de tus funciones existentes
  var callback = e.parameter.callback || null;
  var res = {};
  try {
    if (action == "getAlquileres") {
      res = { success: true, data: getAlquileresActivos(e) };
    } else if (action == "addAlquiler") {
      res = addAlquiler(e);
    } else if (action == "editAlquiler") {
      res = editAlquiler(e);
    } else if (action == "toggleEstado") {
      res = toggleEstado(e);
    } else if (action == "deleteAlquiler") {
      res = deleteAlquiler(e);
    } else if (action == "getAlquileresDueno") {
      res = { success: true, data: getAlquileres(e) };
    } else if (action == "getLoginInfo") {
      res = getLoginInfo(e);
    } else if (action == "verificarLogin") {
      res = verificarLogin(e);
    } else if (action == "getPlanes") {
      res = getPlanes();
    } else if (action == "editarDueno") {
      res = editarDueno(e);
    } else if (action == "updatePlan") {
      res = updatePlan(e);
    } else if (action == "actualizarFechaVencimiento") {
      res = actualizarFechaVencimiento(e);
    } else if (action == "getAlquiler") {
      res = getAlquiler(e);
    } else if (action == "getInmobiliaria") {
      res = getInmobiliaria(e);
    } else if (action == "getLogins") {
      res = { success: true, data: getLogins() };
    } else if (action == "getEstadisticas") {
      res = getEstadisticas(e);
    } else if (action == "getEstadisticasPropiedad") {
      res = getEstadisticasPropiedad(e);
    } else if (action == "getEstadisticasPropiedadV2") {
      res = getEstadisticasPropiedadV2(e);
    } else {
      res = { success: false, error: "Acción no reconocida" };
    }
  } catch (err) {
    Logger.log("Error en doGet: " + err.message);
    res = { success: false, error: err.message };
  }
  var json = JSON.stringify(res);
  var output;
  if (callback) {
    output = ContentService.createTextOutput(callback + "(" + json + ");")
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  } else {
    output = ContentService.createTextOutput(json)
      .setMimeType(ContentService.MimeType.JSON);
  }
  return output;
}
/* --- Maneja OPTIONS (preflight de CORS) --- */
function doOptions(e) {
  return ContentService.createTextOutput("")
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeader("Access-Control-Allow-Origin", "https://alquiya.com.ar")
    .setHeader("Access-Control-Allow-Methods", "POST, GET, OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
}
/* --- Respuesta común con CORS habilitado --- */
function buildCorsResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "https://alquiya.com.ar")
    .setHeader("Access-Control-Allow-Methods", "POST, GET, OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
}
/* --- Manejo de solicitudes POST (Webhooks, FormData, and JSON) --- */
function doPost(e) {
  try {
    const params = e.parameter || JSON.parse(e.postData.contents || "{}");
    const action = params.action;
    // Configura las cabeceras CORS
    const headers = {
      'Access-Control-Allow-Origin': 'https://alquiya.com.ar',
      'Access-Control-Allow-Methods': 'POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
      'Access-Control-Max-Age': '86400'
    };
    // Maneja la solicitud preflight (OPTIONS)
    if (e.parameter.method === 'OPTIONS') {
      return ContentService.createTextOutput()
        .setContent(JSON.stringify({ success: true }))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeaders(headers);
    }
    // Maneja la acción registrarDueno
    if (action === "registrarDueno") {
      return registerDueno(e);
    }
    // Maneja la acción uploadVideoMux
    if (action === 'uploadVideoMux') {
      const base64Video = params.video;
      const row = params.row;
      // Extrae el contenido base64 (después de "data:video/mp4;base64,")
      const base64Content = base64Video.split(',')[1];
      const videoBlob = Utilities.newBlob(Utilities.base64Decode(base64Content), 'video/mp4', 'video.mp4');
      // Sube el video a Mux
      const muxResponse = uploadToMux(videoBlob);
      const videoUrl = muxResponse.data.playback_id[0].id
        ? `https://stream.mux.com/${muxResponse.data.playback_ids[0].id}.m3u8`
        : '';
      // Opcional: Guarda la URL en Google Sheets
      if (row && videoUrl) {
        const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('Alquileres');
        const currentVideos = sheet.getRange(parseInt(row), 16).getValue() || "";
        const updatedVideos = currentVideos ? `${currentVideos},${videoUrl}` : videoUrl;
        sheet.getRange(parseInt(row), 16).setValue(updatedVideos);
        SpreadsheetApp.flush();
      }
      // Respuesta con CORS
      return ContentService.createTextOutput()
        .setContent(JSON.stringify({ success: true, videoUrl: videoUrl }))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeaders(headers);
    }
    // Otras acciones existentes
    if (action === "suscribirNotificaciones") {
      var response = suscribirNotificaciones({
        parameter: {
          email: Array.isArray(params.email) ? params.email[0] : params.email
        }
      });
      return buildCorsResponse(response);
    }
    if (e.postData && e.postData.contents) {
      // Handle Mercado Pago webhook for payment events
      if (params.type === "payment" && params.data && params.data.id) {
        // Verify webhook signature
        var signature = e.parameter['x-signature'] || '';
        var requestId = e.parameter['x-request-id'] || '';
        var timestamp = signature.split(',')[0]?.split('ts=')[1] || '';
        var signatureHash = signature.split(',')[1]?.split('v1=')[1] || '';
        var expectedSignature = Utilities.computeHmacSha256Signature(
          timestamp + '.' + requestId + '.' + e.postData.contents,
          WEBHOOK_SECRET
        ).reduce(function(str, byte) {
          return str + ('0' + (byte & 0xFF).toString(16)).slice(-2);
        }, '');
        if (signatureHash !== expectedSignature) {
          Logger.log("Error en doPost: Firma de webhook inválida - " + signature);
          return buildCorsResponse({ success: false, error: "Firma de webhook inválida" });
        }
        var externalReference = params.data.external_reference || "";
        var [email, plan] = externalReference.split("_");
        if (!email || !plan) {
          Logger.log("Error en doPost: external_reference inválido - " + externalReference);
          return buildCorsResponse({ success: false, error: "external_reference inválido" });
        }
        var response = updatePlan({
          parameter: {
            payment_id: params.data.id,
            email: email,
            plan: plan,
            estadoPago: "Aprobado",
            descripcionPago: `Pago plan ${plan} - ID: ${params.data.id}`
          }
        });
        return buildCorsResponse(response);
      }
      // Subir imágenes Base64 a Cloudinary
      if (params.action === "uploadImagesCloudinary" && params.images) {
        const links = [];
        params.images.forEach((b64, i) => {
          try {
            const url = subirImagenCloudinary(b64);
            if (url) links.push(url);
          } catch (err) {
            Logger.log("Error subiendo a Cloudinary: " + err.message);
          }
        });
        if (params.row && links.length > 0) {
          const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
          sheet.getRange(parseInt(params.row), 9).setValue(links.join(","));
        }
        return buildCorsResponse({ success: true, links });
      }
    }
    return buildCorsResponse({ success: false, error: "Acción no reconocida" });
  } catch (err) {
    Logger.log("Error en doPost: " + err.message);
    return buildCorsResponse({ success: false, error: err.message });
  }
}
/* --- Registrar dueño --- */
function registerDueno(e) {
  var email = e.parameter.email;
  var password = e.parameter.password;
  var nombre = e.parameter.nombre;
  var contacto = e.parameter.contacto;
  if (!email || !password || !nombre || !contacto) {
    return { success: false, error: "Faltan datos requeridos" };
  }
  if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
    return { success: false, error: "El email no es válido" };
  }
  if (password.length < 6) {
    return { success: false, error: "La contraseña debe tener al menos 6 caracteres" };
  }
  if (!contacto.match(/^\+\d+$/)) {
    return { success: false, error: "El contacto debe empezar con '+' seguido de dígitos" };
  }
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) {
      return { success: false, error: "El email ya está registrado" };
    }
  }
  try {
    // Set trial plan and expiration date (7 days from now)
    var fechaNueva = new Date();
    fechaNueva.setDate(fechaNueva.getDate() + 7);
    var formattedDate = Utilities.formatDate(fechaNueva, Session.getScriptTimeZone(), "dd/MM/yyyy");
    // Columns: Tipo | Email | Password | Nombre | Contacto | Plan | EstadoPago | Vencimiento
    loginSheet.appendRow([
      "Dueño", email, password, nombre, contacto, "Prueba", "Activo", formattedDate
    ]);
    SpreadsheetApp.flush();
    return { success: true, message: "Dueño registrado correctamente con plan Prueba" };
  } catch (err) {
    return { success: false, error: "Error al guardar en la hoja: " + err.message };
  }
}
/* --- Subir imagen Base64 a Cloudinary --- */
function subirImagenCloudinary(base64Data) {
  const endpoint = "https://api.cloudinary.com/v1_1/" + CLOUDINARY_CLOUD_NAME + "/image/upload";
  const payload = {
    file: base64Data,
    upload_preset: CLOUDINARY_UPLOAD_PRESET
  };
  const options = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(payload)
  };
  const response = UrlFetchApp.fetch(endpoint, options);
  const data = JSON.parse(response.getContentText());
  return data.secure_url;
}
/* --- Subir video Base64 a Mux --- */
function uploadToMux(videoBlob) {
  const url = 'https://api.mux.com/video/v1/assets';
  const options = {
    method: 'POST',
    headers: {
      'Authorization': 'Basic ' + Utilities.base64Encode(MUX_TOKEN_ID + ':' + MUX_TOKEN_SECRET),
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify({
      input: [{
        url: 'data:video/mp4;base64,' + Utilities.base64Encode(videoBlob.getBytes()),
        type: 'video'
      }],
      playback_policy: ['public']
    })
  };
  return JSON.parse(UrlFetchApp.fetch(url, options).getContentText());
}
/* --- Obtener todos los alquileres activos (solo dueños con pago al día) --- */
function getAlquileresActivos(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var alquileres = [];
  // Verificar filtro de mascotas
  var filtroMascotas = e.parameter.mascotas === "true";
  for (var i = 1; i < data.length; i++) {
    var tipo = data[i][0];
    var estado = data[i][9];
    var lat = data[i][3];
    var lng = data[i][4];
    var email = data[i][1];
    var mascotas = data[i][12]; // Columna M: Mascotas
    var pagoAlDia = loginData.find(row => row[1] === email && (new Date(row[7]) >= new Date() || row[5] === "Prueba"));
    if (estado === "Activo" && lat && lng && pagoAlDia) {
      if (filtroMascotas && mascotas !== "Sí") continue; // Saltar si el filtro de mascotas está activo y no es "Sí"
      var obj = {};
      for (var j = 0; j < headers.length; j++) obj[headers[j]] = data[i][j];
      obj["Contacto"] = data[i][7] || "";
      obj["ID"] = data[i][13] || "";
      obj["Enlace para compartir"] = data[i][14] || "";
      obj["Videos"] = data[i][15] || "";
      obj["Amoblado"] = data[i][16] || "";
      obj["Operacion"] = data[i][17] || ""; // Columna R: Operacion
      // Añadir Plan y Fecha de Vencimiento desde loginData
      var loginRow = loginData.find(row => row[1] === email);
      obj["Plan"] = loginRow ? loginRow[5] || "" : "";
      obj["Fecha de Vencimiento"] = loginRow && loginRow[7] ? Utilities.formatDate(new Date(loginRow[7]), Session.getScriptTimeZone(), "dd/MM/yyyy") : "";
      obj.row = i + 1;
      alquileres.push(obj);
    }
  }
  return alquileres;
}
/* --- Obtener alquileres de un dueño específico --- */
function getAlquileres(e) {
  var email = e.parameter.dueno;
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var alquileres = [];
  for (var i = 1; i < data.length; i++) {
    var correo = data[i][1];
    if (correo === email) {
      var obj = {};
      for (var j = 0; j < headers.length; j++) obj[headers[j]] = data[i][j];
      obj["Contacto"] = data[i][7] || "";
      obj["ID"] = data[i][13] || "";
      obj["Enlace para compartir"] = data[i][14] || "";
      obj["Videos"] = data[i][15] || "";
      obj["Amoblado"] = data[i][16] || "";
      obj["Operacion"] = data[i][17] || ""; // Columna R: Operacion
      obj.row = i + 1;
      alquileres.push(obj);
    }
  }
  return alquileres;
}
/* --- Obtener detalles de una inmobiliaria y sus alquileres --- */
function getInmobiliaria(e) {
  var inmobiliariaEmail = e.parameter.email;
  if (!inmobiliariaEmail) {
    Logger.log("Error en getInmobiliaria: Email no proporcionado");
    return { success: false, error: "Email de inmobiliaria no proporcionado" };
  }
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var alquileresSheet = ss.getSheetByName("Alquileres");
  var alquileresData = alquileresSheet.getDataRange().getValues();
  var headers = alquileresData[0];
  var alquileres = [];
  var inmoData = {};
  // Buscar metadata de la inmobiliaria en la hoja Login
  for (var i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === inmobiliariaEmail) { // Columna B (índice 1): Email
      inmoData = {
        Email: loginData[i][1] || "",
        Nombre: loginData[i][3] || "", // Columna D (índice 3): Nombre
        Contacto: loginData[i][4] || "",
        Plan: loginData[i][5] || "",
        EstadoPago: loginData[i][6] || "",
        Vencimiento: loginData[i][7]
          ? Utilities.formatDate(new Date(loginData[i][7]), Session.getScriptTimeZone(), "yyyy-MM-dd")
          : "",
        Inmobiliaria: loginData[i][9] || ""
      };
      break;
    }
  }
  // Si no se encontró la inmobiliaria, devolver error
  if (!inmoData.Email) {
    Logger.log("Error en getInmobiliaria: Inmobiliaria no encontrada para el email: " + inmobiliariaEmail);
    return { success: false, error: "Inmobiliaria no encontrada para el email proporcionado" };
  }
  // Obtener alquileres asociados al email en columna B de Alquileres
  for (var i = 1; i < alquileresData.length; i++) {
    var tipo = alquileresData[i][0];
    var email = alquileresData[i][1];
    var estado = alquileresData[i][9];
    var lat = alquileresData[i][3];
    var lng = alquileresData[i][4];
    if (email === inmobiliariaEmail && estado === "Activo" && lat && lng) {
      var obj = {};
      for (var j = 0; j < headers.length; j++) obj[headers[j]] = alquileresData[i][j];
      obj["Contacto"] = alquileresData[i][7] || "";
      obj["ID"] = alquileresData[i][13] || "";
      obj["Enlace para compartir"] = alquileresData[i][14] || "";
      obj["Videos"] = alquileresData[i][15] || "";
      obj["Amoblado"] = alquileresData[i][16] || "";
      obj["Operacion"] = alquileresData[i][17] || ""; // Columna R: Operacion
      obj.row = i + 1;
      alquileres.push(obj);
    }
  }
  // Si no se encontraron alquileres, devolver mensaje apropiado
  if (alquileres.length === 0) {
    Logger.log("No se encontraron alquileres activos para el email: " + inmobiliariaEmail);
    return { success: true, data: inmoData, alquileres: [], message: "No se encontraron propiedades activas para este email" };
  }
  Logger.log("Inmobiliaria encontrada: " + (inmoData.Nombre || inmobiliariaEmail) + ", " + alquileres.length + " alquileres activos");
  return { success: true, data: inmoData, alquileres: alquileres };
}
/* --- Obtener detalles de un alquiler por ID --- */
function getAlquiler(e) {
  var id = e.parameter.id;
  if (!id) return { success: false, error: "ID de alquiler no proporcionado" };
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  for (var i = 1; i < data.length; i++) {
    if (data[i][13] === id) { // Columna N (14ª columna, índice 13): ID
      var email = data[i][1];
      var pagoAlDia = loginData.find(row => row[1] === email && (new Date(row[7]) >= new Date() || row[5] === "Prueba"));
      if (data[i][9] === "Activo" && pagoAlDia) {
        var obj = {
          alquiler: {
            Tipo: data[i][0],
            Direccion: data[i][2],
            Lat: data[i][3],
            Lng: data[i][4],
            "Nro Ambientes": data[i][5],
            Precio: data[i][6],
            Contacto: data[i][7] || "",
            Fotos: data[i][8] || "",
            Estado: data[i][9],
            "Informacion ingreso": data[i][10],
            Detalles: data[i][11],
            Mascotas: data[i][12],
            ID: data[i][13],
            "Enlace para compartir": data[i][14],
            Videos: data[i][15],
            Amoblado: data[i][16] || "",
            Operacion: data[i][17] || "" // Columna R: Operacion
          }
        };
        return { success: true, alquiler: obj.alquiler };
      } else {
        return { success: false, error: "Alquiler no está activo o el dueño no tiene un plan válido" };
      }
    }
  }
  return { success: false, error: "Alquiler no encontrado" };
}
/* --- Validar límite de deptos (solo activos) --- */
function validarLimiteDeptos(email) {
  const loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  const loginData = loginSheet.getDataRange().getValues();
  const dueño = loginData.find(row => row[1] === email);
  if (!dueño) throw "Dueño no encontrado";
  const plan = dueño[5] || "Basico";
  const planes = getPlanesDinamicos();
  const limite = planes[plan].limiteDeptos;
  if (limite === Infinity) return; // Sin límite para el plan Prueba
  const alquileresSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  const cantidadDeptos = alquileresSheet.getDataRange().getValues()
    .filter(r => r[1] === email && r[9] === "Activo").length;
  if (cantidadDeptos >= limite) {
    throw `Tu plan actual (${plan}) solo permite ${limite} deptos. Mejora tu plan para agregar más.`;
  }
}
/* --- Validar vencimiento --- */
function validarVencimiento(email) {
  const loginSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Login");
  const loginData = loginSheet.getDataRange().getValues();
  const dueño = loginData.find(row => row[1] === email);
  if (!dueño) throw "Dueño no encontrado";
  const plan = dueño[5] || "Basico";
  if (plan === "Prueba") return true; // El plan Prueba no requiere validación de pago
  const fechaVencimiento = dueño[7];
  if (!fechaVencimiento) return true;
  if (new Date() > new Date(fechaVencimiento)) throw "Tu plan está vencido. Debes renovar para poder agregar o mostrar tus deptos en el mapa.";
  return true;
}
/* --- Generar ID único --- */
function generarIdUnico() {
  return Utilities.getUuid();
}
/* --- Agregar nuevo alquiler (validando plan y vencimiento) --- */
function addAlquiler(e) {
  var email = e.parameter.dueno;
  var tipo = e.parameter.tipo; // Obtener el tipo de propiedad (e.g., Departamento, Local, Temporario)
  var operacion = e.parameter.operacion || ""; // Obtener la operación (Vender o Alquilar)
  // Validar que el tipo de propiedad sea proporcionado
  if (!tipo) {
    Logger.log("Error en addAlquiler: Tipo de propiedad no proporcionado");
    return { success: false, error: "Tipo de propiedad no proporcionado" };
  }
  // Validar que la operación sea proporcionada y válida
  if (!operacion || !["Vender", "Alquilar"].includes(operacion)) {
    Logger.log("Error en addAlquiler: Operación no proporcionada o inválida - " + operacion);
    return { success: false, error: "Operación debe ser 'Vender' o 'Alquilar'" };
  }
  // Validar plan y vencimiento
  try {
    validarLimiteDeptos(email);
    validarVencimiento(email);
  } catch (err) {
    Logger.log("Error en addAlquiler: " + err);
    return { success: false, error: err };
  }
  // Obtener parámetros
  var direccion = e.parameter.direccion || "";
  var ambientes = e.parameter.ambientes || "";
  var precio = e.parameter.precio || "";
  var mascotas = e.parameter.mASCOTAS || "";
  var amoblado = e.parameter.amoblado || "";
  var fotos = e.parameter.fotos || "";
  var videos = e.parameter.videos || "";
  var infoIngreso = e.parameter.infoIngreso || "";
  var detalles = e.parameter.detalles || "";
  var lat = e.parameter.lat || "";
  var lng = e.parameter.lng || "";
  var estado = e.parameter.estado || "Activo";
  var idUnico = generarIdUnico();
  var enlace = `www.alquiya.com.ar/alquiler.html?id=${idUnico}`;
  // Obtener contacto del dueño desde la hoja Login
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var contacto = "auto";
  for (var i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === email) {
      contacto = loginData[i][4] || "auto";
      break;
    }
  }
  // Validar campos obligatorios según el tipo
  if (!direccion || (tipo === "Departamento" && (!ambientes || !precio))) {
    Logger.log("Error en addAlquiler: Faltan campos obligatorios");
    return { success: false, error: "Faltan campos obligatorios" };
  }
  // Guardar en la hoja Alquileres
  var alquileresSheet = ss.getSheetByName("Alquileres");
  alquileresSheet.appendRow([
    tipo, // Columna A: Tipo
    email, // Columna B: Email
    direccion, // Columna C: Direccion
    lat, // Columna D: Latitud
    lng, // Columna E: Longitud
    ambientes, // Columna F: Nro Ambientes
    precio, // Columna G: Precio
    contacto, // Columna H: Contacto
    fotos, // Columna I: Fotos
    estado, // Columna J: Estado
    infoIngreso, // Columna K: Informacion ingreso
    detalles, // Columna L: Detalles
    mascotas, // Columna M: Mascotas
    idUnico, // Columna N: ID
    enlace, // Columna O: Enlace para compartir
    videos, // Columna P: Video
    amoblado, // Columna Q: Amoblado
    operacion // Columna R: Operacion
  ]);
  SpreadsheetApp.flush(); // Forzar sincronización
  Logger.log("Alquiler agregado: ID " + idUnico + ", Tipo: " + tipo + ", Operacion: " + operacion);
  return { success: true, id: idUnico, enlace: enlace };
}
/* --- Editar alquiler existente --- */
function editAlquiler(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) {
    Logger.log("Error en editAlquiler: Fila inválida - " + row);
    return { success: false, error: "Fila inválida" };
  }
  var email = e.parameter.dueno;
  var tipo = e.parameter.tipo; // Obtener el tipo de propiedad
  var operacion = e.parameter.operacion; // Obtener la operación
  var estado = e.parameter.estado || "Activo";
  // Validar que la operación sea válida si se proporciona
  if (operacion && !["Vender", "Alquilar"].includes(operacion)) {
    Logger.log("Error en editAlquiler: Operación inválida - " + operacion);
    return { success: false, error: "Operación debe ser 'Vender' o 'Alquilar'" };
  }
  // Validar plan y vencimiento si el estado es Activo
  if (estado === "Activo") {
    try {
      validarLimiteDeptos(email);
      validarVencimiento(email);
    } catch (err) {
      Logger.log("Error en editAlquiler: " + err);
      return { success: false, error: err };
    }
  }
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var currentId = sheet.getRange(row, 14).getValue(); // Columna N: ID
  var idUnico = e.parameter.idUnico || currentId; // Preservar ID existente a menos que se proporcione uno nuevo
  var enlace = `www.alquiya.com.ar/alquiler.html?id=${idUnico}`; // Actualizar enlace
  // Validar campos obligatorios si se actualiza el tipo a Departamento
  if (tipo === "Departamento") {
    var ambientes = e.parameter.ambientes || sheet.getRange(row, 6).getValue();
    var precio = e.parameter.precio || sheet.getRange(row, 7).getValue();
    if (!ambientes || !precio) {
      Logger.log("Error en editAlquiler: Faltan campos obligatorios para Departamento");
      return { success: false, error: "Faltan campos obligatorios para Departamento" };
    }
  }
  // Actualizar solo los campos proporcionados
  if (tipo) sheet.getRange(row, 1).setValue(tipo); // Columna A: Tipo
  if (e.parameter.direccion) sheet.getRange(row, 3).setValue(e.parameter.direccion); // Columna C: Direccion
  if (e.parameter.lat) sheet.getRange(row, 4).setValue(e.parameter.lat); // Columna D: Latitud
  if (e.parameter.lng) sheet.getRange(row, 5).setValue(e.parameter.lng); // Columna E: Longitud
  if (e.parameter.ambientes) sheet.getRange(row, 6).setValue(e.parameter.ambientes); // Columna F: Nro Ambientes
  if (e.parameter.precio) sheet.getRange(row, 7).setValue(e.parameter.precio); // Columna G: Precio
  if (e.parameter.contacto) sheet.getRange(row, 8).setValue(e.parameter.contacto); // Columna H: Contacto
  if (e.parameter.fotos) sheet.getRange(row, 9).setValue(e.parameter.fotos); // Columna I: Fotos
  if (e.parameter.estado) sheet.getRange(row, 10).setValue(e.parameter.estado); // Columna J: Estado
  if (e.parameter.infoIngreso) sheet.getRange(row, 11).setValue(e.parameter.infoIngreso); // Columna K: Informacion ingreso
  if (e.parameter.detalles) sheet.getRange(row, 12).setValue(e.parameter.detalles); // Columna L: Detalles
  if (e.parameter.mascotas) sheet.getRange(row, 13).setValue(e.parameter.mascotas); // Columna M: Mascotas
  if (e.parameter.idUnico) sheet.getRange(row, 14).setValue(e.parameter.idUnico); // Columna N: ID
  sheet.getRange(row, 15).setValue(enlace); // Columna O: Enlace para compartir
  if (e.parameter.videos) sheet.getRange(row, 16).setValue(e.parameter.videos); // Columna P: Video
  if (e.parameter.amoblado) sheet.getRange(row, 17).setValue(e.parameter.amoblado); // Columna Q: Amoblado
  if (operacion) sheet.getRange(row, 18).setValue(operacion); // Columna R: Operacion
  SpreadsheetApp.flush(); // Forzar sincronización
  Logger.log("Alquiler editado: Fila " + row + ", ID: " + idUnico + ", Operacion: " + operacion);
  return { success: true, id: idUnico, enlace: enlace };
}
/* --- Cambiar estado Activo/Inactivo --- */
function toggleEstado(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) return { success: false, error: "Fila inválida" };
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  var email = sheet.getRange(row, 2).getValue();
  var estado = sheet.getRange(row, 10).getValue();
  var nuevoEstado = estado === "Activo" ? "Inactivo" : "Activo";
  if (nuevoEstado === "Activo") {
    validarLimiteDeptos(email);
    validarVencimiento(email);
  }
  sheet.getRange(row, 10).setValue(nuevoEstado);
  SpreadsheetApp.flush(); // Forzar sincronización
  return { success: true, nuevoEstado: nuevoEstado };
}
/* --- Eliminar alquiler --- */
function deleteAlquiler(e) {
  var row = parseInt(e.parameter.row);
  if (!row || row < 2) return { success: false, error: "Fila inválida" };
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Alquileres");
  sheet.deleteRow(row);
  SpreadsheetApp.flush(); // Forzar sincronización
  return { success: true };
}
/* --- Verificar login --- */
function verificarLogin(e) {
  var email = e.parameter.email;
  var password = e.parameter.password;
  if (!email || !password)
    return { success: false, error: "Faltan credenciales" };
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    var fila = data[i];
    var tipo = fila[0];
    var correo = fila[1];
    var pass = fila[2];
    if (tipo === "Dueño" && correo === email) {
      if (String(pass) == String(password)) {
        return {
          success: true,
          tipo: tipo,
          email: correo,
          nombre: fila[3] || "",
          contacto: fila[4] || "",
          plan: fila[5] || "",
          estadoPago: fila[6] || "",
          vencimiento: fila[7]
            ? Utilities.formatDate(new Date(fila[7]), Session.getScriptTimeZone(), "yyyy-MM-dd")
            : ""
        };
      } else {
        return { success: false, error: "Contraseña incorrecta" };
      }
    }
  }
  return { success: false, error: "Usuario no registrado" };
}
/* --- Editar información del dueño --- */
function editarDueno(e) {
  var email = e.parameter.email;
  var newEmail = e.parameter.newEmail;
  var nombre = e.parameter.nombre;
  var contacto = e.parameter.contacto;
  var password = e.parameter.password;
  if (!email) {
    Logger.log("Error en editarDueno: Email no proporcionado");
    return { success: false, error: "Email no proporcionado" };
  }
  if (!newEmail && !nombre && !contacto && !password) {
    Logger.log("Error en editarDueno: No se proporcionaron datos para actualizar");
    return { success: false, error: "No se proporcionaron datos para actualizar" };
  }
  if (newEmail && !newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
    Logger.log("Error en editarDueno: Nuevo email inválido - " + newEmail);
    return { success: false, error: "El nuevo email no es válido" };
  }
  if (password && password.length < 6) {
    Logger.log("Error en editarDueno: Contraseña demasiado corta - " + password);
    return { success: false, error: "La contraseña debe tener al menos 6 caracteres" };
  }
  if (contacto && !contacto.match(/^\+\d+$/)) {
    Logger.log("Error en editarDueno: Contacto inválido - " + contacto);
    return { success: false, error: "El contacto debe empezar con '+' seguido de dígitos" };
  }
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();
  // Verificar si el nuevo email ya existe (si se proporciona)
  if (newEmail && newEmail !== email) {
    for (var i = 1; i < data.length; i++) {
      if (data[i][1] === newEmail) {
        Logger.log("Error en editarDueno: Nuevo email ya registrado - " + newEmail);
        return { success: false, error: "El nuevo email ya está registrado" };
      }
    }
  }
  // Actualizar información del dueño
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) {
      if (newEmail) loginSheet.getRange(i + 1, 2).setValue(newEmail);
      if (nombre) loginSheet.getRange(i + 1, 4).setValue(nombre);
      if (contacto) loginSheet.getRange(i + 1, 5).setValue(contacto);
      if (password) loginSheet.getRange(i + 1, 3).setValue(password);
      SpreadsheetApp.flush(); // Forzar sincronización
      Logger.log("Dueño actualizado correctamente: " + email);
      return { success: true, message: "Datos actualizados correctamente" };
    }
  }
  Logger.log("Error en editarDueno: Dueño no encontrado - " + email);
  return { success: false, error: "Dueño no encontrado" };
}
/* --- Actualizar fecha de vencimiento --- */
function actualizarFechaVencimiento(e) {
  var email = e.parameter.email;
  var dias = parseInt(e.parameter.dias) || 30; // Por defecto 30 días si no se especifica
  if (!email) {
    Logger.log("Error en actualizarFechaVencimiento: Email no proporcionado");
    return { success: false, error: "Email no proporcionado" };
  }
  if (isNaN(dias) || dias < 1) {
    Logger.log("Error en actualizarFechaVencimiento: Días inválidos - " + dias);
    return { success: false, error: "El número de días debe ser un número positivo" };
  }
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var data = loginSheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === email) {
      var fechaNueva = new Date();
      fechaNueva.setDate(fechaNueva.getDate() + dias);
      var formattedDate = Utilities.formatDate(fechaNueva, Session.getScriptTimeZone(), "dd/MM/yyyy");
      loginSheet.getRange(i + 1, 8).setValue(formattedDate); // Columna H: Fecha Vencimiento
      SpreadsheetApp.flush(); // Forzar sincronización
      Logger.log("Fecha de vencimiento actualizada para " + email + ": " + formattedDate);
      return {
        success: true,
        message: "Fecha de vencimiento actualizada correctamente",
        email: email,
        fechaVencimiento: formattedDate
      };
    }
  }
  Logger.log("Error en actualizarFechaVencimiento: Dueño no encontrado - " + email);
  return { success: false, error: "Dueño no encontrado" };
}
/* --- Actualizar plan tras pago de Mercado Pago --- */
function updatePlan(e, retries = 3) {
  var email = e.parameter.email || null;
  var plan = e.parameter.plan || null;
  var paymentId = e.parameter.payment_id || (e.parameter.data && e.parameter.data.id) || null;
  var estadoPago = e.parameter.estadoPago || "Aprobado";
  var descripcionPago = e.parameter.descripcionPago || null;
  // Validar parámetros de entrada
  if (!paymentId) {
    Logger.log("Error en updatePlan: Faltan parámetros - payment_id: " + paymentId);
    return { success: false, error: "Falta el payment_id" };
  }
  if (!email || !plan) {
    Logger.log("Error en updatePlan: email o plan faltantes - email: " + email + ", plan: " + plan);
    return { success: false, error: "Faltan parámetros email o plan" };
  }
  // Verificar el pago con Mercado Pago
  var mpAccessToken = "APP_USR-595288641172928-010710-d915bce4137b3ee26e0c6e04873f1ac1-695835795";
  var url = "https://api.mercadopago.com/v1/payments/" + encodeURIComponent(paymentId);
  var options = {
    method: "get",
    headers: { "Authorization": "Bearer " + mpAccessToken },
    muteHttpExceptions: true
  };
  try {
    var response = UrlFetchApp.fetch(url, options);
    var paymentData = JSON.parse(response.getContentText());
    // Verificar si el pago está aprobado
    if (response.getResponseCode() === 200 && paymentData.status === "approved") {
      // Extraer email y plan de external_reference si no se proporcionan
      var externalReference = paymentData.external_reference || "";
      if (externalReference && (!email || !plan)) {
        var [refEmail, refPlan] = externalReference.split("_");
        email = email || refEmail;
        plan = plan || refPlan;
      }
      // Validar email y plan
      if (!email || !plan) {
        Logger.log("Error en updatePlan: email o plan faltantes después de external_reference - email: " + email + ", plan: " + plan);
        return { success: false, error: "Faltan parámetros email o plan" };
      }
      if (externalReference && externalReference !== email + "_" + plan) {
        Logger.log("Error en updatePlan: external_reference no coincide - " + externalReference);
        return { success: false, error: "El external_reference no coincide con los parámetros proporcionados" };
      }
      // Validar plan contra getPlanesDinamicos
      var planesValidos = Object.keys(getPlanesDinamicos());
      if (!planesValidos.includes(plan)) {
        Logger.log("Error en updatePlan: Plan inválido - " + plan);
        return { success: false, error: "Plan inválido: debe ser Prueba, Basico, Plus o Full" };
      }
      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var loginSheet = ss.getSheetByName("Login");
      var data = loginSheet.getDataRange().getValues();
      // Verificar si el payment ID ya fue procesado para evitar actualizaciones múltiples
      for (var i = 1; i < data.length; i++) {
        if (data[i][8] && data[i][8].includes(paymentId)) {
          Logger.log("Error en updatePlan: Pago ya procesado - Payment ID: " + paymentId);
          return { success: false, error: "El pago ya fue procesado" };
        }
      }
      // Encontrar la fila del dueño
      for (var i = 1; i < data.length; i++) {
        if (data[i][1] === email) {
          // Calcular fecha de vencimiento: un mes desde la fecha de aprobación del pago
          var fechaAprobacion = new Date(paymentData.case_approved);
          var fechaNueva = new Date(fechaAprobacion.setMonth(fechaAprobacion.getMonth() + 1));
          var formattedDate = Utilities.formatDate(fechaNueva, Session.getScriptTimeZone(), "dd/MM/yyyy");
          // Usar la descripción de pago proporcionada o predeterminada
          var descPago = descripcionPago || `Pago plan ${plan} - ID: ${paymentId}`;
          // Actualizar plan, estado de pago, fecha de vencimiento y descripción
          loginSheet.getRange(i + 1, 6).setValue(plan); // Columna F: Plan
          loginSheet.getRange(i + 1, 7).setValue(estadoPago); // Columna G: Estado del Pago
          loginSheet.getRange(i + 1, 8).setValue(formattedDate); // Columna H: Fecha Vencimiento
          loginSheet.getRange(i + 1, 9).setValue(descPago); // Columna I: Descripción del Pago
          SpreadsheetApp.flush(); // Forzar sincronización
          // Enviar email de notificación al dueño
          var nombre = data[i][3] || "Usuario";
          var message = `Hola ${nombre},\n\nTu pago para el Plan ${plan} ha sido procesado correctamente.\nTu plan estará activo hasta el ${formattedDate}.\n\nGracias por tu suscripción.\n\nSaludos,\nEquipo Alqui Ya`;
          try {
            MailApp.sendEmail(email, "Confirmación de Pago - Alqui Ya", message);
          } catch (emailErr) {
            Logger.log("Error al enviar email de confirmación: " + emailErr.message);
          }
          Logger.log("Plan actualizado para " + email + ": " + plan + ", Payment ID: " + paymentId);
          return {
            success: true,
            message: "Plan actualizado correctamente",
            plan: plan,
            email: email,
            estadoPago: estadoPago,
            fechaVencimiento: formattedDate,
            descripcionPago: descPago
          };
        }
      }
      Logger.log("Error en updatePlan: Dueño no encontrado - " + email);
      return { success: false, error: "Dueño no encontrado" };
    } else {
      Logger.log("Error en updatePlan: Pago no aprobado - Status: " + (paymentData.status || "Desconocido") + ", Response Code: " + response.getResponseCode());
      if (retries > 0) {
        Logger.log(`Reintentando updatePlan (${retries} restantes)...`);
        Utilities.sleep(2000); // Esperar 2 segundos antes de reintentar
        return updatePlan(e, retries - 1);
      }
      return { success: false, error: "El pago no fue aprobado o no se encontró" };
    }
  } catch (err) {
    Logger.log("Error en updatePlan: " + err.message);
    if (retries > 0) {
      Logger.log(`Reintentando updatePlan (${retries} restantes)...`);
      Utilities.sleep(2000); // Esperar 2 segundos antes de reintentar
      return updatePlan(e, retries - 1);
    }
    return { success: false, error: "Error al verificar el pago: " + err.message };
  }
}
/* --- Obtener información de login --- */
function getLoginInfo(e) {
  var email = e.parameter.email;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var loginSheet = ss.getSheetByName("Login");
  var loginData = loginSheet.getDataRange().getValues();
  var result = [];
  for (var i = 1; i < loginData.length; i++) {
    if (loginData[i][1] === email) {
      result.push({
        Email: loginData[i][1],
        Nombre: loginData[i][3] || "",
        Contacto: loginData[i][4] || "",
        Plan: loginData[i][5] || "",
        EstadoPago: loginData[i][6] || "",
        Vencimiento: loginData[i][7]
          ? Utilities.formatDate(new Date(loginData[i][7]), Session.getScriptTimeZone(), "yyyy-MM-dd")
          : "",
        Password: loginData[i][2] || ""
      });
    }
  }
  if (result.length === 0) {
    Logger.log("Error en getLoginInfo: Dueño no encontrado - " + email);
    return { success: false, error: "Dueño no encontrado" };
  }
  return { success: true, data: result };
}
/* --- Suscribir email para notificaciones --- */
function suscribirNotificaciones(e) {
  var email = e.parameter.email;
  if (!email) {
    Logger.log("Error en suscribirNotificaciones: Email no proporcionado");
    return { success: false, error: "Email no proporcionado" };
  }
  if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
    Logger.log("Error en suscribirNotificaciones: Email inválido - " + email);
    return { success: false, error: "El email no es válido" };
  }
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var usuariosSheet = ss.getSheetByName("Usuarios");
  if (!usuariosSheet) {
    Logger.log("Error en suscribirNotificaciones: Hoja 'Usuarios' no encontrada");
    return { success: false, error: "Hoja 'Usuarios' no encontrada" };
  }
  var data = usuariosSheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === email) {
      Logger.log("Error en suscribirNotificaciones: Email ya registrado - " + email);
      return { success: false, error: "El email ya está registrado" };
    }
  }
  try {
    usuariosSheet.appendRow([email]);
    SpreadsheetApp.flush(); // Forzar sincronización
    Logger.log("Email registrado para notificaciones: " + email);
    return { success: true, message: "Email registrado correctamente para notificaciones" };
  } catch (err) {
    Logger.log("Error en suscribirNotificaciones: Error al guardar en la hoja - " + err.message);
    return { success: false, error: "Error al guardar en la hoja: " + err.message };
  }
}
/* --- Trigger diario para notificaciones --- */
function enviarNotificaciones() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const loginSheet = ss.getSheetByName("Login");
  const data = loginSheet.getDataRange().getValues();
  const hoy = new Date();
  for (var i = 1; i < data.length; i++) {
    const email = data[i][1];
    const nombre = data[i][3];
    const plan = data[i][5];
    const fechaVencimiento = new Date(data[i][7]);
    const diffDias = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));
    if (diffDias === 5) {
      MailApp.sendEmail(email, "Tu plan vence en 5 días", `Hola ${nombre}, tu plan ${plan} vence en 5 días. Renueva para no perder servicios.`);
    }
    if (diffDias <= 0 && plan !== "530") {
      MailApp.sendEmail(email, "Plan vencido", `Hola ${nombre}, tu plan ${plan} está vencido. Renueva para seguir mostrando tus deptos.`);
      loginSheet.getRange(i + 1, 7).setValue("Pago vencido");
      SpreadsheetApp.flush(); // Forzar sincronización
    }
  }
}
/* ===================================
   === BACKUP & FALLBACK (onEdit) ===
   =================================== */
function onEdit(e) {
  const sheet = e.range.getSheet();
  if (sheet.getName() !== "Alquileres") return;
  const value = String(e.value || "").trim();
  const a1 = e.range.getA1Notation();
  const patterns = [/habilitar.*edici.n/i, /enable.*editing/i, /click.*to.*enable/i];
  if (patterns.some(p => p.test(value)) || (["A1","A2","B1"].includes(a1) && value !== getExpectedHeader(a1))) {
    restoreFromBackup();
    notifyUserFallbackFixed();
  }
}
function getExpectedHeader(a1) {
  const map = { "A1": "ID", "A2": "Dirección", "B1": "Vistas" };
  return map[a1] || "";
}
function restoreFromBackup() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Alquileres");
  let backup = ss.getSheetByName("Backup_Alquileres");
  if (!backup) backup = createBackupSheet();
  const range = sheet.getRange("A1:Z1000");
  const values = backup.getRange("A1:Z1000").getValues();
  const bg = backup.getRange("A1:Z1000").getBackgrounds();
  const font = backup.getRange("A1:Z1000").getFontWeights();
  const formats = backup.getRange("A1:Z1000").getNumberFormats();
  range.setValues(values).setBackgrounds(bg).setFontWeights(font).setNumberFormats(formats);
  SpreadsheetApp.flush();
}
function createBackupSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const original = ss.getSheetByName("Alquileres");
  const backup = original.copyTo(ss).setName("Backup_Alquileres");
  ss.setActiveSheet(original);
  backup.hideSheet();
  const range = original.getRange("A1:Z1000");
  const values = range.getValues(), bg = range.getBackgrounds(), font = range.getFontWeights(), formats = range.getNumberFormats();
  backup.getRange("A1:Z1000").setValues(values).setBackgrounds(bg).setFontWeights(font).setNumberFormats(formats);
  return backup;
}
function notifyUserFallbackFixed() {
  SpreadsheetApp.getUi().alert("Fallback Corregido", "Datos restaurados automáticamente.", SpreadsheetApp.getUi().ButtonSet.OK);
}
function setupDailyBackup() {
  ScriptApp.newTrigger('updateBackup').timeBased().everyDays(1).atHour(2).create();
}
function updateBackup() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Alquileres");
  let backup = ss.getSheetByName("Backup_Alquileres");
  if (!backup) backup = createBackupSheet();
  const range = sheet.getRange("A1:Z1000");
  const values = range.getValues(), bg = range.getBackgrounds(), font = range.getFontWeights(), formats = range.getNumberFormats();
  backup.getRange("A1:Z1000").setValues(values).setBackgrounds(bg).setFontWeights(font).setNumberFormats(formats);
}

console.log("PANEL DE DUEÑOS LISTO - ESTADÍSTICAS POR ID 100% FUNCIONANDO");
</script>
</body>
</html>
