<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlquiYa - Alquileres en Santo Tomé</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SSJ5DG33JK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-SSJ5DG33JK');
</script>
<link rel="icon" type="image/png" href="https://i.postimg.cc/MKpMcrcQ/AlquiYa.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #3483fa;
    --primary-dark: #2565c0;
    --success: #25D366;
    --bg: #fafafa;
    --card: #ffffff;
    --text: #333;
    --border: #e0e0e0;
    --shadow: 0 6px 20px rgba(0,0,0,0.08);
    --radius: 14px;
    --transition: all 0.3s ease;
  }
  * { box-sizing: border-box; margin:0; padding:0; }
  body {
    font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
  }
  header {
    background: white;
    color: white;
    padding: 15px;
    text-align: center;
  }
  header img {
    max-width: 250px;
    margin-bottom: 10px;
  }
  nav {
    display: flex;
    justify-content: center;
    gap: 20px;
    background: white;
    padding: 1rem;
    box-shadow: var(--shadow);
    margin-bottom: 1rem;
  }
  nav a {
    text-decoration: none;
    font-weight: bold;
    color: #333;
    padding: 0.7rem 1.4rem;
    border-radius: 10px;
    transition: var(--transition);
  }
  nav a:hover {
    background: var(--primary);
    color: white;
  }
  #boton-filtros-container {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin: 1.5rem auto;
    max-width: 700px;
  }
  #boton-filtros-container button {
    padding: 0.8rem 2rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    box-shadow: var(--shadow);
    transition: var(--transition);
  }
  #boton-filtros-container button:hover {
    background: var(--primary-dark);
    transform: translateY(-3px);
  }
  #filtros {
    max-width: 900px;
    margin: 0 auto 2rem;
    padding: 2rem;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    display: none;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: end;
  }
  #filtros input, #filtros select {
    flex: 1;
    min-width: 160px;
    padding: 0.9rem 1rem;
    border: 1.8px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    transition: var(--transition);
  }
  #filtros input:focus, #filtros select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(52,131,250,0.15);
  }
  #filtros label {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-weight: 500;
  }
  #filtros button {
    padding: 0.9rem 2.5rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
  }
  #filtros button:hover {
    background: var(--primary-dark);
    transform: translateY(-3px);
  }
  #map {
    height: 65vh;
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    margin: 1.5rem auto;
    max-width: 1400px;
  }
  #loading-msg {
    text-align: center;
    font-weight: 600;
    color: var(--primary);
    font-size: 1.3rem;
    margin: 2rem;
    display: none;
  }
  /* MARCADORES ORIGINALES + AJUSTE DE TAMAÑO PARA DEPARTAMENTOS */
  .marker-icon {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    background: #3483fa !important;
    color: white !important;
    font-weight: bold !important;
    border-radius: 50% !important;
    width: 30px !important;
    height: 30px !important;
    border: 2px solid white !important;
    box-shadow: 0 0 2px #000 !important;
    font-size: 14px !important; /* Reducido para que quepa bien */
    line-height: 1;
  }
  .marker-icon span {
    font-size: 11px !important;
    margin-left: 1px;
  }
  .popup-button {
    display: inline-block;
    padding: 8px 16px;
    margin-top: 8px;
    background: #3483fa;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    font-size: 0.95em;
  }
  #alquiler-detalle, #login, #registro, #avisos-panel, #panel-dueno {
    max-width: 800px;
    margin: 2rem auto;
    padding: 2.5rem;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    display: none;
  }
  #alquiler-detalle {
    border: 2px solid var(--primary);
    display: none;
  }
  #alquiler-detalle.highlight { animation: resaltar 1.2s ease; }
  #alquiler-detalle h2 { color: var(--primary); font-size: 2rem; margin-bottom: 1.5rem; }
  #imagenes-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
  }
  #imagenes-container img {
    width: 100%;
    height: 110px;
    object-fit: cover;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: var(--transition);
  }
  #imagenes-container img:hover {
    transform: scale(1.08);
    box-shadow: 0 12px 30px rgba(0,0,0,0.2);
  }
  .btn-group {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    flex-wrap: wrap;
  }
  .copy-share-btn {
    background: #6366f1;
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .copy-share-btn:hover {
    background: #4f46e5;
  }
  #publicidad-container {
    background: var(--card);
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 2rem;
    margin: 2rem auto;
    max-width: 700px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
  }
  #publicidad-container:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow);
  }
  #modal-terminos, #modal-img {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(10px);
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 1rem;
  }
  #modal-terminos-content {
    background: white;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 2.5rem;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  #modal-img img {
    max-width: 94%;
    max-height: 94%;
    border-radius: 18px;
    box-shadow: 0 30px 80px rgba(0,0,0,0.6);
  }
  .nav-btn, .close-btn {
    position: absolute;
    background: rgba(255,255,255,0.25);
    color: white;
    border: none;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    font-size: 30px;
    cursor: pointer;
    backdrop-filter: blur(10px);
  }
  .nav-btn:hover, .close-btn:hover { background: var(--primary); }
  @keyframes resaltar {
    0%,100% { transform: scale(1); }
    50% { transform: scale(1.02); box-shadow: 0 0 40px rgba(52,131,250,0.4); }
  }
  @media (max-width: 768px) {
    header img { max-width: 200px; }
    #filtros, #alquiler-detalle { padding: 1.5rem; margin: 1rem; }
    #map { height: 55vh; }
    .btn-group { flex-direction: column; }
  }
</style>
</head>
<body>
<header>
<img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="Logo Alqui Ya">
</header>
    <h3>Mis Propiedades</h3>
    <div id="listaAlquileres">Cargando...</div>
    <button id="btnAgregarPropiedad" onclick="toggleOpcionesPropiedad()">Agregar Propiedad</button>

    <!-- Opciones de tipo de propiedad -->
    <div id="opcionesPropiedad">
      <label for="tipoOperacion">Tipo de Operación</label>
      <select id="tipoOperacion">
        <option value="Vender">Vender</option>
        <option value="Alquilar">Alquilar</option>
      </select>
      <div id="opcionesVenta">
        <button onclick="mostrarFormulario('Terreno')">Terreno</button>
        <button onclick="mostrarFormulario('Casa')">Casa</button>
        <button onclick="mostrarFormulario('Departamento')">Departamento</button>
        <button onclick="mostrarFormulario('Local')">Local Comercial</button>
      </div>
      <div id="opcionesAlquiler">
        <button onclick="mostrarFormulario('Departamento')">Departamento</button>
        <button onclick="mostrarFormulario('Local')">Local Comercial</button>
        <button onclick="mostrarFormulario('Temporario')">Temporario</button>
      </div>
    </div>

    <!-- Formularios ocultos por defecto -->
    <div id="formularioTerreno"><input type="hidden" id="editRowTerreno"><input type="hidden" id="enlaceCompartirTerreno"><input type="hidden" id="existingVideosTerreno"><label>Superficie total (m²)</label><input type="number" id="superficieTerreno"><label>Dirección</label><input type="text" id="direccionTerreno"><label>Precio (USD)</label><input type="text" id="precioTerreno"><label>Imágenes del Terreno</label><input type="file" id="imagenFileTerreno" accept="image/png, image/jpeg" multiple><div id="previewContainerTerreno"></div><label>Videos del Terreno</label><input type="file" id="videoFileTerreno" accept="video/*" multiple><div id="videoPreviewContainerTerreno"></div><label>Información de pago</label><textarea id="infoIngresoTerreno" rows="2"></textarea><label>Detalles</label><textarea id="detallesTerreno" rows="3"></textarea><button id="btnGuardarTerreno" onclick="agregarAlquiler('Terreno')">Agregar</button><p id="msgTerreno"></p></div>
    <div id="formularioCasa"><input type="hidden" id="editRowCasa"><input type="hidden" id="enlaceCompartirCasa"><input type="hidden" id="existingVideosCasa"><label>Dirección</label><input type="text" id="direccionCasa"><label>Precio (USD)</label><input type="text" id="precioCasa"><label>Detalle de Ambientes</label><input type="number" id="ambientesCasa"><label>Patio</label><select id="patioCasa"><option value="Sí">Sí</option><option value="No">No</option></select><label>Garage</label><select id="garageCasa"><option value="Sí">Sí</option><option value="No">No</option></select><label>Antigüedad (años)</label><input type="number" id="antiguedadCasa"><label>Imágenes de la Casa</label><input type="file" id="imagenFileCasa" accept="image/png, image/jpeg" multiple><div id="previewContainerCasa"></div><label>Videos de la Casa</label><input type="file" id="videoFileCasa" accept="video/*" multiple><div id="videoPreviewContainerCasa"></div><label>Información de pago</label><textarea id="infoIngresoCasa" rows="2"></textarea><label>Otros detalles</label><textarea id="detallesCasa" rows="3"></textarea><button id="btnGuardarCasa" onclick="agregarAlquiler('Casa')">Agregar</button><p id="msgCasa"></p></div>
    <div id="formularioDepartamento"><input type="hidden" id="editRowDepartamento"><input type="hidden" id="enlaceCompartirDepartamento"><input type="hidden" id="existingVideosDepartamento"><label>Dirección</label><input type="text" id="direccionDepartamento"><label>Ambientes</label><input type="number" id="ambientesDepartamento"><label>Precio (USD)</label><input type="text" id="precioDepartamento"><label>Imágenes del Alquiler</label><input type="file" id="imagenFileDepartamento" accept="image/png, image/jpeg" multiple><div id="previewContainerDepartamento"></div><label>Videos del Alquiler</label><input type="file" id="videoFileDepartamento" accept="video/*" multiple><div id="videoPreviewContainerDepartamento"></div><label>Información de pago</label><textarea id="infoIngresoDepartamento" rows="2"></textarea><label>Otros detalles</label><textarea id="detallesDepartamento" rows="3"></textarea><button id="btnGuardarDepartamento" onclick="agregarAlquiler('Departamento')">Agregar</button><p id="msgDepartamento"></p></div>
    <div id="formularioLocal"><input type="hidden" id="editRowLocal"><input type="hidden" id="enlaceCompartirLocal"><input type="hidden" id="existingVideosLocal"><label>Dirección</label><input type="text" id="direccionLocal"><label>Imágenes del Alquiler</label><input type="file" id="imagenFileLocal" accept="image/png, image/jpeg" multiple><div id="previewContainerLocal"></div><label>Videos del Alquiler</label><input type="file" id="videoFileLocal" accept="video/*" multiple><div id="videoPreviewContainerLocal"></div><label>Información de ingreso</label><textarea id="infoIngresoLocal" rows="2"></textarea><label>Detalles</label><textarea id="detallesLocal" rows="3"></textarea><button id="btnGuardarLocal" onclick="agregarAlquiler('Local')">Agregar</button><p id="msgLocal"></p></div>
    <div id="formularioTemporario"><input type="hidden" id="editRowTemporario"><input type="hidden" id="enlaceCompartirTemporario"><input type="hidden" id="existingVideosTemporario"><label>Dirección</label><input type="text" id="direccionTemporario"><label>Imágenes del Alquiler</label><input type="file" id="imagenFileTemporario" accept="image/png, image/jpeg" multiple><div id="previewContainerTemporario"></div><label>Videos del Alquiler</label><input type="file" id="videoFileTemporario" accept="video/*" multiple><div id="videoPreviewContainerTemporario"></div><label>Información de ingreso</label><textarea id="infoIngresoTemporario" rows="2"></textarea><label>Detalles</label><textarea id="detallesTemporario" rows="3"></textarea><button id="btnGuardarTemporario" onclick="agregarAlquiler('Temporario')">Agregar</button><p id="msgTemporario"></p></div>

    <!-- Modales (sin cambios) -->
    <div id="modalPlan" class="modal"><div class="modal-content">...</div></div>
    <div id="modalEditarCuenta" class="modal"><div class="modal-content">...</div></div>
    <div id="modalEstadisticas"><div class="modal-content">...</div></div>

    <button id="contactoBtn" title="¿Necesitas ayuda?" onclick="window.open('https://wa.me/5493764275443', '_blank')">
      <i class="fab fa-whatsapp"></i>
    </button>

<script>
// === CONSTANTES Y VARIABLES ===
const API_URL = "https://script.google.com/macros/s/AKfycbyFvDRwPZoG6ChhvcxGm6B27ziD6Qkg4RcH0TI9K59b7zPz7iFxy7mgmbs5mo5T-TxD/exec";
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dnugmwern/image/upload";
const CLOUDINARY_UPLOAD_PRESET = "preset_alquileres";
const GEOCODE_KEY = "AIzaSyAisqYSTfpQ_rqqutAomzitD2v_dtKYtLE";
const MP_BEARER = "APP_USR-595288641172928-010710-d915bce4137b3ee26e0c6e04873f1ac1-695835795";
let imagenesBase64 = { Departamento: [], Local: [], Temporario: [], Terreno: [], Casa: [] };
let videosBase64 = { Departamento: [], Local: [], Temporario: [], Terreno: [], Casa: [] };
let planActual = null;
let limiteDeptos = 0;
let deptosActivos = 0;
let preciosPlanes = {Basico: 0, Plus: 0, Full: 0};

function mostrarAlquileres(res) {
  const div = document.getElementById("listaAlquileres");
  div.innerHTML = "";
  if (!res.success || !res.data || res.data.length === 0) {
    div.innerHTML = "<p style='font-size:1.6em; color:#666; text-align:center;'>No tienes propiedades aún.</p>";
    return;
  }
  deptosActivos = res.data.filter(a => a.Estado === "Activo").length;
  document.getElementById("limiteAlquileres").textContent =
    planActual === "Prueba" ? `${deptosActivos} propiedades activas` :
    `${deptosActivos}/${limiteDeptos} propiedades activas`;

  res.data.forEach(alq => {
    let estado = alq.Estado === "Activo";
    let idPropiedad = alq[13] || alq.ID || alq.row;

    // Solo mostramos Precio y Tipo (A) / Subtipo (R)
    let precioFormateado = (alq.Tipo === "Departamento" || alq.Tipo === "Terreno" || alq.Tipo === "Casa") 
      ? formatoPrecio(alq.Precio) : "";
    let tipoDisplay = alq.Tipo;
    if (alq.Operacion === "Alquilar") tipoDisplay += " (A)";
    if (alq.Operacion === "Vender") tipoDisplay += " (R)";

    let vistas = parseInt(alq.Vistas || alq[18] || 0) || 0;
    let contactos = parseInt(alq.Consultas || alq.contactos || alq.Contactos || alq[19] || 0) || 0;

    const statsHTML = `<div class="stats-inline">
      <div class="stats-item"><i class="fa-solid fa-eye"></i><span class="stats-number">${vistas}</span> vistas</div>
      <div class="stats-item"><i class="fa-solid fa-phone"></i><span class="stats-number">${contactos}</span> contactos</div>
    </div>`;

    div.innerHTML += `<div class="alquiler">
      <b>${alq.Direccion || alq.direccion}</b><br>
      ${tipoDisplay}${precioFormateado ? " - " + precioFormateado : ""}<br>
      Estado: <strong>${estado ? "Activo" : "Inactivo"}</strong><br>
      ${statsHTML}
      <div class="alquiler-actions">
        <div class="alquiler-actions-left">
          <button class="copy-share-btn" data-id="${idPropiedad}">Copiar enlace</button>
          <button onclick='editarAlquiler(${alq.row}, ${JSON.stringify(alq)})'>Editar</button>
        </div>
        <div class="alquiler-actions-right">
          <button onclick="eliminarAlquiler(${alq.row})">Eliminar</button>
          <label class="toggle-switch">
            <input type="checkbox" ${estado ? "checked" : ""} onchange="cambiarEstado(${alq.row}, '${alq.Estado}')">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <span id="estadoMsg-${alq.row}" class="estado-msg"></span>
    </div>`;
  });

  document.querySelectorAll('.copy-share-btn').forEach(btn => {
    btn.onclick = function () {
      const idPropiedad = this.getAttribute('data-id');
      const url = `https://www.alquiya.com.ar/propiedad.html?id=${idPropiedad}`;
      fetch(`${API_URL}?action=generarEnlaceCompartido&id=${idPropiedad}`, {method: 'GET', mode: 'no-cors'}).catch(() => {});
      navigator.clipboard.writeText(url).then(() => {
        const textoOriginal = this.innerHTML;
        this.innerHTML = "Enlace copiado";
        this.style.background = "#10b981";
        setTimeout(() => { this.innerHTML = textoOriginal; this.style.background = ""; }, 2000);
      }).catch(() => alert('Enlace (copia manual):\n' + url));
    };
  });
}

function cargarAlquileres() {
  const loadingEl = document.getElementById("loading-msg");
  loadingEl.style.display = "block";
  loadingEl.textContent = "Cargando alquileres disponibles...";
  if (!map || !markersLayer) {
    if (!initializeMap()) {
      loadingEl.textContent = "Error: No se pudo inicializar el mapa.";
      return;
    }
  }
  markersLayer.clearLayers();

  // Marcadores fijos
  const uniIcon = L.divIcon({ className: 'marker-icon', html: 'Facultad', iconSize: [30, 30], iconAnchor: [15, 15] });
  const hospIcon = L.divIcon({ className: 'marker-icon', html: 'Hospital', iconSize: [30, 30], iconAnchor: [15, 15] });
  const superIcon = L.divIcon({ className: 'marker-icon', html: 'Mercado', iconSize: [30, 30], iconAnchor: [15, 15] });
  const busIcon = L.divIcon({ className: 'marker-icon', html: 'Bus', iconSize: [30, 30], iconAnchor: [15, 15] });
  const policeIcon = L.divIcon({ className: 'marker-icon', html: 'Policía', iconSize: [30, 30], iconAnchor: [15, 15] });
  L.marker([-28.5509978, -56.0409727], { icon: uniIcon }).addTo(markersLayer).bindPopup("<b>Facultad Fundación Barceló</b>");
  L.marker([-28.5551127, -56.0389282], { icon: hospIcon }).addTo(markersLayer).bindPopup("<b>Hospital Universitario San Juan Bautista</b>");
  L.marker([-28.5519443, -56.0401962], { icon: superIcon }).addTo(markersLayer).bindPopup("<b>Supermercado La Bomba</b>");
  L.marker([-28.5472635, -56.0438082], { icon: superIcon }).addTo(markersLayer).bindPopup("<b>Supermercado El Super</b>");
  L.marker([-28.5462903, -56.0440365], { icon: superIcon }).addTo(markersLayer).bindPopup("<b>Supermercado La Economía</b>");
  L.marker([-28.5468697, -56.0432862], { icon: busIcon }).addTo(markersLayer).bindPopup("<b>Terminal de Omnibus</b>");
  L.marker([-28.5487787, -56.0396171], { icon: policeIcon }).addTo(markersLayer).bindPopup("<b>Policía</b>");

  // Filtros
  const filtroAmb = document.getElementById("filtroAmb").value;
  const filtroMin = parseCurrency(document.getElementById("filtroMin").value) || 0;
  const filtroMax = parseCurrency(document.getElementById("filtroMax").value) || Infinity;
  const filtroMascotas = document.getElementById("filtroMascotas").checked;
  const filtroAmoblado = document.getElementById("filtroAmoblado").checked;
  const filtroTipo = document.getElementById("filtroTipo").value;

  makeRequest(webAppURL + "?action=getAlquileres", { method: "GET" })
    .then(res => {
      loadingEl.style.display = "none";
      if (!res.success || !Array.isArray(res.data)) {
        loadingEl.textContent = "Error al cargar alquileres.";
        return;
      }

      res.data.forEach(a => {
        // ... [todo el filtrado de siempre] ...

        const lat = parseFloat(String(getField(a, ["Latitud", "lat"])).replace(/[^0-9.-]/g, ""));
        const lng = parseFloat(String(getField(a, ["Longitud", "lng"])).replace(/[^0-9.-]/g, ""));
        if (isNaN(lat) || isNaN(lng)) return;

        const tipo = getField(a, ["Tipo"]);
        const nroAmb = toInt(getField(a, ["Nro Ambientes", "Ambientes", "Nro"]));
        const precioVal = getField(a, ["Precio", "precio", "$"]);
        const formattedPrecio = formatPrice(precioVal);
        const idPropiedad = getField(a, ["ID Propiedad", "idPropiedad", "ID", "Id"]);
        const direccion = getField(a, ["Direccion", "Dirección", "Domicilio"]);
        const contacto = getField(a, ["Contacto", "Whatsapp", "WhatsApp"]);
        const enlace = getField(a, ["Enlace para compartir"]);

        // ICONO CON EMOJI MÁS PEQUEÑO
        let iconHtml;
        if (tipo === "Temporario") iconHtml = 'Temporario';
        else if (tipo === "Local") iconHtml = 'Local';
        else iconHtml = 'Casa<span style="font-size:11px;margin-left:1px;">' + (nroAmb || "-") + '</span>';

        const icon = L.divIcon({
          className: 'marker-icon',
          html: iconHtml,
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        });

        const marker = L.marker([lat, lng], { icon: icon }).addTo(markersLayer);

        // POPUP MEJORADO CON TIPO, PRECIO Y AMBIENTES
        const popupDiv = document.createElement('div');
        popupDiv.innerHTML = `<b>${direccion || "Sin dirección"}</b><br>`;
        if (tipo !== "Temporario" && tipo !== "Local") {
          popupDiv.innerHTML += `<small><b>Tipo:</b> ${tipo}<br><b>Ambientes:</b> ${nroAmb}<br><b>Precio:</b> ${formattedPrecio}</small>`;
        } else {
          popupDiv.innerHTML += `<small><b>Tipo:</b> ${tipo}</small>`;
        }

        const verBtn = document.createElement('button');
        verBtn.className = 'popup-button';
        verBtn.textContent = 'Ver Detalles';
        verBtn.onclick = () => {
          if (idPropiedad) incrementarMetrica(idPropiedad, "vistas");

          const detalle = document.getElementById('alquiler-detalle');
          detalle Inland = `<h2>${tipo}: ${direccion || 'Sin dirección'}</h2><p id="metricas-error"></p>`;

          // ... [todos los datos como antes] ...

          // BOTONES: WHATSAPP + COPIAR ENLACE
          const btnGroup = document.createElement('div');
          btnGroup.className = 'btn-group';

          if (contacto) {
            const waBtn = document.createElement('button');
            waBtn.textContent = 'Contactar por WhatsApp';
            waBtn.style.background = '#25D366';
            waBtn.style.color = 'white';
            waBtn.style.padding = '12px 20px';
            waBtn.style.border = 'none';
            waBtn.style.borderRadius = '10px';
            waBtn.style.fontWeight = '600';
            waBtn.style.cursor = 'pointer';
            waBtn.onclick = () => {
              if (idPropiedad) incrementarMetrica(idPropiedad, "contactos");
              window.open(`https://wa.me/${contacto}?text=Hola, vengo desde AlquiYa y quiero consultar por el ${tipo.toLowerCase()} en ${direccion}`, '_blank');
            };
            btnGroup.appendChild(waBtn);
          }

          // BOTÓN COPIAR ENLACE
          const copyBtn = document.createElement('button');
          copyBtn.className = 'copy-share-btn';
          copyBtn.textContent = 'Copiar enlace';
          copyBtn.setAttribute('data-id', idPropiedad || '');
          btnGroup.appendChild(copyBtn);

          detalle.appendChild(btnGroup);
          detalle.style.display = 'block';
          detalle.classList.add("highlight");
          detalle.scrollIntoView({ behavior: "smooth" });
          setTimeout(() => detalle.classList.remove("highlight"), 1200);
        };
        popupDiv.appendChild(verBtn);
        marker.bindPopup(popupDiv);
      });
    })
    .catch(err => {
      loadingEl.style.display = "none";
      loadingEl.textContent = "Error de conexión.";
    });
}
  /* =========================
FUNCIÓN COPIAR ENLACE (nueva)
*/
document.addEventListener('click', function(e) {
  if (e.target && e.target.classList.contains('copy-share-btn')) {
    const idPropiedad = e.target.getAttribute('data-id');
    if (!idPropiedad) {
      alert('No se pudo generar el enlace');
      return;
    }
    const url = `https://www.alquiya.com.ar/propiedad.html?id=${idPropiedad}`;

    // Opcional: avisar al backend
    fetch(`${webAppURL}?action=generarEnlaceCompartido&id=${idPropiedad}`, {
      method: 'GET',
      mode: 'no-cors'
    }).catch(() => {});

    navigator.clipboard.writeText(url).then(() => {
      const textoOriginal = e.target.innerHTML;
      e.target.innerHTML = "Enlace copiado";
      e.target.style.background = "#10b981";
      setTimeout(() => {
        e.target.innerHTML = textoOriginal;
        e.target.style.background = "";
      }, 2000);
    }).catch(() => {
      alert('Enlace (copia manual):\n' + url);
    });
  }
});
function initGoogleCharts() {
  console.log('Inicializando Google Charts...');
  if (typeof google === 'undefined' || !google.charts) {
    console.log('Google Charts no disponible, reintentando en 500ms...');
    setTimeout(initGoogleCharts, 500);
    return;
  }
  google.charts.load('current', { packages: ['corechart'] });
  google.charts.setOnLoadCallback(() => {
    console.log('GOOGLE CHARTS CARGADO COMPLETAMENTE');
    window.googleChartsReady = true;
  });
}
window.mostrarModalEstadisticasCallback = function(data, idPropiedad) {
  let datosParaModal = { propiedad: { direccion: `Propiedad ID: ${idPropiedad}` }, metricas: { vistas: 0, contactos: 0 } };
  if (data && data.success && data.vistas !== undefined && data.consultas !== undefined) {
    datosParaModal.metricas.vistas = parseInt(data.vistas) || 0;
    datosParaModal.metricas.contactos = parseInt(data.consultas) || 0;
  }
  mostrarModalEstadisticas(datosParaModal);
};
function usarJSONP(idPropiedad, callbackName) {
  return new Promise((resolve, reject) => {
    callbackName = callbackName || 'jsonp_' + Date.now();
    window[callbackName] = function(data) {
      delete window[callbackName];
      const script = document.querySelector(`script[src*="${callbackName}"]`);
      if (script) script.remove();
      resolve(data);
    };
    const script = document.createElement('script');
    script.src = `${API_URL}?action=getvistasconsultas&id=${idPropiedad}&callback=${callbackName}`;
    script.onerror = () => {
      delete window[callbackName];
      script.remove();
      reject(new Error('JSONP falló'));
    };
    document.body.appendChild(script);
  });
}
function solicitarMetricas(idPropiedad, propId, retryCount = 0) {
  if (typeof google === 'undefined' || !google.charts || !window.googleChartsReady) {
    if (retryCount < 10) {
      setTimeout(() => solicitarMetricas(idPropiedad, propId, retryCount + 1), 500);
      return;
    } else {
      mostrarErrorMetricas(propId);
      return;
    }
  }
  const callbackName = 'metricasCallback_' + Date.now();
  usarJSONP(idPropiedad, callbackName)
    .then(datos => mostrarModalEstadisticasCallback(datos, propId))
    .catch(() => mostrarErrorMetricas(propId));
}
function mostrarErrorMetricas(propId) {
  const datosParaModal = { propiedad: { direccion: `Propiedad ID: ${propId}` }, metricas: { vistas: 0, contactos: 0 } };
  mostrarModalEstadisticas(datosParaModal);
  document.getElementById("msgEstadisticas").style.color = "orange";
  document.getElementById("msgEstadisticas").textContent = "Sin datos aún - ¡Comparte tu propiedad!";
}
function mostrarModalEstadisticas(data) {
  document.getElementById('modal-titulo').textContent = `Estadísticas - ${data.propiedad.direccion}`;
  document.getElementById('modal-vistas').textContent = data.metricas.vistas || 0;
  document.getElementById('modal-contactos').textContent = data.metricas.contactos || 0;
  document.getElementById("modalEstadisticas").style.display = "block";
  document.getElementById("msgEstadisticas").style.color = "green";
  document.getElementById("msgEstadisticas").textContent = "Estadísticas cargadas correctamente";
}
function cerrarModalEstadisticas() {
  document.getElementById("modalEstadisticas").style.display = "none";
  document.getElementById("msgEstadisticas").textContent = "";
}
function formatoPrecio(valor) {
  if (!valor) return "";
  valor = valor.toString().replace(/\D/g, "");
  return "$" + valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
function inicializarFormatoPrecio(tipo) {
  document.getElementById(`precio${tipo}`).addEventListener("input", function(e) {
    const cursorPos = this.selectionStart;
    const valorSinSimbolo = this.value.replace(/\D/g, '');
    const formattedValue = formatoPrecio(valorSinSimbolo);
    const prevLength = this.value.length;
    this.value = formattedValue;
    const newLength = formattedValue.length;
    const diff = newLength - prevLength;
    this.selectionStart = cursorPos + diff;
    this.selectionEnd = cursorPos + diff;
  });
}
function formatoPrecioPlan(valor) {
  if (!valor) return "$0,00";
  const numero = parseFloat(valor);
  if (isNaN(numero)) return "$0,00";
  const entero = Math.floor(numero);
  const decimal = Math.round((numero - entero) * 100).toString().padStart(2, "0");
  const enteroFormateado = entero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  return `$${enteroFormateado},${decimal}`;
}
function formatoFecha(fecha) {
  if (fecha === "N/D") return fecha;
  const partes = fecha.split("/");
  if (partes.length !== 3) return fecha;
  const [dia, mes, anio] = partes;
  return `${parseInt(dia, 10)}/${parseInt(mes, 10)}/${anio}`;
}
function actualizarPreview(tipo) {
  const previewContainer = document.getElementById(`previewContainer${tipo}`);
  previewContainer.innerHTML = "";
  imagenesBase64[tipo].forEach((imgBase64, index) => {
    const container = document.createElement("div");
    container.className = "preview-img-container";
    const img = document.createElement("img");
    img.src = imgBase64;
    img.className = "preview-img";
    const btnDel = document.createElement("button");
    btnDel.className = "delete-img";
    btnDel.textContent = "x";
    btnDel.onclick = () => { imagenesBase64[tipo].splice(index, 1); actualizarPreview(tipo); };
    container.appendChild(img);
    container.appendChild(btnDel);
    previewContainer.appendChild(container);
  });
}
function inicializarPreviewImagenes(tipo) {
  document.getElementById(`imagenFile${tipo}`).addEventListener("change", function() {
    const files = Array.from(this.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        imagenesBase64[tipo].push(e.target.result);
        actualizarPreview(tipo);
      }
      reader.readAsDataURL(file);
    });
  });
}
function actualizarVideoPreview(tipo) {
  const videoPreviewContainer = document.getElementById(`videoPreviewContainer${tipo}`);
  videoPreviewContainer.innerHTML = "";
  videosBase64[tipo].forEach((videoBase64, index) => {
    const container = document.createElement("div");
    container.className = "preview-video-container";
    const video = document.createElement("video");
    video.src = videoBase64;
    video.className = "preview-video";
    video.controls = true;
    const btnDel = document.createElement("button");
    btnDel.className = "delete-video";
    btnDel.textContent = "x";
    btnDel.onclick = () => { videosBase64[tipo].splice(index, 1); actualizarVideoPreview(tipo); };
    container.appendChild(video);
    container.appendChild(btnDel);
    videoPreviewContainer.appendChild(container);
  });
}
function inicializarPreviewVideos(tipo) {
  document.getElementById(`videoFile${tipo}`).addEventListener("change", function() {
    const files = Array.from(this.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        videosBase64[tipo].push(e.target.result);
        actualizarVideoPreview(tipo);
      }
      reader.readAsDataURL(file);
    });
  });
}
async function subirImagenCloudinary(file) {
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
  try {
    const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
    const json = await res.json();
    return json.secure_url;
  } catch (err) {
    console.error("Error subiendo imagen a Cloudinary:", err);
    return null;
  }
}
async function subirVideoMux(videoFile, row, tipo) {
  const msgEl = document.getElementById(`msg${tipo}`);
  try {
    const base64Video = await fileToBase64(videoFile);
    const response = await fetch(API_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'uploadVideoMux', video: base64Video, row: row })
    });
    if (!response.ok) throw new Error(`Error HTTP! Estado: ${response.status}`);
    const result = await response.json();
    if (result.success) return result.videoUrl;
    else throw new Error(result.error || 'Error desconocido al subir el video');
  } catch (error) {
    console.error('Error subiendo video a Mux:', error.message);
    msgEl.className = "estado-msg error";
    msgEl.textContent = `Error al subir video: ${error.message}`;
    setTimeout(() => { msgEl.textContent = ""; }, 5000);
    throw error;
  }
}
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(new Error('Error al convertir el video a base64'));
    reader.readAsDataURL(file);
  });
}
function toggleMenu() {
  const menu = document.getElementById("menu");
  menu.classList.toggle("active");
}
function toggleOpcionesPropiedad() {
  const opciones = document.getElementById("opcionesPropiedad");
  const opcionesVenta = document.getElementById("opcionesVenta");
  const opcionesAlquiler = document.getElementById("opcionesAlquiler");
  const btn = document.getElementById("btnAgregarPropiedad");
  if (opciones.classList.contains("active")) {
    opciones.classList.remove("active");
    opcionesVenta.classList.remove("active");
    opcionesAlquiler.classList.remove("active");
    btn.textContent = "Agregar Propiedad";
    resetAllForms();
  } else {
    opciones.classList.add("active");
    btn.textContent = "Cerrar Opciones";
    window.scrollTo(0, document.getElementById("opcionesPropiedad").offsetTop);
  }
}
function mostrarOpcionesPorOperacion() {
  const tipoOperacion = document.getElementById("tipoOperacion").value;
  const opcionesVenta = document.getElementById("opcionesVenta");
  const opcionesAlquiler = document.getElementById("opcionesAlquiler");
  if (tipoOperacion === "Vender") {
    opcionesVenta.classList.add("active");
    opcionesAlquiler.classList.remove("active");
  } else {
    opcionesAlquiler.classList.add("active");
    opcionesVenta.classList.remove("active");
  }
}
function mostrarFormulario(tipo) {
  const formularios = ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'];
  formularios.forEach(f => document.getElementById(`formulario${f}`).classList.remove("active"));
  document.getElementById(`formulario${tipo}`).classList.add("active");
  document.getElementById("btnAgregarPropiedad").textContent = "Cerrar Opciones";
  window.scrollTo(0, document.getElementById(`formulario${tipo}`).offsetTop);
}
window.onload = function() {
  initGoogleCharts();
  const email = localStorage.getItem("dueno");
  if (!email) { window.location.href = "index.html"; return; }
  cargarEstadoPlan();
  cargarAlquileres();
  cargarPreciosPlanes();
  cargarDatosCuenta();
  checkPaymentOnReturn();
  ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'].forEach(tipo => {
    inicializarPreviewImagenes(tipo);
    inicializarPreviewVideos(tipo);
    if (tipo === 'Departamento' || tipo === 'Terreno' || tipo === 'Casa') inicializarFormatoPrecio(tipo);
  });
  document.getElementById("tipoOperacion").addEventListener("change", mostrarOpcionesPorOperacion);
}
async function checkPaymentOnReturn() {
const urlParams = new URLSearchParams(window.location.search);
const status = urlParams.get("status");
const paymentId = urlParams.get("payment_id");
const planStatusEl = document.getElementById("planStatus");
if (status && paymentId) {
planStatusEl.innerHTML = `<span class="estado-msg loading">Verificando estado del pago...</span>`;
try {
const response = await fetch(`https://api.mercadopago.com/v1/payments/${paymentId}`, {
method: "GET",
headers: { "Authorization": "Bearer " + MP_BEARER }
});
const paymentData = await response.json();
if (response.ok && paymentData.status === "approved") {
const [email, plan] = paymentData.external_reference.split("_");
const script = document.createElement("script");
script.src = `${API_URL}?action=updatePlan&email=${encodeURIComponent(email)}&plan=${plan}&payment_id=${paymentId}&estadoPago=Aprobado&descripcionPago=Pago%20plan%20${plan}%20-%20ID:%20${paymentId}&callback=planActualizado`;
document.body.appendChild(script);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">Pago no aprobado. Estado: ${paymentData.status || "Desconocido"}.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
} catch (err) {
console.error("Error verificando pago:", err);
planStatusEl.innerHTML = `<span class="estado-msg error">Error al verificar el pago. Por favor, intenta de nuevo.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
window.history.replaceState({}, document.title, window.location.pathname);
}
}
function cargarPreciosPlanes() {
const script = document.createElement("script");
script.src = `${API_URL}?action=getPlanes&callback=mostrarPreciosPlanes`;
document.body.appendChild(script);
}
function mostrarPreciosPlanes(res) {
if (res.success && res.data && res.data.length) {
res.data.forEach(plan => {
preciosPlanes[plan.nombre] = parseFloat(plan.precio) || 0;
});
document.getElementById("precioBasico").textContent = formatoPrecioPlan(preciosPlanes.Basico) + " / mes";
document.getElementById("precioPlus").textContent = formatoPrecioPlan(preciosPlanes.Plus) + " / mes";
document.getElementById("precioFull").textContent = formatoPrecioPlan(preciosPlanes.Full) + " / mes";
} else {
console.error("Error al cargar precios de planes:", res);
}
}
function cargarEstadoPlan() {
const email = localStorage.getItem("dueno");
const script = document.createElement("script");
script.src = `${API_URL}?action=getLoginInfo&email=${encodeURIComponent(email)}&callback=mostrarEstadoPlan`;
document.body.appendChild(script);
}
function mostrarEstadoPlan(res) {
const planStatusEl = document.getElementById("planStatus");
if (!res.success || !res.data || !res.data[0]) {
planActual = null;
limiteDeptos = 0;
planStatusEl.innerHTML = `Plan: <b>Sin plan</b> | Estado de Pago: N/D | Vencimiento: N/D`;
document.getElementById("btnPlan").textContent = "Elegir Plan";
document.getElementById("limiteAlquileres").textContent = "";
return;
}
const login = res.data[0];
planActual = login.Plan || null;
limiteDeptos = planActual === "Prueba" ? Infinity : planActual === "Basico" ? 3 : planActual === "Plus" ? 5 : planActual === "Full" ? 10 : 0;
const estadoPago = login.EstadoPago || "No registrado";
const vencimiento = formatoFecha(login.Vencimiento || "N/D");
let planStatusHTML = `Plan: <b>${planActual || "Sin plan"}</b> | Estado de Pago: ${estadoPago} | Vencimiento: ${vencimiento}`;
if (planActual === "Prueba" && vencimiento !== "N/D") {
const vencimientoDate = new Date(vencimiento.split("/").reverse().join("-"));
const today = new Date();
const diffTime = vencimientoDate - today;
const diasRestantes = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
if (diasRestantes > 0) {
planStatusHTML += `<br><span style="color:#00FF00">Te quedan ${diasRestantes} días para mostrar tus departamentos GRATIS con el plan Prueba</span>`;
} else {
planStatusHTML += `<br><span style="color:red">Plan Prueba vencido, tus alquileres no se mostrarán en el mapa</span>`;
}
} else if (vencimiento !== "N/D") {
const vencimientoDate = new Date(vencimiento.split("/").reverse().join("-"));
const today = new Date();
if (vencimientoDate < today) {
planStatusHTML += `<br><span style="color:red">Plan vencido, tus alquileres no se mostrarán en el mapa</span>`;
}
}
planStatusEl.innerHTML = planStatusHTML;
document.getElementById("limiteAlquileres").textContent = planActual === "Prueba" ? `${deptosActivos} propiedades activas` : `${deptosActivos}/${limiteDeptos} propiedades activas`;
document.getElementById("btnPlan").textContent = planActual ? "Mejorar Plan" : "Elegir Plan";
}
function abrirModalPlan() { document.getElementById("modalPlan").style.display = "block"; }
function cerrarModalPlan() {
document.getElementById("modalPlan").style.display = "none";
document.getElementById("mpBtnBasico").innerHTML = "";
document.getElementById("mpBtnPlus").innerHTML = "";
document.getElementById("mpBtnFull").innerHTML = "";
}
async function seleccionarPlan(plan, retries = 3) {
const email = localStorage.getItem("dueno");
const precio = preciosPlanes[plan] || 0;
const planStatusEl = document.getElementById("planStatus");
planStatusEl.innerHTML = `<span class="estado-msg loading">Procesando pago...</span>`;
const preferenceData = {
items: [{ title: `Plan ${plan}`, quantity: 1, unit_price: parseFloat(precio), currency_id: "ARS" }],
payer: { email: email },
external_reference: email + "_" + plan,
back_urls: {
success: window.location.href,
failure: window.location.href,
pending: window.location.href
},
auto_return: "approved",
notification_url: `${API_URL}?action=updatePlan`
};
try {
const response = await fetch("https://api.mercadopago.com/checkout/preferences", {
method: "POST",
headers: { "Authorization": "Bearer " + MP_BEARER, "Content-Type": "application/json" },
body: JSON.stringify(preferenceData)
});
const res = await response.json();
if (res.init_point) {
const mpContainer = document.getElementById("mpBtn" + plan);
mpContainer.innerHTML = `<iframe src="${res.init_point}" width="100%" height="650" frameborder="0" allowtransparency="true"></iframe>`;
planStatusEl.innerHTML = `<span class="estado-msg loading">Iniciando pago. Esperando confirmación...</span>`;
} else {
console.error("Error MP:", res);
if (retries > 0) {
console.log(`Reintentando (${retries} restantes)...`);
setTimeout(() => seleccionarPlan(plan, retries - 1), 2000);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">No se pudo generar el botón de pago. Revisa la consola.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
}
} catch (err) {
console.error("Error MP:", err);
if (retries > 0) {
console.log(`Reintentando (${retries} restantes)...`);
setTimeout(() => seleccionarPlan(plan, retries - 1), 2000);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">Error al procesar el pago. Por favor, intenta de nuevo.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
}
}
function planActualizado(res) {
const planStatusEl = document.getElementById("planStatus");
if (res.success) {
planStatusEl.innerHTML = `<span class="estado-msg success">Plan actualizado con éxito: ${res.plan}</span>`;
setTimeout(() => {
planStatusEl.innerHTML = "";
cargarEstadoPlan();
cargarAlquileres();
cerrarModalPlan();
}, 3000);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">Error al actualizar el plan: ${res.error || "desconocido"}</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
}
function cargarAlquileres() {
const email = localStorage.getItem("dueno");
const script = document.createElement("script");
script.src = `${API_URL}?action=getAlquileresDueno&dueno=${encodeURIComponent(email)}&callback=mostrarAlquileres`;
document.body.appendChild(script);
}
async function agregarAlquiler(tipo) {
const msgEl = document.getElementById(`msg${tipo}`);
msgEl.textContent = "Agregando propiedad...";
msgEl.className = "estado-msg loading";
let direccion = document.getElementById(`direccion${tipo}`).value;
const ambientes = (tipo === "Departamento" || tipo === "Casa") ? document.getElementById(`ambientes${tipo}`).value : "";
let precio = (tipo === "Departamento" || tipo === "Terreno" || tipo === "Casa") ? document.getElementById(`precio${tipo}`).value.replace(/\D/g, "") : "";
const superficie = tipo === "Terreno" ? document.getElementById(`superficie${tipo}`).value : "";
const patio = tipo === "Casa" ? document.getElementById(`patio${tipo}`).value : "";
const garage = tipo === "Casa" ? document.getElementById(`garage${tipo}`).value : "";
const antiguedad = tipo === "Casa" ? document.getElementById(`antiguedad${tipo}`).value : "";
const infoIngreso = document.getElementById(`infoIngreso${tipo}`).value;
const detalles = document.getElementById(`detalles${tipo}`).value;
const operacion = document.getElementById("tipoOperacion").value;
let row = document.getElementById(`editRow${tipo}`).value || new Date().getTime();
const enlaceCompartir = document.getElementById(`editRow${tipo}`).value ? document.getElementById(`enlaceCompartir${tipo}`).value : "";
const email = localStorage.getItem("dueno");
if (!direccion ||
(tipo === "Departamento" && (!ambientes || !precio)) ||
(tipo === "Terreno" && (!superficie || !precio)) ||
(tipo === "Casa" && (!ambientes || !precio))) {
msgEl.className = "estado-msg error";
msgEl.textContent = "Completa todos los campos obligatorios.";
setTimeout(() => { msgEl.textContent = ""; }, 5000);
return;
}
direccion = direccion + ", Santo Tomé Corrientes";
const files = document.getElementById(`imagenFile${tipo}`).files;
let uploadedURLs = [];
for (let i = 0; i < files.length; i++) {
const url = await subirImagenCloudinary(files[i]);
if (url) uploadedURLs.push(url);
}
const videoFiles = document.getElementById(`videoFile${tipo}`).files;
let videos = "";
if (videoFiles.length > 0) {
let videoURLs = [];
for (let i = 0; i < videoFiles.length; i++) {
const url = await subirVideoMux(videoFiles[i], row, tipo);
if (url) videoURLs.push(url);
}
videos = videoURLs.join(",");
} else if (document.getElementById(`editRow${tipo}`).value) {
videos = document.getElementById(`existingVideos${tipo}`).value;
}
fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(direccion)}&key=${GEOCODE_KEY}`)
.then(r => r.json()).then(data => {
let lat = "", lng = "";
if (data.results && data.results[0]) {
lat = data.results[0].geometry.location.lat;
lng = data.results[0].geometry.location.lng;
}
enviarAlquiler(tipo, uploadedURLs.join(","), lat, lng, enlaceCompartir, videos, operacion);
}).catch(err => {
msgEl.className = "estado-msg error";
msgEl.textContent = "Error al obtener coordenadas: " + (err.message || "Error de conexión");
setTimeout(() => { msgEl.textContent = ""; }, 5000);
});
function enviarAlquiler(tipo, fotosConcatenadas, lat, lng, enlaceCompartir, videos, operacion) {
const action = document.getElementById(`editRow${tipo}`).value ? "editAlquiler" : "addAlquiler";
const callback = action === "editAlquiler" ? "alquilerEditado" : "alquilerAgregado";
let estado = "Activo";
if (action === "editAlquiler" && deptosActivos >= limiteDeptos && planActual !== "Prueba") {
estado = "Inactivo";
}
const script = document.createElement("script");
let query = `${API_URL}?action=${action}&row=${row}&dueno=${encodeURIComponent(email)}&direccion=${encodeURIComponent(direccion)}&tipo=${encodeURIComponent(tipo)}`;
if (tipo === "Departamento" || tipo === "Casa") query += `&ambientes=${encodeURIComponent(ambientes)}`;
if (tipo === "Departamento" || tipo === "Terreno" || tipo === "Casa") query += `&precio=${encodeURIComponent(precio)}`;
if (tipo === "Terreno") query += `&superficie=${encodeURIComponent(superficie)}`;
if (tipo === "Casa") {
query += `&patio=${encodeURIComponent(patio)}`;
query += `&garage=${encodeURIComponent(garage)}`;
query += `&antiguedad=${encodeURIComponent(antiguedad)}`;
}
query += `&fotos=${encodeURIComponent(fotosConcatenadas)}&infoIngreso=${encodeURIComponent(infoIngreso)}&detalles=${encodeURIComponent(detalles)}&lat=${lat}&lng=${lng}&contacto=auto&estado=${estado}&videos=${encodeURIComponent(videos)}&operacion=${encodeURIComponent(operacion)}`;
if (enlaceCompartir) query += `&enlaceCompartir=${encodeURIComponent(enlaceCompartir)}`;
query += `&callback=${callback}`;
script.src = query;
document.body.appendChild(script);
}
}
function resetAllForms() {
['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'].forEach(tipo => {
document.getElementById(`formulario${tipo}`).classList.remove("active");
document.getElementById(`editRow${tipo}`).value = "";
document.getElementById(`enlaceCompartir${tipo}`).value = "";
document.getElementById(`existingVideos${tipo}`).value = "";
document.getElementById(`direccion${tipo}`).value = "";
if (tipo === "Departamento" || tipo === "Casa") {
document.getElementById(`ambientes${tipo}`).value = "";
document.getElementById(`precio${tipo}`).value = "";
}
if (tipo === "Terreno") {
document.getElementById(`superficie${tipo}`).value = "";
document.getElementById(`precio${tipo}`).value = "";
}
if (tipo === "Casa") {
document.getElementById(`patio${tipo}`).value = "Sí";
document.getElementById(`garage${tipo}`).value = "Sí";
document.getElementById(`antiguedad${tipo}`).value = "";
}
document.getElementById(`infoIngreso${tipo}`).value = "";
document.getElementById(`detalles${tipo}`).value = "";
document.getElementById(`imagenFile${tipo}`).value = "";
document.getElementById(`videoFile${tipo}`).value = "";
imagenesBase64[tipo] = [];
videosBase64[tipo] = [];
actualizarPreview(tipo);
actualizarVideoPreview(tipo);
document.getElementById(`msg${tipo}`).textContent = "";
document.getElementById(`btnGuardar${tipo}`).textContent = "Agregar";
});
document.getElementById("opcionesPropiedad").classList.remove("active");
document.getElementById("opcionesVenta").classList.remove("active");
document.getElementById("opcionesAlquiler").classList.remove("active");
document.getElementById("btnAgregarPropiedad").textContent = "Agregar Propiedad";
document.getElementById("tipoOperacion").value = "Vender";
mostrarOpcionesPorOperacion();
}
function editarAlquiler(row, datos) {
const tipo = datos.Tipo || "Departamento";
document.getElementById("btnAgregarPropiedad").textContent = "Cerrar Opciones";
document.getElementById(`formulario${tipo}`).classList.add("active");
document.getElementById(`btnGuardar${tipo}`).textContent = "Guardar Cambios";
document.getElementById(`editRow${tipo}`).value = row;
document.getElementById(`enlaceCompartir${tipo}`).value = datos["Enlace para compartir"] || "";
document.getElementById(`existingVideos${tipo}`).value = datos.Videos || "";
document.getElementById(`direccion${tipo}`).value = datos.Direccion || "";
if (tipo === "Departamento" || tipo === "Casa") {
document.getElementById(`ambientes${tipo}`).value = datos["Nro Ambientes"] || "";
document.getElementById(`precio${tipo}`).value = formatoPrecio(datos.Precio);
}
if (tipo === "Terreno") {
document.getElementById(`superficie${tipo}`).value = datos.Superficie || "";
document.getElementById(`precio${tipo}`).value = formatoPrecio(datos.Precio);
}
if (tipo === "Casa") {
document.getElementById(`patio${tipo}`).value = datos.Patio || "No";
document.getElementById(`garage${tipo}`).value = datos.Garage || "No";
document.getElementById(`antiguedad${tipo}`).value = datos.Antiguedad || "";
}
document.getElementById(`infoIngreso${tipo}`).value = datos.InfoIngreso || "";
document.getElementById(`detalles${tipo}`).value = datos.Detalles || "";
document.getElementById("tipoOperacion").value = datos.Operacion || "Vender";
mostrarOpcionesPorOperacion();
imagenesBase64[tipo] = datos.Fotos ? datos.Fotos.split(",") : [];
videosBase64[tipo] = datos.Videos ? datos.Videos.split(",") : [];
actualizarPreview(tipo);
actualizarVideoPreview(tipo);
window.scrollTo(0, document.getElementById(`formulario${tipo}`).offsetTop);
}
async function cambiarEstado(row, estadoActual) {
const msgEl = document.getElementById(`estadoMsg-${row}`);
if (estadoActual === "Inactivo" && deptosActivos >= limiteDeptos && planActual !== "Prueba") {
msgEl.className = "estado-msg error";
msgEl.textContent = `No puedes activar más propiedades. Tu plan (${planActual}) permite hasta ${limiteDeptos} propiedades activas.`;
setTimeout(() => { msgEl.textContent = ""; }, 5000);
return;
}
msgEl.className = "estado-msg loading";
msgEl.textContent = "Cambiando Estado";
try {
const response = await fetch(`${API_URL}?action=toggleEstado&row=${row}`);
const res = await response.json();
estadoCambiado(res, row);
} catch (err) {
msgEl.className = "estado-msg error";
msgEl.textContent = `Error al cambiar estado: ${err.message || "Error de conexión"}`;
setTimeout(() => { msgEl.textContent = ""; }, 5000);
console.error("Error en cambio de estado:", err);
}
}
function estadoCambiado(res, row) {
const msgEl = document.getElementById(`estadoMsg-${row}`);
if (res.success) {
msgEl.className = "estado-msg success";
msgEl.textContent = "Estado cambiado con éxito";
setTimeout(() => { msgEl.textContent = ""; }, 3000);
cargarAlquileres();
} else {
msgEl.className = "estado-msg error";
msgEl.textContent = `Error al cambiar estado: ${res.error || "desconocido"}`;
setTimeout(() => { msgEl.textContent = ""; }, 5000);
}
}
function eliminarAlquiler(row) {
if (!confirm("¿Seguro que deseas eliminar esta propiedad?")) return;
const script = document.createElement("script");
script.src = `${API_URL}?action=deleteAlquiler&row=${row}&callback=cargarAlquileres`;
document.body.appendChild(script);
}
function logout() { localStorage.removeItem("dueno"); window.location.href = "index.html"; }
function alquilerAgregado(res) {
const formularios = ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'];
formularios.forEach(tipo => {
const msgEl = document.getElementById(`msg${tipo}`);
if (res.success) {
msgEl.className = "estado-msg success";
msgEl.textContent = "Propiedad agregada con éxito";
setTimeout(() => {
resetAllForms();
cargarAlquileres();
cargarEstadoPlan();
}, 3000);
} else {
msgEl.className = "estado-msg error";
msgEl.textContent = "Error al agregar: " + (res.error || "desconocido");
setTimeout(() => { msgEl.textContent = ""; }, 5000);
}
});
}
function alquilerEditado(res) {
const formularios = ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'];
formularios.forEach(tipo => {
const msgEl = document.getElementById(`msg${tipo}`);
if (res.success) {
msgEl.className = "estado-msg success";
msgEl.textContent = "Cambios guardados correctamente";
setTimeout(() => {
resetAllForms();
cargarAlquileres();
}, 3000);
} else {
msgEl.className = "estado-msg error";
msgEl.textContent = "Error al editar: " + (res.error || "desconocido");
setTimeout(() => { msgEl.textContent = ""; }, 5000);
}
});
}
function abrirModalEditarCuenta() {
document.getElementById("modalEditarCuenta").style.display = "block";
cargarDatosCuenta();
}
function cerrarModalEditarCuenta() {
document.getElementById("modalEditarCuenta").style.display = "none";
document.getElementById("emailEditar").value = "";
document.getElementById("nombreEditar").value = "";
document.getElementById("contactoEditar").value = "";
document.getElementById("passwordEditar").value = "";
document.getElementById("codigoPaisEditar").value = "+549";
document.getElementById("msgEditarCuenta").textContent = "";
document.getElementById("passwordEditar").type = "password";
document.querySelector(".toggle-password").textContent = "Mostrar";
}
function cargarDatosCuenta() {
const email = localStorage.getItem("dueno");
const msgEl = document.getElementById("msgEditarCuenta");
const script = document.createElement("script");
script.src = `${API_URL}?action=getLoginInfo&email=${encodeURIComponent(email)}&callback=mostrarDatosCuenta`;
document.body.appendChild(script);
}
function mostrarDatosCuenta(res) {
const msgEl = document.getElementById("msgEditarCuenta");
const countryCodes = ["+549", "+55", "+598", "+56", "+595"];
if (res.success && res.data && res.data[0]) {
const login = res.data[0];
document.getElementById("emailEditar").value = login.Email || "";
document.getElementById("nombreEditar").value = login.Nombre || "";
document.getElementById("passwordEditar").value = login.Password || "";
let contacto = login.Contacto || "";
let codigoPais = "+549";
let numero = "";
if (typeof contacto === "string" && contacto.trim() !== "") {
for (const code of countryCodes) {
if (contacto.startsWith(code)) {
codigoPais = code;
numero = contacto.slice(code.length).trim();
break;
}
}
}
document.getElementById("codigoPaisEditar").value = codigoPais;
document.getElementById("contactoEditar").value = numero;
msgEl.textContent = "";
} else {
msgEl.style.color = "red";
msgEl.textContent = "Error al cargar los datos de la cuenta";
setTimeout(() => { msgEl.textContent = ""; }, 3000);
}
}
function togglePasswordVisibility() {
const passwordInput = document.getElementById("passwordEditar");
const toggleButton = document.querySelector(".toggle-password");
if (passwordInput.type === "password") {
passwordInput.type = "text";
toggleButton.textContent = "Ocultar";
} else {
passwordInput.type = "password";
toggleButton.textContent = "Mostrar";
}
}
async function editarCuenta() {
const email = localStorage.getItem("dueno");
const newEmail = document.getElementById("emailEditar").value;
const nombre = document.getElementById("nombreEditar").value;
const codigoPais = document.getElementById("codigoPaisEditar").value;
const contacto = document.getElementById("contactoEditar").value;
const password = document.getElementById("passwordEditar").value;
const msgEl = document.getElementById("msgEditarCuenta");
if (!newEmail && !nombre && !contacto && !password) {
msgEl.style.color = "red";
msgEl.textContent = "Debes completar al menos un campo para actualizar.";
return;
}
if (newEmail && !newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
msgEl.style.color = "red";
msgEl.textContent = "Ingresa un email válido.";
return;
}
if (password && password.length < 6) {
msgEl.style.color = "red";
msgEl.textContent = "La contraseña debe tener al menos 6 caracteres.";
return;
}
if (contacto && !contacto.match(/^\d{6,}$/)) {
msgEl.style.color = "red";
msgEl.textContent = "El número de teléfono debe contener solo dígitos y al menos 6 caracteres.";
return;
}
msgEl.textContent = "Guardando cambios...";
try {
let query = `${API_URL}?action=editarDueno&email=${encodeURIComponent(email)}`;
if (newEmail) query += `&newEmail=${encodeURIComponent(newEmail)}`;
if (nombre) query += `&nombre=${encodeURIComponent(nombre)}`;
if (contacto) query += `&contacto=${encodeURIComponent(codigoPais + contacto)}`;
if (password) query += `&password=${encodeURIComponent(password)}`;
const response = await fetch(query);
const res = await response.json();
if (res.success) {
msgEl.style.color = "green";
msgEl.textContent = "Cambios guardados con éxito";
if (newEmail) localStorage.setItem("dueno", newEmail);
setTimeout(cerrarModalEditarCuenta, 1000);
} else {
msgEl.style.color = "red";
msgEl.textContent = "Error al guardar: " + (res.error || "desconocido");
}
} catch (err) {
msgEl.style.color = "red";
msgEl.textContent = "Error al guardar: " + (err.message || "Error de conexión");
console.error("Error en edición de cuenta:", err);
}
}
</script>
</body>
</html>
