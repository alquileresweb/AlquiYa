<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Dueños</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SSJ5DG33JK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-SSJ5DG33JK');
    </script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/MKpMcrcQ/AlquiYa.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
      :root {
        --primary: #4361ee;
        --success: #10b981;
        --danger: #ef4444;
        --gray: #6b7280;
        --light: #f8fafc;
        --dark: #1e293b;
        --radius: 16px;
        --shadow: 0 10px 25px rgba(0,0,0,0.08);
      }
      body {
        font-family: 'Segoe UI', Arial, sans-serif;
        margin: 0;
        background: linear-gradient(135deg, #f0f2f5 0%, #e2e8f0 100%);
        color: var(--dark);
        font-size: 18px;
        line-height: 1.6;
        padding-top: 90px;
      }
      header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: white;
        z-index: 1000;
        padding: 16px 20px;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      /* LOGO MÁS GRANDE */
      header img {
        max-height: 150px;   /* antes era 60px */
        height: 150px;
      }
      
      /* BOTONES FIJOS: FLECHA Y PERSONITA CON EL MISMO ESTILO */
#back-arrow, #menu-toggle {
  position: fixed;
  top: 20px;
  width: 50px;
  height: 50px;
  background: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow);
  cursor: pointer;
  z-index: 1001;
  transition: all 0.3s ease;
}

/* Flecha izquierda */
#back-arrow {
  left: 20px;
}
#back-arrow i {
  font-size: 32px;
  color: var(--primary);
}

/* Personita derecha (mismo estilo, pero con imagen) */
#menu-toggle {
  right: 20px;
}
#menu-toggle i {
  display: none; /* ocultamos el ícono anterior */
}
#menu-toggle {
  background-image: url('https://i.postimg.cc/h4Xj2nFV/white-profile-icon-app-logo-260nw-1932531338-(1).png');
  background-size: 58%;
  background-repeat: no-repeat;
  background-position: center;
  background-color: white;
}

/* Efecto hover igual para ambos */
#back-arrow:hover, #menu-toggle:hover {
  transform: scale(1.08);
  box-shadow: 0 12px 28px rgba(67, 97, 238, 0.25);
}
#menu-toggle:hover {
  border: 2px solid var(--primary);
}
      
      #menu {
        display: none;
        position: fixed;
        top: 80px;
        right: 20px;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        z-index: 1001;
        min-width: 200px;
      }
      #menu.active { display: block; }
      #menu button {
        width: 100%;
        padding: 16px 20px;
        border: none;
        background: none;
        text-align: left;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.2s;
      }
      #menu button:hover { background: #f1f5f9; }
      
      h2, h3 { text-align: center; color: var(--dark); margin: 20px 0; }
      
      /* TÍTULO "MIS PROPIEDADES" MÁS CHICO */
      h3 {
        text-align: center;
        color: var(--dark);
        margin: 20px 0;
        font-size: 1.4em;   /* antes era 2em */
        font-weight: 600;
      }
      
/* ==================== PANEL MI PLAN - VERSIÓN ULTRA COMPACTA ==================== */
#planContainer {
  background: white;
  margin: 100px auto 25px auto;     /* un poco más abajo */
  max-width: 360px;                /* mucho más estrecho → más corto a los costados */
  padding: 16px 18px;              /* padding mínimo para que quede apretadito */
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  text-align: center;
  border: 2.5px solid var(--primary);
  line-height: 1.3;                /* reduce el espacio entre líneas */
}

/* Tipo de plan / Vencimiento → más cerca */
#planStatus {
  font-weight: bold;
  font-size: 1em !important;   /* un poco más grande para destacar */
  margin: 4px 0 !important;        /* ¡muy poco espacio arriba y abajo! */
  color: var(--primary);
  line-height: 1.2;
}

/* Propiedades activas → casi pegado */
#limiteAlquileres {
  font-size: 1em;
  color: #555;
  margin: 6px 0 10px 0 !important; /* muy poco espacio */
  font-weight: 500;
}
      /* Botón más pequeño y pegado */
#btnPlan {
  background: var(--primary);
  color: white;
  border: none;
  padding: 10px 22px;             /* botón más compacto */
  border-radius: 50px;
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;                 /* casi pegado al texto de arriba */
  transition: all 0.3s ease;
}

#btnPlan:hover {
  background: #3651d4;
  transform: translateY(-2px);
}

/* ===================== NUEVO DISEÑO COMPACTO DE TARJETAS ===================== */
.prop-titulo {
  font-size: 1.22em;
  font-weight: 700;
  color: #222;
  margin: 0 0 10px 0;
  line-height: 1.3;
}

.prop-info {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 12px;
  font-size: 1.05em;
  font-weight: 600;
}

.info-tag {
  background: #e0e7ff;
  color: #4338ca;
  padding: 6px 14px;
  border-radius: 50px;
  font-size: 0.95em;
}

.info-tag.precio {
  background: #d1fae5;
  color: #065f46;
}

.info-tag.estado.activo {
  background: #dcfce7;
  color: #166534;
}

.info-tag.estado.inactivo {
  background: #fee2e2;
  color: #991b1b;
}

/* Tarjeta más compacta */
.alquiler {
  margin: 12px auto !important;
  max-width: 660px;
  padding: 18px 22px !important;
  border-radius: 18px;
  box-shadow: var(--shadow);
  background: white;
}

/* Quitar cualquier <br> viejo que quede */
.alquiler br { display: none !important; }
      
      .alquiler-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 16px; flex-wrap: wrap; gap: 10px; }
      .alquiler-actions-left button, .alquiler-actions-right button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 0.95em;
      }
      .alquiler-actions-right button { background: var(--danger); }
      .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
      .toggle-switch input { opacity: 0; width: 0; height: 0; }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      input:checked + .slider { background-color: var(--success); }
      input:checked + .slider:before { transform: translateX(26px); }
      .stats-inline {
        margin-top: 16px;
        padding: 14px;
        background: #fff8e1;
        border-radius: 12px;
        display: flex;
        justify-content: center;
        gap: 30px;
        flex-wrap: wrap;
        font-size: 1.1em;
      }
      .stats-item { display: flex; align-items: center; gap: 8px; font-weight: bold; color: #d97706; }
      .stats-item i { font-size: 1.2em; }

  /* ==================== BOTÓN "AGREGAR PROPIEDAD" MÁS PEQUEÑO Y ELEGANTE ==================== */
  #btnAgregarPropiedad {
    display: block;
    margin: 28px auto;
    background: var(--primary);
    color: white;
    border: none;
    padding: 11px 26px !important;     /* ← más pequeño que antes */
    border-radius: 50px;
    font-size: 1.15em !important;      /* ← texto un poco más chico */
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 6px 18px rgba(67, 97, 238, 0.35);
    transition: all 0.3s ease;
  }
  #btnAgregarPropiedad:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(67, 97, 238, 0.45);
  }
      
      #contactoBtn {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: #25D366;
        color: white;
        border: none;
        border-radius: 50%;
        width: 64px;
        height: 64px;
        font-size: 2em;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 999;
      }
      /* ==== SELECTOR MODERNO ==== */
      #seleccionPropiedad {
        display: none;
        margin: 30px auto;
        max-width: 750px;
        background: white;
        padding: 32px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        animation: fadeIn 0.4s;
      }
      #seleccionPropiedad.active { display: block; }
      .seleccion-container {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }
      .seleccion-group {
        position: relative;
      }
      .seleccion-group select {
        width: 100%;
        padding: 16px 16px 16px 48px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 18px;
        background: #f8fafc;
        cursor: pointer;
        transition: all 0.3s;
      }
      .seleccion-group select:focus {
        outline: none;
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.15);
      }
      .seleccion-group i {
        position: absolute;
        left: 16px;
        top: 18px;
        color: var(--gray);
        font-size: 20px;
        pointer-events: none;
      }
      .btn-continuar {
        width: 100%;
        padding: 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 1.3em;
        font-weight: bold;
        cursor: pointer;
        margin-top: 20px;
        transition: all 0.3s;
        box-shadow: 0 8px 20px rgba(67, 97, 238, 0.3);
      }
      .btn-continuar:hover {
        background: #3651d4;
        transform: translateY(-2px);
      }
      /* ==== FORMULARIOS MODERNOS ==== */
      [id^="formulario"] {
        display: none;
        margin: 30px auto;
        max-width: 750px;
        background: white;
        padding: 32px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        animation: fadeIn 0.4s;
        box-sizing: border-box;
      }
      [id^="formulario"].active { display: block; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      .form-group {
        position: relative;
        margin-bottom: 28px;
      }
      .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        padding: 14px 16px 14px 48px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s;
        background: #f8fafc;
      }
      .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 4px rgba(67,97,238,0.15);
      }
      .form-group label {
        position: absolute;
        top: -10px;
        left: 16px;
        background: white;
        padding: 0 8px;
        font-size: 14px;
        color: var(--primary);
        font-weight: 600;
      }
      .form-group i {
        position: absolute;
        left: 16px;
        top: 16px;
        color: var(--gray);
        font-size: 18px;
      }
      .form-group textarea { resize: vertical; min-height: 100px; }
      /* IMÁGENES Y VIDEOS AL LADO */
      .media-upload-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 28px;
      }
      @media (max-width: 600px) {
        .media-upload-container { grid-template-columns: 1fr; }
      }
      .file-upload {
        border: 2px dashed #cbd5e1;
        border-radius: 1212px;
        padding: 24px;
        text-align: center;
        background: #f8fafc;
        cursor: pointer;
        transition: all 0.3s;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .file-upload:hover { border-color: var(--primary); background: #eef2ff; }
      .file-upload input { display: none; }
      .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
        margin-top: 16px;
      }
      .preview-img-container, .preview-video-container {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }
      .preview-img, .preview-video { width: 100%; height: 100%; object-fit: cover; }
      .delete-img, .delete-video {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(239,68,68,0.9);
        color: white;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
      }
      .btn-guardar {
        width: 100%;
        padding: 18px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 1.4em;
        font-weight: bold;
        cursor: pointer;
        margin-top: 24px;
        transition: all 0.3s;
        box-shadow: 0 10px 25px rgba(67,97,238,0.3);
      }
      .btn-guardar:hover { background: #3651d4; transform: translateY(-3px); }
      .msg-estado {
        text-align: center;
        font-weight: bold;
        margin-top: 20px;
        padding: 14px;
        border-radius: 12px;
        font-size: 1.1em;
      }
      .estado-msg.success { background: #d1fae5; color: #065f46; }
      .estado-msg.error { background: #fee2e2; color: #991b1b; }
      .estado-msg.loading { background: #dbeafe; color: #1e40af; }
      .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
      .modal.active { display: flex; }
      .modal-content {
        background-color: white;
        margin: auto;
        padding: 24px;
        border-radius: var(--radius);
        width: 90%;
        max-width: 600px;
        position: relative;
        box-shadow: var(--shadow);
        max-height: 90vh;
        overflow-y: auto;
      }
      .close-modal { position: absolute; top: 12px; right: 16px; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
      .close-modal:hover { color: var(--danger); }
      .plan-card { background: #f8fafc; padding: 20px; border-radius: 12px; margin: 15px 0; text-align: center; border: 2px solid #e2e8f0; }
      .plan-card h3 { margin: 0 0 10px; color: var(--primary); }
      .plan-price { font-size: 1.8em; font-weight: bold; color: var(--dark); margin: 10px 0; }
      @media (max-width: 600px) {
        body { font-size: 20px; padding-top: 100px; }
        #seleccionPropiedad, [id^="formulario"] { padding: 20px; }
        .btn-guardar, .btn-continuar { font-size: 1.2em; padding: 16px; }
      }
    </style>
  </head>
  <body>
    <button id="back-arrow" onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i></button>
    <button id="menu-toggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
    <div id="menu">
      <button onclick="abrirModalEditarCuenta()">Editar Cuenta</button>
      <button onclick="logout()">Cerrar Sesión</button>
    </div>
    <header><div></div><img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="Logo Alqui Ya"><div></div></header>
    <div id="planContainer">
      <b>Mi plan</b>
      <div id="planStatus"></div>
      <span id="limiteAlquileres"></span>
      <button id="btnPlan" onclick="abrirModalPlan()">Mejorar Plan</button>
    </div>
    <h3>Mis Propiedades</h3>
    <div id="listaAlquileres">Cargando...</div>
    <button id="btnAgregarPropiedad" onclick="toggleOpcionesPropiedad()">Agregar Propiedad</button>
    <!-- SELECTOR MODERNO -->
    <div id="seleccionPropiedad">
      <h3 style="text-align:center; color:var(--primary); margin-bottom:32px;">
        <i class="fas fa-plus-circle"></i> Agregar Nueva Propiedad
      </h3>
      <div class="seleccion-container">
        <div class="seleccion-group">
          <i class="fas fa-tag"></i>
          <select id="tipoOperacion" onchange="actualizarTipoPropiedad()">
            <option value="">Selecciona tipo de operación</option>
            <option value="Vender">Vender</option>
            <option value="Alquilar">Alquilar</option>
          </select>
        </div>
        <div class="seleccion-group">
          <i class="fas fa-home"></i>
          <select id="tipoPropiedad">
            <option value="">Selecciona tipo de propiedad</option>
          </select>
        </div>
        <button class="btn-continuar" onclick="mostrarFormularioSeleccionado()">
          <i class="fas fa-arrow-right"></i> Continuar
        </button>
      </div>
    </div>
    <!-- ==================== TODOS LOS FORMULARIOS CON DISEÑO MODERNO ==================== -->
    <!-- 1. TERRENO -->
    <div id="formularioTerreno">
      <input type="hidden" id="editRowTerreno"><input type="hidden" id="enlaceCompartirTerreno"><input type="hidden" id="existingVideosTerreno">
      <h3 style="text-align:center; color:var(--primary); margin-bottom:24px;">Terreno en Venta</h3>
      <div class="form-group"><i class="fas fa-map-marker-alt"></i><input type="text" id="direccionTerreno" required><label>Dirección completa</label></div>
      <div class="form-group"><i class="fas fa-ruler-combined"></i><input type="number" id="superficieTerreno" required><label>Superficie (m²)</label></div>
      <div class="form-group"><i class="fas fa-dollar-sign"></i><input type="text" id="precioTerreno" required><label>Precio (USD)</label></div>
      <div class="media-upload-container">
        <div class="form-group">
          <label class="file-upload"><strong>Subir imágenes</strong><br><small>Múltiples permitidas</small><input type="file" id="imagenFileTerreno" accept="image/*" multiple></label>
          <div id="previewContainerTerreno" class="preview-grid"></div>
        </div>
        <div class="form-group">
          <label class="file-upload"><strong>Subir videos (opcional)</strong><input type="file" id="videoFileTerreno" accept="video/*" multiple></label>
          <div id="videoPreviewContainerTerreno" class="preview-grid"></div>
        </div>
      </div>
      <div class="form-group"><i class="fas fa-info-circle"></i><textarea id="infoIngresoTerreno"></textarea><label>Información de pago / contacto</label></div>
      <div class="form-group"><i class="fas fa-align-left"></i><textarea id="detallesTerreno"></textarea><label>Detalles adicionales</label></div>
      <button class="btn-guardar" onclick="agregarAlquiler('Terreno')">Publicar Terreno</button>
      <p id="msgTerreno" class="msg-estado"></p>
    </div>
    <!-- 2. CASA -->
    <div id="formularioCasa">
      <input type="hidden" id="editRowCasa"><input type="hidden" id="enlaceCompartirCasa"><input type="hidden" id="existingVideosCasa">
      <h3 style="text-align:center; color:var(--primary); margin-bottom:24px;">Casa en Venta</h3>
      <div class="form-group"><i class="fas fa-map-marker-alt"></i><input type="text" id="direccionCasa" required><label>Dirección completa</label></div>
      <div class="form-group"><i class="fas fa-bed"></i><input type="number" id="ambientesCasa" required><label>Número de ambientes</label></div>
      <div class="form-group"><i class="fas fa-dollar-sign"></i><input type="text" id="precioCasa" required><label>Precio (USD)</label></div>
      <div class="form-group"><i class="fas fa-tree"></i><select id="patioCasa"><option>Sí</option><option>No</option></select><label>¿Tiene patio?</label></div>
      <div class="form-group"><i class="fas fa-car"></i><select id="garageCasa"><option>Sí</option><option>No</option></select><label>¿Tiene garage?</label></div>
      <div class="form-group"><i class="fas fa-calendar"></i><input type="number" id="antiguedadCasa"><label>Antigüedad (años)</label></div>
      <div class="media-upload-container">
        <div class="form-group"><label class="file-upload"><strong>Subir imágenes</strong><input type="file" id="imagenFileCasa" accept="image/*" multiple></label><div id="previewContainerCasa" class="preview-grid"></div></div>
        <div class="form-group"><label class="file-upload"><strong>Subir videos</strong><input type="file" id="videoFileCasa" accept="video/*" multiple></label><div id="videoPreviewContainerCasa" class="preview-grid"></div></div>
      </div>
      <div class="form-group"><i class="fas fa-info-circle"></i><textarea id="infoIngresoCasa"></textarea><label>Información de pago</label></div>
      <div class="form-group"><i class="fas fa-align-left"></i><textarea id="detallesCasa"></textarea><label>Otros detalles</label></div>
      <button class="btn-guardar" onclick="agregarAlquiler('Casa')">Publicar Casa</button>
      <p id="msgCasa" class="msg-estado"></p>
    </div>
    <!-- 3. DEPARTAMENTO -->
    <div id="formularioDepartamento">
      <input type="hidden" id="editRowDepartamento"><input type="hidden" id="enlaceCompartirDepartamento"><input type="hidden" id="existingVideosDepartamento">
      <h3 style="text-align:center; color:var(--primary); margin-bottom:24px;">Departamento</h3>
      <div class="form-group"><i class="fas fa-map-marker-alt"></i><input type="text" id="direccionDepartamento" required><label>Dirección completa</label></div>
      <div class="form-group"><i class="fas fa-bed"></i><input type="number" id="ambientesDepartamento" required><label>Número de ambientes</label></div>
      <div class="form-group"><i class="fas fa-dollar-sign"></i><input type="text" id="precioDepartamento" required><label>Precio (USD)</label></div>
      <div class="form-group"><i class="fas fa-paw"></i><select id="mascotasDepartamento"><option>Sí</option><option>No</option></select><label>¿Mascotas permitidas?</label></div>
      <div class="form-group"><i class="fas fa-couch"></i><select id="amobladoDepartamento"><option>Sí</option><option>No</option></select><label>¿Amoblado?</label></div>
      <div class="media-upload-container">
        <div class="form-group"><label class="file-upload"><strong>Subir imágenes</strong><input type="file" id="imagenFileDepartamento" accept="image/*" multiple></label><div id="previewContainerDepartamento" class="preview-grid"></div></div>
        <div class="form-group"><label class="file-upload"><strong>Subir videos</strong><input type="file" id="videoFileDepartamento" accept="video/*" multiple></label><div id="videoPreviewContainerDepartamento" class="preview-grid"></div></div>
      </div>
      <div class="form-group"><i class="fas fa-info-circle"></i><textarea id="infoIngresoDepartamento"></textarea><label>Información de pago</label></div>
      <div class="form-group"><i class="fas fa-align-left"></i><textarea id="detallesDepartamento"></textarea><label>Otros detalles</label></div>
      <button class="btn-guardar" onclick="agregarAlquiler('Departamento')">Publicar Departamento</button>
      <p id="msgDepartamento" class="msg-estado"></p>
    </div>
    <!-- 4. LOCAL COMERCIAL -->
    <div id="formularioLocal">
      <input type="hidden" id="editRowLocal"><input type="hidden" id="enlaceCompartirLocal"><input type="hidden" id="existingVideosLocal">
      <h3 style="text-align:center; color:var(--primary); margin-bottom:24px;">Local Comercial</h3>
      <div class="form-group"><i class="fas fa-map-marker-alt"></i><input type="text" id="direccionLocal" required><label>Dirección completa</label></div>
      <div class="media-upload-container">
        <div class="form-group"><label class="file-upload"><strong>Subir imágenes</strong><input type="file" id="imagenFileLocal" accept="image/*" multiple></label><div id="previewContainerLocal" class="preview-grid"></div></div>
        <div class="form-group"><label class="file-upload"><strong>Subir videos</strong><input type="file" id="videoFileLocal" accept="video/*" multiple></label><div id="videoPreviewContainerLocal" class="preview-grid"></div></div>
      </div>
      <div class="form-group"><i class="fas fa-info-circle"></i><textarea id="infoIngresoLocal"></textarea><label>Información de ingreso</label></div>
      <div class="form-group"><i class="fas fa-align-left"></i><textarea id="detallesLocal"></textarea><label>Detalles adicionales</label></div>
      <button class="btn-guardar" onclick="agregarAlquiler('Local')">Publicar Local</button>
      <p id="msgLocal" class="msg-estado"></p>
    </div>
    <!-- 5. TEMPORARIO -->
    <div id="formularioTemporario">
      <input type="hidden" id="editRowTemporario"><input type="hidden" id="enlaceCompartirTemporario"><input type="hidden" id="existingVideosTemporario">
      <h3 style="text-align:center; color:var(--primary); margin-bottom:24px;">Alquiler Temporario</h3>
      <div class="form-group"><i class="fas fa-map-marker-alt"></i><input type="text" id="direccionTemporario" required><label>Dirección completa</label></div>
      <div class="media-upload-container">
        <div class="form-group"><label class="file-upload"><strong>Subir imágenes</strong><input type="file" id="imagenFileTemporario" accept="image/*" multiple></label><div id="previewContainerTemporario" class="preview-grid"></div></div>
        <div class="form-group"><label class="file-upload"><strong>Subir videos</strong><input type="file" id="videoFileTemporario" accept="video/*" multiple></label><div id="videoPreviewContainerTemporario" class="preview-grid"></div></div>
      </div>
      <div class="form-group"><i class="fas fa-info-circle"></i><textarea id="infoIngresoTemporario"></textarea><label>Información de ingreso</label></div>
      <div class="form-group"><i class="fas fa-align-left"></i><textarea id="detallesTemporario"></textarea><label>Detalles adicionales</label></div>
      <button class="btn-guardar" onclick="agregarAlquiler('Temporario')">Publicar Temporario</button>
      <p id="msgTemporario" class="msg-estado"></p>
    </div>
    <!-- MODAL DE PLANES - ACTUALIZADO -->
    <div id="modalPlan" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="cerrarModalPlan()">&times;</span>
        <h2 style="text-align:center; margin-bottom:20px;">Elige tu Plan</h2>
        <div class="plan-card">
          <h3>Plan Básico</h3>
          <div class="plan-price" id="precioBasico">Cargando...</div>
          <ul class="plan-features">
            <li>1 propiedad activa</li>
            <li>Publicación en el mapa</li>
            <li>Soporte básico</li>
          </ul>
          <div id="mpBtnBasico"></div>
          <button style="margin-top:10px; padding:12px 24px; background:var(--primary); color:white; border:none; border-radius:50px; cursor:pointer;" onclick="seleccionarPlan('Basico')">Pagar con Mercado Pago</button>
        </div>
        <div class="plan-card">
          <h3>Plan Plus</h3>
          <div class="plan-price" id="precioPlus">Cargando...</div>
          <ul class="plan-features">
            <li>Hasta 3 propiedades activas</li>
            <li>Destacado en búsquedas</li>
            <li>Soporte prioritario</li>
          </ul>
          <div id="mpBtnPlus"></div>
          <button style="margin-top:10px; padding:12px 24px; background:var(--primary); color:white; border:none; border-radius:50px; cursor:pointer;" onclick="seleccionarPlan('Plus')">Pagar con Mercado Pago</button>
        </div>
        <div class="plan-card">
          <h3>Plan Full</h3>
          <div class="plan-price" id="precioFull">Cargando...</div>
          <ul class="plan-features">
            <li>Hasta 5 propiedades activas</li>
            <li>Máxima visibilidad</li>
            <li>Soporte 24/7 + WhatsApp directo</li>
          </ul>
          <div id="mpBtnFull"></div>
          <button style="margin-top:10px; padding:12px 24px; background:var(--primary); color:white; border:none; border-radius:50px; cursor:pointer;" onclick="seleccionarPlan('Full')">Pagar con Mercado Pago</button>
        </div>
        <div class="plan-card" style="border: 3px solid var(--primary);">
          <h3>Plan Inmobiliario</h3>
          <div class="plan-price" id="precioInmobiliario">Cargando...</div>
          <ul class="plan-features">
            <li>Propiedades ilimitadas</li>
            <li>Todas las funciones premium</li>
            <li>Soporte dedicado</li>
          </ul>
          <div id="mpBtnInmobiliario"></div>
          <button style="margin-top:10px; padding:12px 24px; background:var(--primary); color:white; border:none; border-radius:50px; cursor:pointer;" onclick="seleccionarPlan('Inmobiliario')">Pagar con Mercado Pago</button>
        </div>
      </div>
    </div>
    <!-- MODAL EDITAR CUENTA - AHORA COMPLETO Y FUNCIONAL -->
    <div id="modalEditarCuenta" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="cerrarModalEditarCuenta()">&times;</span>
        <h2 style="text-align:center; margin-bottom:20px;">Editar mi cuenta</h2>
        <label>Email</label>
        <input type="email" id="emailEditar" placeholder="Nuevo email (opcional)">
        <label>Nombre</label>
        <input type="text" id="nombreEditar" placeholder="Tu nombre">
        <label>Teléfono</label>
        <div style="display:flex; gap:5px;">
          <select id="codigoPaisEditar" style="width:100px;">
            <option value="+549">+549</option>
            <option value="+54">+54</option>
            <option value="+55">+55</option>
            <option value="+598">+598</option>
          </select>
          <input type="text" id="contactoEditar" placeholder="Número sin 15 ni 0">
        </div>
        <label>Contraseña</label>
        <div style="position:relative;">
          <input type="password" id="passwordEditar" placeholder="Nueva contraseña (mín. 6 caracteres)">
          <button type="button" class="toggle-password" onclick="togglePasswordVisibility()" style="position:absolute; right:10px; top:10px; background:none; border:none; cursor:pointer; color:var(--primary);">
            Mostrar
          </button>
        </div>
        <button onclick="editarCuenta()" style="margin-top:20px; width:100%; padding:14px; background:var(--primary); color:white; border:none; border-radius:50px; font-size:1.1em; cursor:pointer;">
          Guardar Cambios
        </button>
        <p id="msgEditarCuenta" style="text-align:center; margin-top:15px; font-weight:bold;"></p>
      </div>
    </div>
    <div id="modalEstadisticas"><div class="modal-content">...</div></div>
    <button id="contactoBtn" title="¿Necesitas ayuda?" onclick="window.open('https://wa.me/5493764275443', '_blank')">
      <i class="fab fa-whatsapp"></i>
    </button>
<script>
// === CONSTANTES Y VARIABLES ===
const API_URL = "https://script.google.com/macros/s/AKfycbyFvDRwPZoG6ChhvcxGm6B27ziD6Qkg4RcH0TI9K59b7zPz7iFxy7mgmbs5mo5T-TxD/exec";
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dnugmwern/image/upload";
const CLOUDINARY_UPLOAD_PRESET = "preset_alquileres";
const GEOCODE_KEY = "AIzaSyAisqYSTfpQ_rqqutAomzitD2v_dtKYtLE";
const MP_BEARER = "APP_USR-595288641172928-010710-d915bce4137b3ee26e0c6e04873f1ac1-695835795";
let imagenesBase64 = { Departamento: [], Local: [], Temporario: [], Terreno: [], Casa: [] };
let videosBase64 = { Departamento: [], Local: [], Temporario: [], Terreno: [], Casa: [] };
let planActual = null;
let limiteDeptos = 0;
let deptosActivos = 0;
let preciosPlanes = {Basico: 0, Plus: 0, Full: 0, Inmobiliario: 0};
function mostrarAlquileres(res) {
  const div = document.getElementById("listaAlquileres");
  div.innerHTML = "";
  if (!res.success || !res.data || res.data.length === 0) {
    div.innerHTML = "<p style='font-size:1.6em; color:#666; text-align:center;'>No tienes propiedades aún.</p>";
    return;
  }
  deptosActivos = res.data.filter(a => a.Estado === "Activo").length;
  document.getElementById("limiteAlquileres").textContent =
    planActual === "Prueba" ? `${deptosActivos} propiedades activas` :
    `${deptosActivos}/${limiteDeptos} propiedades activas`;
  res.data.forEach(alq => {
    let estado = alq.Estado === "Activo";
    let idPropiedad = alq[13] || alq.ID || alq.row;
    // Solo mostramos Precio y Tipo (A) / Subtipo (R)
    let precioFormateado = (alq.Tipo === "Departamento" || alq.Tipo === "Terreno" || alq.Tipo === "Casa")
      ? formatoPrecio(alq.Precio) : "";
    let tipoDisplay = alq.Tipo;
    if (alq.Operacion === "Alquilar") tipoDisplay += " (A)";
    if (alq.Operacion === "Vender") tipoDisplay += " (R)";
    let vistas = parseInt(alq.Vistas || alq[18] || 0) || 0;
    let contactos = parseInt(alq.Consultas || alq.contactos || alq.Contactos || alq[19] || 0) || 0;
    const statsHTML = `<div class="stats-inline">
      <div class="stats-item"><i class="fa-solid fa-eye"></i><span class="stats-number">${vistas}</span> vistas</div>
      <div class="stats-item"><i class="fa-solid fa-phone"></i><span class="stats-number">${contactos}</span> contactos</div>
    </div>`;
    div.innerHTML += `<div class="alquiler">
  <!-- TÍTULO: DIRECCIÓN -->
  <div class="prop-titulo">
    ${alq.Direccion || alq.direccion || "Sin dirección"}
  </div>

  <!-- INFORMACIÓN EN LÍNEA: Operación • Precio • Estado -->
  <div class="prop-info">
    <span class="info-tag operacion">
      ${alq.Operacion === "Vender" ? "Venta" : "Alquiler"}
    </span>
    ${precioFormateado ? 
      `<span class="info-tag precio">${precioFormateado}</span>` : 
      '<span class="info-tag precio">Consultar</span>'
    }
    <span class="info-tag estado ${estado ? "activo" : "inactivo"}">
      ${estado ? "Activo" : "Inactivo"}
    </span>
  </div>

  <!-- Estadísticas -->
  ${statsHTML}

  <!-- Botones de acción -->
  <div class="alquiler-actions">
    <div class="alquiler-actions-left">
      <button class="copy-share-btn" data-id="${idPropiedad}">Copiar enlace</button>
      <button onclick='editarAlquiler(${alq.row}, ${JSON.stringify(alq)})'>Editar</button>
    </div>
    <div class="alquiler-actions-right">
      <button onclick="eliminarAlquiler(${alq.row})">Eliminar</button>
      <label class="toggle-switch">
        <input type="checkbox" ${estado ? "checked" : ""} onchange="cambiarEstado(${alq.row}, '${alq.Estado}')">
        <span class="slider"></span>
      </label>
    </div>
  </div>
  <span id="estadoMsg-${alq.row}" class="estado-msg"></span>
</div>`;
  });
  document.querySelectorAll('.copy-share-btn').forEach(btn => {
    btn.onclick = function () {
      const idPropiedad = this.getAttribute('data-id');
      const url = `https://www.alquiya.com.ar/propiedad.html?id=${idPropiedad}`;
      fetch(`${API_URL}?action=generarEnlaceCompartido&id=${idPropiedad}`, {method: 'GET', mode: 'no-cors'}).catch(() => {});
      navigator.clipboard.writeText(url).then(() => {
        const textoOriginal = this.innerHTML;
        this.innerHTML = "Enlace copiado";
        this.style.background = "#10b981";
        setTimeout(() => { this.innerHTML = textoOriginal; this.style.background = ""; }, 2000);
      }).catch(() => alert('Enlace (copia manual):\n' + url));
    };
  });
}
function cargarAlquileres() {
  const email = localStorage.getItem("dueno");
  const script = document.createElement("script");
  script.src = `${API_URL}?action=getAlquileresDueno&dueno=${encodeURIComponent(email)}&callback=mostrarAlquileres`;
  document.body.appendChild(script);
}
function initGoogleCharts() {
  console.log('Inicializando Google Charts...');
  if (typeof google === 'undefined' || !google.charts) {
    console.log('Google Charts no disponible, reintentando en 500ms...');
    setTimeout(initGoogleCharts, 500);
    return;
  }
  google.charts.load('current', { packages: ['corechart'] });
  google.charts.setOnLoadCallback(() => {
    console.log('GOOGLE CHARTS CARGADO COMPLETAMENTE');
    window.googleChartsReady = true;
  });
}
window.mostrarModalEstadisticasCallback = function(data, idPropiedad) {
  let datosParaModal = { propiedad: { direccion: `Propiedad ID: ${idPropiedad}` }, metricas: { vistas: 0, contactos: 0 } };
  if (data && data.success && data.vistas !== undefined && data.consultas !== undefined) {
    datosParaModal.metricas.vistas = parseInt(data.vistas) || 0;
    datosParaModal.metricas.contactos = parseInt(data.consultas) || 0;
  }
  mostrarModalEstadisticas(datosParaModal);
};
function usarJSONP(idPropiedad, callbackName) {
  return new Promise((resolve, reject) => {
    callbackName = callbackName || 'jsonp_' + Date.now();
    window[callbackName] = function(data) {
      delete window[callbackName];
      const script = document.querySelector(`script[src*="${callbackName}"]`);
      if (script) script.remove();
      resolve(data);
    };
    const script = document.createElement('script');
    script.src = `${API_URL}?action=getvistasconsultas&id=${idPropiedad}&callback=${callbackName}`;
    script.onerror = () => {
      delete window[callbackName];
      script.remove();
      reject(new Error('JSONP falló'));
    };
    document.body.appendChild(script);
  });
}
function solicitarMetricas(idPropiedad, propId, retryCount = 0) {
  if (typeof google === 'undefined' || !google.charts || !window.googleChartsReady) {
    if (retryCount < 10) {
      setTimeout(() => solicitarMetricas(idPropiedad, propId, retryCount + 1), 500);
      return;
    } else {
      mostrarErrorMetricas(propId);
      return;
    }
  }
  const callbackName = 'metricasCallback_' + Date.now();
  usarJSONP(idPropiedad, callbackName)
    .then(datos => mostrarModalEstadisticasCallback(datos, propId))
    .catch(() => mostrarErrorMetricas(propId));
}
function mostrarErrorMetricas(propId) {
  const datosParaModal = { propiedad: { direccion: `Propiedad ID: ${propId}` }, metricas: { vistas: 0, contactos: 0 } };
  mostrarModalEstadisticas(datosParaModal);
  document.getElementById("msgEstadisticas").style.color = "orange";
  document.getElementById("msgEstadisticas").textContent = "Sin datos aún - ¡Comparte tu propiedad!";
}
function mostrarModalEstadisticas(data) {
  document.getElementById('modal-titulo').textContent = `Estadísticas - ${data.propiedad.direccion}`;
  document.getElementById('modal-vistas').textContent = data.metricas.vistas || 0;
  document.getElementById('modal-contactos').textContent = data.metricas.contactos || 0;
  document.getElementById("modalEstadisticas").style.display = "block";
  document.getElementById("msgEstadisticas").style.color = "green";
  document.getElementById("msgEstadisticas").textContent = "Estadísticas cargadas correctamente";
}
function cerrarModalEstadisticas() {
  document.getElementById("modalEstadisticas").style.display = "none";
  document.getElementById("msgEstadisticas").textContent = "";
}
function formatoPrecio(valor) {
  if (!valor) return "";
  valor = valor.toString().replace(/\D/g, "");
  return "$" + valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
function inicializarFormatoPrecio(tipo) {
  document.getElementById(`precio${tipo}`).addEventListener("input", function(e) {
    const cursorPos = this.selectionStart;
    const valorSinSimbolo = this.value.replace(/\D/g, '');
    const formattedValue = formatoPrecio(valorSinSimbolo);
    const prevLength = this.value.length;
    this.value = formattedValue;
    const newLength = formattedValue.length;
    const diff = newLength - prevLength;
    this.selectionStart = cursorPos + diff;
    this.selectionEnd = cursorPos + diff;
  });
}
function formatoPrecioPlan(valor) {
  if (!valor) return "$0,00";
  const numero = parseFloat(valor);
  if (isNaN(numero)) return "$0,00";
  const entero = Math.floor(numero);
  const decimal = Math.round((numero - entero) * 100).toString().padStart(2, "0");
  const enteroFormateado = entero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  return `$${enteroFormateado},${decimal}`;
}
function formatoFecha(fecha) {
  if (fecha === "N/D") return fecha;
  const partes = fecha.split("/");
  if (partes.length !== 3) return fecha;
  const [dia, mes, anio] = partes;
  return `${parseInt(dia, 10)}/${parseInt(mes, 10)}/${anio}`;
}
function actualizarPreview(tipo) {
  const previewContainer = document.getElementById(`previewContainer${tipo}`);
  previewContainer.innerHTML = "";
  imagenesBase64[tipo].forEach((imgBase64, index) => {
    const container = document.createElement("div");
    container.className = "preview-img-container";
    const img = document.createElement("img");
    img.src = imgBase64;
    img.className = "preview-img";
    const btnDel = document.createElement("button");
    btnDel.className = "delete-img";
    btnDel.textContent = "x";
    btnDel.onclick = () => { imagenesBase64[tipo].splice(index, 1); actualizarPreview(tipo); };
    container.appendChild(img);
    container.appendChild(btnDel);
    previewContainer.appendChild(container);
  });
}
function inicializarPreviewImagenes(tipo) {
  document.getElementById(`imagenFile${tipo}`).addEventListener("change", function() {
    const files = Array.from(this.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        imagenesBase64[tipo].push(e.target.result);
        actualizarPreview(tipo);
      }
      reader.readAsDataURL(file);
    });
  });
}
function actualizarVideoPreview(tipo) {
  const videoPreviewContainer = document.getElementById(`videoPreviewContainer${tipo}`);
  videoPreviewContainer.innerHTML = "";
  videosBase64[tipo].forEach((videoBase64, index) => {
    const container = document.createElement("div");
    container.className = "preview-video-container";
    const video = document.createElement("video");
    video.src = videoBase64;
    video.className = "preview-video";
    video.controls = true;
    const btnDel = document.createElement("button");
    btnDel.className = "delete-video";
    btnDel.textContent = "x";
    btnDel.onclick = () => { videosBase64[tipo].splice(index, 1); actualizarVideoPreview(tipo); };
    container.appendChild(video);
    container.appendChild(btnDel);
    videoPreviewContainer.appendChild(container);
  });
}
function inicializarPreviewVideos(tipo) {
  document.getElementById(`videoFile${tipo}`).addEventListener("change", function() {
    const files = Array.from(this.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        videosBase64[tipo].push(e.target.result);
        actualizarVideoPreview(tipo);
      }
      reader.readAsDataURL(file);
    });
  });
}
async function subirImagenCloudinary(file) {
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
  try {
    const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
    const json = await res.json();
    return json.secure_url;
  } catch (err) {
    console.error("Error subiendo imagen a Cloudinary:", err);
    return null;
  }
}
async function subirVideoMux(videoFile, row, tipo) {
  const msgEl = document.getElementById(`msg${tipo}`);
  try {
    const base64Video = await fileToBase64(videoFile);
    const response = await fetch(API_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'uploadVideoMux', video: base64Video, row: row })
    });
    if (!response.ok) throw new Error(`Error HTTP! Estado: ${response.status}`);
    const result = await response.json();
    if (result.success) return result.videoUrl;
    else throw new Error(result.error || 'Error desconocido al subir el video');
  } catch (error) {
    console.error('Error subiendo video a Mux:', error.message);
    msgEl.className = "estado-msg error";
    msgEl.textContent = `Error al subir video: ${error.message}`;
    setTimeout(() => { msgEl.textContent = ""; }, 5000);
    throw error;
  }
}
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(new Error('Error al convertir el video a base64'));
    reader.readAsDataURL(file);
  });
}
function toggleMenu() {
  const menu = document.getElementById("menu");
  menu.classList.toggle("active");
}
function toggleOpcionesPropiedad() {
        const selector = document.getElementById("seleccionPropiedad");
        const btn = document.getElementById("btnAgregarPropiedad");
        if (!selector || !btn) return; // Seguridad
        if (selector.classList.contains("active")) {
          selector.classList.remove("active");
          btn.textContent = "Agregar Propiedad";
          resetAllForms();
        } else {
          selector.classList.add("active");
          btn.textContent = "Cerrar";
          document.getElementById("tipoOperacion").value = "";
          document.getElementById("tipoPropiedad").innerHTML = '<option value="">Selecciona tipo de propiedad</option>';
        }
}
function mostrarOpcionesPorOperacion() {
  const tipoOperacion = document.getElementById("tipoOperacion").value;
  const opcionesVenta = document.getElementById("opcionesVenta");
  const opcionesAlquiler = document.getElementById("opcionesAlquiler");
  if (tipoOperacion === "Vender") {
    opcionesVenta.classList.add("active");
    opcionesAlquiler.classList.remove("active");
  } else {
    opcionesAlquiler.classList.add("active");
    opcionesVenta.classList.remove("active");
  }
}
function mostrarFormulario(tipo) {
  const formularios = ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'];
  formularios.forEach(f => document.getElementById(`formulario${f}`).classList.remove("active"));
  document.getElementById(`formulario${tipo}`).classList.add("active");
  document.getElementById("btnAgregarPropiedad").textContent = "Cerrar Opciones";
  window.scrollTo(0, document.getElementById(`formulario${tipo}`).offsetTop);
}
window.onload = function() {
  initGoogleCharts();
  const email = localStorage.getItem("dueno");
  if (!email) { window.location.href = "index.html"; return; }
  cargarEstadoPlan();
  cargarAlquileres();
  cargarPreciosPlanes();
  cargarDatosCuenta();
  checkPaymentOnReturn();
  ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'].forEach(tipo => {
    inicializarPreviewImagenes(tipo);
    inicializarPreviewVideos(tipo);
    if (tipo === 'Departamento' || tipo === 'Terreno' || tipo === 'Casa') inicializarFormatoPrecio(tipo);
  });
  document.getElementById("tipoOperacion").addEventListener("change", mostrarOpcionesPorOperacion);
}
async function checkPaymentOnReturn() {
const urlParams = new URLSearchParams(window.location.search);
const status = urlParams.get("status");
const paymentId = urlParams.get("payment_id");
const planStatusEl = document.getElementById("planStatus");
if (status && paymentId) {
planStatusEl.innerHTML = `<span class="estado-msg loading">Verificando estado del pago...</span>`;
try {
const response = await fetch(`https://api.mercadopago.com/v1/payments/${paymentId}`, {
method: "GET",
headers: { "Authorization": "Bearer " + MP_BEARER }
});
const paymentData = await response.json();
if (response.ok && paymentData.status === "approved") {
const [email, plan] = paymentData.external_reference.split("_");
const script = document.createElement("script");
script.src = `${API_URL}?action=updatePlan&email=${encodeURIComponent(email)}&plan=${plan}&payment_id=${paymentId}&estadoPago=Aprobado&descripcionPago=Pago%20plan%20${plan}%20-%20ID:%20${paymentId}&callback=planActualizado`;
document.body.appendChild(script);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">Pago no aprobado. Estado: ${paymentData.status || "Desconocido"}.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
} catch (err) {
console.error("Error verificando pago:", err);
planStatusEl.innerHTML = `<span class="estado-msg error">Error al verificar el pago. Por favor, intenta de nuevo.</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
window.history.replaceState({}, document.title, window.location.pathname);
}
}
function cargarPreciosPlanes() {
const script = document.createElement("script");
script.src = `${API_URL}?action=getPlanes&callback=mostrarPreciosPlanes`;
document.body.appendChild(script);
}
function mostrarPreciosPlanes(res) {
  if (res.success && res.data && res.data.length) {
    res.data.forEach(plan => {
      preciosPlanes[plan.nombre] = parseFloat(plan.precio) || 0;
    });
    document.getElementById("precioBasico").textContent = formatoPrecioPlan(preciosPlanes.Basico) + " / mes";
    document.getElementById("precioPlus").textContent = formatoPrecioPlan(preciosPlanes.Plus) + " / mes";
    document.getElementById("precioFull").textContent = formatoPrecioPlan(preciosPlanes.Full) + " / mes";
    document.getElementById("precioInmobiliario").textContent = formatoPrecioPlan(preciosPlanes.Inmobiliario || 0) + " / mes";
  }
}
function cargarEstadoPlan() {
const email = localStorage.getItem("dueno");
const script = document.createElement("script");
script.src = `${API_URL}?action=getLoginInfo&email=${encodeURIComponent(email)}&callback=mostrarEstadoPlan`;
document.body.appendChild(script);
}
function mostrarEstadoPlan(res) {
  const planStatusEl = document.getElementById("planStatus");
 
  if (!res.success || !res.data || !res.data[0]) {
    planActual = null;
    limiteDeptos = 0;
    planStatusEl.innerHTML = `Plan: <b>Sin plan</b> | Estado de Pago: N/D | Vencimiento: N/D`;
    document.getElementById("btnPlan").textContent = "Elegir Plan";
    document.getElementById("limiteAlquileres").textContent = "";
    return;
  }
  const login = res.data[0];
  planActual = login.Plan || null;
  // NUEVA LÓGICA DE LÍMITES SEGÚN TUS REQUISITOS
  if (planActual === "Basico") {
    limiteDeptos = 1;
  } else if (planActual === "Plus") {
    limiteDeptos = 3;
  } else if (planActual === "Full") {
    limiteDeptos = 5;
  } else if (planActual === "Inmobiliario") {
    limiteDeptos = Infinity; // Sin límite
  } else if (planActual === "Prueba") {
    limiteDeptos = Infinity; // Durante el período de prueba
  } else {
    limiteDeptos = 0;
  }
  const estadoPago = login.EstadoPago || "No registrado";
  const vencimiento = formatoFecha(login.Vencimiento || "N/D");
  let planStatusHTML = `Plan: <b>${planActual || "Sin plan"}</b> | Vencimiento: ${vencimiento}`;
  // Mensajes especiales si el plan está vencido o es prueba
  if (planActual === "Prueba" && vencimiento !== "N/D") {
    const vencimientoDate = new Date(vencimiento.split("/").reverse().join("-"));
    const today = new Date();
    const diffTime = vencimientoDate - today;
    const diasRestantes = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    if (diasRestantes > 0) {
      planStatusHTML += `<br><span style="color:#00FF00; font-weight:bold;">Te quedan ${diasRestantes} días GRATIS con el Plan Prueba</span>`;
    } else {
      planStatusHTML += `<br><span style="color:red; font-weight:bold;">Plan Prueba vencido. Tus propiedades no se mostrarán hasta activar un plan pago.</span>`;
    }
  }
  else if (vencimiento !== "N/D") {
    const vencimientoDate = new Date(vencimiento.split("/").reverse().join("-"));
    const today = new Date();
    if (vencimientoDate < today && planActual !== "Prueba") {
      planStatusHTML += `<br><span style="color:red; font-weight:bold;">Plan vencido. Renueva para seguir publicando.</span>`;
    }
  }
  planStatusEl.innerHTML = planStatusHTML;
  // Texto del límite de propiedades (actualizado)
  if (planActual === "Prueba" || planActual === "Inmobiliario") {
    document.getElementById("limiteAlquileres").textContent = `${deptosActivos} propiedades activas`;
  } else if (planActual) {
    document.getElementById("limiteAlquileres").textContent = `${deptosActivos}/${limiteDeptos} propiedades activas`;
  } else {
    document.getElementById("limiteAlquileres").textContent = "0 propiedades activas";
  }
  // Cambiar texto del botón
  document.getElementById("btnPlan").textContent = planActual ? "Mejorar Plan" : "Elegir Plan";
}
function abrirModalPlan() {
  document.getElementById("modalPlan").style.display = "flex";
}
function cerrarModalPlan() {
  document.getElementById("modalPlan").style.display = "none";
  document.getElementById("mpBtnBasico").innerHTML = "";
  document.getElementById("mpBtnPlus").innerHTML = "";
  document.getElementById("mpBtnFull").innerHTML = "";
}
async function seleccionarPlan(plan, retries = 3) {
  const email = localStorage.getItem("dueno");
  const precio = preciosPlanes[plan] || 0;
  const planStatusEl = document.getElementById("planStatus");
  if (precio === 0 && plan !== "Inmobiliario") {
    planStatusEl.innerHTML = `<span class="estado-msg error">Error: precio del plan ${plan} no cargado aún.</span>`;
    setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
    return;
  }
  planStatusEl.innerHTML = `<span class="estado-msg loading">Procesando pago del Plan ${plan}...</span>`;
  const preferenceData = {
    items: [{
      title: `Plan ${plan} - AlquiYa`,
      quantity: 1,
      unit_price: parseFloat(precio),
      currency_id: "ARS"
    }],
    payer: { email: email },
    external_reference: email + "_" + plan,
    back_urls: {
      success: window.location.href,
      failure: window.location.href,
      pending: window.location.href
    },
    auto_return: "approved",
    notification_url: `${API_URL}?action=updatePlan`
  };
  try {
    const response = await fetch("https://api.mercadopago.com/checkout/preferences", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + MP_BEARER,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(preferenceData)
    });
    const res = await response.json();
    if (res.init_point) {
      const mpContainer = document.getElementById("mpBtn" + plan);
      mpContainer.innerHTML = `<iframe src="${res.init_point}" width="100%" height="650" frameborder="0" allowtransparency="true" style="border-radius:12px;"></iframe>`;
     
      planStatusEl.innerHTML = `<span class="estado-msg loading">Redirigiendo al pago... Completa el proceso en la ventana de Mercado Pago.</span>`;
    } else {
      console.error("Error al crear preferencia de Mercado Pago:", res);
      if (retries > 0) {
        setTimeout(() => seleccionarPlan(plan, retries - 1), 2000);
      } else {
        planStatusEl.innerHTML = `<span class="estado-msg error">No se pudo generar el botón de pago. Intenta de nuevo.</span>`;
        setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 6000);
      }
    }
  } catch (err) {
    console.error("Error en la solicitud a Mercado Pago:", err);
    if (retries > 0) {
      setTimeout(() => seleccionarPlan(plan, retries - 1), 2000);
    } else {
      planStatusEl.innerHTML = `<span class="estado-msg error">Error de conexión con Mercado Pago. Reintentando...</span>`;
      setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 6000);
    }
  }
}
function planActualizado(res) {
const planStatusEl = document.getElementById("planStatus");
if (res.success) {
planStatusEl.innerHTML = `<span class="estado-msg success">Plan actualizado con éxito: ${res.plan}</span>`;
setTimeout(() => {
planStatusEl.innerHTML = "";
cargarEstadoPlan();
cargarAlquileres();
cerrarModalPlan();
}, 3000);
} else {
planStatusEl.innerHTML = `<span class="estado-msg error">Error al actualizar el plan: ${res.error || "desconocido"}</span>`;
setTimeout(() => { planStatusEl.innerHTML = ""; cargarEstadoPlan(); }, 5000);
}
}
function cargarAlquileres() {
const email = localStorage.getItem("dueno");
const script = document.createElement("script");
script.src = `${API_URL}?action=getAlquileresDueno&dueno=${encodeURIComponent(email)}&callback=mostrarAlquileres`;
document.body.appendChild(script);
}
function toggleOpcionesPropiedad() {
        const selector = document.getElementById("seleccionPropiedad");
        const btn = document.getElementById("btnAgregarPropiedad");
        if (!selector || !btn) return;
        if (selector.classList.contains("active")) {
          selector.classList.remove("active");
          btn.textContent = "Agregar Propiedad";
          resetAllForms();
        } else {
          selector.classList.add("active");
          btn.textContent = "Cerrar";
          document.getElementById("tipoOperacion").value = "";
          document.getElementById("tipoPropiedad").innerHTML = '<option value="">Selecciona tipo de propiedad</option>';
        }
      }
      function actualizarTipoPropiedad() {
        const operacion = document.getElementById("tipoOperacion").value;
        const selectorPropiedad = document.getElementById("tipoPropiedad");
        if (!selectorPropiedad) return;
        selectorPropiedad.innerHTML = '<option value="">Selecciona tipo de propiedad</option>';
        if (operacion === "Vender") {
          ["Terreno", "Casa", "Departamento", "Local"].forEach(op => {
            const option = document.createElement("option");
            option.value = op;
            option.textContent = op === "Local" ? "Local Comercial" : op;
            selectorPropiedad.appendChild(option);
          });
        } else if (operacion === "Alquilar") {
          ["Departamento", "Local", "Temporario"].forEach(op => {
            const option = document.createElement("option");
            option.value = op;
            option.textContent = op === "Local" ? "Local Comercial" : op === "Temporario" ? "Alquiler Temporario" : op;
            selectorPropiedad.appendChild(option);
          });
        }
      }
      function mostrarFormularioSeleccionado() {
        const tipo = document.getElementById("tipoPropiedad").value;
        if (!tipo) return;
        document.querySelectorAll('[id^="formulario"]').forEach(f => f.classList.remove("active"));
        document.getElementById("formulario" + tipo).classList.add("active");
        document.getElementById("btnAgregarPropiedad").textContent = "Cerrar";
        document.getElementById("formulario" + tipo).scrollIntoView({ behavior: "smooth" });
      }
async function agregarAlquiler(tipo) {
const msgEl = document.getElementById(`msg${tipo}`);
msgEl.textContent = "Agregando propiedad...";
msgEl.className = "estado-msg loading";
let direccion = document.getElementById(`direccion${tipo}`).value;
const ambientes = (tipo === "Departamento" || tipo === "Casa") ? document.getElementById(`ambientes${tipo}`).value : "";
let precio = (tipo === "Departamento" || tipo === "Terreno" || tipo === "Casa") ? document.getElementById(`precio${tipo}`).value.replace(/\D/g, "") : "";
const superficie = tipo === "Terreno" ? document.getElementById(`superficie${tipo}`).value : "";
const patio = tipo === "Casa" ? document.getElementById(`patio${tipo}`).value : "";
const garage = tipo === "Casa" ? document.getElementById(`garage${tipo}`).value : "";
const antiguedad = tipo === "Casa" ? document.getElementById(`antiguedad${tipo}`).value : "";
const infoIngreso = document.getElementById(`infoIngreso${tipo}`).value;
const detalles = document.getElementById(`detalles${tipo}`).value;
const operacion = document.getElementById("tipoOperacion").value;
let row = document.getElementById(`editRow${tipo}`).value || new Date().getTime();
const enlaceCompartir = document.getElementById(`editRow${tipo}`).value ? document.getElementById(`enlaceCompartir${tipo}`).value : "";
const email = localStorage.getItem("dueno");
if (!direccion ||
(tipo === "Departamento" && (!ambientes || !precio)) ||
(tipo === "Terreno" && (!superficie || !precio)) ||
(tipo === "Casa" && (!ambientes || !precio))) {
msgEl.className = "estado-msg error";
msgEl.textContent = "Completa todos los campos obligatorios.";
setTimeout(() => { msgEl.textContent = ""; }, 5000);
return;
}
direccion = direccion + ", Santo Tomé Corrientes";
const files = document.getElementById(`imagenFile${tipo}`).files;
let uploadedURLs = [];
for (let i = 0; i < files.length; i++) {
const url = await subirImagenCloudinary(files[i]);
if (url) uploadedURLs.push(url);
}
const videoFiles = document.getElementById(`videoFile${tipo}`).files;
let videos = "";
if (videoFiles.length > 0) {
let videoURLs = [];
for (let i = 0; i < videoFiles.length; i++) {
const url = await subirVideoMux(videoFiles[i], row, tipo);
if (url) videoURLs.push(url);
}
videos = videoURLs.join(",");
} else if (document.getElementById(`editRow${tipo}`).value) {
videos = document.getElementById(`existingVideos${tipo}`).value;
}
fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(direccion)}&key=${GEOCODE_KEY}`)
.then(r => r.json()).then(data => {
let lat = "", lng = "";
if (data.results && data.results[0]) {
lat = data.results[0].geometry.location.lat;
lng = data.results[0].geometry.location.lng;
}
enviarAlquiler(tipo, uploadedURLs.join(","), lat, lng, enlaceCompartir, videos, operacion);
}).catch(err => {
msgEl.className = "estado-msg error";
msgEl.textContent = "Error al obtener coordenadas: " + (err.message || "Error de conexión");
setTimeout(() => { msgEl.textContent = ""; }, 5000);
});
function enviarAlquiler(tipo, fotosConcatenadas, lat, lng, enlaceCompartir, videos, operacion) {
const action = document.getElementById(`editRow${tipo}`).value ? "editAlquiler" : "addAlquiler";
const callback = action === "editAlquiler" ? "alquilerEditado" : "alquilerAgregado";
let estado = "Activo";
if (action === "editAlquiler" && deptosActivos >= limiteDeptos && planActual !== "Prueba") {
estado = "Inactivo";
}
const script = document.createElement("script");
let query = `${API_URL}?action=${action}&row=${row}&dueno=${encodeURIComponent(email)}&direccion=${encodeURIComponent(direccion)}&tipo=${encodeURIComponent(tipo)}`;
if (tipo === "Departamento" || tipo === "Casa") query += `&ambientes=${encodeURIComponent(ambientes)}`;
if (tipo === "Departamento" || tipo === "Terreno" || tipo === "Casa") query += `&precio=${encodeURIComponent(precio)}`;
if (tipo === "Terreno") query += `&superficie=${encodeURIComponent(superficie)}`;
if (tipo === "Casa") {
query += `&patio=${encodeURIComponent(patio)}`;
query += `&garage=${encodeURIComponent(garage)}`;
query += `&antiguedad=${encodeURIComponent(antiguedad)}`;
}
query += `&fotos=${encodeURIComponent(fotosConcatenadas)}&infoIngreso=${encodeURIComponent(infoIngreso)}&detalles=${encodeURIComponent(detalles)}&lat=${lat}&lng=${lng}&contacto=auto&estado=${estado}&videos=${encodeURIComponent(videos)}&operacion=${encodeURIComponent(operacion)}`;
if (enlaceCompartir) query += `&enlaceCompartir=${encodeURIComponent(enlaceCompartir)}`;
query += `&callback=${callback}`;
script.src = query;
document.body.appendChild(script);
}
}
function resetAllForms() {
['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'].forEach(tipo => {
document.getElementById(`formulario${tipo}`).classList.remove("active");
document.getElementById(`editRow${tipo}`).value = "";
document.getElementById(`enlaceCompartir${tipo}`).value = "";
document.getElementById(`existingVideos${tipo}`).value = "";
document.getElementById(`direccion${tipo}`).value = "";
if (tipo === "Departamento" || tipo === "Casa") {
document.getElementById(`ambientes${tipo}`).value = "";
document.getElementById(`precio${tipo}`).value = "";
}
if (tipo === "Terreno") {
document.getElementById(`superficie${tipo}`).value = "";
document.getElementById(`precio${tipo}`).value = "";
}
if (tipo === "Casa") {
document.getElementById(`patio${tipo}`).value = "Sí";
document.getElementById(`garage${tipo}`).value = "Sí";
document.getElementById(`antiguedad${tipo}`).value = "";
}
document.getElementById(`infoIngreso${tipo}`).value = "";
document.getElementById(`detalles${tipo}`).value = "";
document.getElementById(`imagenFile${tipo}`).value = "";
document.getElementById(`videoFile${tipo}`).value = "";
imagenesBase64[tipo] = [];
videosBase64[tipo] = [];
actualizarPreview(tipo);
actualizarVideoPreview(tipo);
document.getElementById(`msg${tipo}`).textContent = "";
document.getElementById(`btnGuardar${tipo}`).textContent = "Agregar";
});
document.getElementById("opcionesPropiedad").classList.remove("active");
document.getElementById("opcionesVenta").classList.remove("active");
document.getElementById("opcionesAlquiler").classList.remove("active");
document.getElementById("btnAgregarPropiedad").textContent = "Agregar Propiedad";
document.getElementById("tipoOperacion").value = "Vender";
mostrarOpcionesPorOperacion();
}
function editarAlquiler(row, datos) {
const tipo = datos.Tipo || "Departamento";
document.getElementById("btnAgregarPropiedad").textContent = "Cerrar Opciones";
document.getElementById(`formulario${tipo}`).classList.add("active");
document.getElementById(`btnGuardar${tipo}`).textContent = "Guardar Cambios";
document.getElementById(`editRow${tipo}`).value = row;
document.getElementById(`enlaceCompartir${tipo}`).value = datos["Enlace para compartir"] || "";
document.getElementById(`existingVideos${tipo}`).value = datos.Videos || "";
document.getElementById(`direccion${tipo}`).value = datos.Direccion || "";
if (tipo === "Departamento" || tipo === "Casa") {
document.getElementById(`ambientes${tipo}`).value = datos["Nro Ambientes"] || "";
document.getElementById(`precio${tipo}`).value = formatoPrecio(datos.Precio);
}
if (tipo === "Terreno") {
document.getElementById(`superficie${tipo}`).value = datos.Superficie || "";
document.getElementById(`precio${tipo}`).value = formatoPrecio(datos.Precio);
}
if (tipo === "Casa") {
document.getElementById(`patio${tipo}`).value = datos.Patio || "No";
document.getElementById(`garage${tipo}`).value = datos.Garage || "No";
document.getElementById(`antiguedad${tipo}`).value = datos.Antiguedad || "";
}
document.getElementById(`infoIngreso${tipo}`).value = datos.InfoIngreso || "";
document.getElementById(`detalles${tipo}`).value = datos.Detalles || "";
document.getElementById("tipoOperacion").value = datos.Operacion || "Vender";
mostrarOpcionesPorOperacion();
imagenesBase64[tipo] = datos.Fotos ? datos.Fotos.split(",") : [];
videosBase64[tipo] = datos.Videos ? datos.Videos.split(",") : [];
actualizarPreview(tipo);
actualizarVideoPreview(tipo);
window.scrollTo(0, document.getElementById(`formulario${tipo}`).offsetTop);
}
async function cambiarEstado(row, estadoActual) {
  const msgEl = document.getElementById(`estadoMsg-${row}`);
  const nuevoEstado = estadoActual === "Activo" ? "Inactivo" : "Activo";
  if (nuevoEstado === "Activo" && deptosActivos >= limiteDeptos && planActual !== "Prueba" && planActual !== "Inmobiliario") {
    msgEl.className = "estado-msg error";
    msgEl.textContent = `Límite alcanzado: tu plan ${planActual} permite solo ${limiteDeptos} ${limiteDeptos === 1 ? 'propiedad' : 'propiedades'} activas.`;
    setTimeout(() => { msgEl.textContent = ""; }, 7000);
    // Revierte el toggle visualmente
    const checkbox = document.querySelector(`input[onchange="cambiarEstado(${row}, '${estadoActual}')"]`);
    if (checkbox) checkbox.checked = (estadoActual === "Activo");
    return;
}
msgEl.className = "estado-msg loading";
msgEl.textContent = "Cambiando Estado";
try {
const response = await fetch(`${API_URL}?action=toggleEstado&row=${row}`);
const res = await response.json();
estadoCambiado(res, row);
} catch (err) {
msgEl.className = "estado-msg error";
msgEl.textContent = `Error al cambiar estado: ${err.message || "Error de conexión"}`;
setTimeout(() => { msgEl.textContent = ""; }, 5000);
console.error("Error en cambio de estado:", err);
}
}
function estadoCambiado(res, row) {
const msgEl = document.getElementById(`estadoMsg-${row}`);
if (res.success) {
msgEl.className = "estado-msg success";
msgEl.textContent = "Estado cambiado con éxito";
setTimeout(() => { msgEl.textContent = ""; }, 3000);
cargarAlquileres();
} else {
msgEl.className = "estado-msg error";
msgEl.textContent = `Error al cambiar estado: ${res.error || "desconocido"}`;
setTimeout(() => { msgEl.textContent = ""; }, 5000);
}
}
function eliminarAlquiler(row) {
if (!confirm("¿Seguro que deseas eliminar esta propiedad?")) return;
const script = document.createElement("script");
script.src = `${API_URL}?action=deleteAlquiler&row=${row}&callback=cargarAlquileres`;
document.body.appendChild(script);
}
function logout() { localStorage.removeItem("dueno"); window.location.href = "index.html"; }
function alquilerAgregado(res) {
const formularios = ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'];
formularios.forEach(tipo => {
const msgEl = document.getElementById(`msg${tipo}`);
if (res.success) {
msgEl.className = "estado-msg success";
msgEl.textContent = "Propiedad agregada con éxito";
setTimeout(() => {
resetAllForms();
cargarAlquileres();
cargarEstadoPlan();
}, 3000);
} else {
msgEl.className = "estado-msg error";
msgEl.textContent = "Error al agregar: " + (res.error || "desconocido");
setTimeout(() => { msgEl.textContent = ""; }, 5000);
}
});
}
function alquilerEditado(res) {
const formularios = ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'];
formularios.forEach(tipo => {
const msgEl = document.getElementById(`msg${tipo}`);
if (res.success) {
msgEl.className = "estado-msg success";
msgEl.textContent = "Cambios guardados correctamente";
setTimeout(() => {
resetAllForms();
cargarAlquileres();
}, 3000);
} else {
msgEl.className = "estado-msg error";
msgEl.textContent = "Error al editar: " + (res.error || "desconocido");
setTimeout(() => { msgEl.textContent = ""; }, 5000);
}
});
}
function abrirModalEditarCuenta() {
  document.getElementById("modalEditarCuenta").style.display = "flex"; // ← CORREGIDO: era "block"
  cargarDatosCuenta();
}
function cerrarModalEditarCuenta() {
  document.getElementById("modalEditarCuenta").style.display = "none";
  document.getElementById("emailEditar").value = "";
  document.getElementById("nombreEditar").value = "";
  document.getElementById("contactoEditar").value = "";
  document.getElementById("passwordEditar").value = "";
  document.getElementById("codigoPaisEditar").value = "+549";
  document.getElementById("msgEditarCuenta").textContent = "";
  document.getElementById("passwordEditar").type = "password";
  document.querySelector(".toggle-password").textContent = "Mostrar";
}
function cargarDatosCuenta() {
const email = localStorage.getItem("dueno");
const msgEl = document.getElementById("msgEditarCuenta");
const script = document.createElement("script");
script.src = `${API_URL}?action=getLoginInfo&email=${encodeURIComponent(email)}&callback=mostrarDatosCuenta`;
document.body.appendChild(script);
}
function mostrarDatosCuenta(res) {
const msgEl = document.getElementById("msgEditarCuenta");
const countryCodes = ["+549", "+55", "+598", "+56", "+595"];
if (res.success && res.data && res.data[0]) {
const login = res.data[0];
document.getElementById("emailEditar").value = login.Email || "";
document.getElementById("nombreEditar").value = login.Nombre || "";
document.getElementById("passwordEditar").value = login.Password || "";
let contacto = login.Contacto || "";
let codigoPais = "+549";
let numero = "";
if (typeof contacto === "string" && contacto.trim() !== "") {
for (const code of countryCodes) {
if (contacto.startsWith(code)) {
codigoPais = code;
numero = contacto.slice(code.length).trim();
break;
}
}
}
document.getElementById("codigoPaisEditar").value = codigoPais;
document.getElementById("contactoEditar").value = numero;
msgEl.textContent = "";
} else {
msgEl.style.color = "red";
msgEl.textContent = "Error al cargar los datos de la cuenta";
setTimeout(() => { msgEl.textContent = ""; }, 3000);
}
}
function togglePasswordVisibility() {
const passwordInput = document.getElementById("passwordEditar");
const toggleButton = document.querySelector(".toggle-password");
if (passwordInput.type === "password") {
passwordInput.type = "text";
toggleButton.textContent = "Ocultar";
} else {
passwordInput.type = "password";
toggleButton.textContent = "Mostrar";
}
}
async function editarCuenta() {
const email = localStorage.getItem("dueno");
const newEmail = document.getElementById("emailEditar").value;
const nombre = document.getElementById("nombreEditar").value;
const codigoPais = document.getElementById("codigoPaisEditar").value;
const contacto = document.getElementById("contactoEditar").value;
const password = document.getElementById("passwordEditar").value;
const msgEl = document.getElementById("msgEditarCuenta");
if (!newEmail && !nombre && !contacto && !password) {
msgEl.style.color = "red";
msgEl.textContent = "Debes completar al menos un campo para actualizar.";
return;
}
if (newEmail && !newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
msgEl.style.color = "red";
msgEl.textContent = "Ingresa un email válido.";
return;
}
if (password && password.length < 6) {
msgEl.style.color = "red";
msgEl.textContent = "La contraseña debe tener al menos 6 caracteres.";
return;
}
if (contacto && !contacto.match(/^\d{6,}$/)) {
msgEl.style.color = "red";
msgEl.textContent = "El número de teléfono debe contener solo dígitos y al menos 6 caracteres.";
return;
}
msgEl.textContent = "Guardando cambios...";
try {
let query = `${API_URL}?action=editarDueno&email=${encodeURIComponent(email)}`;
if (newEmail) query += `&newEmail=${encodeURIComponent(newEmail)}`;
if (nombre) query += `&nombre=${encodeURIComponent(nombre)}`;
if (contacto) query += `&contacto=${encodeURIComponent(codigoPais + contacto)}`;
if (password) query += `&password=${encodeURIComponent(password)}`;
const response = await fetch(query);
const res = await response.json();
if (res.success) {
msgEl.style.color = "green";
msgEl.textContent = "Cambios guardados con éxito";
if (newEmail) localStorage.setItem("dueno", newEmail);
setTimeout(cerrarModalEditarCuenta, 1000);
} else {
msgEl.style.color = "red";
msgEl.textContent = "Error al guardar: " + (res.error || "desconocido");
}
} catch (err) {
msgEl.style.color = "red";
msgEl.textContent = "Error al guardar: " + (err.message || "Error de conexión");
console.error("Error en edición de cuenta:", err);
}
}
</script>
    
  <!-- =============== PIE DE PÁGINA AZUL – VOLVER AL MAPA (para dueños.html) =============== -->
  <footer style="margin-top:80px;background:#3483fa;color:white;padding:2.5rem 1rem 1.5rem;">
    <div style="max-width:1200px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:2rem;align-items:center;text-align:center;">
      <!-- Logo -->
      <div>
        <img src="https://i.postimg.cc/FHXRBTTX/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.png" alt="Logo AlquiYa" style="max-width:180px;height:auto;">
      </div>

      <!-- Botón Volver al Mapa -->
      <div>
        <a href="https://www.alquiya.com.ar" 
           style="display:inline-block;background:white;color:#3483fa;font-weight:700;padding:0.9rem 2.6rem;border-radius:50px;font-size:1.28rem;box-shadow:0 6px 20px rgba(52,131,250,0.3);transition:all 0.3s ease;text-decoration:none;">
          ← Volver al Inicio
        </a>
      </div>

      <!-- Instagram -->
      <div>
        <a href="https://www.instagram.com/alquiya.st/" target="_blank">
          <img src="https://i.postimg.cc/GmVWTXX0/394a7aaecd6b8ce44528649681d9fa05.png" alt="Instagram" style="width:40px;height:40px;">
        </a>
      </div>

      <!-- Copyright -->
      <div style="font-size:0.95rem;opacity:0.9;grid-column:1/-1;">
        © 2025 AlquiYa • Todos los derechos reservados
      </div>
    </div>
  </footer>
</body>
</html>
