<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SSJ5DG33JK"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-SSJ5DG33JK');
</script>
<link rel="icon" type="image/png" href="https://i.postimg.cc/MKpMcrcQ/AlquiYa.png">
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
}
header {
  background: white;
  color: white;
  padding: 15px;
  text-align: center;
}
#alquiler-detalle {
  max-width: 700px;
  margin: 20px auto;
  padding: 15px;
  border: 2px solid #3483fa;
  border-radius: 8px;
  background: #f9f9f9;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
#alquiler-detalle img {
  max-width: 100%;
  border-radius: 6px;
  margin-top: 10px;
}
#alquiler-detalle p {
  margin: 10px 0;
}
#alquiler-detalle button {
  background: #25D366;
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 10px;
  margin-right: 10px;
}
#alquiler-detalle button:hover {
  background: #1ebe57;
}
#loading-msg {
  display: none;
  text-align: center;
  font-weight: bold;
  margin: 10px;
  color: #3483fa;
}
#imagenes-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}
#imagenes-container img {
  max-width: 120px;
  height: 90px;
  margin: 5px;
  border-radius: 6px;
  object-fit: cover;
  cursor: pointer;
}
#modal-img {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
#modal-img img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 8px;
  box-shadow: 0 0 15px #000;
  cursor: pointer;
}
#modal-img .close-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: red;
  color: white;
  border: none;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
#modal-img .nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: #3483fa;
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
#modal-img .prev-btn {
  left: 10px;
}
#modal-img .next-btn {
  right: 10px;
}
</style>
</head>
<body>
<header>
  <img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="Logo Alqui Ya" style="max-width:250px;margin-bottom:10px;">
</header>
<div id="loading-msg">Cargando datos del alquiler...</div>
<div id="alquiler-detalle"></div>
<div id="modal-img">
  <img id="img-grande">
  <button class="close-btn" onclick="cerrarModal()">X</button>
  <button class="nav-btn prev-btn" onclick="cambiarImagen(-1)">&lt;</button>
  <button class="nav-btn next-btn" onclick="cambiarImagen(1)">&gt;</button>
</div>
<script>
const webAppURL = "https://script.google.com/macros/s/AKfycbwDl73ZMnMowfSu_NoISSSc4fnQpLp6kaxT9Dz5jMjE9NxT64AmeN23ORQy8lejul6S/exec";
let currentImages = [];
let currentImageIndex = 0;

function driveUrlDirect(url) {
  let fileId = null;
  if (url && url.includes("drive.google.com")) {
    let match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if (match) fileId = match[1];
    else {
      match = url.match(/id=([a-zA-Z0-9_-]+)/);
      if (match) fileId = match[1];
    }
  }
  return fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : url;
}

function formatPrice(num) {
  if (!num) return "";
  const clean = String(num).replace(/[^\d]/g, "");
  const formatted = parseInt(clean, 10).toLocaleString('es-AR');
  return "$" + formatted.replace(/,/g, ".");
}

function abrirModal(src, images, index) {
  currentImages = images;
  currentImageIndex = index;
  const modal = document.getElementById("modal-img");
  const img = document.getElementById("img-grande");
  img.src = src;
  modal.style.display = "flex";
  document.querySelector(".prev-btn").style.display = images.length > 1 ? "block" : "none";
  document.querySelector(".next-btn").style.display = images.length > 1 ? "block" : "none";
}

function cerrarModal() {
  document.getElementById("modal-img").style.display = "none";
  currentImages = [];
  currentImageIndex = 0;
}

function cambiarImagen(direction) {
  currentImageIndex = (currentImageIndex + direction + currentImages.length) % currentImages.length;
  document.getElementById("img-grande").src = currentImages[currentImageIndex];
}

window.onload = () => {
  const urlParams = new URLSearchParams(window.location.search);
  const alquilerId = urlParams.get("id");
  const loadingEl = document.getElementById("loading-msg");
  const detalle = document.getElementById("alquiler-detalle");

  if (!alquilerId) {
    detalle.innerHTML = "<h2>Error: No se proporcion贸 un ID de alquiler</h2>";
    return;
  }

  loadingEl.style.display = "block";

  fetch(`${webAppURL}?action=getAlquiler&id=${encodeURIComponent(alquilerId)}`)
    .then(res => res.json())
    .then(data => {
      loadingEl.style.display = "none";
      if (data.success) {
        const alquiler = data.alquiler;
        const precio = (alquiler.Precio && !isNaN(alquiler.Precio)) ? formatPrice(alquiler.Precio) : "No disponible";
        detalle.innerHTML = `
          <h2>Alquiler: ${alquiler.Direccion || "Sin direcci贸n"}</h2>
        `;
        const rows = [
          ["Ambientes", alquiler.Ambientes || ""],
          ["Precio", precio],
          ["Informaci贸n de ingreso", alquiler.InfoIngreso || ""],
          ["Detalles", alquiler.Detalles || ""],
          ["Mascotas", alquiler.Mascotas || ""]
        ];
        rows.forEach(([label, val]) => {
          const p = document.createElement("p");
          p.innerHTML = `<b>${label}:</b> ${val}`;
          detalle.appendChild(p);
        });

        const imgContainer = document.createElement("div");
        imgContainer.id = "imagenes-container";
        let imageUrls = [];
        if (alquiler.Imagen) {
          imageUrls = alquiler.Imagen.split(",").map(f => driveUrlDirect(f.trim())).filter(url => url);
          imageUrls.forEach((url, index) => {
            const img = document.createElement("img");
            img.src = url;
            img.alt = "Imagen del alquiler";
            img.referrerPolicy = "no-referrer";
            img.onclick = () => abrirModal(url, imageUrls, index);
            imgContainer.appendChild(img);
          });
        }
        detalle.appendChild(imgContainer);

        if (alquiler.Contacto) {
          const waBtn = document.createElement("button");
          waBtn.textContent = "Contactar por WhatsApp";
          waBtn.style.background = "#25D366";
          waBtn.style.color = "white";
          waBtn.style.marginTop = "10px";
          waBtn.onclick = () => {
            const mensaje = `Hola, quiero consultar por el alquiler de ${alquiler.Direccion || "sin direcci贸n"}`;
            window.open(`https://wa.me/${alquiler.Contacto}?text=${encodeURIComponent(mensaje)}`, "_blank");
          };
          detalle.appendChild(waBtn);
        }

        const mapBtn = document.createElement("button");
        mapBtn.textContent = "Ir al Mapa";
        mapBtn.style.background = "#25D366";
        mapBtn.style.color = "white";
        mapBtn.style.marginTop = "10px";
        mapBtn.onclick = () => {
          window.location.href = "index.html";
        };
        detalle.appendChild(mapBtn);
      } else {
        detalle.innerHTML = "<h2>Este alquiler no existe o fue dado de baja</h2>";
      }
    })
    .catch(err => {
      loadingEl.style.display = "none";
      detalle.innerHTML = "<h2>Error al cargar los datos del alquiler</h2>";
      console.error("Error:", err);
    });
};
</script>
</body>
</html>
