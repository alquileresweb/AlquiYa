<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Due√±os - Agregar y Editar Propiedades</title>
<style>
/* Estilos generales */
body { font-family: 'Inter', Arial, sans-serif; margin: 10px; background: #f5f5f5; font-size: 20px; text-align: center; margin-top: 120px; }
h3 { color: #333; font-size: 2em; margin-bottom: 18px; }

/* Contenedor de formularios */
.form-container {
  max-width: 680px;
  margin: 0 auto 1rem;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  padding: 20px;
}

/* Campos de entrada */
input[type="text"], input[type="number"], textarea, select {
  width: 100%;
  max-width: 100%; /* Asegura que no sobrepase el contenedor */
  padding: 10px 14px;
  border: 1px solid #b0b0b0; /* Borde m√°s oscuro */
  border-radius: 8px;
  font-size: 14px;
  font-family: 'Inter', sans-serif;
  box-sizing: border-box; /* Incluye padding y border en el ancho */
}
input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
  outline: none;
  border-color: #095dbd;
  box-shadow: 0 0 0 2px rgba(9, 93, 189, 0.15);
}

/* Estilos para el grupo de botones de tipo de operaci√≥n (Venta/Alquiler) como toggle */
.toggle-group {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}
.toggle-btn {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  background: #f2f2f2;
  color: #333;
  font-weight: 500;
  text-align: center;
  cursor: pointer;
  transition: background 0.2s;
  border: none;
  position: relative;
  overflow: hidden;
}
.toggle-btn.active {
  background: #095dbd;
  color: #fff;
}
.toggle-btn input[type="radio"] {
  position: absolute;
  opacity: 0;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  cursor: pointer;
}

/* Estilos para botones de tipo de propiedad */
.property-type {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.property-btn {
  flex: 1;
  padding: 14px;
  border: 1px solid #dcdcdc;
  border-radius: 8px;
  text-align: center;
  background: #fff;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 1.3em;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.property-btn.active {
  background: #095dbd;
  color: #fff;
  border-color: #095dbd;
}

/* Contador para ambientes */
.counter {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
}
.counter button {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  background: #f2f2f2;
  border: none;
  font-size: 18px;
  cursor: pointer;
}
.counter span {
  min-width: 20px;
  text-align: center;
  font-weight: 500;
}

/* Botones S√≠/No para Patio y Garage */
.toggle-group.yes-no {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}
.toggle-btn.yes-no-btn {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  background: #f2f2f2;
  color: #333;
  font-weight: 500;
  text-align: center;
  cursor: pointer;
  transition: background 0.2s;
}
.toggle-btn.yes-no-btn.active {
  background: #095dbd;
  color: #fff;
}

/* Estilos para otros elementos */
label {
  display: block;
  margin: 12px 0 8px;
  font-weight: bold;
  font-size: 1.3em;
}
button {
  margin: 6px;
  padding: 14px 20px;
  font-size: 1.3em;
  border-radius: 6px;
  cursor: pointer;
}
#btnAgregarPropiedad {
  background: #095dbd;
  color: white;
}
#opcionesPropiedad {
  background: #fff;
  padding: 20px;
  border: 1px solid #dcdcdc;
  margin-top: 24px;
  border-radius: 12px;
  font-size: 1.3em;
  text-align: left;
  display: none;
}
#opcionesPropiedad.active {
  display: block;
}
.preview-img { max-width: 140px; margin-top: 6px; display: inline-block; position: relative; border-radius: 6px; }
.preview-img-container { display: inline-block; margin-right: 6px; position: relative; }
.delete-img { position: absolute; top: 0; right: 0; background: red; color: white; border: none; border-radius: 50%; cursor: pointer; font-weight: bold; padding: 3px 8px; }
.preview-video { max-width: 140px; margin-top: 6px; display: inline-block; position: relative; border-radius: 6px; }
.preview-video-container { display: inline-block; margin-right: 6px; position: relative; }
.delete-video { position: absolute; top: 0; right: 0; background: red; color: white; border: none; border-radius: 50%; cursor: pointer; font-weight: bold; padding: 3px 8px; }
.estado-msg { font-size: 1.1em; margin-top: 6px; display: block; }
.estado-msg.loading { color: blue; }
.estado-msg.success { color: green; }
.estado-msg.error { color: red; }

/* Media queries para mobile */
@media screen and (max-width: 600px) {
  body { font-size: 24px; margin-top: 140px; }
  .form-container { padding: 24px; }
  input[type="text"], input[type="number"], textarea, select { font-size: 1.4em; padding: 16px; }
  .property-btn { font-size: 1.5em; padding: 16px; }
  .toggle-btn { font-size: 1.5em; padding: 12px; }
  .counter button { width: 32px; height: 32px; font-size: 20px; }
}
</style>
</head>
<body>
<button id="btnAgregarPropiedad" onclick="toggleOpcionesPropiedad()">‚ûï Agregar Propiedad</button>
<div id="opcionesPropiedad" class="form-container">
  <label>Tipo de Operaci√≥n</label>
  <div class="toggle-group" id="tipoOperacionToggle">
    <label class="toggle-btn">
      <input type="radio" name="operacion" value="Vender" checked onclick="seleccionarOperacion('Vender')">Vender
    </label>
    <label class="toggle-btn">
      <input type="radio" name="operacion" value="Alquilar" onclick="seleccionarOperacion('Alquilar')">Alquilar
    </label>
  </div>
  <div id="opcionesVenta" class="property-type">
    <button class="property-btn" onclick="mostrarFormulario('Terreno')">üèûÔ∏è Terreno</button>
    <button class="property-btn" onclick="mostrarFormulario('Casa')">üè† Casa</button>
    <button class="property-btn" onclick="mostrarFormulario('Departamento')">üè¢ Departamento</button>
    <button class="property-btn" onclick="mostrarFormulario('Local')">üè¨ Local Comercial</button>
  </div>
  <div id="opcionesAlquiler" class="property-type" style="display: none;">
    <button class="property-btn" onclick="mostrarFormulario('Departamento')">üè¢ Departamento</button>
    <button class="property-btn" onclick="mostrarFormulario('Local')">üè¨ Local Comercial</button>
    <button class="property-btn" onclick="mostrarFormulario('Temporario')">üèñÔ∏è Temporario</button>
  </div>
</div>

<!-- Formulario Terreno -->
<div id="formularioTerreno" class="form-container" style="display: none;">
  <input type="hidden" id="editRowTerreno" value="">
  <input type="hidden" id="enlaceCompartirTerreno" value="">
  <input type="hidden" id="existingVideosTerreno" value="">
  <label>Superficie total (m¬≤)</label>
  <input type="number" id="superficieTerreno">
  <label>Direcci√≥n</label>
  <input type="text" id="direccionTerreno">
  <label>Precio (USD)</label>
  <input type="text" id="precioTerreno">
  <label>Im√°genes del Terreno (PNG/JPG, m√∫ltiples)</label>
  <input type="file" id="imagenFileTerreno" accept="image/png, image/jpeg" multiple>
  <div id="previewContainerTerreno"></div>
  <label>Videos del Terreno (MP4, m√∫ltiples)</label>
  <input type="file" id="videoFileTerreno" accept="video/*" multiple>
  <div id="videoPreviewContainerTerreno"></div>
  <label>Informaci√≥n de pago</label>
  <textarea id="infoIngresoTerreno" rows="2"></textarea>
  <label>Detalles</label>
  <textarea id="detallesTerreno" rows="3"></textarea>
  <button id="btnGuardarTerreno" onclick="agregarAlquiler('Terreno')">Agregar</button>
  <p id="msgTerreno" class="estado-msg"></p>
</div>

<!-- Formulario Casa -->
<div id="formularioCasa" class="form-container" style="display: none;">
  <input type="hidden" id="editRowCasa" value="">
  <input type="hidden" id="enlaceCompartirCasa" value="">
  <input type="hidden" id="existingVideosCasa" value="">
  <label>Direcci√≥n</label>
  <input type="text" id="direccionCasa">
  <label>Ambientes</label>
  <div class="counter">
    <button onclick="cambiarAmbientes('Casa', -1)">‚Äì</button>
    <span id="ambientesCasaDisplay">1</span>
    <input type="hidden" id="ambientesCasa" value="1">
    <button onclick="cambiarAmbientes('Casa', 1)">+</button>
  </div>
  <label>Precio (USD)</label>
  <input type="text" id="precioCasa">
  <label>Patio</label>
  <div class="toggle-group yes-no" id="patioCasaToggle">
    <button class="toggle-btn yes-no-btn active" onclick="seleccionarOpcion('patioCasa', 'S√≠')">S√≠</button>
    <button class="toggle-btn yes-no-btn" onclick="seleccionarOpcion('patioCasa', 'No')">No</button>
  </div>
  <label>Garage</label>
  <div class="toggle-group yes-no" id="garageCasaToggle">
    <button class="toggle-btn yes-no-btn active" onclick="seleccionarOpcion('garageCasa', 'S√≠')">S√≠</button>
    <button class="toggle-btn yes-no-btn" onclick="seleccionarOpcion('garageCasa', 'No')">No</button>
  </div>
  <label>Antig√ºedad (a√±os)</label>
  <input type="number" id="antiguedadCasa">
  <label>Im√°genes de la Casa (PNG/JPG, m√∫ltiples)</label>
  <input type="file" id="imagenFileCasa" accept="image/png, image/jpeg" multiple>
  <div id="previewContainerCasa"></div>
  <label>Videos de la Casa (MP4, m√∫ltiples)</label>
  <input type="file" id="videoFileCasa" accept="video/*" multiple>
  <div id="videoPreviewContainerCasa"></div>
  <label>Informaci√≥n de pago</label>
  <textarea id="infoIngresoCasa" rows="2"></textarea>
  <label>Otros detalles</label>
  <textarea id="detallesCasa" rows="3"></textarea>
  <button id="btnGuardarCasa" onclick="agregarAlquiler('Casa')">Agregar</button>
  <p id="msgCasa" class="estado-msg"></p>
</div>

<!-- Formulario Departamento -->
<div id="formularioDepartamento" class="form-container" style="display: none;">
  <input type="hidden" id="editRowDepartamento" value="">
  <input type="hidden" id="enlaceCompartirDepartamento" value="">
  <input type="hidden" id="existingVideosDepartamento" value="">
  <label>Direcci√≥n</label>
  <input type="text" id="direccionDepartamento">
  <label>Ambientes</label>
  <div class="counter">
    <button onclick="cambiarAmbientes('Departamento', -1)">‚Äì</button>
    <span id="ambientesDepartamentoDisplay">1</span>
    <input type="hidden" id="ambientesDepartamento" value="1">
    <button onclick="cambiarAmbientes('Departamento', 1)">+</button>
  </div>
  <label>Precio (USD)</label>
  <input type="text" id="precioDepartamento">
  <label>Im√°genes del Alquiler (PNG/JPG, m√∫ltiples)</label>
  <input type="file" id="imagenFileDepartamento" accept="image/png, image/jpeg" multiple>
  <div id="previewContainerDepartamento"></div>
  <label>Videos del Alquiler (MP4, m√∫ltiples)</label>
  <input type="file" id="videoFileDepartamento" accept="video/*" multiple>
  <div id="videoPreviewContainerDepartamento"></div>
  <label>Informaci√≥n de pago</label>
  <textarea id="infoIngresoDepartamento" rows="2"></textarea>
  <label>Otros detalles</label>
  <textarea id="detallesDepartamento" rows="3"></textarea>
  <button id="btnGuardarDepartamento" onclick="agregarAlquiler('Departamento')">Agregar</button>
  <p id="msgDepartamento" class="estado-msg"></p>
</div>

<!-- Formulario Local -->
<div id="formularioLocal" class="form-container" style="display: none;">
  <input type="hidden" id="editRowLocal" value="">
  <input type="hidden" id="enlaceCompartirLocal" value="">
  <input type="hidden" id="existingVideosLocal" value="">
  <label>Direcci√≥n</label>
  <input type="text" id="direccionLocal">
  <label>Im√°genes del Alquiler (PNG/JPG, m√∫ltiples)</label>
  <input type="file" id="imagenFileLocal" accept="image/png, image/jpeg" multiple>
  <div id="previewContainerLocal"></div>
  <label>Videos del Alquiler (MP4, m√∫ltiples)</label>
  <input type="file" id="videoFileLocal" accept="video/*" multiple>
  <div id="videoPreviewContainerLocal"></div>
  <label>Informaci√≥n de ingreso</label>
  <textarea id="infoIngresoLocal" rows="2"></textarea>
  <label>Detalles</label>
  <textarea id="detallesLocal" rows="3"></textarea>
  <button id="btnGuardarLocal" onclick="agregarAlquiler('Local')">Agregar</button>
  <p id="msgLocal" class="estado-msg"></p>
</div>

<!-- Formulario Temporario -->
<div id="formularioTemporario" class="form-container" style="display: none;">
  <input type="hidden" id="editRowTemporario" value="">
  <input type="hidden" id="enlaceCompartirTemporario" value="">
  <input type="hidden" id="existingVideosTemporario" value="">
  <label>Direcci√≥n</label>
  <input type="text" id="direccionTemporario">
  <label>Im√°genes del Alquiler (PNG/JPG, m√∫ltiples)</label>
  <input type="file" id="imagenFileTemporario" accept="image/png, image/jpeg" multiple>
  <div id="previewContainerTemporario"></div>
  <label>Videos del Alquiler (MP4, m√∫ltiples)</label>
  <input type="file" id="videoFileTemporario" accept="video/*" multiple>
  <div id="videoPreviewContainerTemporario"></div>
  <label>Informaci√≥n de ingreso</label>
  <textarea id="infoIngresoTemporario" rows="2"></textarea>
  <label>Detalles</label>
  <textarea id="detallesTemporario" rows="3"></textarea>
  <button id="btnGuardarTemporario" onclick="agregarAlquiler('Temporario')">Agregar</button>
  <p id="msgTemporario" class="estado-msg"></p>
</div>

<script>
// === CONSTANTES Y VARIABLES ===
const API_URL = "https://script.google.com/macros/s/AKfycbwDl73ZMnMowfSu_NoISSSc4fnQpLp6kaxT9Dz5jMjE9NxT64AmeN23ORQy8lejul6S/exec";
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dnugmwern/image/upload";
const CLOUDINARY_UPLOAD_PRESET = "preset_alquileres";
const GEOCODE_KEY = "AIzaSyAisqYSTfpQ_rqqutAomzitD2v_dtKYtLE";
let imagenesBase64 = { Departamento: [], Local: [], Temporario: [], Terreno: [], Casa: [] };
let videosBase64 = { Departamento: [], Local: [], Temporario: [], Terreno: [], Casa: [] };
let planActual = null;
let limiteDeptos = 0;
let deptosActivos = 0;

// === FORMATO DE PRECIO ===
function formatoPrecio(valor) {
  if (!valor) return "";
  valor = valor.toString().replace(/\D/g, "");
  return "$" + valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function inicializarFormatoPrecio(tipo) {
  document.getElementById(`precio${tipo}`).addEventListener("input", function(e) {
    const cursorPos = this.selectionStart;
    const valorSinSimbolo = this.value.replace(/\D/g, '');
    const formattedValue = formatoPrecio(valorSinSimbolo);
    const prevLength = this.value.length;
    this.value = formattedValue;
    const newLength = formattedValue.length;
    const diff = newLength - prevLength;
    this.selectionStart = cursorPos + diff;
    this.selectionEnd = cursorPos + diff;
  });
}

// === PREVIEW IM√ÅGENES ===
function actualizarPreview(tipo) {
  const previewContainer = document.getElementById(`previewContainer${tipo}`);
  previewContainer.innerHTML = "";
  imagenesBase64[tipo].forEach((imgBase64, index) => {
    const container = document.createElement("div");
    container.className = "preview-img-container";
    const img = document.createElement("img");
    img.src = imgBase64;
    img.className = "preview-img";
    const btnDel = document.createElement("button");
    btnDel.className = "delete-img";
    btnDel.textContent = "x";
    btnDel.onclick = () => { imagenesBase64[tipo].splice(index, 1); actualizarPreview(tipo); };
    container.appendChild(img);
    container.appendChild(btnDel);
    previewContainer.appendChild(container);
  });
}

function inicializarPreviewImagenes(tipo) {
  document.getElementById(`imagenFile${tipo}`).addEventListener("change", function() {
    const files = Array.from(this.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        imagenesBase64[tipo].push(e.target.result);
        actualizarPreview(tipo);
      }
      reader.readAsDataURL(file);
    });
  });
}

// === PREVIEW VIDEOS ===
function actualizarVideoPreview(tipo) {
  const videoPreviewContainer = document.getElementById(`videoPreviewContainer${tipo}`);
  videoPreviewContainer.innerHTML = "";
  videosBase64[tipo].forEach((videoBase64, index) => {
    const container = document.createElement("div");
    container.className = "preview-video-container";
    const video = document.createElement("video");
    video.src = videoBase64;
    video.className = "preview-video";
    video.controls = true;
    const btnDel = document.createElement("button");
    btnDel.className = "delete-video";
    btnDel.textContent = "x";
    btnDel.onclick = () => { videosBase64[tipo].splice(index, 1); actualizarVideoPreview(tipo); };
    container.appendChild(video);
    container.appendChild(btnDel);
    videoPreviewContainer.appendChild(container);
  });
}

function inicializarPreviewVideos(tipo) {
  document.getElementById(`videoFile${tipo}`).addEventListener("change", function() {
    const files = Array.from(this.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        videosBase64[tipo].push(e.target.result);
        actualizarVideoPreview(tipo);
      }
      reader.readAsDataURL(file);
    });
  });
}

// === SUBIR IM√ÅGENES ===
async function subirImagenCloudinary(file) {
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
  try {
    const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
    const json = await res.json();
    return json.secure_url;
  } catch (err) {
    console.error("Error subiendo imagen a Cloudinary:", err);
    return null;
  }
}

// === SUBIR VIDEO A MUX ===
async function subirVideoMux(videoFile, row, tipo) {
  const msgEl = document.getElementById(`msg${tipo}`);
  try {
    const base64Video = await fileToBase64(videoFile);
    const response = await fetch(API_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'uploadVideoMux', video: base64Video, row: row })
    });
    if (!response.ok) throw new Error(`Error HTTP! Estado: ${response.status}`);
    const result = await response.json();
    if (result.success) {
      console.log('Video subido a Mux:', result.videoUrl);
      return result.videoUrl;
    } else {
      throw new Error(result.error || 'Error desconocido al subir el video');
    }
  } catch (error) {
    console.error('Error subiendo video a Mux:', error.message);
    msgEl.className = "estado-msg error";
    msgEl.textContent = `‚ùå Error al subir video: ${error.message}`;
    setTimeout(() => { msgEl.textContent = ""; }, 5000);
    throw error;
  }
}

// === CONVERTIR ARCHIVO A BASE64 ===
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(new Error('Error al convertir el video a base64'));
    reader.readAsDataURL(file);
  });
}

// === TOGGLE OPCIONES PROPIEDAD ===
function toggleOpcionesPropiedad() {
  const opciones = document.getElementById("opcionesPropiedad");
  const opcionesVenta = document.getElementById("opcionesVenta");
  const opcionesAlquiler = document.getElementById("opcionesAlquiler");
  const btn = document.getElementById("btnAgregarPropiedad");
  if (opciones.classList.contains("active")) {
    opciones.classList.remove("active");
    opcionesVenta.classList.remove("active");
    opcionesAlquiler.classList.remove("active");
    btn.textContent = "‚ûï Agregar Propiedad";
    resetAllForms();
  } else {
    opciones.classList.add("active");
    btn.textContent = "‚ûñ Cerrar Opciones";
    window.scrollTo(0, document.getElementById("opcionesPropiedad").offsetTop);
  }
}

// === SELECCIONAR TIPO DE OPERACI√ìN ===
function seleccionarOperacion(operacion) {
  const toggleButtons = document.querySelectorAll('#tipoOperacionToggle .toggle-btn');
  toggleButtons.forEach(btn => {
    btn.classList.remove('active');
    const radio = btn.querySelector('input[type="radio"]');
    if (radio && radio.value === operacion) {
      btn.classList.add('active');
    }
  });
  const opcionesVenta = document.getElementById("opcionesVenta");
  const opcionesAlquiler = document.getElementById("opcionesAlquiler");
  if (operacion === "Vender") {
    opcionesVenta.classList.add("active");
    opcionesAlquiler.classList.remove("active");
    opcionesVenta.style.display = "flex";
    opcionesAlquiler.style.display = "none";
  } else {
    opcionesAlquiler.classList.add("active");
    opcionesVenta.classList.remove("active");
    opcionesAlquiler.style.display = "flex";
    opcionesVenta.style.display = "none";
  }
  window.scrollTo(0, operacion === "Vender" ? opcionesVenta.offsetTop : opcionesAlquiler.offsetTop);
}

// === MOSTRAR FORMULARIO ===
function mostrarFormulario(tipo) {
  const formularios = ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'];
  formularios.forEach(f => {
    const form = document.getElementById(`formulario${f}`);
    form.classList.remove("active");
    form.style.display = "none";
  });
  const form = document.getElementById(`formulario${tipo}`);
  form.classList.add("active");
  form.style.display = "block";
  document.getElementById("btnAgregarPropiedad").textContent = "‚ûñ Cerrar Opciones";
  const propertyButtons = document.querySelectorAll('.property-btn');
  propertyButtons.forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.property-btn[onclick="mostrarFormulario('${tipo}')"]`).classList.add('active');
  window.scrollTo(0, form.offsetTop);
}

// === CONTADOR DE AMBIENTES ===
function cambiarAmbientes(tipo, cambio) {
  const input = document.getElementById(`ambientes${tipo}`);
  const display = document.getElementById(`ambientes${tipo}Display`);
  let valor = parseInt(input.value) + cambio;
  if (valor < 1) valor = 1;
  input.value = valor;
  display.textContent = valor;
}

// === SELECCIONAR S√ç/NO ===
function seleccionarOpcion(campo, valor) {
  const toggleGroup = document.getElementById(`${campo}Toggle`);
  const buttons = toggleGroup.querySelectorAll('.yes-no-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  toggleGroup.querySelector(`.yes-no-btn[onclick="seleccionarOpcion('${campo}', '${valor}')"]`).classList.add('active');
  document.getElementById(campo).value = valor;
}

// === INICIALIZAR EVENTOS ===
window.onload = function() {
  const email = localStorage.getItem("dueno");
  if (!email) { window.location.href = "index.html"; return; }
  ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'].forEach(tipo => {
    inicializarPreviewImagenes(tipo);
    inicializarPreviewVideos(tipo);
    if (tipo === 'Departamento' || tipo === 'Terreno' || tipo === 'Casa') inicializarFormatoPrecio(tipo);
  });
  // Asegurar que "Vender" est√© seleccionado al inicio
  document.querySelector('#tipoOperacionToggle input[value="Vender"]').checked = true;
  seleccionarOperacion('Vender');
}

// === AGREGAR / EDITAR ALQUILER ===
async function agregarAlquiler(tipo) {
  const msgEl = document.getElementById(`msg${tipo}`);
  msgEl.textContent = "Agregando propiedad...";
  msgEl.className = "estado-msg loading";
  let direccion = document.getElementById(`direccion${tipo}`).value;
  const ambientes = (tipo === "Departamento" || tipo === "Casa") ? document.getElementById(`ambientes${tipo}`).value : "";
  let precio = (tipo === "Departamento" || tipo === "Terreno" || tipo === "Casa") ? document.getElementById(`precio${tipo}`).value.replace(/\D/g, "") : "";
  const superficie = tipo === "Terreno" ? document.getElementById(`superficie${tipo}`).value : "";
  const patio = tipo === "Casa" ? document.getElementById(`patioCasa`).value : "";
  const garage = tipo === "Casa" ? document.getElementById(`garageCasa`).value : "";
  const antiguedad = tipo === "Casa" ? document.getElementById(`antiguedad${tipo}`).value : "";
  const infoIngreso = document.getElementById(`infoIngreso${tipo}`).value;
  const detalles = document.getElementById(`detalles${tipo}`).value;
  const operacion = document.querySelector('#tipoOperacionToggle input[type="radio"]:checked').value;
  let row = document.getElementById(`editRow${tipo}`).value || new Date().getTime();
  const enlaceCompartir = document.getElementById(`editRow${tipo}`).value ? document.getElementById(`enlaceCompartir${tipo}`).value : "";
  const email = localStorage.getItem("dueno");
  if (!direccion || 
      (tipo === "Departamento" && (!ambientes || !precio)) || 
      (tipo === "Terreno" && (!superficie || !precio)) || 
      (tipo === "Casa" && (!ambientes || !precio))) { 
    msgEl.className = "estado-msg error";
    msgEl.textContent = "Completa todos los campos obligatorios.";
    setTimeout(() => { msgEl.textContent = ""; }, 5000);
    return; 
  }
  direccion = direccion + ", Santo Tom√© Corrientes";
  const files = document.getElementById(`imagenFile${tipo}`).files;
  let uploadedURLs = [];
  for (let i = 0; i < files.length; i++) {
    const url = await subirImagenCloudinary(files[i]);
    if (url) uploadedURLs.push(url);
  }
  const videoFiles = document.getElementById(`videoFile${tipo}`).files;
  let videos = "";
  if (videoFiles.length > 0) {
    let videoURLs = [];
    for (let i = 0; i < videoFiles.length; i++) {
      const url = await subirVideoMux(videoFiles[i], row, tipo);
      if (url) videoURLs.push(url);
    }
    videos = videoURLs.join(",");
  } else if (document.getElementById(`editRow${tipo}`).value) {
    videos = document.getElementById(`existingVideos${tipo}`).value;
  }
  fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(direccion)}&key=${GEOCODE_KEY}`)
    .then(r => r.json()).then(data => {
      let lat = "", lng = "";
      if (data.results && data.results[0]) {
        lat = data.results[0].geometry.location.lat;
        lng = data.results[0].geometry.location.lng;
      }
      enviarAlquiler(tipo, uploadedURLs.join(","), lat, lng, enlaceCompartir, videos, operacion);
    }).catch(err => {
      msgEl.className = "estado-msg error";
      msgEl.textContent = "Error al obtener coordenadas: " + (err.message || "Error de conexi√≥n");
      setTimeout(() => { msgEl.textContent = ""; }, 5000);
    });
  function enviarAlquiler(tipo, fotosConcatenadas, lat, lng, enlaceCompartir, videos, operacion) {
    const action = document.getElementById(`editRow${tipo}`).value ? "editAlquiler" : "addAlquiler";
    const callback = action === "editAlquiler" ? "alquilerEditado" : "alquilerAgregado";
    let estado = "Activo";
    if (action === "editAlquiler" && deptosActivos >= limiteDeptos && planActual !== "Prueba") {
      estado = "Inactivo";
    }
    const script = document.createElement("script");
    let query = `${API_URL}?action=${action}&row=${row}&dueno=${encodeURIComponent(email)}&direccion=${encodeURIComponent(direccion)}&tipo=${encodeURIComponent(tipo)}`;
    if (tipo === "Departamento" || tipo === "Casa") query += `&ambientes=${encodeURIComponent(ambientes)}`;
    if (tipo === "Departamento" || tipo === "Terreno" || tipo === "Casa") query += `&precio=${encodeURIComponent(precio)}`;
    if (tipo === "Terreno") query += `&superficie=${encodeURIComponent(superficie)}`;
    if (tipo === "Casa") {
      query += `&patio=${encodeURIComponent(patio)}`;
      query += `&garage=${encodeURIComponent(garage)}`;
      query += `&antiguedad=${encodeURIComponent(antiguedad)}`;
    }
    query += `&fotos=${encodeURIComponent(fotosConcatenadas)}&infoIngreso=${encodeURIComponent(infoIngreso)}&detalles=${encodeURIComponent(detalles)}&lat=${lat}&lng=${lng}&contacto=auto&estado=${estado}&videos=${encodeURIComponent(videos)}&operacion=${encodeURIComponent(operacion)}`;
    if (enlaceCompartir) query += `&enlaceCompartir=${encodeURIComponent(enlaceCompartir)}`;
    query += `&callback=${callback}`;
    script.src = query;
    document.body.appendChild(script);
  }
}

// === RESET FORMULARIOS ===
function resetAllForms() {
  ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'].forEach(tipo => {
    document.getElementById(`formulario${tipo}`).classList.remove("active");
    document.getElementById(`formulario${tipo}`).style.display = "none";
    document.getElementById(`editRow${tipo}`).value = "";
    document.getElementById(`enlaceCompartir${tipo}`).value = "";
    document.getElementById(`existingVideos${tipo}`).value = "";
    document.getElementById(`direccion${tipo}`).value = "";
    if (tipo === "Departamento" || tipo === "Casa") {
      document.getElementById(`ambientes${tipo}`).value = "1";
      document.getElementById(`ambientes${tipo}Display`).textContent = "1";
      if (tipo === "Casa") {
        document.getElementById(`patioCasa`).value = "S√≠";
        document.getElementById(`garageCasa`).value = "S√≠";
        document.getElementById(`antiguedad${tipo}`).value = "";
        const patioButtons = document.querySelectorAll('#patioCasaToggle .yes-no-btn');
        const garageButtons = document.querySelectorAll('#garageCasaToggle .yes-no-btn');
        patioButtons.forEach(btn => btn.classList.remove('active'));
        garageButtons.forEach(btn => btn.classList.remove('active'));
        document.querySelector('#patioCasaToggle .yes-no-btn[onclick="seleccionarOpcion(\'patioCasa\', \'S√≠\')"]').classList.add('active');
        document.querySelector('#garageCasaToggle .yes-no-btn[onclick="seleccionarOpcion(\'garageCasa\', \'S√≠\')"]').classList.add('active');
      }
      document.getElementById(`precio${tipo}`).value = "";
    }
    if (tipo === "Terreno") {
      document.getElementById(`superficie${tipo}`).value = "";
      document.getElementById(`precio${tipo}`).value = "";
    }
    document.getElementById(`infoIngreso${tipo}`).value = "";
    document.getElementById(`detalles${tipo}`).value = "";
    document.getElementById(`imagenFile${tipo}`).value = "";
    document.getElementById(`videoFile${tipo}`).value = "";
    imagenesBase64[tipo] = [];
    videosBase64[tipo] = [];
    actualizarPreview(tipo);
    actualizarVideoPreview(tipo);
    document.getElementById(`msg${tipo}`).textContent = "";
    document.getElementById(`btnGuardar${tipo}`).textContent = "Agregar";
  });
  document.getElementById("opcionesPropiedad").classList.remove("active");
  document.getElementById("opcionesVenta").classList.remove("active");
  document.getElementById("opcionesAlquiler").classList.remove("active");
  document.getElementById("opcionesVenta").style.display = "flex";
  document.getElementById("opcionesAlquiler").style.display = "none";
  document.getElementById("btnAgregarPropiedad").textContent = "‚ûï Agregar Propiedad";
  document.querySelector('#tipoOperacionToggle input[value="Vender"]').checked = true;
  seleccionarOperacion("Vender");
}

// === EDITAR ALQUILER ===
function editarAlquiler(row, datos) {
  const tipo = datos.Tipo || "Departamento";
  document.getElementById("btnAgregarPropiedad").textContent = "‚ûñ Cerrar Opciones";
  document.getElementById(`formulario${tipo}`).classList.add("active");
  document.getElementById(`formulario${tipo}`).style.display = "block";
  document.getElementById(`btnGuardar${tipo}`).textContent = "Guardar Cambios";
  document.getElementById(`editRow${tipo}`).value = row;
  document.getElementById(`enlaceCompartir${tipo}`).value = datos["Enlace para compartir"] || "";
  document.getElementById(`existingVideos${tipo}`).value = datos.Videos || "";
  document.getElementById(`direccion${tipo}`).value = datos.Direccion || "";
  if (tipo === "Departamento" || tipo === "Casa") {
    const ambientes = datos["Nro Ambientes"] || "1";
    document.getElementById(`ambientes${tipo}`).value = ambientes;
    document.getElementById(`ambientes${tipo}Display`).textContent = ambientes;
    document.getElementById(`precio${tipo}`).value = formatoPrecio(datos.Precio);
  }
  if (tipo === "Terreno") {
    document.getElementById(`superficie${tipo}`).value = datos.Superficie || "";
    document.getElementById(`precio${tipo}`).value = formatoPrecio(datos.Precio);
  }
  if (tipo === "Casa") {
    const patio = datos.Patio || "S√≠";
    const garage = datos.Garage || "S√≠";
    document.getElementById(`patio${tipo}`).value = patio;
    document.getElementById(`garage${tipo}`).value = garage;
    document.getElementById(`antiguedad${tipo}`).value = datos.Antiguedad || "";
    const patioButtons = document.querySelectorAll('#patioCasaToggle .yes-no-btn');
    const garageButtons = document.querySelectorAll('#garageCasaToggle .yes-no-btn');
    patioButtons.forEach(btn => btn.classList.remove('active'));
    garageButtons.forEach(btn => btn.classList.remove('active'));
    document.querySelector(`#patioCasaToggle .yes-no-btn[onclick="seleccionarOpcion('patioCasa', '${patio}')"]`).classList.add('active');
    document.querySelector(`#garageCasaToggle .yes-no-btn[onclick="seleccionarOpcion('garageCasa', '${garage}')"]`).classList.add('active');
  }
  document.getElementById(`infoIngreso${tipo}`).value = datos.InfoIngreso || "";
  document.getElementById(`detalles${tipo}`).value = datos.Detalles || "";
  document.querySelector(`#tipoOperacionToggle input[value="${datos.Operacion || "Vender"}"]`).checked = true;
  seleccionarOperacion(datos.Operacion || "Vender");
  imagenesBase64[tipo] = datos.Fotos ? datos.Fotos.split(",") : [];
  videosBase64[tipo] = datos.Videos ? datos.Videos.split(",") : [];
  actualizarPreview(tipo);
  actualizarVideoPreview(tipo);
  window.scrollTo(0, document.getElementById(`formulario${tipo}`).offsetTop);
}

// === ALQUILER AGREGADO ===
function alquilerAgregado(res) {
  const formularios = ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'];
  formularios.forEach(tipo => {
    const msgEl = document.getElementById(`msg${tipo}`);
    if (res.success) {
      msgEl.className = "estado-msg success";
      msgEl.textContent = "‚úÖ Propiedad agregada con √©xito";
      setTimeout(() => {
        resetAllForms();
        // cargarAlquileres(); // Comentado para mantener el archivo independiente
        // cargarEstadoPlan();
      }, 3000);
    } else {
      msgEl.className = "estado-msg error";
      msgEl.textContent = "‚ùå Error al agregar: " + (res.error || "desconocido");
      setTimeout(() => { msgEl.textContent = ""; }, 5000);
    }
  });
}

// === ALQUILER EDITADO ===
function alquilerEditado(res) {
  const formularios = ['Departamento', 'Local', 'Temporario', 'Terreno', 'Casa'];
  formularios.forEach(tipo => {
    const msgEl = document.getElementById(`msg${tipo}`);
    if (res.success) {
      msgEl.className = "estado-msg success";
      msgEl.textContent = "‚úÖ Cambios guardados correctamente";
      setTimeout(() => {
        resetAllForms();
        // cargarAlquileres();
      }, 3000);
    } else {
      msgEl.className = "estado-msg error";
      msgEl.textContent = "‚ùå Error al editar: " + (res.error || "desconocido");
      setTimeout(() => { msgEl.textContent = ""; }, 5000);
    }
  });
}
</script>
</body>
</html>
