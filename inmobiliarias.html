<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SSJ5DG33JK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-SSJ5DG33JK');
</script>
<link rel="icon" type="image/png" href="https://i.postimg.cc/MKpMcrcQ/AlquiYa.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  :root {
    --primary: #3483fa;
    --primary-dark: #2565c0;
    --success: #25D366;
    --bg: #fafafa;
    --card: white;
    --text: #333;
    --border: #e0e0e0;
    --shadow: 0 4px 20px rgba(0,0,0,0.08);
    --radius: 14px;
    --transition: all 0.3s ease;
  }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
  header { background: white; padding: 1rem; text-align: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000; }
  header img { max-width: 250px; height: auto; }

  /* MEN√ö PRINCIPAL COMPACTO */
  nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.8rem;
    background: white;
    padding: 0.9rem 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    flex-wrap: nowrap;
    overflow-x: auto;
    white-space: nowrap;
    scrollbar-width: none;
  }
  nav::-webkit-scrollbar { display: none; }
  nav a, nav select {
    text-decoration: none;
    font-weight: 600;
    color: var(--text);
    padding: 0.65rem 1rem;
    border-radius: 10px;
    transition: var(--transition);
    font-size: 0.95rem;
    min-width: fit-content;
    flex-shrink: 0;
    background: none;
    border: none;
  }
  nav a:hover, nav a.active, nav select:hover {
    background: var(--primary);
    color: white;
  }

  /* BOTONES FILTROS */
  #boton-filtros-container {
    display: flex;
    justify-content: center;
    gap: 12px;
    padding: 0.75rem 1rem;
    background: white;
    border-bottom: 1px solid #eee;
  }
  #boton-filtros-container button, #boton-filtros-container select {
    padding: 0.5rem 1rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 50px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 3px 8px rgba(52,131,250,0.25);
    transition: var(--transition);
  }
  #boton-filtros-container button:hover {
    background: var(--primary-dark);
    transform: translateY(-3px);
  }

  /* FILTROS */
  #filtros {
    max-width: 800px;
    margin: 0 auto 2rem;
    padding: 1.8rem;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    display: none;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: end;
  }
  #filtros input, #filtros select {
    padding: 0.9rem 1rem;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    flex: 1;
    min-width: 140px;
  }
  #filtros button {
    padding: 0.9rem 2.5rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
  }
  #filtros button:hover {
    background: var(--primary-dark);
    transform: translateY(-3px);
  }

  /* MAPA */
  #map {
    height: 65vh;
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    margin: 1.5rem auto;
    max-width: 1400px;
  }
  #loading-msg {
    text-align: center;
    font-weight: 600;
    color: var(--primary);
    font-size: 1.3rem;
    margin: 2rem;
    display: none;
  }

  /* DETALLE PROPIEDAD (MODERNO) */
  #alquiler-detalle {
    display: none;
    max-width: 800px;
    margin: 2rem auto;
    padding: 2rem;
    background: var(--card);
    border: 2px solid var(--primary);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    animation: fadeIn 0.6s ease;
    position: relative;
  }
  #alquiler-detalle.highlight { animation: resaltar 1.2s ease; }
  #alquiler-detalle h2 {
    margin-top: 0;
    color: var(--primary);
    font-size: 2rem;
  }
  #alquiler-detalle p {
    margin: 0.9rem 0;
    padding-bottom: 0.9rem;
    border-bottom: 1px solid #eee;
  }
  #alquiler-detalle p:last-child { border-bottom: none; }
  .action-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin: 1.5rem 0;
  }
  .copy-share-btn {
    background: #10b981;
    color: white;
    padding: 1rem 1.8rem;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
  }
  .copy-share-btn:hover { background: #059669; }

  #imagenes-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 14px;
    margin: 1.8rem 0;
  }
  #imagenes-container img {
    width: 100%;
    height: 110px;
    object-fit: cover;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 3px 12px rgba(0,0,0,0.12);
    transition: var(--transition);
  }
  #imagenes-container img:hover {
    transform: scale(1.06);
    box-shadow: 0 10px 30px rgba(0,0,0,0.22);
  }

  /* FOTO PERFIL DUE√ëO */
  .owner-profile-img {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: transform 0.2s ease;
  }
  .owner-profile-img:hover { transform: scale(1.1); }

  /* MODAL IM√ÅGENES */
  #modal-img {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.94);
    backdrop-filter: blur(10px);
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 2rem;
  }
  #modal-img img {
    max-width: 95%;
    max-height: 95%;
    border-radius: 18px;
    box-shadow: 0 25px 60px rgba(0,0,0,0.6);
  }
  .close-btn, .prev-btn, .next-btn {
    position: absolute;
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    font-size: 30px;
    cursor: pointer;
    backdrop-filter: blur(12px);
    transition: var(--transition);
  }
  .close-btn:hover, .prev-btn:hover, .next-btn:hover {
    background: var(--primary);
    transform: scale(1.12);
  }
  .close-btn { top: 20px; right: 20px; }
  .prev-btn { left: 20px; }
  .next-btn { right: 20px; }

  /* MARCADORES */
  .marker-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #3483fa;
    color: white;
    font-weight: bold;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    border: 2px solid white;
    box-shadow: 0 0 2px #000;
  }
  .popup-button {
    display: inline-block;
    padding: 8px 16px;
    margin-top: 8px;
    background: var(--primary);
    color: white;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: var(--transition);
  }
  .popup-button:hover { background: var(--primary-dark); }

  /* ANIMACIONES */
  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes resaltar { 0%, 100% { transform: scale(1); box-shadow: var(--shadow); } 50% { transform: scale(1.02); box-shadow: 0 0 35px rgba(52,131,250,0.4); } }

  /* FOOTER */
  footer {
    background: var(--primary);
    color: white;
    padding: 2.5rem 1rem 1.5rem;
    margin-top: 4rem;
  }
  .footer-container {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    align-items: center;
    text-align: center;
  }
  .footer-logo img { max-width: 180px; height: auto; }
  .footer-copy { font-size: 0.95rem; opacity: 0.9; margin-top: 1.5rem; grid-column: 1 / -1; }
</style>
</head>
<body>

<header>
  <img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="Logo Alqui Ya">
</header>

<nav>
  <select id="filtroOperacion" onchange="updateFiltros()">
    <option value="Alquilar">Alquilar</option>
    <option value="Comprar">Comprar</option>
  </select>
  <button onclick="toggleFiltros()">A√±adir Filtros</button>
</nav>

<div id="filtros">
  <div id="filtros-alquilar">
    <input type="number" id="filtroAmb" placeholder="Nro de Ambientes">
    <input type="text" id="filtroMin" placeholder="Precio M√≠nimo" oninput="formatCurrency(this)">
    <input type="text" id="filtroMax" placeholder="Precio M√°ximo" oninput="formatCurrency(this)">
    <select id="filtroTipoAlquilar">
      <option value="">Todos los tipos</option>
      <option value="Departamento">Departamento</option>
      <option value="Temporario">Alquiler Temporario</option>
      <option value="Local">Local Comercial</option>
    </select>
    <label class="checkbox-label">
      <input type="checkbox" id="filtroMascotas">
      <span class="custom-checkbox"></span>
      Mascotas Permitidas
    </label>
    <label class="checkbox-label">
      <input type="checkbox" id="filtroAmoblado">
      <span class="custom-checkbox"></span>
      Amoblado
    </label>
  </div>
  <div id="filtros-comprar" style="display:none;">
    <select id="filtroTipoComprar">
      <option value="">Todos los tipos</option>
      <option value="Terreno">Terreno</option>
      <option value="Departamento">Departamento</option>
      <option value="Casa">Casa</option>
      <option value="Local">Local Comercial</option>
    </select>
  </div>
  <button onclick="cargarPropiedades()">Filtrar</button>
</div>

<div id="loading-msg">Cargando propiedades...</div>
<div id="map"></div>

<div id="alquiler-detalle"></div>

<!-- MODAL IM√ÅGENES -->
<div id="modal-img" onclick="if(event.target===this) cerrarModal()">
  <img id="img-grande" src="" alt="Imagen grande">
  <button class="close-btn" onclick="cerrarModal()">X</button>
  <button class="prev-btn" onclick="cambiarImagen(-1)"><</button>
  <button class="next-btn" onclick="cambiarImagen(1)">></button>
</div>

<footer>
  <div class="footer-container">
    <div class="footer-logo">
      <img src="https://i.postimg.cc/FHXRBTTX/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.png" alt="Logo AlquiYa">
    </div>
    <div>
      <a href="https://www.alquiya.com.ar" style="display:inline-block;background:white;color:#3483fa;font-weight:700;padding:0.9rem 2.6rem;border-radius:50px;font-size:1.28rem;box-shadow:0 6px 20px rgba(52,131,250,0.3);text-decoration:none;">
        ‚Üê Volver al Inicio
      </a>
    </div>
    <div>
      <a href="https://www.instagram.com/alquiya.st/" target="_blank">
        <img src="https://i.postimg.cc/GmVWTXX0/394a7aaecd6b8ce44528649681d9fa05.png" alt="Instagram" style="width:40px;height:40px;">
      </a>
    </div>
    <div class="footer-copy">
      ¬© 2025 AlquiYa ‚Ä¢ Todos los derechos reservados
    </div>
  </div>
</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const webAppURL = "https://script.google.com/macros/s/AKfycbyFvDRwPZoG6ChhvcxGm6B27ziD6Qkg4RcH0TI9K59b7zPz7iFxy7mgmbs5mo5T-TxD/exec";
let currentImages = [];
let currentImageIndex = 0;
let map = null;
let markersLayer = null;
let inmobiliariaEmail = "";

function initializeMap() {
  if (map) return;
  map = L.map('map').setView([-28.5503, -56.0406], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
  }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
}

/* UTILIDADES */
function getField(obj, keys) {
  for (const k of keys) {
    if (Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null && obj[k] !== "") return obj[k];
  }
  return "";
}
function toNumber(val) {
  if (typeof val === "number") return val;
  if (!val) return 0;
  const clean = String(val).replace(/[^\d.,-]/g, "").replace(/\./g, "").replace(",", ".");
  return parseFloat(clean) || 0;
}
function toInt(val, def = 0) { return parseInt(val, 10) || def; }
function formatPrice(num) {
  if (!num) return "";
  const clean = String(num).replace(/[^\d]/g, "");
  return "$" + parseInt(clean, 10).toLocaleString('es-AR').replace(/,/g, ".");
}
function formatCurrency(el) {
  let raw = String(el.value || "").replace(/\D/g, '');
  if (raw === '') { el.value = ''; return; }
  el.value = '$' + parseInt(raw, 10).toLocaleString('es-AR');
}
function parseCurrency(str) {
  let cleaned = String(str).replace(/[^\d]/g, '');
  return parseInt(cleaned, 10) || 0;
}
function driveUrlDirect(url) {
  if (!url) return "";
  const match = url.match(/\/d\/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)/);
  const id = match ? (match[1] || match[2]) : null;
  return id ? `https://drive.google.com/uc?export=view&id=${id}` : url;
}

/* M√âTRICAS */
async function incrementarMetrica(idPropiedad, metrica = "vistas") {
  if (!idPropiedad) return;
  await fetch(`${webAppURL}?action=incrementarmetrica&idPropiedad=${idPropiedad}&metrica=${metrica}`, {method:"GET"}).catch(()=>{});
}

/* MODAL IM√ÅGENES */
function abrirModal(src, images, index = 0) {
  currentImages = images.filter(url => url && url.trim() !== "");
  if (currentImages.length === 0) return;
  currentImageIndex = index < currentImages.length ? index : 0;
  document.getElementById("img-grande").src = currentImages[currentImageIndex];
  document.getElementById("modal-img").style.display = "flex";
  document.querySelector(".prev-btn").style.display = currentImages.length > 1 ? "block" : "none";
  document.querySelector(".next-btn").style.display = currentImages.length > 1 ? "block" : "none";
}
function cerrarModal() { document.getElementById("modal-img").style.display = "none"; }
function cambiarImagen(dir) {
  if (currentImages.length <= 1) return;
  currentImageIndex = (currentImageIndex + dir + currentImages.length) % currentImages.length;
  document.getElementById("img-grande").src = currentImages[currentImageIndex];
}

/* MOSTRAR DETALLE (COPIADO DE INDEX.HTML) */
async function mostrarDetalle(prop) {
  if (idPropiedad) await incrementarMetrica(idPropiedad, "vistas");

  const detalle = document.getElementById('alquiler-detalle');
  const titulo = getField(prop, ["T√≠tulo", "titulo", "Titulo", "T√≠tulo Propiedad"]) || getField(prop, ["Tipo"]) || "Propiedad";
  const tipo = getField(prop, ["Tipo"]);
  const direccion = getField(prop, ["Direccion", "Direcci√≥n", "Domicilio"]);
  const precioRaw = getField(prop, ["Precio"]);
  const formattedPrecio = formatPrice(precioRaw);
  const nroAmb = toInt(getField(prop, ["Nro Ambientes", "Ambientes"]));
  const mascotas = getField(prop, ["Mascotas"]);
  const amoblado = getField(prop, ["Amoblado"]);
  const infoIngreso = getField(prop, ["Informacion ingreso", "Informaci√≥n ingreso"]);
  const detalles = getField(prop, ["Detalles", "Detalle", "Descripcion"]);
  const fotos = getField(prop, ["Fotos", "Imagenes", "Im√°genes", "images"]);
  const contacto = getField(prop, ["Contacto", "Whatsapp", "WhatsApp"]);
  const idPropiedad = getField(prop, ["ID Propiedad", "idPropiedad", "ID"]);
  const fotoPerfil = getField(prop, ["FotoPerfil", "fotoPerfil", "Foto Perfil", "FotoPerfilDue√±o"]) || "https://i.postimg.cc/0jFNDZ7Y/default-avatar.png";

  detalle.innerHTML = `<h2>${titulo}</h2><p id="metricas-error"></p>`;

  const profileImg = document.createElement('img');
  profileImg.className = "owner-profile-img";
  profileImg.src = fotoPerfil;
  profileImg.onclick = () => abrirModal(fotoPerfil, [fotoPerfil], 0);
  detalle.appendChild(profileImg);

  const rows = [
    ['Tipo', tipo],
    ['Direcci√≥n', direccion || 'No disponible'],
    ['Precio', formattedPrecio || '-'],
    ['Ambientes', nroAmb || '-'],
    ['Mascotas', mascotas || '-'],
    ['Amoblado', amoblado || '-'],
    ['Informaci√≥n de ingreso', infoIngreso || '-'],
    ['Detalles', detalles || '-']
  ];
  rows.forEach(([label, val]) => {
    if (val && val !== 'No disponible' && val !== '-') {
      const p = document.createElement('p');
      p.innerHTML = `<b>${label}:</b> ${val}`;
      detalle.appendChild(p);
    }
  });

  const imgContainer = document.createElement('div');
  imgContainer.id = 'imagenes-container';
  if (fotos) {
    const urls = fotos.split(',').map(f => driveUrlDirect(f.trim())).filter(Boolean);
    urls.forEach((url, i) => {
      const img = document.createElement('img');
      img.src = url;
      img.onclick = () => abrirModal(url, urls, i);
      imgContainer.appendChild(img);
    });
  }
  detalle.appendChild(imgContainer);

  const actionDiv = document.createElement('div');
  actionDiv.className = 'action-buttons';
  if (contacto) {
    const waBtn = document.createElement('button');
    waBtn.textContent = 'Contactar por WhatsApp';
    waBtn.style.cssText = 'background:#25D366;color:white;padding:1rem 2rem;border-radius:14px;border:none;font-weight:600;cursor:pointer;margin:5px;';
    waBtn.onclick = () => {
      incrementarMetrica(idPropiedad, "contactos");
      const msg = `Hola, consulto por "${titulo}"`;
      window.open(`https://wa.me/${contacto}?text=${encodeURIComponent(msg)}`, '_blank');
    };
    actionDiv.appendChild(waBtn);
  }
  if (idPropiedad) {
    const copyBtn = document.createElement('button');
    copyBtn.className = 'copy-share-btn';
    copyBtn.setAttribute('data-id', idPropiedad);
    copyBtn.textContent = 'Copiar Enlace';
    actionDiv.appendChild(copyBtn);
  }
  detalle.appendChild(actionDiv);

  detalle.style.display = 'block';
  detalle.classList.add("highlight");
  detalle.scrollIntoView({ behavior: "smooth" });
  setTimeout(() => detalle.classList.remove("highlight"), 1200);
  map.invalidateSize();
}

/* UI */
function toggleFiltros() {
  const f = document.getElementById("filtros");
  f.style.display = (f.style.display === "none" || !f.style.display) ? "flex" : "none";
}
function updateFiltros() {
  const op = document.getElementById("filtroOperacion").value;
  document.getElementById("filtros-alquilar").style.display = op === "Alquilar" ? "flex" : "none";
  document.getElementById("filtros-comprar").style.display = op === "Comprar" ? "flex" : "none";
  cargarPropiedades();
}

/* CARGA PROPIEDADES */
async function cargarPropiedades() {
  const loadingEl = document.getElementById("loading-msg");
  loadingEl.style.display = "block";
  loadingEl.textContent = "Cargando propiedades...";

  if (!map || !markersLayer) initializeMap();
  markersLayer.clearLayers();
  document.getElementById("alquiler-detalle").style.display = "none";

  // Marcadores est√°ticos
  const uniIcon = L.divIcon({ className: 'marker-icon', html: 'üéì', iconSize: [30, 30], iconAnchor: [15, 15] });
  const hospIcon = L.divIcon({ className: 'marker-icon', html: 'üè•', iconSize: [30, 30], iconAnchor: [15, 15] });
  const superIcon = L.divIcon({ className: 'marker-icon', html: 'üõí', iconSize: [30, 30], iconAnchor: [15, 15] });
  const busIcon = L.divIcon({ className: 'marker-icon', html: 'üöå', iconSize: [30, 30], iconAnchor: [15, 15] });
  const policeIcon = L.divIcon({ className: 'marker-icon', html: 'üëÆ', iconSize: [30, 30], iconAnchor: [15, 15] });
  L.marker([-28.5509978, -56.0409727], { icon: uniIcon }).addTo(markersLayer).bindPopup("<b>Facultad Fundaci√≥n Barcel√≥</b>");
  L.marker([-28.5551127, -56.0389282], { icon: hospIcon }).addTo(markersLayer).bindPopup("<b>Hospital Universitario San Juan Bautista</b>");
  L.marker([-28.5519443, -56.0401962], { icon: superIcon }).addTo(markersLayer).bindPopup("<b>Supermercado La Bomba</b>");
  L.marker([-28.5472635, -56.0438082], { icon: superIcon }).addTo(markersLayer).bindPopup("<b>Supermercado La Previsora</b>");
  L.marker([-28.5462903, -56.0440365], { icon: superIcon }).addTo(markersLayer).bindPopup("<b>Supermercado La Econom√≠a</b>");
  L.marker([-28.5468697, -56.0432862], { icon: busIcon }).addTo(markersLayer).bindPopup("<b>Terminal de Omnibus</b>");
  L.marker([-28.5487787, -56.0396171], { icon: policeIcon }).addTo(markersLayer).bindPopup("<b>Polic√≠a</b>");

  const urlParams = new URLSearchParams(window.location.search);
  inmobiliariaEmail = urlParams.get('email') || urlParams.get('') || "";
  if (!inmobiliariaEmail.includes('@')) {
    loadingEl.textContent = "Email de inmobiliaria no v√°lido";
    return;
  }

  const operacion = document.getElementById("filtroOperacion").value;
  const filtroAmb = toInt(document.getElementById("filtroAmb").value);
  const filtroMin = parseCurrency(document.getElementById("filtroMin").value) || 0;
  const filtroMax = parseCurrency(document.getElementById("filtroMax").value) || Infinity;
  const filtroMascotas = document.getElementById("filtroMascotas").checked;
  const filtroAmoblado = document.getElementById("filtroAmoblado").checked;
  const filtroTipoAlquilar = document.getElementById("filtroTipoAlquilar").value;
  const filtroTipoComprar = document.getElementById("filtroTipoComprar").value;

  try {
    const res = await fetch(`${webAppURL}?action=getInmobiliaria&email=${encodeURIComponent(inmobiliariaEmail)}`);
    const data = await res.json();

    loadingEl.style.display = "none";

    if (!data.success || !data.alquileres) {
      loadingEl.textContent = "Inmobiliaria no encontrada";
      return;
    }

    document.querySelector("#inmobiliaria-nombre h2").textContent = `Inmobiliaria "${data.data.Nombre || "Sin nombre"}"`;

    let cont = 0;
    const propertyMarkers = [];

    data.alquileres.forEach(a => {
      const subtipo = getField(a, ["Subtipo", "subtipo"]);
      if ((operacion === "Alquilar" && subtipo !== "Alquilar") || (operacion === "Comprar" && subtipo !== "Vender")) return;

      const lat = parseFloat(getField(a, ["Latitud", "lat"]));
      const lng = parseFloat(getField(a, ["Longitud", "lng"]));
      if (isNaN(lat) || isNaN(lng)) return;

      const tipo = getField(a, ["Tipo"]);
      if (operacion === "Alquilar" && filtroTipoAlquilar && tipo !== filtroTipoAlquilar) return;
      if (operacion === "Comprar" && filtroTipoComprar && tipo !== filtroTipoComprar) return;

      const nroAmb = toInt(getField(a, ["Nro Ambientes", "Ambientes"]));
      if (operacion === "Alquilar" && filtroAmb && nroAmb !== filtroAmb) return;

      const precio = toNumber(getField(a, ["Precio"]));
      if (operacion === "Alquilar" && (precio < filtroMin || precio > filtroMax)) return;

      if (operacion === "Alquilar" && filtroMascotas && getField(a, ["Mascotas"]).toLowerCase() !== "s√≠") return;
      if (operacion === "Alquilar" && filtroAmoblado && getField(a, ["Amoblado"]).toLowerCase() !== "s√≠") return;

      let iconHtml = 'üè†';
      if (tipo === "Temporario") iconHtml = '‚åõ';
      else if (tipo === "Local") iconHtml = 'üõçÔ∏è';
      else if (nroAmb > 0) iconHtml = `üè†<span style="font-size:12px;margin-left:2px;">${nroAmb}</span>`;

      const icon = L.divIcon({ className: 'marker-icon', html: iconHtml, iconSize: [30, 30], iconAnchor: [15, 15] });
      const marker = L.marker([lat, lng], { icon }).addTo(markersLayer);
      propertyMarkers.push(marker);

      const popupDiv = document.createElement('div');
      popupDiv.style.padding = "12px";
      popupDiv.style.minWidth = "240px";

      const fotoPerfil = getField(a, ["FotoPerfil", "fotoPerfil"]) || "https://i.postimg.cc/0jFNDZ7Y/default-avatar.png";
      const popupImg = document.createElement('img');
      popupImg.className = "popup-profile-img";
      popupImg.src = fotoPerfil;
      popupImg.style.width = "44px"; popupImg.style.height = "44px";
      popupImg.onclick = e => { e.stopPropagation(); abrirModal(fotoPerfil, [fotoPerfil]); };
      popupDiv.appendChild(popupImg);

      popupDiv.innerHTML += `
        <div style="margin-right:60px;">
          <b style="font-size:16px;display:block;margin-bottom:4px;">${getField(a, ["T√≠tulo", "titulo", "Titulo"]) || tipo}</b>
          <b>Tipo:</b> ${tipo}<br>
          <b>Precio:</b> ${formatPrice(getField(a, ["Precio"]))}
        </div>
      `;

      const verBtn = document.createElement('button');
      verBtn.className = 'popup-button';
      verBtn.textContent = 'Ver Detalles';
      verBtn.onclick = () => mostrarDetalle(a);
      popupDiv.appendChild(verBtn);

      marker.bindPopup(popupDiv);
      cont++;
    });

    if (propertyMarkers.length > 0) {
      const group = L.featureGroup(propertyMarkers);
      map.fitBounds(group.getBounds(), { padding: [50, 50] });
    }
  } catch (err) {
    loadingEl.style.display = "none";
    loadingEl.textContent = "Error de conexi√≥n";
    console.error(err);
  }
}

/* COPIAR ENLACE */
document.addEventListener('click', e => {
  if (e.target && e.target.classList.contains('copy-share-btn')) {
    const id = e.target.getAttribute('data-id');
    const url = `https://www.alquiya.com.ar/propiedad.html?id=${id}`;
    navigator.clipboard.writeText(url).then(() => {
      const txt = e.target.textContent;
      e.target.textContent = "¬°Copiado!";
      setTimeout(() => e.target.textContent = txt, 2000);
    });
  }
});

/* INIT */
window.onload = () => {
  initializeMap();
  cargarPropiedades();
};
</script>
</body>
</html>
