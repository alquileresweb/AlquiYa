<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SSJ5DG33JK"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-SSJ5DG33JK');
</script>
<link rel="icon" type="image/png" href="https://i.postimg.cc/MKpMcrcQ/AlquiYa.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
:root {
  --primary: #3483fa;
  --primary-dark: #2565c0;
  --radius: 14px;
  --transition: all 0.3s ease;
}
body { margin: 0; font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; background: #fafafa; color: #333; }
header {
  background: white;
  padding: 15px;
  text-align: center;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}
#logo-overlay img { max-width: 180px; height: auto; }
#inmobiliaria-nombre {
  text-align: center;
  margin: 20px 0;
}
#inmobiliaria-nombre h2 {
  color: #333;
  font-size: 1.8em;
  font-weight: 600;
}
#map {
  height: 65vh;
  width: 100%;
  margin: 20px 0;
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}
#loading-msg {
  text-align: center;
  font-weight: 600;
  color: var(--primary);
  font-size: 1.3rem;
  margin: 2rem;
  display: none;
}
#boton-filtros-container {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin: 15px 0;
  flex-wrap: wrap;
}
#boton-filtros-container select,
#boton-filtros-container button {
  padding: 0.9rem 1.8rem;
  border-radius: var(--radius);
  border: 1.5px solid #e0e0e0;
  background: white;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}
#boton-filtros-container button {
  background: var(--primary);
  color: white;
  border: none;
}
#boton-filtros-container button:hover {
  background: var(--primary-dark);
  transform: translateY(-3px);
}
#filtros {
  max-width: 800px;
  margin: 0 auto 2rem;
  padding: 1.8rem;
  background: white;
  border-radius: var(--radius);
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  display: none;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: end;
}
#filtros input,
#filtros select {
  padding: 0.9rem 1rem;
  border: 1.5px solid #e0e0e0;
  border-radius: var(--radius);
  font-size: 1rem;
  flex: 1;
  min-width: 140px;
}
#filtros input:focus,
#filtros select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(52,131,250,0.15);
}
#filtros label {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  font-weight: 500;
  white-space: nowrap;
}
#filtros button {
  padding: 0.9rem 2.5rem;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  cursor: pointer;
}
#filtros button:hover {
  background: var(--primary-dark);
  transform: translateY(-3px);
}

/* ESTILOS DEL POPUP - IGUAL QUE INDEX.HTML */
.leaflet-popup-content {
  margin: 12px !important;
  min-width: 240px;
  font-size: 14px;
}
.leaflet-popup-content-wrapper {
  border-radius: 14px !important;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
}
.popup-profile-img {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid white;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  cursor: pointer;
  transition: transform 0.2s ease;
  z-index: 10;
}
.popup-profile-img:hover {
  transform: scale(1.1);
}
.popup-button {
  display: block;
  width: 100%;
  padding: 10px 16px;
  margin-top: 12px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 10px;
  font-weight: bold;
  font-size: 1rem;
  cursor: pointer;
  transition: var(--transition);
}
.popup-button:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
}

/* MARCADORES */
.marker-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #3483fa;
  color: white;
  font-weight: bold;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  border: 2px solid white;
  box-shadow: 0 0 2px #000;
}

/* MODAL IM√ÅGENES */
#modal-img {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.94);
  backdrop-filter: blur(10px);
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 2rem;
}
#modal-img img {
  max-width: 95%;
  max-height: 95%;
  border-radius: 18px;
  box-shadow: 0 25px 60px rgba(0,0,0,0.6);
}
.close-btn, .prev-btn, .next-btn {
  position: absolute;
  background: rgba(255,255,255,0.2);
  color: white;
  border: none;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  font-size: 30px;
  cursor: pointer;
  backdrop-filter: blur(12px);
  transition: var(--transition);
}
.close-btn:hover, .prev-btn:hover, .next-btn:hover {
  background: var(--primary);
  transform: scale(1.12);
}
.close-btn { top: 20px; right: 20px; }
.prev-btn { left: 20px; }
.next-btn { right: 20px; }
</style>
</head>
<body>

<header>
  <div id="logo-overlay">
    <img src="https://i.postimg.cc/SxDLDXZz/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.jpg" alt="Logo Alqui Ya">
  </div>
</header>

<div id="inmobiliaria-nombre">
  <h2></h2>
</div>

<div id="boton-filtros-container">
  <select id="filtroOperacion" onchange="updateFiltros()">
    <option value="Alquilar">Alquilar</option>
    <option value="Comprar">Comprar</option>
  </select>
  <button onclick="toggleFiltros()">A√±adir Filtros</button>
</div>

<div id="filtros">
  <div id="filtros-alquilar">
    <input type="number" id="filtroAmb" placeholder="Nro de Ambientes">
    <input type="text" id="filtroMin" placeholder="Precio M√≠nimo" oninput="formatCurrency(this)">
    <input type="text" id="filtroMax" placeholder="Precio M√°ximo" oninput="formatCurrency(this)">
    <select id="filtroTipoAlquilar">
      <option value="">Todos los tipos</option>
      <option value="Departamento">Departamento</option>
      <option value="Temporario">Alquiler Temporario</option>
      <option value="Local">Local Comercial</option>
    </select>
    <label><input type="checkbox" id="filtroMascotas"> Mascotas Permitidas</label>
    <label><input type="checkbox" id="filtroAmoblado"> Amoblado</label>
  </div>
  <div id="filtros-comprar" style="display: none;">
    <select id="filtroTipoComprar">
      <option value="">Todos los tipos</option>
      <option value="Terreno">Terreno</option>
      <option value="Departamento">Departamento</option>
      <option value="Casa">Casa</option>
      <option value="Local">Local Comercial</option>
    </select>
  </div>
  <button onclick="cargarPropiedades()">Filtrar</button>
</div>

<div id="loading-msg">Cargando propiedades...</div>
<div id="map"></div>

<!-- MODAL IM√ÅGENES -->
<div id="modal-img" onclick="if(event.target === this) cerrarModal()">
  <img id="img-grande" src="" alt="Imagen grande">
  <button class="close-btn" onclick="cerrarModal()">X</button>
  <button class="prev-btn" onclick="cambiarImagen(-1)"><</button>
  <button class="next-btn" onclick="cambiarImagen(1)">></button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const webAppURL = "https://script.google.com/macros/s/AKfycbyFvDRwPZoG6ChhvcxGm6B27ziD6Qkg4RcH0TI9K59b7zPz7iFxy7mgmbs5mo5T-TxD/exec";
let currentImages = [];
let currentImageIndex = 0;
let inmobiliariaEmail = "";

let map = L.map('map').setView([-28.5503, -56.0406], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' }).addTo(map);
let markersLayer = L.layerGroup().addTo(map);

function getField(obj, keys) {
  for (const k of keys) {
    if (Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null && obj[k] !== "") return obj[k];
  }
  return "";
}
function toNumber(val) {
  if (typeof val === "number") return val;
  if (!val) return 0;
  const clean = String(val).replace(/[^\d.,-]/g, "").replace(/\./g, "").replace(",", ".");
  const num = parseFloat(clean);
  return isNaN(num) ? 0 : num;
}
function toInt(val, def = 0) {
  const n = parseInt(val, 10);
  return isNaN(n) ? def : n;
}
function formatPrice(num) {
  if (!num) return "";
  const clean = String(num).replace(/[^\d]/g, "");
  const formatted = parseInt(clean, 10).toLocaleString('es-AR');
  return "$" + formatted.replace(/,/g, ".");
}
function formatCurrency(el) {
  let raw = String(el.value || "");
  let digits = raw.replace(/\D/g, '');
  if (digits === '') { el.value = ''; return; }
  let n = parseInt(digits, 10);
  if (isNaN(n)) { el.value = ''; return; }
  let formatted = n.toLocaleString('es-AR');
  el.value = '$' + formatted;
}
function parseCurrency(str) {
  if (!str) return 0;
  let cleaned = String(str).replace(/[^\d]/g, '');
  return cleaned === '' ? 0 : parseInt(cleaned, 10);
}
function driveUrlDirect(url) {
  let fileId = null;
  if (url && url.includes("drive.google.com")) {
    let match = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
    if (match) fileId = match[1];
  }
  return fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : url;
}

async function incrementarMetrica(idPropiedad) {
  if (!idPropiedad) return;
  await fetch(`${webAppURL}?action=incrementarmetrica&idPropiedad=${idPropiedad}&metrica=vistas`, {method:"GET"}).catch(()=>{});
}

function abrirModal(src, images, index = 0) {
  currentImages = images.filter(url => url && url.trim() !== "");
  if (currentImages.length === 0) return;
  currentImageIndex = index;
  document.getElementById("img-grande").src = currentImages[currentImageIndex];
  document.getElementById("modal-img").style.display = "flex";
  document.querySelector(".prev-btn").style.display = currentImages.length > 1 ? "block" : "none";
  document.querySelector(".next-btn").style.display = currentImages.length > 1 ? "block" : "none";
}
function cerrarModal() {
  document.getElementById("modal-img").style.display = "none";
}
function cambiarImagen(dir) {
  if (currentImages.length <= 1) return;
  currentImageIndex = (currentImageIndex + dir + currentImages.length) % currentImages.length;
  document.getElementById("img-grande").src = currentImages[currentImageIndex];
}

function toggleFiltros() {
  const f = document.getElementById("filtros");
  f.style.display = (f.style.display === "none" || !f.style.display) ? "flex" : "none";
}
function updateFiltros() {
  const operacion = document.getElementById("filtroOperacion").value;
  document.getElementById("filtros-alquilar").style.display = operacion === "Alquilar" ? "flex" : "none";
  document.getElementById("filtros-comprar").style.display = operacion === "Comprar" ? "flex" : "none";
  cargarPropiedades();
}

async function makeRequest(url) {
  const res = await fetch(url);
  return await res.json();
}

function cargarPropiedades() {
  const loadingEl = document.getElementById("loading-msg");
  loadingEl.style.display = "block";
  markersLayer.clearLayers();

  const urlParams = new URLSearchParams(window.location.search);
  inmobiliariaEmail = urlParams.get('email')?.trim() || window.location.search.replace(/^\?/, '').trim();
  if (!inmobiliariaEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(inmobiliariaEmail)) {
    loadingEl.style.display = "none";
    document.querySelector("#inmobiliaria-nombre h2").textContent = "Inmobiliaria no encontrada";
    return;
  }

  const operacion = document.getElementById("filtroOperacion").value;
  const filtroAmb = toInt(document.getElementById("filtroAmb").value);
  const filtroMin = parseCurrency(document.getElementById("filtroMin").value) || 0;
  const filtroMax = parseCurrency(document.getElementById("filtroMax").value) || Infinity;
  const filtroMascotas = document.getElementById("filtroMascotas").checked;
  const filtroAmoblado = document.getElementById("filtroAmoblado").checked;
  const filtroTipoAlquilar = document.getElementById("filtroTipoAlquilar").value;
  const filtroTipoComprar = document.getElementById("filtroTipoComprar").value;

  makeRequest(`${webAppURL}?action=getInmobiliaria&email=${encodeURIComponent(inmobiliariaEmail)}`)
    .then(res => {
      loadingEl.style.display = "none";
      if (!res.success || !res.alquileres) {
        document.querySelector("#inmobiliaria-nombre h2").textContent = "Inmobiliaria no encontrada";
        return;
      }
      const nombre = res.data.Nombre || "Inmobiliaria";
      document.querySelector("#inmobiliaria-nombre h2").textContent = `Inmobiliaria "${nombre}"`;

      const marcadores = [];
      let cont = 0;

      // Marcadores est√°ticos
      const uniIcon = L.divIcon({className:'marker-icon',html:'üéì',iconSize:[30,30],iconAnchor:[15,15]});
      const hospIcon = L.divIcon({className:'marker-icon',html:'üè•',iconSize:[30,30],iconAnchor:[15,15]});
      const superIcon = L.divIcon({className:'marker-icon',html:'üõí',iconSize:[30,30],iconAnchor:[15,15]});
      const busIcon = L.divIcon({className:'marker-icon',html:'üöå',iconSize:[30,30],iconAnchor:[15,15]});
      const policeIcon = L.divIcon({className:'marker-icon',html:'üëÆ',iconSize:[30,30],iconAnchor:[15,15]});
      L.marker([-28.5509978,-56.0409727],{icon:uniIcon}).addTo(markersLayer).bindPopup("<b>Facultad Fundaci√≥n Barcel√≥</b>");
      L.marker([-28.5551127,-56.0389282],{icon:hospIcon}).addTo(markersLayer).bindPopup("<b>Hospital Universitario San Juan Bautista</b>");
      L.marker([-28.5519443,-56.0401962],{icon:superIcon}).addTo(markersLayer).bindPopup("<b>Supermercado La Bomba</b>");
      L.marker([-28.5472635,-56.0438082],{icon:superIcon}).addTo(markersLayer).bindPopup("<b>Supermercado El Super</b>");
      L.marker([-28.5462903,-56.0440365],{icon:superIcon}).addTo(markersLayer).bindPopup("<b>Supermercado La Econom√≠a</b>");
      L.marker([-28.5468697,-56.0432862],{icon:busIcon}).addTo(markersLayer).bindPopup("<b>Terminal de Omnibus</b>");
      L.marker([-28.5487787,-56.0396171],{icon:policeIcon}).addTo(markersLayer).bindPopup("<b>Polic√≠a</b>");

      res.alquileres.forEach(a => {
        const lat = parseFloat(getField(a, ["Latitud","lat"]));
        const lng = parseFloat(getField(a, ["Longitud","lng"]));
        if (isNaN(lat) || isNaN(lng)) return;

        const subtipo = getField(a, ["Subtipo"]);
        if ((operacion === "Alquilar" && subtipo !== "Alquilar") || (operacion === "Comprar" && subtipo !== "Vender")) return;

        const tipo = getField(a, ["Tipo"]) || "Propiedad";
        if (operacion === "Alquilar" && filtroTipoAlquilar && tipo !== filtroTipoAlquilar) return;
        if (operacion === "Comprar" && filtroTipoComprar && tipo !== filtroTipoComprar) return;

        const nroAmb = toInt(getField(a, ["Nro Ambientes","Ambientes"]));
        if (operacion === "Alquilar" && filtroAmb && nroAmb !== filtroAmb) return;

        const precioRaw = getField(a, ["Precio"]);
        const precio = toNumber(precioRaw);
        const formattedPrecio = formatPrice(precioRaw);
        if (operacion === "Alquilar" && (precio < filtroMin || precio > filtroMax)) return;

        if (operacion === "Alquilar" && filtroMascotas && getField(a,["Mascotas"]).toLowerCase() !== "s√≠") return;
        if (operacion === "Alquilar" && filtroAmoblado && getField(a,["Amoblado"]).toLowerCase() !== "s√≠") return;

        const titulo = getField(a, ["T√≠tulo","titulo","Titulo","T√≠tulo Propiedad"]) || tipo;
        const id = getField(a, ["ID Propiedad","idPropiedad","ID"]);
        const fotoPerfil = getField(a, ["FotoPerfil","fotoPerfil"]) || "https://i.postimg.cc/0jFNDZ7Y/default-avatar.png";

        let iconHtml = 'üè†';
        if (tipo === "Temporario") iconHtml = '‚åõ';
        else if (tipo === "Local") iconHtml = 'üõçÔ∏è';
        else if (nroAmb) iconHtml = `üè†<span style="font-size:12px;margin-left:2px;">${nroAmb}</span>`;

        const icon = L.divIcon({className:'marker-icon',html:iconHtml,iconSize:[30,30],iconAnchor:[15,15]});
        const marker = L.marker([lat, lng], {icon}).addTo(markersLayer);
        marcadores.push(marker);

        const popupDiv = document.createElement('div');
        popupDiv.style.position = "relative";
        popupDiv.style.padding = "12px";

        const imgPerfil = document.createElement('img');
        imgPerfil.className = "popup-profile-img";
        imgPerfil.src = fotoPerfil;
        imgPerfil.onclick = e => { e.stopPropagation(); abrirModal(fotoPerfil, [fotoPerfil], 0); };
        popupDiv.appendChild(imgPerfil);

        popupDiv.innerHTML += `
          <div style="margin-right:60px;">
            <b style="font-size:16px;display:block;margin-bottom:4px;">${titulo}</b>
            <b>Tipo:</b> ${tipo}<br>
            <b>Precio:</b> ${formattedPrecio || 'Consultar'}
          </div>
        `;

        const verBtn = document.createElement('button');
        verBtn.className = 'popup-button';
        verBtn.textContent = 'Ver Detalles';
        verBtn.onclick = async e => {
          e.stopPropagation();
          if (id) await incrementarMetrica(id);
          window.open(`https://www.alquiya.com.ar/propiedad.html?id=${id}`, "_blank");
        };
        popupDiv.appendChild(verBtn);

        marker.bindPopup(popupDiv);
        cont++;
      });

      if (marcadores.length > 0) {
        const group = L.featureGroup(marcadores);
        map.fitBounds(group.getBounds(), {padding: [50,50]});
      }
    })
    .catch(() => {
      loadingEl.style.display = "none";
      document.querySelector("#inmobiliaria-nombre h2").textContent = "Error de conexi√≥n";
    });
}

window.onload = () => cargarPropiedades();
</script>

<footer style="margin-top:80px;background:#3483fa;color:white;padding:2.5rem 1rem 1.5rem;">
  <div style="max-width:1200px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:2rem;align-items:center;text-align:center;">
    <div><img src="https://i.postimg.cc/FHXRBTTX/logo-Alqui-Ya-fondo-blanco-Photoroom-Photoroom.png" alt="Logo AlquiYa" style="max-width:180px;height:auto;"></div>
    <div><a href="https://www.alquiya.com.ar" style="display:inline-block;background:white;color:#3483fa;font-weight:700;padding:0.9rem 2.6rem;border-radius:50px;font-size:1.28rem;box-shadow:0 6px 20px rgba(52,131,250,0.3);transition:all 0.3s ease;text-decoration:none;">‚Üê Volver al Inicio</a></div>
    <div><a href="https://www.instagram.com/alquiya.st/" target="_blank"><img src="https://i.postimg.cc/GmVWTXX0/394a7aaecd6b8ce44528649681d9fa05.png" alt="Instagram" style="width:40px;height:40px;"></a></div>
    <div style="font-size:0.95rem;opacity:0.9;grid-column:1/-1;">¬© 2025 AlquiYa ‚Ä¢ Todos los derechos reservados</div>
  </div>
</footer>

</body>
</html>
